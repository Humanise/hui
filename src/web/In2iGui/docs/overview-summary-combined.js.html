<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
 Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="combined.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b></b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>combined.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		No overview generated for 'combined.js'<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ObjectList.Text.html">In2iGui.ObjectList.Text</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Tabs.Tab.html">In2iGui.Tabs.Tab</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Menu.html">In2iGui.Menu</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Selection.html">In2iGui.Selection</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ImageViewer.html">In2iGui.ImageViewer</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.DatePicker.html">In2iGui.DatePicker</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Calendar.html">In2iGui.Calendar</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="N2i.Preloader.html">N2i.Preloader</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Editor.html">In2iGui.Editor</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ViewStack.html">In2iGui.ViewStack</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Toolbar.SearchField.html">In2iGui.Toolbar.SearchField</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Selection.Source.html">In2iGui.Selection.Source</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ObjectList.html">In2iGui.ObjectList</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.html">In2iGui.Formula</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Group.html">In2iGui.Formula.Group</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.MultiUpload.Item.html">In2iGui.MultiUpload.Item</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.List.html">In2iGui.List</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="N2i.DateField.html">N2i.DateField</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Button.html">In2iGui.Button</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.MultiUpload.html">In2iGui.MultiUpload</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Columns.html">In2iGui.Columns</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Toolbar.html">In2iGui.Toolbar</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.BoundPanel.html">In2iGui.BoundPanel</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Checkboxes.Source.html">In2iGui.Formula.Checkboxes.Source</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.TextField.html">In2iGui.TextField</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Checkboxes.html">In2iGui.Formula.Checkboxes</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Checkbox.html">In2iGui.Formula.Checkbox</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="N2i.TextField.html">N2i.TextField</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="N2i.DateTimeField.html">N2i.DateTimeField</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Select.html">In2iGui.Formula.Select</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Window.html">In2iGui.Window</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ObjectList.Object.html">In2iGui.ObjectList.Object</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Buttons.html">In2iGui.Buttons</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Panel.html">In2iGui.Panel</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Text.html">In2iGui.Formula.Text</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Editor.Html.html">In2iGui.Editor.Html</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Overlay.html">In2iGui.Overlay</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.InfoView.html">In2iGui.InfoView</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.DateTime.html">In2iGui.Formula.DateTime</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Picker.html">In2iGui.Picker</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ObjectList.Select.html">In2iGui.ObjectList.Select</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.RevealingToolbar.html">In2iGui.RevealingToolbar</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.html">In2iGui</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="N2i.Event.html">N2i.Event</a></b></td>
    <td>A wrapper for an event
 </td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Tokens.html">In2iGui.Formula.Tokens</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Tabs.html">In2iGui.Tabs</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Gallery.html">In2iGui.Gallery</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Formula.Radiobuttons.html">In2iGui.Formula.Radiobuttons</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Tabbox.html">In2iGui.Tabbox</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Toolbar.Icon.html">In2iGui.Toolbar.Icon</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.RichText.html">In2iGui.RichText</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ProgressBar.html">In2iGui.ProgressBar</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Upload.html">In2iGui.Upload</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="N2i.Request.html">N2i.Request</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Alert.html">In2iGui.Alert</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.ImagePicker.html">In2iGui.ImagePicker</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Editor.Header.html">In2iGui.Editor.Header</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="In2iGui.Toolbar.Badge.html">In2iGui.Toolbar.Badge</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">/**
 * Base
 */</span>
var N2i = {};

<span class="comment">/**
 * <span class="attrib">@todo</span> Maybe improve performace
 */</span>
<span class="reserved">function</span> $id() {
	var elements = new Array();

	<span class="reserved">for</span> (var i = 0; i &lt; arguments.length; i++) {
		var element = arguments[i];
		<span class="reserved">if</span> (typeof element == <span class="literal">'string'</span>) {
			element = document.getElementById(element);
		}
		<span class="reserved">if</span> (arguments.length == 1) {
			<span class="reserved">return</span> element;			
		}
		elements.push(element);
	}

	<span class="reserved">return</span> elements;
}

<span class="reserved">function</span> $class(className,parentElement) {
	var children = ($id(parentElement) || document.body).getElementsByTagName(<span class="literal">'*'</span>);
	var elements = [];
	<span class="reserved">for</span> (var i=0;i&lt;children.length;i++) {
		<span class="reserved">if</span> (N2i.hasClass(children[i],className)) {
			elements[elements.length] = children[i];
		}
	}
	<span class="reserved">return</span> elements;
}

<span class="reserved">function</span> $firstClass(className,parentElement) {
	var children = ($id(parentElement) || document.body).getElementsByTagName(<span class="literal">'*'</span>);
	<span class="reserved">for</span> (var i=0;i&lt;children.length;i++) {
		<span class="reserved">if</span> (N2i.hasClass(children[i],className)) {
			<span class="reserved">return</span> children[i];
		}
	}
	<span class="reserved">return</span> null;
}

<span class="reserved">function</span> $tag(name,parentElement) {
	parentElement = parentElement ? $id(parentElement) : document.body;
	<span class="reserved">return</span> parentElement.getElementsByTagName(name);
}

<span class="reserved">function</span> $ani(element,style,value,duration,delegate) {
	<span class="reserved">if</span> (N2i.Animation) {
		N2i.Animation.get(element).animate(null,value,style,duration,delegate);
	}
}

<span class="reserved">function</span> $get(url,delegate,options) {
	var req = new N2i.Request(delegate);
	req.request(url,options);
}

<span class="comment">/**
 * Implement push on array if not implemented
 */</span>
<span class="reserved">if</span> (!Array.<span class="reserved">prototype</span>.push) {
	Array.<span class="reserved">prototype</span>.push = <span class="reserved">function</span>() {
		var startLength = <span class="reserved">this</span>.length;
		<span class="reserved">for</span> (var i = 0; i &lt; arguments.length; i++) {
			<span class="reserved">this</span>[startLength + i] = arguments[i];
		}
		<span class="reserved">return</span> <span class="reserved">this</span>.length;
	}
}


<span class="comment">///////////////////////////////////////// Util //////////////////////////////////////</span>

N2i.override = <span class="reserved">function</span>(original,subject) {
	<span class="reserved">if</span> (subject) {
		<span class="reserved">for</span> (prop in subject) {
			original[prop] = subject[prop];
		}
	}
	<span class="reserved">return</span> original;
}

N2i.camelize = <span class="reserved">function</span>(str) {
    var oStringList = str.split(<span class="literal">'-'</span>);
    <span class="reserved">if</span> (oStringList.length == 1) <span class="reserved">return</span> oStringList[0];

    var camelizedString = str.indexOf(<span class="literal">'-'</span>) == 0
      ? oStringList[0].charAt(0).toUpperCase() + oStringList[0].substring(1)
      : oStringList[0];

    <span class="reserved">for</span> (var i = 1, len = oStringList.length; i &lt; len; i++) {
      var s = oStringList[i];
      camelizedString += s.charAt(0).toUpperCase() + s.substring(1);
    }

    <span class="reserved">return</span> camelizedString;
}

N2i.log = <span class="reserved">function</span>(obj) {
	try {
		console.log(obj);
	} catch (ignore) {};
}

N2i.escapeHTML = <span class="reserved">function</span>(str) {
    var div = document.createElement(<span class="literal">'div'</span>);
    var text = document.createTextNode(str);
    div.appendChild(text);
    <span class="reserved">return</span> div.innerHTML;
}

<span class="comment">/////////////////////////////////////// Element /////////////////////////////////////</span>

N2i.create = <span class="reserved">function</span>(name,attributes,styles,properties) {
	var element = document.createElement(name);
	<span class="reserved">if</span> (attributes) {
		<span class="reserved">for</span> (attribute in attributes) {
			<span class="reserved">if</span> (attribute==<span class="literal">'class'</span>) {
				element.className = attributes[attribute];
			} <span class="reserved">else</span> {
				element.setAttribute(attribute,attributes[attribute]);
			}
		}
	}
	<span class="reserved">if</span> (styles) {
		<span class="reserved">for</span> (style in styles) {
			element.style[style] = styles[style];
		}
	}
	<span class="reserved">if</span> (properties) {
		<span class="reserved">for</span> (property in properties) {
			element[property] = properties[property];
		}
	}
	<span class="reserved">return</span> element;
}

N2i.removeChildren = <span class="reserved">function</span>(node) {
	var children = node.childNodes;
	<span class="reserved">for</span> (var i = children.length - 1; i &gt;= 0; i--){
		node.removeChild(children[i]);
	};
}

N2i.ELEMENT_NODE=1;
N2i.ATTRIBUTE_NODE=2;
N2i.TEXT_NODE=3;

N2i.Element = {}

N2i.Element.removeClassName = N2i.removeClass = <span class="reserved">function</span>(element, className) {
	element = $id(element);
	<span class="reserved">if</span> (!element) <span class="reserved">return</span>;		

	var newClassName = <span class="literal">''</span>;
	var a = element.className.split(/\s+/);
	<span class="reserved">for</span> (var i = 0; i &lt; a.length; i++) {
		<span class="reserved">if</span> (a[i] != className) {
			<span class="reserved">if</span> (i &gt; 0) {
				newClassName += <span class="literal">' '</span>;				
			}
			newClassName += a[i];
		}
	}
	element.className = newClassName;
}

N2i.Element.hasClassName = N2i.hasClass = <span class="reserved">function</span>(element, className) {
	element = $id(element);
	<span class="reserved">if</span> (!element) <span class="reserved">return</span>;
	var a = element.className.split(/\s+/);
	<span class="reserved">for</span> (var i = 0; i &lt; a.length; i++) {
		<span class="reserved">if</span> (a[i] == className) {
			<span class="reserved">return</span> true;
		}
	}
	<span class="reserved">return</span> false;
}

N2i.Element.addClassName = N2i.addClass = <span class="reserved">function</span>(element, className) {
    element = $id(element);
	<span class="reserved">if</span> (!element) <span class="reserved">return</span>;
	
    N2i.Element.removeClassName(element, className);
    element.className += <span class="literal">' '</span> + className;
}

N2i.toggleClass = <span class="reserved">function</span>(element,className) {
	<span class="reserved">if</span> (N2i.hasClass(element,className)) {
		N2i.removeClass(element,className);
	} <span class="reserved">else</span> {
		N2i.addClass(element,className);
	}
}

N2i.setClass = <span class="reserved">function</span>(element,className,add) {
	<span class="reserved">if</span> (add) {
		N2i.addClass(element,className);
	} <span class="reserved">else</span> {
		N2i.removeClass(element,className);
	}
}


N2i.Element.scrollTo = <span class="reserved">function</span>(element) {
	element = $id(element);
	window.scrollTo(N2i.Element.getLeft(element), N2i.Element.getTop(element)-20);
}

N2i.Element.getLeft = N2i.getLeft = <span class="reserved">function</span>(element) {
    element = $id(element);
	<span class="reserved">if</span> (element) {
		xPos = element.offsetLeft;
		tempEl = element.offsetParent;
		<span class="reserved">while</span> (tempEl != null) {
			xPos += tempEl.offsetLeft;
			tempEl = tempEl.offsetParent;
		}
		<span class="reserved">return</span> xPos;
	}
	<span class="reserved">else</span> <span class="reserved">return</span> 0;
}


N2i.Element.getTop = N2i.getTop = <span class="reserved">function</span>(element) {
    element = $id(element);
	<span class="reserved">if</span> (element) {
		yPos = element.offsetTop;
		tempEl = element.offsetParent;
		<span class="reserved">while</span> (tempEl != null) {
			yPos += tempEl.offsetTop;
			tempEl = tempEl.offsetParent;
		}
		<span class="reserved">return</span> yPos;
	}
	<span class="reserved">else</span> <span class="reserved">return</span> 0;
}

<span class="comment">/**
 * Finds an elements width as displayed by the browser
 * <span class="attrib">@param</span> {Object} obj The element to analyze
 * <span class="attrib">@return</span> {int} The width in pixels of the element
 */</span>
N2i.Element.getWidth = N2i.getWidth = <span class="reserved">function</span>(element) {
	element = $id(element);
	<span class="reserved">return</span> element.offsetWidth;
}

<span class="comment">/**
 * Finds an elements height as displayed by the browser
 * <span class="attrib">@param</span> {Object} obj The element to analyze
 * <span class="attrib">@return</span> {int} The height in pixels of the element
 */</span>
N2i.Element.getHeight = N2i.getHeight = <span class="reserved">function</span>(element) {
	element = $id(element);
	<span class="reserved">return</span> element.offsetHeight;
}

N2i.Element.getRect = <span class="reserved">function</span>(element) {
	<span class="reserved">return</span> {
		left:	N2i.Element.getLeft(element),
		top:	N2i.Element.getTop(element),
		width:	N2i.Element.getWidth(element),
		height:	N2i.Element.getHeight(element)
	};
}


N2i.Element.getStyle = N2i.getStyle = <span class="reserved">function</span>(element, style) {
	element = $id(element);
	var cameled = N2i.camelize(style);
	var value = element.style[cameled];
	<span class="reserved">if</span> (!value) {
		<span class="reserved">if</span> (document.defaultView &amp;&amp; document.defaultView.getComputedStyle) {
			var css = document.defaultView.getComputedStyle(element, null);
			value = css ? css.getPropertyValue(style) : null;
		} <span class="reserved">else</span> <span class="reserved">if</span> (element.currentStyle) {
			value = element.currentStyle[cameled];
		}
	}
	<span class="reserved">if</span> (window.opera &amp;&amp; [<span class="literal">'left'</span>, <span class="literal">'top'</span>, <span class="literal">'right'</span>, <span class="literal">'bottom'</span>].include(style)) {
		<span class="reserved">if</span> (N2i.Element.getStyle(element, <span class="literal">'position'</span>) == <span class="literal">'static'</span>) value = <span class="literal">'auto'</span>;
	}
	<span class="reserved">return</span> value == <span class="literal">'auto'</span> ? null : value;
}

N2i.setOpacity = <span class="reserved">function</span>(element,opacity) {
	<span class="reserved">if</span> (N2i.isIE()) {
		<span class="reserved">if</span> (opacity==1) {
			element.style[<span class="literal">'filter'</span>]=null;
		} <span class="reserved">else</span> {
			element.style[<span class="literal">'filter'</span>]=<span class="literal">'alpha(opacity='</span>+(opacity*100)+<span class="literal">')'</span>;
		}
	} <span class="reserved">else</span> {
		element.style[<span class="literal">'opacity'</span>]=opacity;
	}
}

N2i.getDocumentHeight = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (window.scrollMaxY &amp;&amp; window.innerHeight) {
		<span class="reserved">return</span> window.scrollMaxY+window.innerHeight;
	} <span class="reserved">else</span> {
		<span class="reserved">return</span> Math.max(document.body.clientHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight);
	}
}

<span class="comment">////////////////////////////////////// Window ////////////////////////////////</span>


N2i.Window = <span class="reserved">function</span>() {}

<span class="comment">/**
 * Finds how far the window has scrolled from the top
 * <span class="attrib">@return</span> {int} The number of pixels the window is scrolled from the top
 */</span>
N2i.Window.getScrollTop = <span class="reserved">function</span>() {
	var x,y;
	<span class="reserved">if</span> (self.pageYOffset) <span class="comment">// all except Explorer</span>
	{
		y = self.pageYOffset;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (document.documentElement &amp;&amp; document.documentElement.scrollTop)
		<span class="comment">// Explorer 6 Strict</span>
	{
		y = document.documentElement.scrollTop;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (document.body) <span class="comment">// all other Explorers</span>
	{
		y = document.body.scrollTop;
	}
	<span class="reserved">return</span> y;
}

<span class="comment">/**
 * Finds how far the window has scrolled from the left
 * <span class="attrib">@return</span> {int} The number of pixels the window is scrolled from the left
 */</span>
N2i.Window.getScrollLeft = <span class="reserved">function</span>() {
	var x;
	<span class="reserved">if</span> (self.pageYOffset) <span class="comment">// all except Explorer</span>
	{
		x = self.pageXOffset;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (document.documentElement &amp;&amp; document.documentElement.scrollTop)
		<span class="comment">// Explorer 6 Strict</span>
	{
		x = document.documentElement.scrollLeft;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (document.body) <span class="comment">// all other Explorers</span>
	{
		x = document.body.scrollLeft;
	}
	<span class="reserved">return</span> x;
}


<span class="comment">/**
 * Finds how much the window is scrolled
 * <span class="attrib">@return</span> {Object} An object with left,top
 */</span>
N2i.Window.getScrollPosition = <span class="reserved">function</span>() {
	<span class="reserved">return</span> {
		left:	N2i.Window.getScrollLeft(),
		top:	N2i.Window.getScrollTop()
	};
}

<span class="comment">/**
 * Finds the height of the windows visible view of the document
 * <span class="attrib">@return</span> {int} The height of the windows view of the document in pixels
 */</span>
N2i.Window.getInnerHeight = <span class="reserved">function</span>() {
	var y;
	<span class="reserved">if</span> (self.innerHeight) <span class="comment">// all except Explorer</span>
	{
		y = self.innerHeight;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (document.documentElement &amp;&amp; document.documentElement.clientHeight)
		<span class="comment">// Explorer 6 Strict Mode</span>
	{
		y = document.documentElement.clientHeight;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (document.body) <span class="comment">// other Explorers</span>
	{
		y = document.body.clientHeight;
	}
	<span class="reserved">return</span> y;
}

<span class="comment">/**
 * Finds the width of the windows visible view of the document
 * <span class="attrib">@return</span> {int} The width of the windows view of the document in pixels
 */</span>
N2i.Window.getInnerWidth = <span class="reserved">function</span>() {
	var x;
	<span class="reserved">if</span> (self.innerHeight) <span class="comment">// all except Explorer</span>
	{
		x = self.innerWidth;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (document.documentElement &amp;&amp; document.documentElement.clientHeight)
		<span class="comment">// Explorer 6 Strict Mode</span>
	{
		x = document.documentElement.clientWidth;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (document.body) <span class="comment">// other Explorers</span>
	{
		x = document.body.clientWidth;
	}
	<span class="reserved">return</span> x;
}


<span class="comment">/**
 * Finds the dimensions of the visible area of the document
 * <span class="attrib">@return</span> {Object} An object with left,top,width,height
 */</span>
N2i.Window.getDocumentRect = <span class="reserved">function</span>() {
	<span class="reserved">return</span> {
		left:	0,
		top:	0,
		width:	N2i.Window.getInnerWidth(),
		height:	N2i.Window.getInnerHeight()
	};
}

<span class="comment">////////////////////////////////////// Event /////////////////////////////////</span>

<span class="comment">/**
 * Creates a new In2iEvent object from an event
 * <span class="attrib">@class</span> A wrapper for an event
 * <span class="attrib">@constructor</span>
 */</span>
N2i.Event = <span class="reserved">function</span>(event) {
    <span class="reserved">if</span> (!event) {
		<span class="reserved">this</span>.event = window.event;
	} <span class="reserved">else</span> {
		<span class="reserved">this</span>.event=event;
	}
}

N2i.Event.<span class="reserved">prototype</span> = {
	mouseLeft : <span class="reserved">function</span>() {
	    var left = 0;
		<span class="reserved">if</span> (<span class="reserved">this</span>.event) {
		    <span class="reserved">if</span> (<span class="reserved">this</span>.event.pageX) {
			    left = <span class="reserved">this</span>.event.pageX;
		    } <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.event.clientX) {
			    left = <span class="reserved">this</span>.event.clientX + document.body.scrollLeft;
		    }
		}
	    <span class="reserved">return</span> left;
	},
	mouseTop : <span class="reserved">function</span>() {
	    var top = 0;
		<span class="reserved">if</span> (<span class="reserved">this</span>.event) {
		    <span class="reserved">if</span> (<span class="reserved">this</span>.event.pageY) {
			    top = <span class="reserved">this</span>.event.pageY;
		    } <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.event.clientY) {
			    top = <span class="reserved">this</span>.event.clientY + document.body.scrollTop;
		    }
		}
	    <span class="reserved">return</span> top;
	},
	getTarget : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.event.target != null ? <span class="reserved">this</span>.event.target : <span class="reserved">this</span>.event.srcElement;
	},
	isReturnKey : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.event.keyCode==13;
	},
	isRightKey : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.event.keyCode==39;
	},
	isLeftKey : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.event.keyCode==37;
	},
	isEscapeKey : <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.event.keyCode==27;
	},
	isSpaceKey : <span class="reserved">function</span>() {
		N2i.log(<span class="reserved">this</span>.event.keyCode);
		<span class="reserved">return</span> <span class="reserved">this</span>.event.keyCode==32;
	},
	stop : <span class="reserved">function</span>() {
<span class="comment">//		this.event.returnValue = false;</span>
<span class="comment">//		N2i.Event.stop(this.event);</span>
	}
}


N2i.Event.addListener = N2i.addListener = <span class="reserved">function</span>(el,type,listener,useCapture) {
	el = $id(el);
	<span class="reserved">if</span>(document.addEventListener) {
		<span class="comment">// W3C DOM Level 2 Events - used by Mozilla, Opera and Safari</span>
		<span class="reserved">if</span>(!useCapture) {useCapture = false;} <span class="reserved">else</span> {useCapture = true;} {
			el.addEventListener(type,listener,useCapture);
		}
	} <span class="reserved">else</span> {
		<span class="comment">// MS implementation - used by Internet Explorer</span>
		el.attachEvent(<span class="literal">'on'</span>+type, listener);
	}
}

N2i.Event.removeListener = N2i.removeListener = <span class="reserved">function</span>(el,type,listener,useCapture) {
	el = $id(el);
	<span class="reserved">if</span>(document.removeEventListener) {
		<span class="comment">// W3C DOM Level 2 Events - used by Mozilla, Opera and Safari</span>
		<span class="reserved">if</span>(!useCapture) {useCapture = false;} <span class="reserved">else</span> {useCapture = true;} {
			el.removeEventListener(type,listener,useCapture);
		}
	} <span class="reserved">else</span> {
		<span class="comment">// MS implementation - used by Internet Explorer</span>
		el.detachEvent(<span class="literal">'on'</span>+type, listener);
	}
}

N2i.Event.stop = <span class="reserved">function</span>(e) {
	<span class="reserved">if</span> (!e) var e = window.event;
	e.cancelBubble = true;
	<span class="reserved">if</span> (e.stopPropagation) e.stopPropagation();
}

N2i.Event.addLoadListener = N2i.addLoadListener = <span class="reserved">function</span>(delegate) {
	<span class="reserved">if</span>(typeof window.addEventListener != <span class="literal">'undefined'</span>)
	{
		<span class="comment">//.. gecko, safari, konqueror and standard</span>
		window.addEventListener(<span class="literal">'load'</span>, delegate, false);
	}
	<span class="reserved">else</span> <span class="reserved">if</span>(typeof document.addEventListener != <span class="literal">'undefined'</span>)
	{
		<span class="comment">//.. opera 7</span>
		document.addEventListener(<span class="literal">'load'</span>, delegate, false);
	}
	<span class="reserved">else</span> <span class="reserved">if</span>(typeof window.attachEvent != <span class="literal">'undefined'</span>)
	{
		<span class="comment">//.. win/ie</span>
		window.attachEvent(<span class="literal">'onload'</span>, delegate);
	}

	<span class="comment">//** remove this condition to degrade older browsers</span>
	<span class="reserved">else</span>
	{
		<span class="comment">//.. mac/ie5 and anything else that gets this far</span>
	
		<span class="comment">//if there's an existing onload function</span>
		<span class="reserved">if</span>(typeof window.onload == <span class="literal">'function'</span>)
		{
			<span class="comment">//store it</span>
			var existing = window.onload;
		
			<span class="comment">//add new onload handler</span>
			window.onload = <span class="reserved">function</span>()
			{
				<span class="comment">//call existing onload function</span>
				existing();
			
				<span class="comment">//call delegate onload function</span>
				delegate();
			};
		}
		<span class="reserved">else</span>
		{
			<span class="comment">//setup onload function</span>
			window.onload = delegate;
		}
	}
}

N2i.Location = {};

N2i.Location.getParameter = <span class="reserved">function</span>(name) {
	var parms = N2i.Location.getParameters();
	<span class="reserved">for</span> (var i=0; i &lt; parms.length; i++) {
		<span class="reserved">if</span> (parms[i].name==name) {
			<span class="reserved">return</span> parms[i].value;
		}
	};
	<span class="reserved">return</span> null;
}

N2i.Location.setParameter = <span class="reserved">function</span>(name,value) {
	var parms = N2i.Location.getParameters();
	var found = false;
	<span class="reserved">for</span> (var i=0; i &lt; parms.length; i++) {
		<span class="reserved">if</span> (parms[i].name==name) {
			parms[i].value=value;
			found=true;
			break;
		}
	};
	<span class="reserved">if</span> (!found) {
		parms.push({name:name,value:value});
	}
	N2i.Location.setParameters(parms);
}

N2i.Location.setParameters = <span class="reserved">function</span>(parms) {
	var query = <span class="literal">''</span>;
	<span class="reserved">for</span> (var i=0; i &lt; parms.length; i++) {
		query+= i==0 ? <span class="literal">'?'</span> : <span class="literal">'&amp;'</span>;
		query+=parms[i].name+<span class="literal">'='</span>+parms[i].value;
	};
	document.location.search=query;
}

N2i.Location.getBoolean = <span class="reserved">function</span>(name) {
	var value = N2i.Location.getParameter(name);
	<span class="reserved">return</span> (value==<span class="literal">'true'</span> || value==<span class="literal">'1'</span>);
}

N2i.Location.getParameters = <span class="reserved">function</span>() {
	var items = document.location.search.substring(1).split(<span class="literal">'&amp;'</span>);
	var parsed = [];
	<span class="reserved">for</span>( var i = 0; i &lt; items.length; i++) {
		var item = items[i].split(<span class="literal">'='</span>);
		var name = unescape(item[0]).replace(/^\s*|\s*$/g,<span class="literal">""</span>);
		var value = unescape(item[1]).replace(/^\s*|\s*$/g,<span class="literal">""</span>);
		<span class="reserved">if</span> (name) {
			parsed.push({name:name,value:value});
		}
	};
	<span class="reserved">return</span> parsed;
}

<span class="comment">/************************************* Request ******************************/</span>

N2i.Request = <span class="reserved">function</span>(delegate) {
	<span class="reserved">this</span>.delegate = delegate;
	<span class="reserved">this</span>.options = {method:<span class="literal">'GET'</span>,async:true};
}

N2i.Request.<span class="reserved">prototype</span>.request = <span class="reserved">function</span>(url,options) {
	N2i.override(<span class="reserved">this</span>.options,options);
	<span class="reserved">this</span>.initTransport();
	var req = <span class="reserved">this</span>.transport;
	var self = <span class="reserved">this</span>;
	req.onreadystatechange = <span class="reserved">function</span>() {
		try {
			<span class="reserved">if</span> (req.readyState == 4) {
				<span class="reserved">if</span> (req.status == 200) {
					<span class="reserved">if</span> (req.responseXML &amp;&amp; req.responseXML.documentElement) {
						<span class="reserved">if</span> (self.callDelegate(<span class="literal">'onXML'</span>,req.responseXML)) {
							<span class="reserved">return</span>;
						}
					} <span class="reserved">else</span> {
						<span class="reserved">if</span> (self.callDelegate(<span class="literal">'onText'</span>,req.responseXML)) {
							<span class="reserved">return</span>;
						}
					}
					self.callDelegate(<span class="literal">'onSuccess'</span>,req);
				} <span class="reserved">else</span> {
					self.callDelegate(<span class="literal">'onFailure'</span>,req);
				}
			}
		} catch (e) {
			N2i.log(e);
		}
	};
	var method = <span class="reserved">this</span>.options.method.toUpperCase();
	req.open(method, url, <span class="reserved">this</span>.options.async);
	var parameters = null;
	var body = <span class="literal">''</span>;
    <span class="reserved">if</span> (method==<span class="literal">'POST'</span> &amp;&amp; <span class="reserved">this</span>.options.parameters) {
		body = <span class="reserved">this</span>.buildPostBody(<span class="reserved">this</span>.options.parameters);
		req.setRequestHeader(<span class="literal">"Content-type"</span>, <span class="literal">"application/x-www-form-urlencoded; charset=utf-8"</span>);
		req.setRequestHeader(<span class="literal">"Content-length"</span>, body.length);
		req.setRequestHeader(<span class="literal">"Connection"</span>, <span class="literal">"close"</span>);
	}
	req.send(body);
}

N2i.Request.<span class="reserved">prototype</span>.buildPostBody = <span class="reserved">function</span>(parameters) {
	<span class="reserved">if</span> (!parameters) <span class="reserved">return</span> null;
	var output = <span class="literal">''</span>;
	<span class="reserved">for</span> (param in parameters) {
		<span class="reserved">if</span> (output.length&gt;0) output+=<span class="literal">'&amp;'</span>;
		output+=encodeURIComponent(param)+<span class="literal">'='</span>+encodeURIComponent(parameters[param]);
	}
	<span class="reserved">return</span> output;
}

N2i.Request.<span class="reserved">prototype</span>.callDelegate = <span class="reserved">function</span>(method,variable) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.delegate &amp;&amp; <span class="reserved">this</span>.delegate[method]) {
		<span class="reserved">this</span>.delegate[method](variable);
		<span class="reserved">return</span> true;
	}
	<span class="reserved">return</span> false;
}

N2i.Request.<span class="reserved">prototype</span>.initTransport = <span class="reserved">function</span>() {
	<span class="reserved">this</span>.transport = N2i.Request.createTransport();
}

N2i.Request.createTransport = <span class="reserved">function</span>() {
	try {
		<span class="reserved">if</span> (window.XMLHttpRequest) {
			var req = new XMLHttpRequest();
			<span class="reserved">if</span> (req.readyState == null) {
				req.readyState = 1;
				req.addEventListener(<span class="literal">"load"</span>, <span class="reserved">function</span> () {
					req.readyState = 4;
					<span class="reserved">if</span> (typeof req.onreadystatechange == <span class="literal">"function"</span>)
						req.onreadystatechange();
				}, false);
			}
			<span class="reserved">return</span> req;
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (window.ActiveXObject) {
			<span class="reserved">return</span> N2i.Request.getActiveX();
		} <span class="reserved">else</span> {
			<span class="comment">// Could not create transport</span>
			<span class="reserved">this</span>.delegate.onError(<span class="reserved">this</span>);
		}
	}
	catch (ex) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.delegate.onError) {
			<span class="reserved">this</span>.delegate.onError(<span class="reserved">this</span>,ex);
		}
	}
}

N2i.Request.getActiveX = <span class="reserved">function</span>() {
	var prefixes = [<span class="literal">"MSXML2"</span>, <span class="literal">"Microsoft"</span>, <span class="literal">"MSXML"</span>, <span class="literal">"MSXML3"</span>];
	var o;
	<span class="reserved">for</span> (var i = 0; i &lt; prefixes.length; i++) {
		try {
			<span class="comment">// try to create the objects</span>
			o = new ActiveXObject(prefixes[i] + <span class="literal">".XmlHttp"</span>);
			<span class="reserved">return</span> o;
		}
		catch (ex) {};
	}
	
	throw new Error(<span class="literal">"Could not find an installed XML parser"</span>);
}

N2i.Preloader = <span class="reserved">function</span>(options) {
	<span class="reserved">this</span>.options = options || {};
	<span class="reserved">this</span>.delegate = {};
	<span class="reserved">this</span>.images = [];
	<span class="reserved">this</span>.loaded = 0;
}

N2i.Preloader.<span class="reserved">prototype</span> = {
	addImages : <span class="reserved">function</span>(imageOrImages) {
		<span class="reserved">if</span> (typeof(imageOrImages)==<span class="literal">'object'</span>) {
			<span class="reserved">for</span> (var i=0; i &lt; imageOrImages.length; i++) {
				<span class="reserved">this</span>.images.push(imageOrImages[i]);
			};
		} <span class="reserved">else</span> {
			<span class="reserved">this</span>.images.push(imageOrImages);
		}
	},
	setDelegate : <span class="reserved">function</span>(d) {
		<span class="reserved">this</span>.delegate = d;
	},
	load : <span class="reserved">function</span>() {
		var self = <span class="reserved">this</span>;
		<span class="reserved">this</span>.obs = [];
		<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.images.length; i++) {
			var img = new Image();
			img.n2iPreloaderIndex = i;
			img.onload = <span class="reserved">function</span>() {self.imageChanged(<span class="reserved">this</span>.n2iPreloaderIndex,<span class="literal">'imageDidLoad'</span>)};
			img.onerror = <span class="reserved">function</span>() {self.imageChanged(<span class="reserved">this</span>.n2iPreloaderIndex,<span class="literal">'imageDidGiveError'</span>)};
			img.onabort = <span class="reserved">function</span>() {self.imageChanged(<span class="reserved">this</span>.n2iPreloaderIndex,<span class="literal">'imageDidAbort'</span>)};
			img.src = (<span class="reserved">this</span>.options.context ? <span class="reserved">this</span>.options.context : <span class="literal">''</span>)+<span class="reserved">this</span>.images[i];
			<span class="reserved">this</span>.obs.push(img);
		};
	},
	imageChanged : <span class="reserved">function</span>(index,method) {
		<span class="reserved">this</span>.loaded++;
		<span class="reserved">if</span> (<span class="reserved">this</span>.delegate[method]) {
			<span class="reserved">this</span>.delegate[method](<span class="reserved">this</span>.loaded,<span class="reserved">this</span>.images.length,index);
		}
		<span class="reserved">if</span> (<span class="reserved">this</span>.loaded==<span class="reserved">this</span>.images.length &amp;&amp; <span class="reserved">this</span>.delegate.allImagesDidLoad) {
			<span class="reserved">this</span>.delegate.allImagesDidLoad();
		}
	}
}

<span class="comment">///////////////////////////////////// Strings /////////////////////////////////////</span>

N2i.trim = <span class="reserved">function</span>(str) {
	<span class="reserved">if</span> (!str) <span class="reserved">return</span> str;
	<span class="reserved">return</span> str.replace(/^[\s\x0b\xa0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000]+|[\s\x0b\xa0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000]+$/g, <span class="literal">''</span>);
}

N2i.isEmpty = <span class="reserved">function</span>(str) {
	<span class="reserved">if</span> (str==null || typeof(str)==<span class="literal">'undefined'</span>) <span class="reserved">return</span> true;
	<span class="reserved">return</span> N2i.trim(str).length==0;
}

<span class="comment">///////////////////////////////////// Arrays /////////////////////////////////////</span>

N2i.inArray = <span class="reserved">function</span>(arr,value) {
	<span class="reserved">for</span> (var i=0; i &lt; arr.length; i++) {
		<span class="reserved">if</span> (arr[i]==value) <span class="reserved">return</span> true;
	};
}


N2i.flipInArray = <span class="reserved">function</span>(arr,value) {
	<span class="reserved">if</span> (N2i.inArray(arr,value)) {
		N2i.removeFromArray(arr,value);
	} <span class="reserved">else</span> {
		arr.push(value);
	}
}

N2i.removeFromArray = <span class="reserved">function</span>(arr,value) {
	<span class="reserved">for</span> (var i = arr.length - 1; i &gt;= 0; i--){
		<span class="reserved">if</span> (arr[i]==value) {
			arr.splice(i,1);
		}
	};
}

N2i.addToArray = <span class="reserved">function</span>(arr,value) {
	<span class="reserved">if</span> (value.constructor==Array) {
		<span class="reserved">for</span> (var i=0; i &lt; value.length; i++) {
			<span class="reserved">if</span> (!N2i.inArray(arr,value[i])) {
				arr.push(value);
			}
		};
	} <span class="reserved">else</span> {
		<span class="reserved">if</span> (!N2i.inArray(arr,value)) {
			arr.push(value);
		}
	}
}

<span class="comment">/////////////////////////////////////////////// Browsers //////////////////////////////////////</span>

N2i.isIE = <span class="reserved">function</span>() {
	var ua = navigator.userAgent;
	var opera = /opera [56789]|opera\/[56789]/i.test(ua);
	var ie = !opera &amp;&amp; /MSIE/.test(ua);
	<span class="reserved">return</span> ie;
}

<span class="comment">////////////////////////////////////////////// Cookie ///////////////////////////////////////////</span>

N2i.Cookie = {
	set : <span class="reserved">function</span>(name,value,days) {
		<span class="reserved">if</span> (days) {
			var date = new Date();
			date.setTime(date.getTime()+(days*24*60*60*1000));
			var expires = <span class="literal">"; expires="</span>+date.toGMTString();
		}
		<span class="reserved">else</span> var expires = <span class="literal">""</span>;
		document.cookie = name+<span class="literal">"="</span>+value+expires+<span class="literal">"; path=/"</span>;
	},
	get : <span class="reserved">function</span>(name) {
		var nameEQ = name + <span class="literal">"="</span>;
		var ca = document.cookie.split(<span class="literal">';'</span>);
		<span class="reserved">for</span>(var i=0;i &lt; ca.length;i++) {
			var c = ca[i];
			<span class="reserved">while</span> (c.charAt(0)==<span class="literal">' '</span>) c = c.substring(1,c.length);
			<span class="reserved">if</span> (c.indexOf(nameEQ) == 0) <span class="reserved">return</span> c.substring(nameEQ.length,c.length);
		}
		<span class="reserved">return</span> null;
	},
	clear : <span class="reserved">function</span>(name) {
		<span class="reserved">this</span>.set(name,<span class="literal">""</span>,-1);
	}
}<span class="comment">/*  Prototype JavaScript framework, version 1.6.0.2
 *  (c) 2005-2008 Sam Stephenson
 *
 *  Prototype is freely distributable under the terms of an MIT-style license.
 *  For details, see the Prototype web site: http://www.prototypejs.org/
 *
 *--------------------------------------------------------------------------*/</span>

var Prototype = {
  Version: <span class="literal">'1.6.0.2'</span>,

  Browser: {
    IE:     !!(window.attachEvent &amp;&amp; !window.opera),
    Opera:  !!window.opera,
    WebKit: navigator.userAgent.indexOf(<span class="literal">'AppleWebKit/'</span>) &gt; -1,
    Gecko:  navigator.userAgent.indexOf(<span class="literal">'Gecko'</span>) &gt; -1 &amp;&amp; navigator.userAgent.indexOf(<span class="literal">'KHTML'</span>) == -1,
    MobileSafari: !!navigator.userAgent.match(/Apple.*Mobile.*Safari/)
  },

  BrowserFeatures: {
    XPath: !!document.evaluate,
    ElementExtensions: !!window.HTMLElement,
    SpecificElementExtensions:
      document.createElement(<span class="literal">'div'</span>).__proto__ &amp;&amp;
      document.createElement(<span class="literal">'div'</span>).__proto__ !==
        document.createElement(<span class="literal">'form'</span>).__proto__
  },

  ScriptFragment: <span class="literal">'&lt;script[^&gt;]*&gt;([\\S\\s]*?)&lt;\/script&gt;'</span>,
  JSONFilter: /^\/\*-secure-([\s\S]*)\*\/\s*$/,

  emptyFunction: <span class="reserved">function</span>() { },
  K: <span class="reserved">function</span>(x) { <span class="reserved">return</span> x }
};

<span class="reserved">if</span> (Prototype.Browser.MobileSafari)
  Prototype.BrowserFeatures.SpecificElementExtensions = false;


<span class="comment">/* Based on Alex Arnell's inheritance implementation. */</span>
var Class = {
  create: <span class="reserved">function</span>() {
    var parent = null, properties = $A(arguments);
    <span class="reserved">if</span> (Object.isFunction(properties[0]))
      parent = properties.shift();

    <span class="reserved">function</span> klass() {
      <span class="reserved">this</span>.initialize.apply(<span class="reserved">this</span>, arguments);
    }

    Object.extend(klass, Class.Methods);
    klass.superclass = parent;
    klass.subclasses = [];

    <span class="reserved">if</span> (parent) {
      var subclass = <span class="reserved">function</span>() { };
      subclass.<span class="reserved">prototype</span> = parent.<span class="reserved">prototype</span>;
      klass.<span class="reserved">prototype</span> = new subclass;
      parent.subclasses.push(klass);
    }

    <span class="reserved">for</span> (var i = 0; i &lt; properties.length; i++)
      klass.addMethods(properties[i]);

    <span class="reserved">if</span> (!klass.<span class="reserved">prototype</span>.initialize)
      klass.<span class="reserved">prototype</span>.initialize = Prototype.emptyFunction;

    klass.<span class="reserved">prototype</span>.constructor = klass;

    <span class="reserved">return</span> klass;
  }
};

Class.Methods = {
  addMethods: <span class="reserved">function</span>(source) {
    var ancestor   = <span class="reserved">this</span>.superclass &amp;&amp; <span class="reserved">this</span>.superclass.<span class="reserved">prototype</span>;
    var properties = Object.keys(source);

    <span class="reserved">if</span> (!Object.keys({ toString: true }).length)
      properties.push(<span class="literal">"toString"</span>, <span class="literal">"valueOf"</span>);

    <span class="reserved">for</span> (var i = 0, length = properties.length; i &lt; length; i++) {
      var property = properties[i], value = source[property];
      <span class="reserved">if</span> (ancestor &amp;&amp; Object.isFunction(value) &amp;&amp;
          value.argumentNames().first() == <span class="literal">"$super"</span>) {
        var method = value, value = Object.extend((<span class="reserved">function</span>(m) {
          <span class="reserved">return</span> <span class="reserved">function</span>() { <span class="reserved">return</span> ancestor[m].apply(<span class="reserved">this</span>, arguments) };
        })(property).wrap(method), {
          valueOf:  <span class="reserved">function</span>() { <span class="reserved">return</span> method },
          toString: <span class="reserved">function</span>() { <span class="reserved">return</span> method.toString() }
        });
      }
      <span class="reserved">this</span>.<span class="reserved">prototype</span>[property] = value;
    }

    <span class="reserved">return</span> <span class="reserved">this</span>;
  }
};

var Abstract = { };

Object.extend = <span class="reserved">function</span>(destination, source) {
  <span class="reserved">for</span> (var property in source)
    destination[property] = source[property];
  <span class="reserved">return</span> destination;
};

Object.extend(Object, {
  inspect: <span class="reserved">function</span>(object) {
    try {
      <span class="reserved">if</span> (Object.isUndefined(object)) <span class="reserved">return</span> <span class="literal">'undefined'</span>;
      <span class="reserved">if</span> (object === null) <span class="reserved">return</span> <span class="literal">'null'</span>;
      <span class="reserved">return</span> object.inspect ? object.inspect() : String(object);
    } catch (e) {
      <span class="reserved">if</span> (e instanceof RangeError) <span class="reserved">return</span> <span class="literal">'...'</span>;
      throw e;
    }
  },

  toJSON: <span class="reserved">function</span>(object) {
    var type = typeof object;
    switch (type) {
      case <span class="literal">'undefined'</span>:
      case <span class="literal">'function'</span>:
      case <span class="literal">'unknown'</span>: <span class="reserved">return</span>;
      case <span class="literal">'boolean'</span>: <span class="reserved">return</span> object.toString();
    }

    <span class="reserved">if</span> (object === null) <span class="reserved">return</span> <span class="literal">'null'</span>;
    <span class="reserved">if</span> (object.toJSON) <span class="reserved">return</span> object.toJSON();
    <span class="reserved">if</span> (Object.isElement(object)) <span class="reserved">return</span>;

    var results = [];
    <span class="reserved">for</span> (var property in object) {
      var value = Object.toJSON(object[property]);
      <span class="reserved">if</span> (!Object.isUndefined(value))
        results.push(property.toJSON() + <span class="literal">': '</span> + value);
    }

    <span class="reserved">return</span> <span class="literal">'{'</span> + results.join(<span class="literal">', '</span>) + <span class="literal">'}'</span>;
  },

  toQueryString: <span class="reserved">function</span>(object) {
    <span class="reserved">return</span> $H(object).toQueryString();
  },

  toHTML: <span class="reserved">function</span>(object) {
    <span class="reserved">return</span> object &amp;&amp; object.toHTML ? object.toHTML() : String.interpret(object);
  },

  keys: <span class="reserved">function</span>(object) {
    var keys = [];
    <span class="reserved">for</span> (var property in object)
      keys.push(property);
    <span class="reserved">return</span> keys;
  },

  values: <span class="reserved">function</span>(object) {
    var values = [];
    <span class="reserved">for</span> (var property in object)
      values.push(object[property]);
    <span class="reserved">return</span> values;
  },

  clone: <span class="reserved">function</span>(object) {
    <span class="reserved">return</span> Object.extend({ }, object);
  },

  isElement: <span class="reserved">function</span>(object) {
    <span class="reserved">return</span> object &amp;&amp; object.nodeType == 1;
  },

  isArray: <span class="reserved">function</span>(object) {
    <span class="reserved">return</span> object != null &amp;&amp; typeof object == <span class="literal">"object"</span> &amp;&amp;
      <span class="literal">'splice'</span> in object &amp;&amp; <span class="literal">'join'</span> in object;
  },

  isHash: <span class="reserved">function</span>(object) {
    <span class="reserved">return</span> object instanceof Hash;
  },

  isFunction: <span class="reserved">function</span>(object) {
    <span class="reserved">return</span> typeof object == <span class="literal">"function"</span>;
  },

  isString: <span class="reserved">function</span>(object) {
    <span class="reserved">return</span> typeof object == <span class="literal">"string"</span>;
  },

  isNumber: <span class="reserved">function</span>(object) {
    <span class="reserved">return</span> typeof object == <span class="literal">"number"</span>;
  },

  isUndefined: <span class="reserved">function</span>(object) {
    <span class="reserved">return</span> typeof object == <span class="literal">"undefined"</span>;
  }
});

Object.extend(Function.<span class="reserved">prototype</span>, {
  argumentNames: <span class="reserved">function</span>() {
    var names = <span class="reserved">this</span>.toString().match(/^[\s\(]*<span class="reserved">function</span>[^(]*\((.*?)\)/)[1].split(<span class="literal">","</span>).invoke(<span class="literal">"strip"</span>);
    <span class="reserved">return</span> names.length == 1 &amp;&amp; !names[0] ? [] : names;
  },

  bind: <span class="reserved">function</span>() {
    <span class="reserved">if</span> (arguments.length &lt; 2 &amp;&amp; Object.isUndefined(arguments[0])) <span class="reserved">return</span> <span class="reserved">this</span>;
    var __method = <span class="reserved">this</span>, args = $A(arguments), object = args.shift();
    <span class="reserved">return</span> <span class="reserved">function</span>() {
      <span class="reserved">return</span> __method.apply(object, args.concat($A(arguments)));
    }
  },

  bindAsEventListener: <span class="reserved">function</span>() {
    var __method = <span class="reserved">this</span>, args = $A(arguments), object = args.shift();
    <span class="reserved">return</span> <span class="reserved">function</span>(event) {
      <span class="reserved">return</span> __method.apply(object, [event || window.event].concat(args));
    }
  },

  curry: <span class="reserved">function</span>() {
    <span class="reserved">if</span> (!arguments.length) <span class="reserved">return</span> <span class="reserved">this</span>;
    var __method = <span class="reserved">this</span>, args = $A(arguments);
    <span class="reserved">return</span> <span class="reserved">function</span>() {
      <span class="reserved">return</span> __method.apply(<span class="reserved">this</span>, args.concat($A(arguments)));
    }
  },

  delay: <span class="reserved">function</span>() {
    var __method = <span class="reserved">this</span>, args = $A(arguments), timeout = args.shift() * 1000;
    <span class="reserved">return</span> window.setTimeout(<span class="reserved">function</span>() {
      <span class="reserved">return</span> __method.apply(__method, args);
    }, timeout);
  },

  wrap: <span class="reserved">function</span>(wrapper) {
    var __method = <span class="reserved">this</span>;
    <span class="reserved">return</span> <span class="reserved">function</span>() {
      <span class="reserved">return</span> wrapper.apply(<span class="reserved">this</span>, [__method.bind(<span class="reserved">this</span>)].concat($A(arguments)));
    }
  },

  methodize: <span class="reserved">function</span>() {
    <span class="reserved">if</span> (<span class="reserved">this</span>._methodized) <span class="reserved">return</span> <span class="reserved">this</span>._methodized;
    var __method = <span class="reserved">this</span>;
    <span class="reserved">return</span> <span class="reserved">this</span>._methodized = <span class="reserved">function</span>() {
      <span class="reserved">return</span> __method.apply(null, [<span class="reserved">this</span>].concat($A(arguments)));
    };
  }
});

Function.<span class="reserved">prototype</span>.defer = Function.<span class="reserved">prototype</span>.delay.curry(0.01);

Date.<span class="reserved">prototype</span>.toJSON = <span class="reserved">function</span>() {
  <span class="reserved">return</span> <span class="literal">'"'</span> + <span class="reserved">this</span>.getUTCFullYear() + <span class="literal">'-'</span> +
    (<span class="reserved">this</span>.getUTCMonth() + 1).toPaddedString(2) + <span class="literal">'-'</span> +
    <span class="reserved">this</span>.getUTCDate().toPaddedString(2) + <span class="literal">'T'</span> +
    <span class="reserved">this</span>.getUTCHours().toPaddedString(2) + <span class="literal">':'</span> +
    <span class="reserved">this</span>.getUTCMinutes().toPaddedString(2) + <span class="literal">':'</span> +
    <span class="reserved">this</span>.getUTCSeconds().toPaddedString(2) + <span class="literal">'Z"'</span>;
};

var Try = {
  these: <span class="reserved">function</span>() {
    var returnValue;

    <span class="reserved">for</span> (var i = 0, length = arguments.length; i &lt; length; i++) {
      var lambda = arguments[i];
      try {
        returnValue = lambda();
        break;
      } catch (e) { }
    }

    <span class="reserved">return</span> returnValue;
  }
};

RegExp.<span class="reserved">prototype</span>.match = RegExp.<span class="reserved">prototype</span>.test;

RegExp.escape = <span class="reserved">function</span>(str) {
  <span class="reserved">return</span> String(str).replace(/([.*+?^=!:${}()|[\]\/\\])/g, <span class="literal">'\\$1'</span>);
};

<span class="comment">/*--------------------------------------------------------------------------*/</span>

var PeriodicalExecuter = Class.create({
  initialize: <span class="reserved">function</span>(callback, frequency) {
    <span class="reserved">this</span>.callback = callback;
    <span class="reserved">this</span>.frequency = frequency;
    <span class="reserved">this</span>.currentlyExecuting = false;

    <span class="reserved">this</span>.registerCallback();
  },

  registerCallback: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.timer = setInterval(<span class="reserved">this</span>.onTimerEvent.bind(<span class="reserved">this</span>), <span class="reserved">this</span>.frequency * 1000);
  },

  execute: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.callback(<span class="reserved">this</span>);
  },

  stop: <span class="reserved">function</span>() {
    <span class="reserved">if</span> (!<span class="reserved">this</span>.timer) <span class="reserved">return</span>;
    clearInterval(<span class="reserved">this</span>.timer);
    <span class="reserved">this</span>.timer = null;
  },

  onTimerEvent: <span class="reserved">function</span>() {
    <span class="reserved">if</span> (!<span class="reserved">this</span>.currentlyExecuting) {
      try {
        <span class="reserved">this</span>.currentlyExecuting = true;
        <span class="reserved">this</span>.execute();
      } finally {
        <span class="reserved">this</span>.currentlyExecuting = false;
      }
    }
  }
});
Object.extend(String, {
  interpret: <span class="reserved">function</span>(value) {
    <span class="reserved">return</span> value == null ? <span class="literal">''</span> : String(value);
  },
  specialChar: {
    <span class="literal">'\b'</span>: <span class="literal">'\\b'</span>,
    <span class="literal">'\t'</span>: <span class="literal">'\\t'</span>,
    <span class="literal">'\n'</span>: <span class="literal">'\\n'</span>,
    <span class="literal">'\f'</span>: <span class="literal">'\\f'</span>,
    <span class="literal">'\r'</span>: <span class="literal">'\\r'</span>,
    <span class="literal">'\\'</span>: <span class="literal">'\\\\'</span>
  }
});

Object.extend(String.<span class="reserved">prototype</span>, {
  gsub: <span class="reserved">function</span>(pattern, replacement) {
    var result = <span class="literal">''</span>, source = <span class="reserved">this</span>, match;
    replacement = arguments.callee.prepareReplacement(replacement);

    <span class="reserved">while</span> (source.length &gt; 0) {
      <span class="reserved">if</span> (match = source.match(pattern)) {
        result += source.slice(0, match.index);
        result += String.interpret(replacement(match));
        source  = source.slice(match.index + match[0].length);
      } <span class="reserved">else</span> {
        result += source, source = <span class="literal">''</span>;
      }
    }
    <span class="reserved">return</span> result;
  },

  sub: <span class="reserved">function</span>(pattern, replacement, count) {
    replacement = <span class="reserved">this</span>.gsub.prepareReplacement(replacement);
    count = Object.isUndefined(count) ? 1 : count;

    <span class="reserved">return</span> <span class="reserved">this</span>.gsub(pattern, <span class="reserved">function</span>(match) {
      <span class="reserved">if</span> (--count &lt; 0) <span class="reserved">return</span> match[0];
      <span class="reserved">return</span> replacement(match);
    });
  },

  scan: <span class="reserved">function</span>(pattern, iterator) {
    <span class="reserved">this</span>.gsub(pattern, iterator);
    <span class="reserved">return</span> String(<span class="reserved">this</span>);
  },

  truncate: <span class="reserved">function</span>(length, truncation) {
    length = length || 30;
    truncation = Object.isUndefined(truncation) ? <span class="literal">'...'</span> : truncation;
    <span class="reserved">return</span> <span class="reserved">this</span>.length &gt; length ?
      <span class="reserved">this</span>.slice(0, length - truncation.length) + truncation : String(<span class="reserved">this</span>);
  },

  strip: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.replace(/^\s+/, <span class="literal">''</span>).replace(/\s+$/, <span class="literal">''</span>);
  },

  stripTags: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.replace(/&lt;\/?[^&gt;]+&gt;/gi, <span class="literal">''</span>);
  },

  stripScripts: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.replace(new RegExp(Prototype.ScriptFragment, <span class="literal">'img'</span>), <span class="literal">''</span>);
  },

  extractScripts: <span class="reserved">function</span>() {
    var matchAll = new RegExp(Prototype.ScriptFragment, <span class="literal">'img'</span>);
    var matchOne = new RegExp(Prototype.ScriptFragment, <span class="literal">'im'</span>);
    <span class="reserved">return</span> (<span class="reserved">this</span>.match(matchAll) || []).map(<span class="reserved">function</span>(scriptTag) {
      <span class="reserved">return</span> (scriptTag.match(matchOne) || [<span class="literal">''</span>, <span class="literal">''</span>])[1];
    });
  },

  evalScripts: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.extractScripts().map(<span class="reserved">function</span>(script) { <span class="reserved">return</span> eval(script) });
  },

  escapeHTML: <span class="reserved">function</span>() {
    var self = arguments.callee;
    self.text.data = <span class="reserved">this</span>;
    <span class="reserved">return</span> self.div.innerHTML;
  },

  unescapeHTML: <span class="reserved">function</span>() {
    var div = new Element(<span class="literal">'div'</span>);
    div.innerHTML = <span class="reserved">this</span>.stripTags();
    <span class="reserved">return</span> div.childNodes[0] ? (div.childNodes.length &gt; 1 ?
      $A(div.childNodes).inject(<span class="literal">''</span>, <span class="reserved">function</span>(memo, node) { <span class="reserved">return</span> memo+node.nodeValue }) :
      div.childNodes[0].nodeValue) : <span class="literal">''</span>;
  },

  toQueryParams: <span class="reserved">function</span>(separator) {
    var match = <span class="reserved">this</span>.strip().match(/([^?#]*)(#.*)?$/);
    <span class="reserved">if</span> (!match) <span class="reserved">return</span> { };

    <span class="reserved">return</span> match[1].split(separator || <span class="literal">'&amp;'</span>).inject({ }, <span class="reserved">function</span>(hash, pair) {
      <span class="reserved">if</span> ((pair = pair.split(<span class="literal">'='</span>))[0]) {
        var key = decodeURIComponent(pair.shift());
        var value = pair.length &gt; 1 ? pair.join(<span class="literal">'='</span>) : pair[0];
        <span class="reserved">if</span> (value != undefined) value = decodeURIComponent(value);

        <span class="reserved">if</span> (key in hash) {
          <span class="reserved">if</span> (!Object.isArray(hash[key])) hash[key] = [hash[key]];
          hash[key].push(value);
        }
        <span class="reserved">else</span> hash[key] = value;
      }
      <span class="reserved">return</span> hash;
    });
  },

  toArray: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.split(<span class="literal">''</span>);
  },

  succ: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.slice(0, <span class="reserved">this</span>.length - 1) +
      String.fromCharCode(<span class="reserved">this</span>.charCodeAt(<span class="reserved">this</span>.length - 1) + 1);
  },

  times: <span class="reserved">function</span>(count) {
    <span class="reserved">return</span> count &lt; 1 ? <span class="literal">''</span> : new Array(count + 1).join(<span class="reserved">this</span>);
  },

  camelize: <span class="reserved">function</span>() {
    var parts = <span class="reserved">this</span>.split(<span class="literal">'-'</span>), len = parts.length;
    <span class="reserved">if</span> (len == 1) <span class="reserved">return</span> parts[0];

    var camelized = <span class="reserved">this</span>.charAt(0) == <span class="literal">'-'</span>
      ? parts[0].charAt(0).toUpperCase() + parts[0].substring(1)
      : parts[0];

    <span class="reserved">for</span> (var i = 1; i &lt; len; i++)
      camelized += parts[i].charAt(0).toUpperCase() + parts[i].substring(1);

    <span class="reserved">return</span> camelized;
  },

  capitalize: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.charAt(0).toUpperCase() + <span class="reserved">this</span>.substring(1).toLowerCase();
  },

  underscore: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.gsub(/::/, <span class="literal">'/'</span>).gsub(/([A-Z]+)([A-Z][a-z])/,<span class="literal">'#{1}_#{2}'</span>).gsub(/([a-z\d])([A-Z])/,<span class="literal">'#{1}_#{2}'</span>).gsub(/-/,<span class="literal">'_'</span>).toLowerCase();
  },

  dasherize: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.gsub(/_/,<span class="literal">'-'</span>);
  },

  inspect: <span class="reserved">function</span>(useDoubleQuotes) {
    var escapedString = <span class="reserved">this</span>.gsub(/[\x00-\x1f\\]/, <span class="reserved">function</span>(match) {
      var character = String.specialChar[match[0]];
      <span class="reserved">return</span> character ? character : <span class="literal">'\\u00'</span> + match[0].charCodeAt().toPaddedString(2, 16);
    });
    <span class="reserved">if</span> (useDoubleQuotes) <span class="reserved">return</span> <span class="literal">'"'</span> + escapedString.replace(/<span class="literal">"/g, '\\"</span><span class="literal">') + '</span><span class="literal">"';
    return "</span><span class="literal">'" + escapedString.replace(/'</span>/g, <span class="literal">'\\\'</span><span class="literal">') + "'</span><span class="literal">";
  },

  toJSON: function() {
    return this.inspect(true);
  },

  unfilterJSON: function(filter) {
    return this.sub(filter || Prototype.JSONFilter, '#{1}');
  },

  isJSON: function() {
    var str = this;
    if (str.blank()) return false;
    str = this.replace(/\\./g, '@').replace(/"</span>[^<span class="literal">"\\\n\r]*"</span>/g, <span class="literal">''</span>);
    <span class="reserved">return</span> (/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/).test(str);
  },

  evalJSON: <span class="reserved">function</span>(sanitize) {
    var json = <span class="reserved">this</span>.unfilterJSON();
    try {
      <span class="reserved">if</span> (!sanitize || json.isJSON()) <span class="reserved">return</span> eval(<span class="literal">'('</span> + json + <span class="literal">')'</span>);
    } catch (e) { }
    throw new SyntaxError(<span class="literal">'Badly formed JSON string: '</span> + <span class="reserved">this</span>.inspect());
  },

  include: <span class="reserved">function</span>(pattern) {
    <span class="reserved">return</span> <span class="reserved">this</span>.indexOf(pattern) &gt; -1;
  },

  startsWith: <span class="reserved">function</span>(pattern) {
    <span class="reserved">return</span> <span class="reserved">this</span>.indexOf(pattern) === 0;
  },

  endsWith: <span class="reserved">function</span>(pattern) {
    var d = <span class="reserved">this</span>.length - pattern.length;
    <span class="reserved">return</span> d &gt;= 0 &amp;&amp; <span class="reserved">this</span>.lastIndexOf(pattern) === d;
  },

  empty: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span> == <span class="literal">''</span>;
  },

  blank: <span class="reserved">function</span>() {
    <span class="reserved">return</span> /^\s*$/.test(<span class="reserved">this</span>);
  },

  interpolate: <span class="reserved">function</span>(object, pattern) {
    <span class="reserved">return</span> new Template(<span class="reserved">this</span>, pattern).evaluate(object);
  }
});

<span class="reserved">if</span> (Prototype.Browser.WebKit || Prototype.Browser.IE) Object.extend(String.<span class="reserved">prototype</span>, {
  escapeHTML: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.replace(/&amp;/g,<span class="literal">'&amp;amp;'</span>).replace(/&lt;/g,<span class="literal">'&amp;lt;'</span>).replace(/&gt;/g,<span class="literal">'&amp;gt;'</span>);
  },
  unescapeHTML: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.replace(/&amp;amp;/g,<span class="literal">'&amp;'</span>).replace(/&amp;lt;/g,<span class="literal">'&lt;'</span>).replace(/&amp;gt;/g,<span class="literal">'&gt;'</span>);
  }
});

String.<span class="reserved">prototype</span>.gsub.prepareReplacement = <span class="reserved">function</span>(replacement) {
  <span class="reserved">if</span> (Object.isFunction(replacement)) <span class="reserved">return</span> replacement;
  var template = new Template(replacement);
  <span class="reserved">return</span> <span class="reserved">function</span>(match) { <span class="reserved">return</span> template.evaluate(match) };
};

String.<span class="reserved">prototype</span>.parseQuery = String.<span class="reserved">prototype</span>.toQueryParams;

Object.extend(String.<span class="reserved">prototype</span>.escapeHTML, {
  div:  document.createElement(<span class="literal">'div'</span>),
  text: document.createTextNode(<span class="literal">''</span>)
});

with (String.<span class="reserved">prototype</span>.escapeHTML) div.appendChild(text);

var Template = Class.create({
  initialize: <span class="reserved">function</span>(template, pattern) {
    <span class="reserved">this</span>.template = template.toString();
    <span class="reserved">this</span>.pattern = pattern || Template.Pattern;
  },

  evaluate: <span class="reserved">function</span>(object) {
    <span class="reserved">if</span> (Object.isFunction(object.toTemplateReplacements))
      object = object.toTemplateReplacements();

    <span class="reserved">return</span> <span class="reserved">this</span>.template.gsub(<span class="reserved">this</span>.pattern, <span class="reserved">function</span>(match) {
      <span class="reserved">if</span> (object == null) <span class="reserved">return</span> <span class="literal">''</span>;

      var before = match[1] || <span class="literal">''</span>;
      <span class="reserved">if</span> (before == <span class="literal">'\\'</span>) <span class="reserved">return</span> match[2];

      var ctx = object, expr = match[3];
      var pattern = /^([^.[]+|\[((?:.*?[^\\])?)\])(\.|\[|$)/;
      match = pattern.exec(expr);
      <span class="reserved">if</span> (match == null) <span class="reserved">return</span> before;

      <span class="reserved">while</span> (match != null) {
        var comp = match[1].startsWith(<span class="literal">'['</span>) ? match[2].gsub(<span class="literal">'\\\\]'</span>, <span class="literal">']'</span>) : match[1];
        ctx = ctx[comp];
        <span class="reserved">if</span> (null == ctx || <span class="literal">''</span> == match[3]) break;
        expr = expr.substring(<span class="literal">'['</span> == match[3] ? match[1].length : match[0].length);
        match = pattern.exec(expr);
      }

      <span class="reserved">return</span> before + String.interpret(ctx);
    });
  }
});
Template.Pattern = /(^|.|\r|\n)(#\{(.*?)\})/;

var $break = { };

var Enumerable = {
  each: <span class="reserved">function</span>(iterator, context) {
    var index = 0;
    iterator = iterator.bind(context);
    try {
      <span class="reserved">this</span>._each(<span class="reserved">function</span>(value) {
        iterator(value, index++);
      });
    } catch (e) {
      <span class="reserved">if</span> (e != $break) throw e;
    }
    <span class="reserved">return</span> <span class="reserved">this</span>;
  },

  eachSlice: <span class="reserved">function</span>(number, iterator, context) {
    iterator = iterator ? iterator.bind(context) : Prototype.K;
    var index = -number, slices = [], array = <span class="reserved">this</span>.toArray();
    <span class="reserved">while</span> ((index += number) &lt; array.length)
      slices.push(array.slice(index, index+number));
    <span class="reserved">return</span> slices.collect(iterator, context);
  },

  all: <span class="reserved">function</span>(iterator, context) {
    iterator = iterator ? iterator.bind(context) : Prototype.K;
    var result = true;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      result = result &amp;&amp; !!iterator(value, index);
      <span class="reserved">if</span> (!result) throw $break;
    });
    <span class="reserved">return</span> result;
  },

  any: <span class="reserved">function</span>(iterator, context) {
    iterator = iterator ? iterator.bind(context) : Prototype.K;
    var result = false;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      <span class="reserved">if</span> (result = !!iterator(value, index))
        throw $break;
    });
    <span class="reserved">return</span> result;
  },

  collect: <span class="reserved">function</span>(iterator, context) {
    iterator = iterator ? iterator.bind(context) : Prototype.K;
    var results = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      results.push(iterator(value, index));
    });
    <span class="reserved">return</span> results;
  },

  detect: <span class="reserved">function</span>(iterator, context) {
    iterator = iterator.bind(context);
    var result;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      <span class="reserved">if</span> (iterator(value, index)) {
        result = value;
        throw $break;
      }
    });
    <span class="reserved">return</span> result;
  },

  findAll: <span class="reserved">function</span>(iterator, context) {
    iterator = iterator.bind(context);
    var results = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      <span class="reserved">if</span> (iterator(value, index))
        results.push(value);
    });
    <span class="reserved">return</span> results;
  },

  grep: <span class="reserved">function</span>(filter, iterator, context) {
    iterator = iterator ? iterator.bind(context) : Prototype.K;
    var results = [];

    <span class="reserved">if</span> (Object.isString(filter))
      filter = new RegExp(filter);

    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      <span class="reserved">if</span> (filter.match(value))
        results.push(iterator(value, index));
    });
    <span class="reserved">return</span> results;
  },

  include: <span class="reserved">function</span>(object) {
    <span class="reserved">if</span> (Object.isFunction(<span class="reserved">this</span>.indexOf))
      <span class="reserved">if</span> (<span class="reserved">this</span>.indexOf(object) != -1) <span class="reserved">return</span> true;

    var found = false;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value) {
      <span class="reserved">if</span> (value == object) {
        found = true;
        throw $break;
      }
    });
    <span class="reserved">return</span> found;
  },

  inGroupsOf: <span class="reserved">function</span>(number, fillWith) {
    fillWith = Object.isUndefined(fillWith) ? null : fillWith;
    <span class="reserved">return</span> <span class="reserved">this</span>.eachSlice(number, <span class="reserved">function</span>(slice) {
      <span class="reserved">while</span>(slice.length &lt; number) slice.push(fillWith);
      <span class="reserved">return</span> slice;
    });
  },

  inject: <span class="reserved">function</span>(memo, iterator, context) {
    iterator = iterator.bind(context);
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      memo = iterator(memo, value, index);
    });
    <span class="reserved">return</span> memo;
  },

  invoke: <span class="reserved">function</span>(method) {
    var args = $A(arguments).slice(1);
    <span class="reserved">return</span> <span class="reserved">this</span>.map(<span class="reserved">function</span>(value) {
      <span class="reserved">return</span> value[method].apply(value, args);
    });
  },

  max: <span class="reserved">function</span>(iterator, context) {
    iterator = iterator ? iterator.bind(context) : Prototype.K;
    var result;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      value = iterator(value, index);
      <span class="reserved">if</span> (result == null || value &gt;= result)
        result = value;
    });
    <span class="reserved">return</span> result;
  },

  min: <span class="reserved">function</span>(iterator, context) {
    iterator = iterator ? iterator.bind(context) : Prototype.K;
    var result;
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      value = iterator(value, index);
      <span class="reserved">if</span> (result == null || value &lt; result)
        result = value;
    });
    <span class="reserved">return</span> result;
  },

  partition: <span class="reserved">function</span>(iterator, context) {
    iterator = iterator ? iterator.bind(context) : Prototype.K;
    var trues = [], falses = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      (iterator(value, index) ?
        trues : falses).push(value);
    });
    <span class="reserved">return</span> [trues, falses];
  },

  pluck: <span class="reserved">function</span>(property) {
    var results = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value) {
      results.push(value[property]);
    });
    <span class="reserved">return</span> results;
  },

  reject: <span class="reserved">function</span>(iterator, context) {
    iterator = iterator.bind(context);
    var results = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(value, index) {
      <span class="reserved">if</span> (!iterator(value, index))
        results.push(value);
    });
    <span class="reserved">return</span> results;
  },

  sortBy: <span class="reserved">function</span>(iterator, context) {
    iterator = iterator.bind(context);
    <span class="reserved">return</span> <span class="reserved">this</span>.map(<span class="reserved">function</span>(value, index) {
      <span class="reserved">return</span> {value: value, criteria: iterator(value, index)};
    }).sort(<span class="reserved">function</span>(left, right) {
      var a = left.criteria, b = right.criteria;
      <span class="reserved">return</span> a &lt; b ? -1 : a &gt; b ? 1 : 0;
    }).pluck(<span class="literal">'value'</span>);
  },

  toArray: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.map();
  },

  zip: <span class="reserved">function</span>() {
    var iterator = Prototype.K, args = $A(arguments);
    <span class="reserved">if</span> (Object.isFunction(args.last()))
      iterator = args.pop();

    var collections = [<span class="reserved">this</span>].concat(args).map($A);
    <span class="reserved">return</span> <span class="reserved">this</span>.map(<span class="reserved">function</span>(value, index) {
      <span class="reserved">return</span> iterator(collections.pluck(index));
    });
  },

  size: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.toArray().length;
  },

  inspect: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="literal">'#&lt;Enumerable:'</span> + <span class="reserved">this</span>.toArray().inspect() + <span class="literal">'&gt;'</span>;
  }
};

Object.extend(Enumerable, {
  map:     Enumerable.collect,
  find:    Enumerable.detect,
  select:  Enumerable.findAll,
  filter:  Enumerable.findAll,
  member:  Enumerable.include,
  entries: Enumerable.toArray,
  every:   Enumerable.all,
  some:    Enumerable.any
});
<span class="reserved">function</span> $A(iterable) {
  <span class="reserved">if</span> (!iterable) <span class="reserved">return</span> [];
  <span class="reserved">if</span> (iterable.toArray) <span class="reserved">return</span> iterable.toArray();
  var length = iterable.length || 0, results = new Array(length);
  <span class="reserved">while</span> (length--) results[length] = iterable[length];
  <span class="reserved">return</span> results;
}

<span class="reserved">if</span> (Prototype.Browser.WebKit) {
  $A = <span class="reserved">function</span>(iterable) {
    <span class="reserved">if</span> (!iterable) <span class="reserved">return</span> [];
    <span class="reserved">if</span> (!(Object.isFunction(iterable) &amp;&amp; iterable == <span class="literal">'[object NodeList]'</span>) &amp;&amp;
        iterable.toArray) <span class="reserved">return</span> iterable.toArray();
    var length = iterable.length || 0, results = new Array(length);
    <span class="reserved">while</span> (length--) results[length] = iterable[length];
    <span class="reserved">return</span> results;
  };
}

Array.from = $A;

Object.extend(Array.<span class="reserved">prototype</span>, Enumerable);

<span class="reserved">if</span> (!Array.<span class="reserved">prototype</span>._reverse) Array.<span class="reserved">prototype</span>._reverse = Array.<span class="reserved">prototype</span>.reverse;

Object.extend(Array.<span class="reserved">prototype</span>, {
  _each: <span class="reserved">function</span>(iterator) {
    <span class="reserved">for</span> (var i = 0, length = <span class="reserved">this</span>.length; i &lt; length; i++)
      iterator(<span class="reserved">this</span>[i]);
  },

  clear: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.length = 0;
    <span class="reserved">return</span> <span class="reserved">this</span>;
  },

  first: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>[0];
  },

  last: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>[<span class="reserved">this</span>.length - 1];
  },

  compact: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.select(<span class="reserved">function</span>(value) {
      <span class="reserved">return</span> value != null;
    });
  },

  flatten: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.inject([], <span class="reserved">function</span>(array, value) {
      <span class="reserved">return</span> array.concat(Object.isArray(value) ?
        value.flatten() : [value]);
    });
  },

  without: <span class="reserved">function</span>() {
    var values = $A(arguments);
    <span class="reserved">return</span> <span class="reserved">this</span>.select(<span class="reserved">function</span>(value) {
      <span class="reserved">return</span> !values.include(value);
    });
  },

  reverse: <span class="reserved">function</span>(inline) {
    <span class="reserved">return</span> (inline !== false ? <span class="reserved">this</span> : <span class="reserved">this</span>.toArray())._reverse();
  },

  reduce: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.length &gt; 1 ? <span class="reserved">this</span> : <span class="reserved">this</span>[0];
  },

  uniq: <span class="reserved">function</span>(sorted) {
    <span class="reserved">return</span> <span class="reserved">this</span>.inject([], <span class="reserved">function</span>(array, value, index) {
      <span class="reserved">if</span> (0 == index || (sorted ? array.last() != value : !array.include(value)))
        array.push(value);
      <span class="reserved">return</span> array;
    });
  },

  intersect: <span class="reserved">function</span>(array) {
    <span class="reserved">return</span> <span class="reserved">this</span>.uniq().findAll(<span class="reserved">function</span>(item) {
      <span class="reserved">return</span> array.detect(<span class="reserved">function</span>(value) { <span class="reserved">return</span> item === value });
    });
  },

  clone: <span class="reserved">function</span>() {
    <span class="reserved">return</span> [].concat(<span class="reserved">this</span>);
  },

  size: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.length;
  },

  inspect: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="literal">'['</span> + <span class="reserved">this</span>.map(Object.inspect).join(<span class="literal">', '</span>) + <span class="literal">']'</span>;
  },

  toJSON: <span class="reserved">function</span>() {
    var results = [];
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(object) {
      var value = Object.toJSON(object);
      <span class="reserved">if</span> (!Object.isUndefined(value)) results.push(value);
    });
    <span class="reserved">return</span> <span class="literal">'['</span> + results.join(<span class="literal">', '</span>) + <span class="literal">']'</span>;
  }
});

<span class="comment">// use native browser JS 1.6 implementation if available</span>
<span class="reserved">if</span> (Object.isFunction(Array.<span class="reserved">prototype</span>.forEach))
  Array.<span class="reserved">prototype</span>._each = Array.<span class="reserved">prototype</span>.forEach;

<span class="reserved">if</span> (!Array.<span class="reserved">prototype</span>.indexOf) Array.<span class="reserved">prototype</span>.indexOf = <span class="reserved">function</span>(item, i) {
  i || (i = 0);
  var length = <span class="reserved">this</span>.length;
  <span class="reserved">if</span> (i &lt; 0) i = length + i;
  <span class="reserved">for</span> (; i &lt; length; i++)
    <span class="reserved">if</span> (<span class="reserved">this</span>[i] === item) <span class="reserved">return</span> i;
  <span class="reserved">return</span> -1;
};

<span class="reserved">if</span> (!Array.<span class="reserved">prototype</span>.lastIndexOf) Array.<span class="reserved">prototype</span>.lastIndexOf = <span class="reserved">function</span>(item, i) {
  i = isNaN(i) ? <span class="reserved">this</span>.length : (i &lt; 0 ? <span class="reserved">this</span>.length + i : i) + 1;
  var n = <span class="reserved">this</span>.slice(0, i).reverse().indexOf(item);
  <span class="reserved">return</span> (n &lt; 0) ? n : i - n - 1;
};

Array.<span class="reserved">prototype</span>.toArray = Array.<span class="reserved">prototype</span>.clone;

<span class="reserved">function</span> $w(string) {
  <span class="reserved">if</span> (!Object.isString(string)) <span class="reserved">return</span> [];
  string = string.strip();
  <span class="reserved">return</span> string ? string.split(/\s+/) : [];
}

<span class="reserved">if</span> (Prototype.Browser.Opera){
  Array.<span class="reserved">prototype</span>.concat = <span class="reserved">function</span>() {
    var array = [];
    <span class="reserved">for</span> (var i = 0, length = <span class="reserved">this</span>.length; i &lt; length; i++) array.push(<span class="reserved">this</span>[i]);
    <span class="reserved">for</span> (var i = 0, length = arguments.length; i &lt; length; i++) {
      <span class="reserved">if</span> (Object.isArray(arguments[i])) {
        <span class="reserved">for</span> (var j = 0, arrayLength = arguments[i].length; j &lt; arrayLength; j++)
          array.push(arguments[i][j]);
      } <span class="reserved">else</span> {
        array.push(arguments[i]);
      }
    }
    <span class="reserved">return</span> array;
  };
}
Object.extend(Number.<span class="reserved">prototype</span>, {
  toColorPart: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.toPaddedString(2, 16);
  },

  succ: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span> + 1;
  },

  times: <span class="reserved">function</span>(iterator) {
    $R(0, <span class="reserved">this</span>, true).each(iterator);
    <span class="reserved">return</span> <span class="reserved">this</span>;
  },

  toPaddedString: <span class="reserved">function</span>(length, radix) {
    var string = <span class="reserved">this</span>.toString(radix || 10);
    <span class="reserved">return</span> <span class="literal">'0'</span>.times(length - string.length) + string;
  },

  toJSON: <span class="reserved">function</span>() {
    <span class="reserved">return</span> isFinite(<span class="reserved">this</span>) ? <span class="reserved">this</span>.toString() : <span class="literal">'null'</span>;
  }
});

$w(<span class="literal">'abs round ceil floor'</span>).each(<span class="reserved">function</span>(method){
  Number.<span class="reserved">prototype</span>[method] = Math[method].methodize();
});
<span class="reserved">function</span> $H(object) {
  <span class="reserved">return</span> new Hash(object);
};

var Hash = Class.create(Enumerable, (<span class="reserved">function</span>() {

  <span class="reserved">function</span> toQueryPair(key, value) {
    <span class="reserved">if</span> (Object.isUndefined(value)) <span class="reserved">return</span> key;
    <span class="reserved">return</span> key + <span class="literal">'='</span> + encodeURIComponent(String.interpret(value));
  }

  <span class="reserved">return</span> {
    initialize: <span class="reserved">function</span>(object) {
      <span class="reserved">this</span>._object = Object.isHash(object) ? object.toObject() : Object.clone(object);
    },

    _each: <span class="reserved">function</span>(iterator) {
      <span class="reserved">for</span> (var key in <span class="reserved">this</span>._object) {
        var value = <span class="reserved">this</span>._object[key], pair = [key, value];
        pair.key = key;
        pair.value = value;
        iterator(pair);
      }
    },

    set: <span class="reserved">function</span>(key, value) {
      <span class="reserved">return</span> <span class="reserved">this</span>._object[key] = value;
    },

    get: <span class="reserved">function</span>(key) {
      <span class="reserved">return</span> <span class="reserved">this</span>._object[key];
    },

    unset: <span class="reserved">function</span>(key) {
      var value = <span class="reserved">this</span>._object[key];
      delete <span class="reserved">this</span>._object[key];
      <span class="reserved">return</span> value;
    },

    toObject: <span class="reserved">function</span>() {
      <span class="reserved">return</span> Object.clone(<span class="reserved">this</span>._object);
    },

    keys: <span class="reserved">function</span>() {
      <span class="reserved">return</span> <span class="reserved">this</span>.pluck(<span class="literal">'key'</span>);
    },

    values: <span class="reserved">function</span>() {
      <span class="reserved">return</span> <span class="reserved">this</span>.pluck(<span class="literal">'value'</span>);
    },

    index: <span class="reserved">function</span>(value) {
      var match = <span class="reserved">this</span>.detect(<span class="reserved">function</span>(pair) {
        <span class="reserved">return</span> pair.value === value;
      });
      <span class="reserved">return</span> match &amp;&amp; match.key;
    },

    merge: <span class="reserved">function</span>(object) {
      <span class="reserved">return</span> <span class="reserved">this</span>.clone().update(object);
    },

    update: <span class="reserved">function</span>(object) {
      <span class="reserved">return</span> new Hash(object).inject(<span class="reserved">this</span>, <span class="reserved">function</span>(result, pair) {
        result.set(pair.key, pair.value);
        <span class="reserved">return</span> result;
      });
    },

    toQueryString: <span class="reserved">function</span>() {
      <span class="reserved">return</span> <span class="reserved">this</span>.map(<span class="reserved">function</span>(pair) {
        var key = encodeURIComponent(pair.key), values = pair.value;

        <span class="reserved">if</span> (values &amp;&amp; typeof values == <span class="literal">'object'</span>) {
          <span class="reserved">if</span> (Object.isArray(values))
            <span class="reserved">return</span> values.map(toQueryPair.curry(key)).join(<span class="literal">'&amp;'</span>);
        }
        <span class="reserved">return</span> toQueryPair(key, values);
      }).join(<span class="literal">'&amp;'</span>);
    },

    inspect: <span class="reserved">function</span>() {
      <span class="reserved">return</span> <span class="literal">'#&lt;Hash:{'</span> + <span class="reserved">this</span>.map(<span class="reserved">function</span>(pair) {
        <span class="reserved">return</span> pair.map(Object.inspect).join(<span class="literal">': '</span>);
      }).join(<span class="literal">', '</span>) + <span class="literal">'}&gt;'</span>;
    },

    toJSON: <span class="reserved">function</span>() {
      <span class="reserved">return</span> Object.toJSON(<span class="reserved">this</span>.toObject());
    },

    clone: <span class="reserved">function</span>() {
      <span class="reserved">return</span> new Hash(<span class="reserved">this</span>);
    }
  }
})());

Hash.<span class="reserved">prototype</span>.toTemplateReplacements = Hash.<span class="reserved">prototype</span>.toObject;
Hash.from = $H;
var ObjectRange = Class.create(Enumerable, {
  initialize: <span class="reserved">function</span>(start, end, exclusive) {
    <span class="reserved">this</span>.start = start;
    <span class="reserved">this</span>.end = end;
    <span class="reserved">this</span>.exclusive = exclusive;
  },

  _each: <span class="reserved">function</span>(iterator) {
    var value = <span class="reserved">this</span>.start;
    <span class="reserved">while</span> (<span class="reserved">this</span>.include(value)) {
      iterator(value);
      value = value.succ();
    }
  },

  include: <span class="reserved">function</span>(value) {
    <span class="reserved">if</span> (value &lt; <span class="reserved">this</span>.start)
      <span class="reserved">return</span> false;
    <span class="reserved">if</span> (<span class="reserved">this</span>.exclusive)
      <span class="reserved">return</span> value &lt; <span class="reserved">this</span>.end;
    <span class="reserved">return</span> value &lt;= <span class="reserved">this</span>.end;
  }
});

var $R = <span class="reserved">function</span>(start, end, exclusive) {
  <span class="reserved">return</span> new ObjectRange(start, end, exclusive);
};

var Ajax = {
  getTransport: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Try.these(
      <span class="reserved">function</span>() {<span class="reserved">return</span> new XMLHttpRequest()},
      <span class="reserved">function</span>() {<span class="reserved">return</span> new ActiveXObject(<span class="literal">'Msxml2.XMLHTTP'</span>)},
      <span class="reserved">function</span>() {<span class="reserved">return</span> new ActiveXObject(<span class="literal">'Microsoft.XMLHTTP'</span>)}
    ) || false;
  },

  activeRequestCount: 0
};

Ajax.Responders = {
  responders: [],

  _each: <span class="reserved">function</span>(iterator) {
    <span class="reserved">this</span>.responders._each(iterator);
  },

  register: <span class="reserved">function</span>(responder) {
    <span class="reserved">if</span> (!<span class="reserved">this</span>.include(responder))
      <span class="reserved">this</span>.responders.push(responder);
  },

  unregister: <span class="reserved">function</span>(responder) {
    <span class="reserved">this</span>.responders = <span class="reserved">this</span>.responders.without(responder);
  },

  dispatch: <span class="reserved">function</span>(callback, request, transport, json) {
    <span class="reserved">this</span>.each(<span class="reserved">function</span>(responder) {
      <span class="reserved">if</span> (Object.isFunction(responder[callback])) {
        try {
          responder[callback].apply(responder, [request, transport, json]);
        } catch (e) { }
      }
    });
  }
};

Object.extend(Ajax.Responders, Enumerable);

Ajax.Responders.register({
  onCreate:   <span class="reserved">function</span>() { Ajax.activeRequestCount++ },
  onComplete: <span class="reserved">function</span>() { Ajax.activeRequestCount-- }
});

Ajax.Base = Class.create({
  initialize: <span class="reserved">function</span>(options) {
    <span class="reserved">this</span>.options = {
      method:       <span class="literal">'post'</span>,
      asynchronous: true,
      contentType:  <span class="literal">'application/x-www-form-urlencoded'</span>,
      encoding:     <span class="literal">'UTF-8'</span>,
      parameters:   <span class="literal">''</span>,
      evalJSON:     true,
      evalJS:       true
    };
    Object.extend(<span class="reserved">this</span>.options, options || { });

    <span class="reserved">this</span>.options.method = <span class="reserved">this</span>.options.method.toLowerCase();

    <span class="reserved">if</span> (Object.isString(<span class="reserved">this</span>.options.parameters))
      <span class="reserved">this</span>.options.parameters = <span class="reserved">this</span>.options.parameters.toQueryParams();
    <span class="reserved">else</span> <span class="reserved">if</span> (Object.isHash(<span class="reserved">this</span>.options.parameters))
      <span class="reserved">this</span>.options.parameters = <span class="reserved">this</span>.options.parameters.toObject();
  }
});

Ajax.Request = Class.create(Ajax.Base, {
  _complete: false,

  initialize: <span class="reserved">function</span>($super, url, options) {
    $super(options);
    <span class="reserved">this</span>.transport = Ajax.getTransport();
    <span class="reserved">this</span>.request(url);
  },

  request: <span class="reserved">function</span>(url) {
    <span class="reserved">this</span>.url = url;
    <span class="reserved">this</span>.method = <span class="reserved">this</span>.options.method;
    var params = Object.clone(<span class="reserved">this</span>.options.parameters);

    <span class="reserved">if</span> (![<span class="literal">'get'</span>, <span class="literal">'post'</span>].include(<span class="reserved">this</span>.method)) {
      <span class="comment">// simulate other verbs over post</span>
      params[<span class="literal">'_method'</span>] = <span class="reserved">this</span>.method;
      <span class="reserved">this</span>.method = <span class="literal">'post'</span>;
    }

    <span class="reserved">this</span>.parameters = params;

    <span class="reserved">if</span> (params = Object.toQueryString(params)) {
      <span class="comment">// when GET, append parameters to URL</span>
      <span class="reserved">if</span> (<span class="reserved">this</span>.method == <span class="literal">'get'</span>)
        <span class="reserved">this</span>.url += (<span class="reserved">this</span>.url.include(<span class="literal">'?'</span>) ? <span class="literal">'&amp;'</span> : <span class="literal">'?'</span>) + params;
      <span class="reserved">else</span> <span class="reserved">if</span> (/Konqueror|Safari|KHTML/.test(navigator.userAgent))
        params += <span class="literal">'&amp;_='</span>;
    }

    try {
      var response = new Ajax.Response(<span class="reserved">this</span>);
      <span class="reserved">if</span> (<span class="reserved">this</span>.options.onCreate) <span class="reserved">this</span>.options.onCreate(response);
      Ajax.Responders.dispatch(<span class="literal">'onCreate'</span>, <span class="reserved">this</span>, response);

      <span class="reserved">this</span>.transport.open(<span class="reserved">this</span>.method.toUpperCase(), <span class="reserved">this</span>.url,
        <span class="reserved">this</span>.options.asynchronous);

      <span class="reserved">if</span> (<span class="reserved">this</span>.options.asynchronous) <span class="reserved">this</span>.respondToReadyState.bind(<span class="reserved">this</span>).defer(1);

      <span class="reserved">this</span>.transport.onreadystatechange = <span class="reserved">this</span>.onStateChange.bind(<span class="reserved">this</span>);
      <span class="reserved">this</span>.setRequestHeaders();

      <span class="reserved">this</span>.body = <span class="reserved">this</span>.method == <span class="literal">'post'</span> ? (<span class="reserved">this</span>.options.postBody || params) : null;
      <span class="reserved">this</span>.transport.send(<span class="reserved">this</span>.body);

      <span class="comment">/* Force Firefox to handle ready state 4 for synchronous requests */</span>
      <span class="reserved">if</span> (!<span class="reserved">this</span>.options.asynchronous &amp;&amp; <span class="reserved">this</span>.transport.overrideMimeType)
        <span class="reserved">this</span>.onStateChange();

    }
    catch (e) {
      <span class="reserved">this</span>.dispatchException(e);
    }
  },

  onStateChange: <span class="reserved">function</span>() {
    var readyState = <span class="reserved">this</span>.transport.readyState;
    <span class="reserved">if</span> (readyState &gt; 1 &amp;&amp; !((readyState == 4) &amp;&amp; <span class="reserved">this</span>._complete))
      <span class="reserved">this</span>.respondToReadyState(<span class="reserved">this</span>.transport.readyState);
  },

  setRequestHeaders: <span class="reserved">function</span>() {
    var headers = {
      <span class="literal">'X-Requested-With'</span>: <span class="literal">'XMLHttpRequest'</span>,
      <span class="literal">'X-Prototype-Version'</span>: Prototype.Version,
      <span class="literal">'Accept'</span>: <span class="literal">'text/javascript, text/html, application/xml, text/xml, */*'</span>
    };

    <span class="reserved">if</span> (<span class="reserved">this</span>.method == <span class="literal">'post'</span>) {
      headers[<span class="literal">'Content-type'</span>] = <span class="reserved">this</span>.options.contentType +
        (<span class="reserved">this</span>.options.encoding ? <span class="literal">'; charset='</span> + <span class="reserved">this</span>.options.encoding : <span class="literal">''</span>);

      <span class="comment">/* Force "Connection: close" for older Mozilla browsers to work
       * around a bug where XMLHttpRequest sends an incorrect
       * Content-length header. See Mozilla Bugzilla #246651.
       */</span>
      <span class="reserved">if</span> (<span class="reserved">this</span>.transport.overrideMimeType &amp;&amp;
          (navigator.userAgent.match(/Gecko\/(\d{4})/) || [0,2005])[1] &lt; 2005)
            headers[<span class="literal">'Connection'</span>] = <span class="literal">'close'</span>;
    }

    <span class="comment">// user-defined headers</span>
    <span class="reserved">if</span> (typeof <span class="reserved">this</span>.options.requestHeaders == <span class="literal">'object'</span>) {
      var extras = <span class="reserved">this</span>.options.requestHeaders;

      <span class="reserved">if</span> (Object.isFunction(extras.push))
        <span class="reserved">for</span> (var i = 0, length = extras.length; i &lt; length; i += 2)
          headers[extras[i]] = extras[i+1];
      <span class="reserved">else</span>
        $H(extras).each(<span class="reserved">function</span>(pair) { headers[pair.key] = pair.value });
    }

    <span class="reserved">for</span> (var name in headers)
      <span class="reserved">this</span>.transport.setRequestHeader(name, headers[name]);
  },

  success: <span class="reserved">function</span>() {
    var status = <span class="reserved">this</span>.getStatus();
    <span class="reserved">return</span> !status || (status &gt;= 200 &amp;&amp; status &lt; 300);
  },

  getStatus: <span class="reserved">function</span>() {
    try {
      <span class="reserved">return</span> <span class="reserved">this</span>.transport.status || 0;
    } catch (e) { <span class="reserved">return</span> 0 }
  },

  respondToReadyState: <span class="reserved">function</span>(readyState) {
    var state = Ajax.Request.Events[readyState], response = new Ajax.Response(<span class="reserved">this</span>);

    <span class="reserved">if</span> (state == <span class="literal">'Complete'</span>) {
      try {
        <span class="reserved">this</span>._complete = true;
        (<span class="reserved">this</span>.options[<span class="literal">'on'</span> + response.status]
         || <span class="reserved">this</span>.options[<span class="literal">'on'</span> + (<span class="reserved">this</span>.success() ? <span class="literal">'Success'</span> : <span class="literal">'Failure'</span>)]
         || Prototype.emptyFunction)(response, response.headerJSON);
      } catch (e) {
        <span class="reserved">this</span>.dispatchException(e);
      }

      var contentType = response.getHeader(<span class="literal">'Content-type'</span>);
      <span class="reserved">if</span> (<span class="reserved">this</span>.options.evalJS == <span class="literal">'force'</span>
          || (<span class="reserved">this</span>.options.evalJS &amp;&amp; <span class="reserved">this</span>.isSameOrigin() &amp;&amp; contentType
          &amp;&amp; contentType.match(/^\s*(text|application)\/(x-)?(java|ecma)script(;.*)?\s*$/i)))
        <span class="reserved">this</span>.evalResponse();
    }

    try {
      (<span class="reserved">this</span>.options[<span class="literal">'on'</span> + state] || Prototype.emptyFunction)(response, response.headerJSON);
      Ajax.Responders.dispatch(<span class="literal">'on'</span> + state, <span class="reserved">this</span>, response, response.headerJSON);
    } catch (e) {
      <span class="reserved">this</span>.dispatchException(e);
    }

    <span class="reserved">if</span> (state == <span class="literal">'Complete'</span>) {
      <span class="comment">// avoid memory leak in MSIE: clean up</span>
      <span class="reserved">this</span>.transport.onreadystatechange = Prototype.emptyFunction;
    }
  },

  isSameOrigin: <span class="reserved">function</span>() {
    var m = <span class="reserved">this</span>.url.match(/^\s*https?:\/\/[^\/]*/);
    <span class="reserved">return</span> !m || (m[0] == <span class="literal">'#{protocol}//#{domain}#{port}'</span>.interpolate({
      protocol: location.protocol,
      domain: document.domain,
      port: location.port ? <span class="literal">':'</span> + location.port : <span class="literal">''</span>
    }));
  },

  getHeader: <span class="reserved">function</span>(name) {
    try {
      <span class="reserved">return</span> <span class="reserved">this</span>.transport.getResponseHeader(name) || null;
    } catch (e) { <span class="reserved">return</span> null }
  },

  evalResponse: <span class="reserved">function</span>() {
    try {
      <span class="reserved">return</span> eval((<span class="reserved">this</span>.transport.responseText || <span class="literal">''</span>).unfilterJSON());
    } catch (e) {
      <span class="reserved">this</span>.dispatchException(e);
    }
  },

  dispatchException: <span class="reserved">function</span>(exception) {
    (<span class="reserved">this</span>.options.onException || Prototype.emptyFunction)(<span class="reserved">this</span>, exception);
    Ajax.Responders.dispatch(<span class="literal">'onException'</span>, <span class="reserved">this</span>, exception);
  }
});

Ajax.Request.Events =
  [<span class="literal">'Uninitialized'</span>, <span class="literal">'Loading'</span>, <span class="literal">'Loaded'</span>, <span class="literal">'Interactive'</span>, <span class="literal">'Complete'</span>];

Ajax.Response = Class.create({
  initialize: <span class="reserved">function</span>(request){
    <span class="reserved">this</span>.request = request;
    var transport  = <span class="reserved">this</span>.transport  = request.transport,
        readyState = <span class="reserved">this</span>.readyState = transport.readyState;

    <span class="reserved">if</span>((readyState &gt; 2 &amp;&amp; !Prototype.Browser.IE) || readyState == 4) {
      <span class="reserved">this</span>.status       = <span class="reserved">this</span>.getStatus();
      <span class="reserved">this</span>.statusText   = <span class="reserved">this</span>.getStatusText();
      <span class="reserved">this</span>.responseText = String.interpret(transport.responseText);
      <span class="reserved">this</span>.headerJSON   = <span class="reserved">this</span>._getHeaderJSON();
    }

    <span class="reserved">if</span>(readyState == 4) {
      var xml = transport.responseXML;
      <span class="reserved">this</span>.responseXML  = Object.isUndefined(xml) ? null : xml;
      <span class="reserved">this</span>.responseJSON = <span class="reserved">this</span>._getResponseJSON();
    }
  },

  status:      0,
  statusText: <span class="literal">''</span>,

  getStatus: Ajax.Request.<span class="reserved">prototype</span>.getStatus,

  getStatusText: <span class="reserved">function</span>() {
    try {
      <span class="reserved">return</span> <span class="reserved">this</span>.transport.statusText || <span class="literal">''</span>;
    } catch (e) { <span class="reserved">return</span> <span class="literal">''</span> }
  },

  getHeader: Ajax.Request.<span class="reserved">prototype</span>.getHeader,

  getAllHeaders: <span class="reserved">function</span>() {
    try {
      <span class="reserved">return</span> <span class="reserved">this</span>.getAllResponseHeaders();
    } catch (e) { <span class="reserved">return</span> null }
  },

  getResponseHeader: <span class="reserved">function</span>(name) {
    <span class="reserved">return</span> <span class="reserved">this</span>.transport.getResponseHeader(name);
  },

  getAllResponseHeaders: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.transport.getAllResponseHeaders();
  },

  _getHeaderJSON: <span class="reserved">function</span>() {
    var json = <span class="reserved">this</span>.getHeader(<span class="literal">'X-JSON'</span>);
    <span class="reserved">if</span> (!json) <span class="reserved">return</span> null;
    json = decodeURIComponent(escape(json));
    try {
      <span class="reserved">return</span> json.evalJSON(<span class="reserved">this</span>.request.options.sanitizeJSON ||
        !<span class="reserved">this</span>.request.isSameOrigin());
    } catch (e) {
      <span class="reserved">this</span>.request.dispatchException(e);
    }
  },

  _getResponseJSON: <span class="reserved">function</span>() {
    var options = <span class="reserved">this</span>.request.options;
    <span class="reserved">if</span> (!options.evalJSON || (options.evalJSON != <span class="literal">'force'</span> &amp;&amp;
      !(<span class="reserved">this</span>.getHeader(<span class="literal">'Content-type'</span>) || <span class="literal">''</span>).include(<span class="literal">'application/json'</span>)) ||
        <span class="reserved">this</span>.responseText.blank())
          <span class="reserved">return</span> null;
    try {
      <span class="reserved">return</span> <span class="reserved">this</span>.responseText.evalJSON(options.sanitizeJSON ||
        !<span class="reserved">this</span>.request.isSameOrigin());
    } catch (e) {
      <span class="reserved">this</span>.request.dispatchException(e);
    }
  }
});

Ajax.Updater = Class.create(Ajax.Request, {
  initialize: <span class="reserved">function</span>($super, container, url, options) {
    <span class="reserved">this</span>.container = {
      success: (container.success || container),
      failure: (container.failure || (container.success ? null : container))
    };

    options = Object.clone(options);
    var onComplete = options.onComplete;
    options.onComplete = (<span class="reserved">function</span>(response, json) {
      <span class="reserved">this</span>.updateContent(response.responseText);
      <span class="reserved">if</span> (Object.isFunction(onComplete)) onComplete(response, json);
    }).bind(<span class="reserved">this</span>);

    $super(url, options);
  },

  updateContent: <span class="reserved">function</span>(responseText) {
    var receiver = <span class="reserved">this</span>.container[<span class="reserved">this</span>.success() ? <span class="literal">'success'</span> : <span class="literal">'failure'</span>],
        options = <span class="reserved">this</span>.options;

    <span class="reserved">if</span> (!options.evalScripts) responseText = responseText.stripScripts();

    <span class="reserved">if</span> (receiver = $(receiver)) {
      <span class="reserved">if</span> (options.insertion) {
        <span class="reserved">if</span> (Object.isString(options.insertion)) {
          var insertion = { }; insertion[options.insertion] = responseText;
          receiver.insert(insertion);
        }
        <span class="reserved">else</span> options.insertion(receiver, responseText);
      }
      <span class="reserved">else</span> receiver.update(responseText);
    }
  }
});

Ajax.PeriodicalUpdater = Class.create(Ajax.Base, {
  initialize: <span class="reserved">function</span>($super, container, url, options) {
    $super(options);
    <span class="reserved">this</span>.onComplete = <span class="reserved">this</span>.options.onComplete;

    <span class="reserved">this</span>.frequency = (<span class="reserved">this</span>.options.frequency || 2);
    <span class="reserved">this</span>.decay = (<span class="reserved">this</span>.options.decay || 1);

    <span class="reserved">this</span>.updater = { };
    <span class="reserved">this</span>.container = container;
    <span class="reserved">this</span>.url = url;

    <span class="reserved">this</span>.start();
  },

  start: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.options.onComplete = <span class="reserved">this</span>.updateComplete.bind(<span class="reserved">this</span>);
    <span class="reserved">this</span>.onTimerEvent();
  },

  stop: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.updater.options.onComplete = undefined;
    clearTimeout(<span class="reserved">this</span>.timer);
    (<span class="reserved">this</span>.onComplete || Prototype.emptyFunction).apply(<span class="reserved">this</span>, arguments);
  },

  updateComplete: <span class="reserved">function</span>(response) {
    <span class="reserved">if</span> (<span class="reserved">this</span>.options.decay) {
      <span class="reserved">this</span>.decay = (response.responseText == <span class="reserved">this</span>.lastText ?
        <span class="reserved">this</span>.decay * <span class="reserved">this</span>.options.decay : 1);

      <span class="reserved">this</span>.lastText = response.responseText;
    }
    <span class="reserved">this</span>.timer = <span class="reserved">this</span>.onTimerEvent.bind(<span class="reserved">this</span>).delay(<span class="reserved">this</span>.decay * <span class="reserved">this</span>.frequency);
  },

  onTimerEvent: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.updater = new Ajax.Updater(<span class="reserved">this</span>.container, <span class="reserved">this</span>.url, <span class="reserved">this</span>.options);
  }
});
<span class="reserved">function</span> $(element) {
  <span class="reserved">if</span> (arguments.length &gt; 1) {
    <span class="reserved">for</span> (var i = 0, elements = [], length = arguments.length; i &lt; length; i++)
      elements.push($(arguments[i]));
    <span class="reserved">return</span> elements;
  }
  <span class="reserved">if</span> (Object.isString(element))
    element = document.getElementById(element);
  <span class="reserved">return</span> Element.extend(element);
}

<span class="reserved">if</span> (Prototype.BrowserFeatures.XPath) {
  document._getElementsByXPath = <span class="reserved">function</span>(expression, parentElement) {
    var results = [];
    var query = document.evaluate(expression, $(parentElement) || document,
      null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
    <span class="reserved">for</span> (var i = 0, length = query.snapshotLength; i &lt; length; i++)
      results.push(Element.extend(query.snapshotItem(i)));
    <span class="reserved">return</span> results;
  };
}

<span class="comment">/*--------------------------------------------------------------------------*/</span>

<span class="reserved">if</span> (!window.Node) var Node = { };

<span class="reserved">if</span> (!Node.ELEMENT_NODE) {
  <span class="comment">// DOM level 2 ECMAScript Language Binding</span>
  Object.extend(Node, {
    ELEMENT_NODE: 1,
    ATTRIBUTE_NODE: 2,
    TEXT_NODE: 3,
    CDATA_SECTION_NODE: 4,
    ENTITY_REFERENCE_NODE: 5,
    ENTITY_NODE: 6,
    PROCESSING_INSTRUCTION_NODE: 7,
    COMMENT_NODE: 8,
    DOCUMENT_NODE: 9,
    DOCUMENT_TYPE_NODE: 10,
    DOCUMENT_FRAGMENT_NODE: 11,
    NOTATION_NODE: 12
  });
}

(<span class="reserved">function</span>() {
  var element = <span class="reserved">this</span>.Element;
  <span class="reserved">this</span>.Element = <span class="reserved">function</span>(tagName, attributes) {
    attributes = attributes || { };
    tagName = tagName.toLowerCase();
    var cache = Element.cache;
    <span class="reserved">if</span> (Prototype.Browser.IE &amp;&amp; attributes.name) {
      tagName = <span class="literal">'&lt;'</span> + tagName + <span class="literal">' name="'</span> + attributes.name + <span class="literal">'"&gt;'</span>;
      delete attributes.name;
      <span class="reserved">return</span> Element.writeAttribute(document.createElement(tagName), attributes);
    }
    <span class="reserved">if</span> (!cache[tagName]) cache[tagName] = Element.extend(document.createElement(tagName));
    <span class="reserved">return</span> Element.writeAttribute(cache[tagName].cloneNode(false), attributes);
  };
  Object.extend(<span class="reserved">this</span>.Element, element || { });
}).call(window);

Element.cache = { };

Element.Methods = {
  visible: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).style.display != <span class="literal">'none'</span>;
  },

  toggle: <span class="reserved">function</span>(element) {
    element = $(element);
    Element[Element.visible(element) ? <span class="literal">'hide'</span> : <span class="literal">'show'</span>](element);
    <span class="reserved">return</span> element;
  },

  hide: <span class="reserved">function</span>(element) {
    $(element).style.display = <span class="literal">'none'</span>;
    <span class="reserved">return</span> element;
  },

  show: <span class="reserved">function</span>(element) {
    $(element).style.display = <span class="literal">''</span>;
    <span class="reserved">return</span> element;
  },

  remove: <span class="reserved">function</span>(element) {
    element = $(element);
    element.parentNode.removeChild(element);
    <span class="reserved">return</span> element;
  },

  update: <span class="reserved">function</span>(element, content) {
    element = $(element);
    <span class="reserved">if</span> (content &amp;&amp; content.toElement) content = content.toElement();
    <span class="reserved">if</span> (Object.isElement(content)) <span class="reserved">return</span> element.update().insert(content);
    content = Object.toHTML(content);
    element.innerHTML = content.stripScripts();
    content.evalScripts.bind(content).defer();
    <span class="reserved">return</span> element;
  },

  replace: <span class="reserved">function</span>(element, content) {
    element = $(element);
    <span class="reserved">if</span> (content &amp;&amp; content.toElement) content = content.toElement();
    <span class="reserved">else</span> <span class="reserved">if</span> (!Object.isElement(content)) {
      content = Object.toHTML(content);
      var range = element.ownerDocument.createRange();
      range.selectNode(element);
      content.evalScripts.bind(content).defer();
      content = range.createContextualFragment(content.stripScripts());
    }
    element.parentNode.replaceChild(content, element);
    <span class="reserved">return</span> element;
  },

  insert: <span class="reserved">function</span>(element, insertions) {
    element = $(element);

    <span class="reserved">if</span> (Object.isString(insertions) || Object.isNumber(insertions) ||
        Object.isElement(insertions) || (insertions &amp;&amp; (insertions.toElement || insertions.toHTML)))
          insertions = {bottom:insertions};

    var content, insert, tagName, childNodes;

    <span class="reserved">for</span> (var position in insertions) {
      content  = insertions[position];
      position = position.toLowerCase();
      insert = Element._insertionTranslations[position];

      <span class="reserved">if</span> (content &amp;&amp; content.toElement) content = content.toElement();
      <span class="reserved">if</span> (Object.isElement(content)) {
        insert(element, content);
        continue;
      }

      content = Object.toHTML(content);

      tagName = ((position == <span class="literal">'before'</span> || position == <span class="literal">'after'</span>)
        ? element.parentNode : element).tagName.toUpperCase();

      childNodes = Element._getContentFromAnonymousElement(tagName, content.stripScripts());

      <span class="reserved">if</span> (position == <span class="literal">'top'</span> || position == <span class="literal">'after'</span>) childNodes.reverse();
      childNodes.each(insert.curry(element));

      content.evalScripts.bind(content).defer();
    }

    <span class="reserved">return</span> element;
  },

  wrap: <span class="reserved">function</span>(element, wrapper, attributes) {
    element = $(element);
    <span class="reserved">if</span> (Object.isElement(wrapper))
      $(wrapper).writeAttribute(attributes || { });
    <span class="reserved">else</span> <span class="reserved">if</span> (Object.isString(wrapper)) wrapper = new Element(wrapper, attributes);
    <span class="reserved">else</span> wrapper = new Element(<span class="literal">'div'</span>, wrapper);
    <span class="reserved">if</span> (element.parentNode)
      element.parentNode.replaceChild(wrapper, element);
    wrapper.appendChild(element);
    <span class="reserved">return</span> wrapper;
  },

  inspect: <span class="reserved">function</span>(element) {
    element = $(element);
    var result = <span class="literal">'&lt;'</span> + element.tagName.toLowerCase();
    $H({<span class="literal">'id'</span>: <span class="literal">'id'</span>, <span class="literal">'className'</span>: <span class="literal">'class'</span>}).each(<span class="reserved">function</span>(pair) {
      var property = pair.first(), attribute = pair.last();
      var value = (element[property] || <span class="literal">''</span>).toString();
      <span class="reserved">if</span> (value) result += <span class="literal">' '</span> + attribute + <span class="literal">'='</span> + value.inspect(true);
    });
    <span class="reserved">return</span> result + <span class="literal">'&gt;'</span>;
  },

  recursivelyCollect: <span class="reserved">function</span>(element, property) {
    element = $(element);
    var elements = [];
    <span class="reserved">while</span> (element = element[property])
      <span class="reserved">if</span> (element.nodeType == 1)
        elements.push(Element.extend(element));
    <span class="reserved">return</span> elements;
  },

  ancestors: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).recursivelyCollect(<span class="literal">'parentNode'</span>);
  },

  descendants: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).select(<span class="literal">"*"</span>);
  },

  firstDescendant: <span class="reserved">function</span>(element) {
    element = $(element).firstChild;
    <span class="reserved">while</span> (element &amp;&amp; element.nodeType != 1) element = element.nextSibling;
    <span class="reserved">return</span> $(element);
  },

  immediateDescendants: <span class="reserved">function</span>(element) {
    <span class="reserved">if</span> (!(element = $(element).firstChild)) <span class="reserved">return</span> [];
    <span class="reserved">while</span> (element &amp;&amp; element.nodeType != 1) element = element.nextSibling;
    <span class="reserved">if</span> (element) <span class="reserved">return</span> [element].concat($(element).nextSiblings());
    <span class="reserved">return</span> [];
  },

  previousSiblings: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).recursivelyCollect(<span class="literal">'previousSibling'</span>);
  },

  nextSiblings: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).recursivelyCollect(<span class="literal">'nextSibling'</span>);
  },

  siblings: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">return</span> element.previousSiblings().reverse().concat(element.nextSiblings());
  },

  match: <span class="reserved">function</span>(element, selector) {
    <span class="reserved">if</span> (Object.isString(selector))
      selector = new Selector(selector);
    <span class="reserved">return</span> selector.match($(element));
  },

  up: <span class="reserved">function</span>(element, expression, index) {
    element = $(element);
    <span class="reserved">if</span> (arguments.length == 1) <span class="reserved">return</span> $(element.parentNode);
    var ancestors = element.ancestors();
    <span class="reserved">return</span> Object.isNumber(expression) ? ancestors[expression] :
      Selector.findElement(ancestors, expression, index);
  },

  down: <span class="reserved">function</span>(element, expression, index) {
    element = $(element);
    <span class="reserved">if</span> (arguments.length == 1) <span class="reserved">return</span> element.firstDescendant();
    <span class="reserved">return</span> Object.isNumber(expression) ? element.descendants()[expression] :
      element.select(expression)[index || 0];
  },

  previous: <span class="reserved">function</span>(element, expression, index) {
    element = $(element);
    <span class="reserved">if</span> (arguments.length == 1) <span class="reserved">return</span> $(Selector.handlers.previousElementSibling(element));
    var previousSiblings = element.previousSiblings();
    <span class="reserved">return</span> Object.isNumber(expression) ? previousSiblings[expression] :
      Selector.findElement(previousSiblings, expression, index);
  },

  next: <span class="reserved">function</span>(element, expression, index) {
    element = $(element);
    <span class="reserved">if</span> (arguments.length == 1) <span class="reserved">return</span> $(Selector.handlers.nextElementSibling(element));
    var nextSiblings = element.nextSiblings();
    <span class="reserved">return</span> Object.isNumber(expression) ? nextSiblings[expression] :
      Selector.findElement(nextSiblings, expression, index);
  },

  select: <span class="reserved">function</span>() {
    var args = $A(arguments), element = $(args.shift());
    <span class="reserved">return</span> Selector.findChildElements(element, args);
  },

  adjacent: <span class="reserved">function</span>() {
    var args = $A(arguments), element = $(args.shift());
    <span class="reserved">return</span> Selector.findChildElements(element.parentNode, args).without(element);
  },

  identify: <span class="reserved">function</span>(element) {
    element = $(element);
    var id = element.readAttribute(<span class="literal">'id'</span>), self = arguments.callee;
    <span class="reserved">if</span> (id) <span class="reserved">return</span> id;
    do { id = <span class="literal">'anonymous_element_'</span> + self.counter++ } <span class="reserved">while</span> ($(id));
    element.writeAttribute(<span class="literal">'id'</span>, id);
    <span class="reserved">return</span> id;
  },

  readAttribute: <span class="reserved">function</span>(element, name) {
    element = $(element);
    <span class="reserved">if</span> (Prototype.Browser.IE) {
      var t = Element._attributeTranslations.read;
      <span class="reserved">if</span> (t.values[name]) <span class="reserved">return</span> t.values[name](element, name);
      <span class="reserved">if</span> (t.names[name]) name = t.names[name];
      <span class="reserved">if</span> (name.include(<span class="literal">':'</span>)) {
        <span class="reserved">return</span> (!element.attributes || !element.attributes[name]) ? null :
         element.attributes[name].value;
      }
    }
    <span class="reserved">return</span> element.getAttribute(name);
  },

  writeAttribute: <span class="reserved">function</span>(element, name, value) {
    element = $(element);
    var attributes = { }, t = Element._attributeTranslations.write;

    <span class="reserved">if</span> (typeof name == <span class="literal">'object'</span>) attributes = name;
    <span class="reserved">else</span> attributes[name] = Object.isUndefined(value) ? true : value;

    <span class="reserved">for</span> (var attr in attributes) {
      name = t.names[attr] || attr;
      value = attributes[attr];
      <span class="reserved">if</span> (t.values[attr]) name = t.values[attr](element, value);
      <span class="reserved">if</span> (value === false || value === null)
        element.removeAttribute(name);
      <span class="reserved">else</span> <span class="reserved">if</span> (value === true)
        element.setAttribute(name, name);
      <span class="reserved">else</span> element.setAttribute(name, value);
    }
    <span class="reserved">return</span> element;
  },

  getHeight: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).getDimensions().height;
  },

  getWidth: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).getDimensions().width;
  },

  classNames: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> new Element.ClassNames(element);
  },

  hasClassName: <span class="reserved">function</span>(element, className) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;
    var elementClassName = element.className;
    <span class="reserved">return</span> (elementClassName.length &gt; 0 &amp;&amp; (elementClassName == className ||
      new RegExp(<span class="literal">"(^|\\s)"</span> + className + <span class="literal">"(\\s|$)"</span>).test(elementClassName)));
  },

  addClassName: <span class="reserved">function</span>(element, className) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;
    <span class="reserved">if</span> (!element.hasClassName(className))
      element.className += (element.className ? <span class="literal">' '</span> : <span class="literal">''</span>) + className;
    <span class="reserved">return</span> element;
  },

  removeClassName: <span class="reserved">function</span>(element, className) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;
    element.className = element.className.replace(
      new RegExp(<span class="literal">"(^|\\s+)"</span> + className + <span class="literal">"(\\s+|$)"</span>), <span class="literal">' '</span>).strip();
    <span class="reserved">return</span> element;
  },

  toggleClassName: <span class="reserved">function</span>(element, className) {
    <span class="reserved">if</span> (!(element = $(element))) <span class="reserved">return</span>;
    <span class="reserved">return</span> element[element.hasClassName(className) ?
      <span class="literal">'removeClassName'</span> : <span class="literal">'addClassName'</span>](className);
  },

  <span class="comment">// removes whitespace-only text node children</span>
  cleanWhitespace: <span class="reserved">function</span>(element) {
    element = $(element);
    var node = element.firstChild;
    <span class="reserved">while</span> (node) {
      var nextNode = node.nextSibling;
      <span class="reserved">if</span> (node.nodeType == 3 &amp;&amp; !/\S/.test(node.nodeValue))
        element.removeChild(node);
      node = nextNode;
    }
    <span class="reserved">return</span> element;
  },

  empty: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).innerHTML.blank();
  },

  descendantOf: <span class="reserved">function</span>(element, ancestor) {
    element = $(element), ancestor = $(ancestor);
    var originalAncestor = ancestor;

    <span class="reserved">if</span> (element.compareDocumentPosition)
      <span class="reserved">return</span> (element.compareDocumentPosition(ancestor) &amp; 8) === 8;

    <span class="reserved">if</span> (element.sourceIndex &amp;&amp; !Prototype.Browser.Opera) {
      var e = element.sourceIndex, a = ancestor.sourceIndex,
       nextAncestor = ancestor.nextSibling;
      <span class="reserved">if</span> (!nextAncestor) {
        do { ancestor = ancestor.parentNode; }
        <span class="reserved">while</span> (!(nextAncestor = ancestor.nextSibling) &amp;&amp; ancestor.parentNode);
      }
      <span class="reserved">if</span> (nextAncestor &amp;&amp; nextAncestor.sourceIndex)
       <span class="reserved">return</span> (e &gt; a &amp;&amp; e &lt; nextAncestor.sourceIndex);
    }

    <span class="reserved">while</span> (element = element.parentNode)
      <span class="reserved">if</span> (element == originalAncestor) <span class="reserved">return</span> true;
    <span class="reserved">return</span> false;
  },

  scrollTo: <span class="reserved">function</span>(element) {
    element = $(element);
    var pos = element.cumulativeOffset();
    window.scrollTo(pos[0], pos[1]);
    <span class="reserved">return</span> element;
  },

  getStyle: <span class="reserved">function</span>(element, style) {
    element = $(element);
    style = style == <span class="literal">'float'</span> ? <span class="literal">'cssFloat'</span> : style.camelize();
    var value = element.style[style];
    <span class="reserved">if</span> (!value) {
      var css = document.defaultView.getComputedStyle(element, null);
      value = css ? css[style] : null;
    }
    <span class="reserved">if</span> (style == <span class="literal">'opacity'</span>) <span class="reserved">return</span> value ? parseFloat(value) : 1.0;
    <span class="reserved">return</span> value == <span class="literal">'auto'</span> ? null : value;
  },

  getOpacity: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).getStyle(<span class="literal">'opacity'</span>);
  },

  setStyle: <span class="reserved">function</span>(element, styles) {
    element = $(element);
    var elementStyle = element.style, match;
    <span class="reserved">if</span> (Object.isString(styles)) {
      element.style.cssText += <span class="literal">';'</span> + styles;
      <span class="reserved">return</span> styles.include(<span class="literal">'opacity'</span>) ?
        element.setOpacity(styles.match(/opacity:\s*(\d?\.?\d*)/)[1]) : element;
    }
    <span class="reserved">for</span> (var property in styles)
      <span class="reserved">if</span> (property == <span class="literal">'opacity'</span>) element.setOpacity(styles[property]);
      <span class="reserved">else</span>
        elementStyle[(property == <span class="literal">'float'</span> || property == <span class="literal">'cssFloat'</span>) ?
          (Object.isUndefined(elementStyle.styleFloat) ? <span class="literal">'cssFloat'</span> : <span class="literal">'styleFloat'</span>) :
            property] = styles[property];

    <span class="reserved">return</span> element;
  },

  setOpacity: <span class="reserved">function</span>(element, value) {
    element = $(element);
    element.style.opacity = (value == 1 || value === <span class="literal">''</span>) ? <span class="literal">''</span> :
      (value &lt; 0.00001) ? 0 : value;
    <span class="reserved">return</span> element;
  },

  getDimensions: <span class="reserved">function</span>(element) {
    element = $(element);
    var display = $(element).getStyle(<span class="literal">'display'</span>);
    <span class="reserved">if</span> (display != <span class="literal">'none'</span> &amp;&amp; display != null) <span class="comment">// Safari bug</span>
      <span class="reserved">return</span> {width: element.offsetWidth, height: element.offsetHeight};

    <span class="comment">// All *Width and *Height properties give 0 on elements with display none,</span>
    <span class="comment">// so enable the element temporarily</span>
    var els = element.style;
    var originalVisibility = els.visibility;
    var originalPosition = els.position;
    var originalDisplay = els.display;
    els.visibility = <span class="literal">'hidden'</span>;
    els.position = <span class="literal">'absolute'</span>;
    els.display = <span class="literal">'block'</span>;
    var originalWidth = element.clientWidth;
    var originalHeight = element.clientHeight;
    els.display = originalDisplay;
    els.position = originalPosition;
    els.visibility = originalVisibility;
    <span class="reserved">return</span> {width: originalWidth, height: originalHeight};
  },

  makePositioned: <span class="reserved">function</span>(element) {
    element = $(element);
    var pos = Element.getStyle(element, <span class="literal">'position'</span>);
    <span class="reserved">if</span> (pos == <span class="literal">'static'</span> || !pos) {
      element._madePositioned = true;
      element.style.position = <span class="literal">'relative'</span>;
      <span class="comment">// Opera returns the offset relative to the positioning context, when an</span>
      <span class="comment">// element is position relative but top and left have not been defined</span>
      <span class="reserved">if</span> (window.opera) {
        element.style.top = 0;
        element.style.left = 0;
      }
    }
    <span class="reserved">return</span> element;
  },

  undoPositioned: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (element._madePositioned) {
      element._madePositioned = undefined;
      element.style.position =
        element.style.top =
        element.style.left =
        element.style.bottom =
        element.style.right = <span class="literal">''</span>;
    }
    <span class="reserved">return</span> element;
  },

  makeClipping: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (element._overflow) <span class="reserved">return</span> element;
    element._overflow = Element.getStyle(element, <span class="literal">'overflow'</span>) || <span class="literal">'auto'</span>;
    <span class="reserved">if</span> (element._overflow !== <span class="literal">'hidden'</span>)
      element.style.overflow = <span class="literal">'hidden'</span>;
    <span class="reserved">return</span> element;
  },

  undoClipping: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (!element._overflow) <span class="reserved">return</span> element;
    element.style.overflow = element._overflow == <span class="literal">'auto'</span> ? <span class="literal">''</span> : element._overflow;
    element._overflow = null;
    <span class="reserved">return</span> element;
  },

  cumulativeOffset: <span class="reserved">function</span>(element) {
    var valueT = 0, valueL = 0;
    do {
      valueT += element.offsetTop  || 0;
      valueL += element.offsetLeft || 0;
      element = element.offsetParent;
    } <span class="reserved">while</span> (element);
    <span class="reserved">return</span> Element._returnOffset(valueL, valueT);
  },

  positionedOffset: <span class="reserved">function</span>(element) {
    var valueT = 0, valueL = 0;
    do {
      valueT += element.offsetTop  || 0;
      valueL += element.offsetLeft || 0;
      element = element.offsetParent;
      <span class="reserved">if</span> (element) {
        <span class="reserved">if</span> (element.tagName == <span class="literal">'BODY'</span>) break;
        var p = Element.getStyle(element, <span class="literal">'position'</span>);
        <span class="reserved">if</span> (p !== <span class="literal">'static'</span>) break;
      }
    } <span class="reserved">while</span> (element);
    <span class="reserved">return</span> Element._returnOffset(valueL, valueT);
  },

  absolutize: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (element.getStyle(<span class="literal">'position'</span>) == <span class="literal">'absolute'</span>) <span class="reserved">return</span>;
    <span class="comment">// Position.prepare(); // To be done manually by Scripty when it needs it.</span>

    var offsets = element.positionedOffset();
    var top     = offsets[1];
    var left    = offsets[0];
    var width   = element.clientWidth;
    var height  = element.clientHeight;

    element._originalLeft   = left - parseFloat(element.style.left  || 0);
    element._originalTop    = top  - parseFloat(element.style.top || 0);
    element._originalWidth  = element.style.width;
    element._originalHeight = element.style.height;

    element.style.position = <span class="literal">'absolute'</span>;
    element.style.top    = top + <span class="literal">'px'</span>;
    element.style.left   = left + <span class="literal">'px'</span>;
    element.style.width  = width + <span class="literal">'px'</span>;
    element.style.height = height + <span class="literal">'px'</span>;
    <span class="reserved">return</span> element;
  },

  relativize: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (element.getStyle(<span class="literal">'position'</span>) == <span class="literal">'relative'</span>) <span class="reserved">return</span>;
    <span class="comment">// Position.prepare(); // To be done manually by Scripty when it needs it.</span>

    element.style.position = <span class="literal">'relative'</span>;
    var top  = parseFloat(element.style.top  || 0) - (element._originalTop || 0);
    var left = parseFloat(element.style.left || 0) - (element._originalLeft || 0);

    element.style.top    = top + <span class="literal">'px'</span>;
    element.style.left   = left + <span class="literal">'px'</span>;
    element.style.height = element._originalHeight;
    element.style.width  = element._originalWidth;
    <span class="reserved">return</span> element;
  },

  cumulativeScrollOffset: <span class="reserved">function</span>(element) {
    var valueT = 0, valueL = 0;
    do {
      valueT += element.scrollTop  || 0;
      valueL += element.scrollLeft || 0;
      element = element.parentNode;
    } <span class="reserved">while</span> (element);
    <span class="reserved">return</span> Element._returnOffset(valueL, valueT);
  },

  getOffsetParent: <span class="reserved">function</span>(element) {
    <span class="reserved">if</span> (element.offsetParent) <span class="reserved">return</span> $(element.offsetParent);
    <span class="reserved">if</span> (element == document.body) <span class="reserved">return</span> $(element);

    <span class="reserved">while</span> ((element = element.parentNode) &amp;&amp; element != document.body)
      <span class="reserved">if</span> (Element.getStyle(element, <span class="literal">'position'</span>) != <span class="literal">'static'</span>)
        <span class="reserved">return</span> $(element);

    <span class="reserved">return</span> $(document.body);
  },

  viewportOffset: <span class="reserved">function</span>(forElement) {
    var valueT = 0, valueL = 0;

    var element = forElement;
    do {
      valueT += element.offsetTop  || 0;
      valueL += element.offsetLeft || 0;

      <span class="comment">// Safari fix</span>
      <span class="reserved">if</span> (element.offsetParent == document.body &amp;&amp;
        Element.getStyle(element, <span class="literal">'position'</span>) == <span class="literal">'absolute'</span>) break;

    } <span class="reserved">while</span> (element = element.offsetParent);

    element = forElement;
    do {
      <span class="reserved">if</span> (!Prototype.Browser.Opera || element.tagName == <span class="literal">'BODY'</span>) {
        valueT -= element.scrollTop  || 0;
        valueL -= element.scrollLeft || 0;
      }
    } <span class="reserved">while</span> (element = element.parentNode);

    <span class="reserved">return</span> Element._returnOffset(valueL, valueT);
  },

  clonePosition: <span class="reserved">function</span>(element, source) {
    var options = Object.extend({
      setLeft:    true,
      setTop:     true,
      setWidth:   true,
      setHeight:  true,
      offsetTop:  0,
      offsetLeft: 0
    }, arguments[2] || { });

    <span class="comment">// find page position of source</span>
    source = $(source);
    var p = source.viewportOffset();

    <span class="comment">// find coordinate system to use</span>
    element = $(element);
    var delta = [0, 0];
    var parent = null;
    <span class="comment">// delta [0,0] will do fine with position: fixed elements,</span>
    <span class="comment">// position:absolute needs offsetParent deltas</span>
    <span class="reserved">if</span> (Element.getStyle(element, <span class="literal">'position'</span>) == <span class="literal">'absolute'</span>) {
      parent = element.getOffsetParent();
      delta = parent.viewportOffset();
    }

    <span class="comment">// correct by body offsets (fixes Safari)</span>
    <span class="reserved">if</span> (parent == document.body) {
      delta[0] -= document.body.offsetLeft;
      delta[1] -= document.body.offsetTop;
    }

    <span class="comment">// set position</span>
    <span class="reserved">if</span> (options.setLeft)   element.style.left  = (p[0] - delta[0] + options.offsetLeft) + <span class="literal">'px'</span>;
    <span class="reserved">if</span> (options.setTop)    element.style.top   = (p[1] - delta[1] + options.offsetTop) + <span class="literal">'px'</span>;
    <span class="reserved">if</span> (options.setWidth)  element.style.width = source.offsetWidth + <span class="literal">'px'</span>;
    <span class="reserved">if</span> (options.setHeight) element.style.height = source.offsetHeight + <span class="literal">'px'</span>;
    <span class="reserved">return</span> element;
  }
};

Element.Methods.identify.counter = 1;

Object.extend(Element.Methods, {
  getElementsBySelector: Element.Methods.select,
  childElements: Element.Methods.immediateDescendants
});

Element._attributeTranslations = {
  write: {
    names: {
      className: <span class="literal">'class'</span>,
      htmlFor:   <span class="literal">'for'</span>
    },
    values: { }
  }
};

<span class="reserved">if</span> (Prototype.Browser.Opera) {
  Element.Methods.getStyle = Element.Methods.getStyle.wrap(
    <span class="reserved">function</span>(proceed, element, style) {
      switch (style) {
        case <span class="literal">'left'</span>: case <span class="literal">'top'</span>: case <span class="literal">'right'</span>: case <span class="literal">'bottom'</span>:
          <span class="reserved">if</span> (proceed(element, <span class="literal">'position'</span>) === <span class="literal">'static'</span>) <span class="reserved">return</span> null;
        case <span class="literal">'height'</span>: case <span class="literal">'width'</span>:
          <span class="comment">// returns '0px' for hidden elements; we want it to return null</span>
          <span class="reserved">if</span> (!Element.visible(element)) <span class="reserved">return</span> null;

          <span class="comment">// returns the border-box dimensions rather than the content-box</span>
          <span class="comment">// dimensions, so we subtract padding and borders from the value</span>
          var dim = parseInt(proceed(element, style), 10);

          <span class="reserved">if</span> (dim !== element[<span class="literal">'offset'</span> + style.capitalize()])
            <span class="reserved">return</span> dim + <span class="literal">'px'</span>;

          var properties;
          <span class="reserved">if</span> (style === <span class="literal">'height'</span>) {
            properties = [<span class="literal">'border-top-width'</span>, <span class="literal">'padding-top'</span>,
             <span class="literal">'padding-bottom'</span>, <span class="literal">'border-bottom-width'</span>];
          }
          <span class="reserved">else</span> {
            properties = [<span class="literal">'border-left-width'</span>, <span class="literal">'padding-left'</span>,
             <span class="literal">'padding-right'</span>, <span class="literal">'border-right-width'</span>];
          }
          <span class="reserved">return</span> properties.inject(dim, <span class="reserved">function</span>(memo, property) {
            var val = proceed(element, property);
            <span class="reserved">return</span> val === null ? memo : memo - parseInt(val, 10);
          }) + <span class="literal">'px'</span>;
        default: <span class="reserved">return</span> proceed(element, style);
      }
    }
  );

  Element.Methods.readAttribute = Element.Methods.readAttribute.wrap(
    <span class="reserved">function</span>(proceed, element, attribute) {
      <span class="reserved">if</span> (attribute === <span class="literal">'title'</span>) <span class="reserved">return</span> element.title;
      <span class="reserved">return</span> proceed(element, attribute);
    }
  );
}

<span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.IE) {
  <span class="comment">// IE doesn't report offsets correctly for static elements, so we change them</span>
  <span class="comment">// to "relative" to get the values, then change them back.</span>
  Element.Methods.getOffsetParent = Element.Methods.getOffsetParent.wrap(
    <span class="reserved">function</span>(proceed, element) {
      element = $(element);
      var position = element.getStyle(<span class="literal">'position'</span>);
      <span class="reserved">if</span> (position !== <span class="literal">'static'</span>) <span class="reserved">return</span> proceed(element);
      element.setStyle({ position: <span class="literal">'relative'</span> });
      var value = proceed(element);
      element.setStyle({ position: position });
      <span class="reserved">return</span> value;
    }
  );

  $w(<span class="literal">'positionedOffset viewportOffset'</span>).each(<span class="reserved">function</span>(method) {
    Element.Methods[method] = Element.Methods[method].wrap(
      <span class="reserved">function</span>(proceed, element) {
        element = $(element);
        var position = element.getStyle(<span class="literal">'position'</span>);
        <span class="reserved">if</span> (position !== <span class="literal">'static'</span>) <span class="reserved">return</span> proceed(element);
        <span class="comment">// Trigger hasLayout on the offset parent so that IE6 reports</span>
        <span class="comment">// accurate offsetTop and offsetLeft values for position: fixed.</span>
        var offsetParent = element.getOffsetParent();
        <span class="reserved">if</span> (offsetParent &amp;&amp; offsetParent.getStyle(<span class="literal">'position'</span>) === <span class="literal">'fixed'</span>)
          offsetParent.setStyle({ zoom: 1 });
        element.setStyle({ position: <span class="literal">'relative'</span> });
        var value = proceed(element);
        element.setStyle({ position: position });
        <span class="reserved">return</span> value;
      }
    );
  });

  Element.Methods.getStyle = <span class="reserved">function</span>(element, style) {
    element = $(element);
    style = (style == <span class="literal">'float'</span> || style == <span class="literal">'cssFloat'</span>) ? <span class="literal">'styleFloat'</span> : style.camelize();
    var value = element.style[style];
    <span class="reserved">if</span> (!value &amp;&amp; element.currentStyle) value = element.currentStyle[style];

    <span class="reserved">if</span> (style == <span class="literal">'opacity'</span>) {
      <span class="reserved">if</span> (value = (element.getStyle(<span class="literal">'filter'</span>) || <span class="literal">''</span>).match(/alpha\(opacity=(.*)\)/))
        <span class="reserved">if</span> (value[1]) <span class="reserved">return</span> parseFloat(value[1]) / 100;
      <span class="reserved">return</span> 1.0;
    }

    <span class="reserved">if</span> (value == <span class="literal">'auto'</span>) {
      <span class="reserved">if</span> ((style == <span class="literal">'width'</span> || style == <span class="literal">'height'</span>) &amp;&amp; (element.getStyle(<span class="literal">'display'</span>) != <span class="literal">'none'</span>))
        <span class="reserved">return</span> element[<span class="literal">'offset'</span> + style.capitalize()] + <span class="literal">'px'</span>;
      <span class="reserved">return</span> null;
    }
    <span class="reserved">return</span> value;
  };

  Element.Methods.setOpacity = <span class="reserved">function</span>(element, value) {
    <span class="reserved">function</span> stripAlpha(filter){
      <span class="reserved">return</span> filter.replace(/alpha\([^\)]*\)/gi,<span class="literal">''</span>);
    }
    element = $(element);
    var currentStyle = element.currentStyle;
    <span class="reserved">if</span> ((currentStyle &amp;&amp; !currentStyle.hasLayout) ||
      (!currentStyle &amp;&amp; element.style.zoom == <span class="literal">'normal'</span>))
        element.style.zoom = 1;

    var filter = element.getStyle(<span class="literal">'filter'</span>), style = element.style;
    <span class="reserved">if</span> (value == 1 || value === <span class="literal">''</span>) {
      (filter = stripAlpha(filter)) ?
        style.filter = filter : style.removeAttribute(<span class="literal">'filter'</span>);
      <span class="reserved">return</span> element;
    } <span class="reserved">else</span> <span class="reserved">if</span> (value &lt; 0.00001) value = 0;
    style.filter = stripAlpha(filter) +
      <span class="literal">'alpha(opacity='</span> + (value * 100) + <span class="literal">')'</span>;
    <span class="reserved">return</span> element;
  };

  Element._attributeTranslations = {
    read: {
      names: {
        <span class="literal">'class'</span>: <span class="literal">'className'</span>,
        <span class="literal">'for'</span>:   <span class="literal">'htmlFor'</span>
      },
      values: {
        _getAttr: <span class="reserved">function</span>(element, attribute) {
          <span class="reserved">return</span> element.getAttribute(attribute, 2);
        },
        _getAttrNode: <span class="reserved">function</span>(element, attribute) {
          var node = element.getAttributeNode(attribute);
          <span class="reserved">return</span> node ? node.value : <span class="literal">""</span>;
        },
        _getEv: <span class="reserved">function</span>(element, attribute) {
          attribute = element.getAttribute(attribute);
          <span class="reserved">return</span> attribute ? attribute.toString().slice(23, -2) : null;
        },
        _flag: <span class="reserved">function</span>(element, attribute) {
          <span class="reserved">return</span> $(element).hasAttribute(attribute) ? attribute : null;
        },
        style: <span class="reserved">function</span>(element) {
          <span class="reserved">return</span> element.style.cssText.toLowerCase();
        },
        title: <span class="reserved">function</span>(element) {
          <span class="reserved">return</span> element.title;
        }
      }
    }
  };

  Element._attributeTranslations.write = {
    names: Object.extend({
      cellpadding: <span class="literal">'cellPadding'</span>,
      cellspacing: <span class="literal">'cellSpacing'</span>
    }, Element._attributeTranslations.read.names),
    values: {
      checked: <span class="reserved">function</span>(element, value) {
        element.checked = !!value;
      },

      style: <span class="reserved">function</span>(element, value) {
        element.style.cssText = value ? value : <span class="literal">''</span>;
      }
    }
  };

  Element._attributeTranslations.has = {};

  $w(<span class="literal">'colSpan rowSpan vAlign dateTime accessKey tabIndex '</span> +
      <span class="literal">'encType maxLength readOnly longDesc'</span>).each(<span class="reserved">function</span>(attr) {
    Element._attributeTranslations.write.names[attr.toLowerCase()] = attr;
    Element._attributeTranslations.has[attr.toLowerCase()] = attr;
  });

  (<span class="reserved">function</span>(v) {
    Object.extend(v, {
      href:        v._getAttr,
      src:         v._getAttr,
      type:        v._getAttr,
      action:      v._getAttrNode,
      disabled:    v._flag,
      checked:     v._flag,
      readonly:    v._flag,
      multiple:    v._flag,
      onload:      v._getEv,
      onunload:    v._getEv,
      onclick:     v._getEv,
      ondblclick:  v._getEv,
      onmousedown: v._getEv,
      onmouseup:   v._getEv,
      onmouseover: v._getEv,
      onmousemove: v._getEv,
      onmouseout:  v._getEv,
      onfocus:     v._getEv,
      onblur:      v._getEv,
      onkeypress:  v._getEv,
      onkeydown:   v._getEv,
      onkeyup:     v._getEv,
      onsubmit:    v._getEv,
      onreset:     v._getEv,
      onselect:    v._getEv,
      onchange:    v._getEv
    });
  })(Element._attributeTranslations.read.values);
}

<span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.Gecko &amp;&amp; /rv:1\.8\.0/.test(navigator.userAgent)) {
  Element.Methods.setOpacity = <span class="reserved">function</span>(element, value) {
    element = $(element);
    element.style.opacity = (value == 1) ? 0.999999 :
      (value === <span class="literal">''</span>) ? <span class="literal">''</span> : (value &lt; 0.00001) ? 0 : value;
    <span class="reserved">return</span> element;
  };
}

<span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.WebKit) {
  Element.Methods.setOpacity = <span class="reserved">function</span>(element, value) {
    element = $(element);
    element.style.opacity = (value == 1 || value === <span class="literal">''</span>) ? <span class="literal">''</span> :
      (value &lt; 0.00001) ? 0 : value;

    <span class="reserved">if</span> (value == 1)
      <span class="reserved">if</span>(element.tagName == <span class="literal">'IMG'</span> &amp;&amp; element.width) {
        element.width++; element.width--;
      } <span class="reserved">else</span> try {
        var n = document.createTextNode(<span class="literal">' '</span>);
        element.appendChild(n);
        element.removeChild(n);
      } catch (e) { }

    <span class="reserved">return</span> element;
  };

  <span class="comment">// Safari returns margins on body which is incorrect if the child is absolutely</span>
  <span class="comment">// positioned.  For performance reasons, redefine Element#cumulativeOffset for</span>
  <span class="comment">// KHTML/WebKit only.</span>
  Element.Methods.cumulativeOffset = <span class="reserved">function</span>(element) {
    var valueT = 0, valueL = 0;
    do {
      valueT += element.offsetTop  || 0;
      valueL += element.offsetLeft || 0;
      <span class="reserved">if</span> (element.offsetParent == document.body)
        <span class="reserved">if</span> (Element.getStyle(element, <span class="literal">'position'</span>) == <span class="literal">'absolute'</span>) break;

      element = element.offsetParent;
    } <span class="reserved">while</span> (element);

    <span class="reserved">return</span> Element._returnOffset(valueL, valueT);
  };
}

<span class="reserved">if</span> (Prototype.Browser.IE || Prototype.Browser.Opera) {
  <span class="comment">// IE and Opera are missing .innerHTML support for TABLE-related and SELECT elements</span>
  Element.Methods.update = <span class="reserved">function</span>(element, content) {
    element = $(element);

    <span class="reserved">if</span> (content &amp;&amp; content.toElement) content = content.toElement();
    <span class="reserved">if</span> (Object.isElement(content)) <span class="reserved">return</span> element.update().insert(content);

    content = Object.toHTML(content);
    var tagName = element.tagName.toUpperCase();

    <span class="reserved">if</span> (tagName in Element._insertionTranslations.tags) {
      $A(element.childNodes).each(<span class="reserved">function</span>(node) { element.removeChild(node) });
      Element._getContentFromAnonymousElement(tagName, content.stripScripts())
        .each(<span class="reserved">function</span>(node) { element.appendChild(node) });
    }
    <span class="reserved">else</span> element.innerHTML = content.stripScripts();

    content.evalScripts.bind(content).defer();
    <span class="reserved">return</span> element;
  };
}

<span class="reserved">if</span> (<span class="literal">'outerHTML'</span> in document.createElement(<span class="literal">'div'</span>)) {
  Element.Methods.replace = <span class="reserved">function</span>(element, content) {
    element = $(element);

    <span class="reserved">if</span> (content &amp;&amp; content.toElement) content = content.toElement();
    <span class="reserved">if</span> (Object.isElement(content)) {
      element.parentNode.replaceChild(content, element);
      <span class="reserved">return</span> element;
    }

    content = Object.toHTML(content);
    var parent = element.parentNode, tagName = parent.tagName.toUpperCase();

    <span class="reserved">if</span> (Element._insertionTranslations.tags[tagName]) {
      var nextSibling = element.next();
      var fragments = Element._getContentFromAnonymousElement(tagName, content.stripScripts());
      parent.removeChild(element);
      <span class="reserved">if</span> (nextSibling)
        fragments.each(<span class="reserved">function</span>(node) { parent.insertBefore(node, nextSibling) });
      <span class="reserved">else</span>
        fragments.each(<span class="reserved">function</span>(node) { parent.appendChild(node) });
    }
    <span class="reserved">else</span> element.outerHTML = content.stripScripts();

    content.evalScripts.bind(content).defer();
    <span class="reserved">return</span> element;
  };
}

Element._returnOffset = <span class="reserved">function</span>(l, t) {
  var result = [l, t];
  result.left = l;
  result.top = t;
  <span class="reserved">return</span> result;
};

Element._getContentFromAnonymousElement = <span class="reserved">function</span>(tagName, html) {
  var div = new Element(<span class="literal">'div'</span>), t = Element._insertionTranslations.tags[tagName];
  <span class="reserved">if</span> (t) {
    div.innerHTML = t[0] + html + t[1];
    t[2].times(<span class="reserved">function</span>() { div = div.firstChild });
  } <span class="reserved">else</span> div.innerHTML = html;
  <span class="reserved">return</span> $A(div.childNodes);
};

Element._insertionTranslations = {
  before: <span class="reserved">function</span>(element, node) {
    element.parentNode.insertBefore(node, element);
  },
  top: <span class="reserved">function</span>(element, node) {
    element.insertBefore(node, element.firstChild);
  },
  bottom: <span class="reserved">function</span>(element, node) {
    element.appendChild(node);
  },
  after: <span class="reserved">function</span>(element, node) {
    element.parentNode.insertBefore(node, element.nextSibling);
  },
  tags: {
    TABLE:  [<span class="literal">'&lt;table&gt;'</span>,                <span class="literal">'&lt;/table&gt;'</span>,                   1],
    TBODY:  [<span class="literal">'&lt;table&gt;&lt;tbody&gt;'</span>,         <span class="literal">'&lt;/tbody&gt;&lt;/table&gt;'</span>,           2],
    TR:     [<span class="literal">'&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;'</span>,     <span class="literal">'&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;'</span>,      3],
    TD:     [<span class="literal">'&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;'</span>, <span class="literal">'&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;'</span>, 4],
    SELECT: [<span class="literal">'&lt;select&gt;'</span>,               <span class="literal">'&lt;/select&gt;'</span>,                  1]
  }
};

(<span class="reserved">function</span>() {
  Object.extend(<span class="reserved">this</span>.tags, {
    THEAD: <span class="reserved">this</span>.tags.TBODY,
    TFOOT: <span class="reserved">this</span>.tags.TBODY,
    TH:    <span class="reserved">this</span>.tags.TD
  });
}).call(Element._insertionTranslations);

Element.Methods.Simulated = {
  hasAttribute: <span class="reserved">function</span>(element, attribute) {
    attribute = Element._attributeTranslations.has[attribute] || attribute;
    var node = $(element).getAttributeNode(attribute);
    <span class="reserved">return</span> node &amp;&amp; node.specified;
  }
};

Element.Methods.ByTag = { };

Object.extend(Element, Element.Methods);

<span class="reserved">if</span> (!Prototype.BrowserFeatures.ElementExtensions &amp;&amp;
    document.createElement(<span class="literal">'div'</span>).__proto__) {
  window.HTMLElement = { };
  window.HTMLElement.<span class="reserved">prototype</span> = document.createElement(<span class="literal">'div'</span>).__proto__;
  Prototype.BrowserFeatures.ElementExtensions = true;
}

Element.extend = (<span class="reserved">function</span>() {
  <span class="reserved">if</span> (Prototype.BrowserFeatures.SpecificElementExtensions)
    <span class="reserved">return</span> Prototype.K;

  var Methods = { }, ByTag = Element.Methods.ByTag;

  var extend = Object.extend(<span class="reserved">function</span>(element) {
    <span class="reserved">if</span> (!element || element._extendedByPrototype ||
        element.nodeType != 1 || element == window) <span class="reserved">return</span> element;

    var methods = Object.clone(Methods),
      tagName = element.tagName, property, value;

    <span class="comment">// extend methods for specific tags</span>
    <span class="reserved">if</span> (ByTag[tagName]) Object.extend(methods, ByTag[tagName]);

    <span class="reserved">for</span> (property in methods) {
      value = methods[property];
      <span class="reserved">if</span> (Object.isFunction(value) &amp;&amp; !(property in element))
        element[property] = value.methodize();
    }

    element._extendedByPrototype = Prototype.emptyFunction;
    <span class="reserved">return</span> element;

  }, {
    refresh: <span class="reserved">function</span>() {
      <span class="comment">// extend methods for all tags (Safari doesn't need this)</span>
      <span class="reserved">if</span> (!Prototype.BrowserFeatures.ElementExtensions) {
        Object.extend(Methods, Element.Methods);
        Object.extend(Methods, Element.Methods.Simulated);
      }
    }
  });

  extend.refresh();
  <span class="reserved">return</span> extend;
})();

Element.hasAttribute = <span class="reserved">function</span>(element, attribute) {
  <span class="reserved">if</span> (element.hasAttribute) <span class="reserved">return</span> element.hasAttribute(attribute);
  <span class="reserved">return</span> Element.Methods.Simulated.hasAttribute(element, attribute);
};

Element.addMethods = <span class="reserved">function</span>(methods) {
  var F = Prototype.BrowserFeatures, T = Element.Methods.ByTag;

  <span class="reserved">if</span> (!methods) {
    Object.extend(Form, Form.Methods);
    Object.extend(Form.Element, Form.Element.Methods);
    Object.extend(Element.Methods.ByTag, {
      <span class="literal">"FORM"</span>:     Object.clone(Form.Methods),
      <span class="literal">"INPUT"</span>:    Object.clone(Form.Element.Methods),
      <span class="literal">"SELECT"</span>:   Object.clone(Form.Element.Methods),
      <span class="literal">"TEXTAREA"</span>: Object.clone(Form.Element.Methods)
    });
  }

  <span class="reserved">if</span> (arguments.length == 2) {
    var tagName = methods;
    methods = arguments[1];
  }

  <span class="reserved">if</span> (!tagName) Object.extend(Element.Methods, methods || { });
  <span class="reserved">else</span> {
    <span class="reserved">if</span> (Object.isArray(tagName)) tagName.each(extend);
    <span class="reserved">else</span> extend(tagName);
  }

  <span class="reserved">function</span> extend(tagName) {
    tagName = tagName.toUpperCase();
    <span class="reserved">if</span> (!Element.Methods.ByTag[tagName])
      Element.Methods.ByTag[tagName] = { };
    Object.extend(Element.Methods.ByTag[tagName], methods);
  }

  <span class="reserved">function</span> copy(methods, destination, onlyIfAbsent) {
    onlyIfAbsent = onlyIfAbsent || false;
    <span class="reserved">for</span> (var property in methods) {
      var value = methods[property];
      <span class="reserved">if</span> (!Object.isFunction(value)) continue;
      <span class="reserved">if</span> (!onlyIfAbsent || !(property in destination))
        destination[property] = value.methodize();
    }
  }

  <span class="reserved">function</span> findDOMClass(tagName) {
    var klass;
    var trans = {
      <span class="literal">"OPTGROUP"</span>: <span class="literal">"OptGroup"</span>, <span class="literal">"TEXTAREA"</span>: <span class="literal">"TextArea"</span>, <span class="literal">"P"</span>: <span class="literal">"Paragraph"</span>,
      <span class="literal">"FIELDSET"</span>: <span class="literal">"FieldSet"</span>, <span class="literal">"UL"</span>: <span class="literal">"UList"</span>, <span class="literal">"OL"</span>: <span class="literal">"OList"</span>, <span class="literal">"DL"</span>: <span class="literal">"DList"</span>,
      <span class="literal">"DIR"</span>: <span class="literal">"Directory"</span>, <span class="literal">"H1"</span>: <span class="literal">"Heading"</span>, <span class="literal">"H2"</span>: <span class="literal">"Heading"</span>, <span class="literal">"H3"</span>: <span class="literal">"Heading"</span>,
      <span class="literal">"H4"</span>: <span class="literal">"Heading"</span>, <span class="literal">"H5"</span>: <span class="literal">"Heading"</span>, <span class="literal">"H6"</span>: <span class="literal">"Heading"</span>, <span class="literal">"Q"</span>: <span class="literal">"Quote"</span>,
      <span class="literal">"INS"</span>: <span class="literal">"Mod"</span>, <span class="literal">"DEL"</span>: <span class="literal">"Mod"</span>, <span class="literal">"A"</span>: <span class="literal">"Anchor"</span>, <span class="literal">"IMG"</span>: <span class="literal">"Image"</span>, <span class="literal">"CAPTION"</span>:
      <span class="literal">"TableCaption"</span>, <span class="literal">"COL"</span>: <span class="literal">"TableCol"</span>, <span class="literal">"COLGROUP"</span>: <span class="literal">"TableCol"</span>, <span class="literal">"THEAD"</span>:
      <span class="literal">"TableSection"</span>, <span class="literal">"TFOOT"</span>: <span class="literal">"TableSection"</span>, <span class="literal">"TBODY"</span>: <span class="literal">"TableSection"</span>, <span class="literal">"TR"</span>:
      <span class="literal">"TableRow"</span>, <span class="literal">"TH"</span>: <span class="literal">"TableCell"</span>, <span class="literal">"TD"</span>: <span class="literal">"TableCell"</span>, <span class="literal">"FRAMESET"</span>:
      <span class="literal">"FrameSet"</span>, <span class="literal">"IFRAME"</span>: <span class="literal">"IFrame"</span>
    };
    <span class="reserved">if</span> (trans[tagName]) klass = <span class="literal">'HTML'</span> + trans[tagName] + <span class="literal">'Element'</span>;
    <span class="reserved">if</span> (window[klass]) <span class="reserved">return</span> window[klass];
    klass = <span class="literal">'HTML'</span> + tagName + <span class="literal">'Element'</span>;
    <span class="reserved">if</span> (window[klass]) <span class="reserved">return</span> window[klass];
    klass = <span class="literal">'HTML'</span> + tagName.capitalize() + <span class="literal">'Element'</span>;
    <span class="reserved">if</span> (window[klass]) <span class="reserved">return</span> window[klass];

    window[klass] = { };
    window[klass].<span class="reserved">prototype</span> = document.createElement(tagName).__proto__;
    <span class="reserved">return</span> window[klass];
  }

  <span class="reserved">if</span> (F.ElementExtensions) {
    copy(Element.Methods, HTMLElement.<span class="reserved">prototype</span>);
    copy(Element.Methods.Simulated, HTMLElement.<span class="reserved">prototype</span>, true);
  }

  <span class="reserved">if</span> (F.SpecificElementExtensions) {
    <span class="reserved">for</span> (var tag in Element.Methods.ByTag) {
      var klass = findDOMClass(tag);
      <span class="reserved">if</span> (Object.isUndefined(klass)) continue;
      copy(T[tag], klass.<span class="reserved">prototype</span>);
    }
  }

  Object.extend(Element, Element.Methods);
  delete Element.ByTag;

  <span class="reserved">if</span> (Element.extend.refresh) Element.extend.refresh();
  Element.cache = { };
};

document.viewport = {
  getDimensions: <span class="reserved">function</span>() {
    var dimensions = { };
    var B = Prototype.Browser;
    $w(<span class="literal">'width height'</span>).each(<span class="reserved">function</span>(d) {
      var D = d.capitalize();
      dimensions[d] = (B.WebKit &amp;&amp; !document.evaluate) ? self[<span class="literal">'inner'</span> + D] :
        (B.Opera) ? document.body[<span class="literal">'client'</span> + D] : document.documentElement[<span class="literal">'client'</span> + D];
    });
    <span class="reserved">return</span> dimensions;
  },

  getWidth: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.getDimensions().width;
  },

  getHeight: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.getDimensions().height;
  },

  getScrollOffsets: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Element._returnOffset(
      window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft,
      window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop);
  }
};
<span class="comment">/* Portions of the Selector class are derived from Jack Slocums DomQuery,
 * part of YUI-Ext version 0.40, distributed under the terms of an MIT-style
 * license.  Please see http://www.yui-ext.com/ for more information. */</span>

var Selector = Class.create({
  initialize: <span class="reserved">function</span>(expression) {
    <span class="reserved">this</span>.expression = expression.strip();
    <span class="reserved">this</span>.compileMatcher();
  },

  shouldUseXPath: <span class="reserved">function</span>() {
    <span class="reserved">if</span> (!Prototype.BrowserFeatures.XPath) <span class="reserved">return</span> false;

    var e = <span class="reserved">this</span>.expression;

    <span class="comment">// Safari 3 chokes on :*-of-type and :empty</span>
    <span class="reserved">if</span> (Prototype.Browser.WebKit &amp;&amp;
     (e.include(<span class="literal">"-of-type"</span>) || e.include(<span class="literal">":empty"</span>)))
      <span class="reserved">return</span> false;

    <span class="comment">// XPath can't do namespaced attributes, nor can it read</span>
    <span class="comment">// the "checked" property from DOM nodes</span>
    <span class="reserved">if</span> ((/(\[[\w-]*?:|:checked)/).test(<span class="reserved">this</span>.expression))
      <span class="reserved">return</span> false;

    <span class="reserved">return</span> true;
  },

  compileMatcher: <span class="reserved">function</span>() {
    <span class="reserved">if</span> (<span class="reserved">this</span>.shouldUseXPath())
      <span class="reserved">return</span> <span class="reserved">this</span>.compileXPathMatcher();

    var e = <span class="reserved">this</span>.expression, ps = Selector.patterns, h = Selector.handlers,
        c = Selector.criteria, le, p, m;

    <span class="reserved">if</span> (Selector._cache[e]) {
      <span class="reserved">this</span>.matcher = Selector._cache[e];
      <span class="reserved">return</span>;
    }

    <span class="reserved">this</span>.matcher = [<span class="literal">"this.matcher = function(root) {"</span>,
                    <span class="literal">"var r = root, h = Selector.handlers, c = false, n;"</span>];

    <span class="reserved">while</span> (e &amp;&amp; le != e &amp;&amp; (/\S/).test(e)) {
      le = e;
      <span class="reserved">for</span> (var i in ps) {
        p = ps[i];
        <span class="reserved">if</span> (m = e.match(p)) {
          <span class="reserved">this</span>.matcher.push(Object.isFunction(c[i]) ? c[i](m) :
    	      new Template(c[i]).evaluate(m));
          e = e.replace(m[0], <span class="literal">''</span>);
          break;
        }
      }
    }

    <span class="reserved">this</span>.matcher.push(<span class="literal">"return h.unique(n);\n}"</span>);
    eval(<span class="reserved">this</span>.matcher.join(<span class="literal">'\n'</span>));
    Selector._cache[<span class="reserved">this</span>.expression] = <span class="reserved">this</span>.matcher;
  },

  compileXPathMatcher: <span class="reserved">function</span>() {
    var e = <span class="reserved">this</span>.expression, ps = Selector.patterns,
        x = Selector.xpath, le, m;

    <span class="reserved">if</span> (Selector._cache[e]) {
      <span class="reserved">this</span>.xpath = Selector._cache[e]; <span class="reserved">return</span>;
    }

    <span class="reserved">this</span>.matcher = [<span class="literal">'.//*'</span>];
    <span class="reserved">while</span> (e &amp;&amp; le != e &amp;&amp; (/\S/).test(e)) {
      le = e;
      <span class="reserved">for</span> (var i in ps) {
        <span class="reserved">if</span> (m = e.match(ps[i])) {
          <span class="reserved">this</span>.matcher.push(Object.isFunction(x[i]) ? x[i](m) :
            new Template(x[i]).evaluate(m));
          e = e.replace(m[0], <span class="literal">''</span>);
          break;
        }
      }
    }

    <span class="reserved">this</span>.xpath = <span class="reserved">this</span>.matcher.join(<span class="literal">''</span>);
    Selector._cache[<span class="reserved">this</span>.expression] = <span class="reserved">this</span>.xpath;
  },

  findElements: <span class="reserved">function</span>(root) {
    root = root || document;
    <span class="reserved">if</span> (<span class="reserved">this</span>.xpath) <span class="reserved">return</span> document._getElementsByXPath(<span class="reserved">this</span>.xpath, root);
    <span class="reserved">return</span> <span class="reserved">this</span>.matcher(root);
  },

  match: <span class="reserved">function</span>(element) {
    <span class="reserved">this</span>.tokens = [];

    var e = <span class="reserved">this</span>.expression, ps = Selector.patterns, as = Selector.assertions;
    var le, p, m;

    <span class="reserved">while</span> (e &amp;&amp; le !== e &amp;&amp; (/\S/).test(e)) {
      le = e;
      <span class="reserved">for</span> (var i in ps) {
        p = ps[i];
        <span class="reserved">if</span> (m = e.match(p)) {
          <span class="comment">// use the Selector.assertions methods unless the selector</span>
          <span class="comment">// is too complex.</span>
          <span class="reserved">if</span> (as[i]) {
            <span class="reserved">this</span>.tokens.push([i, Object.clone(m)]);
            e = e.replace(m[0], <span class="literal">''</span>);
          } <span class="reserved">else</span> {
            <span class="comment">// reluctantly do a document-wide search</span>
            <span class="comment">// and look for a match in the array</span>
            <span class="reserved">return</span> <span class="reserved">this</span>.findElements(document).include(element);
          }
        }
      }
    }

    var match = true, name, matches;
    <span class="reserved">for</span> (var i = 0, token; token = <span class="reserved">this</span>.tokens[i]; i++) {
      name = token[0], matches = token[1];
      <span class="reserved">if</span> (!Selector.assertions[name](element, matches)) {
        match = false; break;
      }
    }

    <span class="reserved">return</span> match;
  },

  toString: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.expression;
  },

  inspect: <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="literal">"#&lt;Selector:"</span> + <span class="reserved">this</span>.expression.inspect() + <span class="literal">"&gt;"</span>;
  }
});

Object.extend(Selector, {
  _cache: { },

  xpath: {
    descendant:   <span class="literal">"//*"</span>,
    child:        <span class="literal">"/*"</span>,
    adjacent:     <span class="literal">"/following-sibling::*[1]"</span>,
    laterSibling: <span class="literal">'/following-sibling::*'</span>,
    tagName:      <span class="reserved">function</span>(m) {
      <span class="reserved">if</span> (m[1] == <span class="literal">'*'</span>) <span class="reserved">return</span> <span class="literal">''</span>;
      <span class="reserved">return</span> <span class="literal">"[local-name()='"</span> + m[1].toLowerCase() +
             <span class="literal">"' or local-name()='"</span> + m[1].toUpperCase() + <span class="literal">"']"</span>;
    },
    className:    <span class="literal">"[contains(concat(' ', @class, ' '), ' #{1} ')]"</span>,
    id:           <span class="literal">"[@id='#{1}']"</span>,
    attrPresence: <span class="reserved">function</span>(m) {
      m[1] = m[1].toLowerCase();
      <span class="reserved">return</span> new Template(<span class="literal">"[@#{1}]"</span>).evaluate(m);
    },
    attr: <span class="reserved">function</span>(m) {
      m[1] = m[1].toLowerCase();
      m[3] = m[5] || m[6];
      <span class="reserved">return</span> new Template(Selector.xpath.operators[m[2]]).evaluate(m);
    },
    pseudo: <span class="reserved">function</span>(m) {
      var h = Selector.xpath.pseudos[m[1]];
      <span class="reserved">if</span> (!h) <span class="reserved">return</span> <span class="literal">''</span>;
      <span class="reserved">if</span> (Object.isFunction(h)) <span class="reserved">return</span> h(m);
      <span class="reserved">return</span> new Template(Selector.xpath.pseudos[m[1]]).evaluate(m);
    },
    operators: {
      <span class="literal">'='</span>:  <span class="literal">"[@#{1}='#{3}']"</span>,
      <span class="literal">'!='</span>: <span class="literal">"[@#{1}!='#{3}']"</span>,
      <span class="literal">'^='</span>: <span class="literal">"[starts-with(@#{1}, '#{3}')]"</span>,
      <span class="literal">'$='</span>: <span class="literal">"[substring(@#{1}, (string-length(@#{1}) - string-length('#{3}') + 1))='#{3}']"</span>,
      <span class="literal">'*='</span>: <span class="literal">"[contains(@#{1}, '#{3}')]"</span>,
      <span class="literal">'~='</span>: <span class="literal">"[contains(concat(' ', @#{1}, ' '), ' #{3} ')]"</span>,
      <span class="literal">'|='</span>: <span class="literal">"[contains(concat('-', @#{1}, '-'), '-#{3}-')]"</span>
    },
    pseudos: {
      <span class="literal">'first-child'</span>: <span class="literal">'[not(preceding-sibling::*)]'</span>,
      <span class="literal">'last-child'</span>:  <span class="literal">'[not(following-sibling::*)]'</span>,
      <span class="literal">'only-child'</span>:  <span class="literal">'[not(preceding-sibling::* or following-sibling::*)]'</span>,
      <span class="literal">'empty'</span>:       <span class="literal">"[count(*) = 0 and (count(text()) = 0 or translate(text(), ' \t\r\n', '') = '')]"</span>,
      <span class="literal">'checked'</span>:     <span class="literal">"[@checked]"</span>,
      <span class="literal">'disabled'</span>:    <span class="literal">"[@disabled]"</span>,
      <span class="literal">'enabled'</span>:     <span class="literal">"[not(@disabled)]"</span>,
      <span class="literal">'not'</span>: <span class="reserved">function</span>(m) {
        var e = m[6], p = Selector.patterns,
            x = Selector.xpath, le, v;

        var exclusion = [];
        <span class="reserved">while</span> (e &amp;&amp; le != e &amp;&amp; (/\S/).test(e)) {
          le = e;
          <span class="reserved">for</span> (var i in p) {
            <span class="reserved">if</span> (m = e.match(p[i])) {
              v = Object.isFunction(x[i]) ? x[i](m) : new Template(x[i]).evaluate(m);
              exclusion.push(<span class="literal">"("</span> + v.substring(1, v.length - 1) + <span class="literal">")"</span>);
              e = e.replace(m[0], <span class="literal">''</span>);
              break;
            }
          }
        }
        <span class="reserved">return</span> <span class="literal">"[not("</span> + exclusion.join(<span class="literal">" and "</span>) + <span class="literal">")]"</span>;
      },
      <span class="literal">'nth-child'</span>:      <span class="reserved">function</span>(m) {
        <span class="reserved">return</span> Selector.xpath.pseudos.nth(<span class="literal">"(count(./preceding-sibling::*) + 1) "</span>, m);
      },
      <span class="literal">'nth-last-child'</span>: <span class="reserved">function</span>(m) {
        <span class="reserved">return</span> Selector.xpath.pseudos.nth(<span class="literal">"(count(./following-sibling::*) + 1) "</span>, m);
      },
      <span class="literal">'nth-of-type'</span>:    <span class="reserved">function</span>(m) {
        <span class="reserved">return</span> Selector.xpath.pseudos.nth(<span class="literal">"position() "</span>, m);
      },
      <span class="literal">'nth-last-of-type'</span>: <span class="reserved">function</span>(m) {
        <span class="reserved">return</span> Selector.xpath.pseudos.nth(<span class="literal">"(last() + 1 - position()) "</span>, m);
      },
      <span class="literal">'first-of-type'</span>:  <span class="reserved">function</span>(m) {
        m[6] = <span class="literal">"1"</span>; <span class="reserved">return</span> Selector.xpath.pseudos[<span class="literal">'nth-of-type'</span>](m);
      },
      <span class="literal">'last-of-type'</span>:   <span class="reserved">function</span>(m) {
        m[6] = <span class="literal">"1"</span>; <span class="reserved">return</span> Selector.xpath.pseudos[<span class="literal">'nth-last-of-type'</span>](m);
      },
      <span class="literal">'only-of-type'</span>:   <span class="reserved">function</span>(m) {
        var p = Selector.xpath.pseudos; <span class="reserved">return</span> p[<span class="literal">'first-of-type'</span>](m) + p[<span class="literal">'last-of-type'</span>](m);
      },
      nth: <span class="reserved">function</span>(fragment, m) {
        var mm, formula = m[6], predicate;
        <span class="reserved">if</span> (formula == <span class="literal">'even'</span>) formula = <span class="literal">'2n+0'</span>;
        <span class="reserved">if</span> (formula == <span class="literal">'odd'</span>)  formula = <span class="literal">'2n+1'</span>;
        <span class="reserved">if</span> (mm = formula.match(/^(\d+)$/)) <span class="comment">// digit only</span>
          <span class="reserved">return</span> <span class="literal">'['</span> + fragment + <span class="literal">"= "</span> + mm[1] + <span class="literal">']'</span>;
        <span class="reserved">if</span> (mm = formula.match(/^(-?\d*)?n(([+-])(\d+))?/)) { <span class="comment">// an+b</span>
          <span class="reserved">if</span> (mm[1] == <span class="literal">"-"</span>) mm[1] = -1;
          var a = mm[1] ? Number(mm[1]) : 1;
          var b = mm[2] ? Number(mm[2]) : 0;
          predicate = <span class="literal">"[((#{fragment} - #{b}) mod #{a} = 0) and "</span> +
          <span class="literal">"((#{fragment} - #{b}) div #{a} &gt;= 0)]"</span>;
          <span class="reserved">return</span> new Template(predicate).evaluate({
            fragment: fragment, a: a, b: b });
        }
      }
    }
  },

  criteria: {
    tagName:      <span class="literal">'n = h.tagName(n, r, "#{1}", c);      c = false;'</span>,
    className:    <span class="literal">'n = h.className(n, r, "#{1}", c);    c = false;'</span>,
    id:           <span class="literal">'n = h.id(n, r, "#{1}", c);           c = false;'</span>,
    attrPresence: <span class="literal">'n = h.attrPresence(n, r, "#{1}", c); c = false;'</span>,
    attr: <span class="reserved">function</span>(m) {
      m[3] = (m[5] || m[6]);
      <span class="reserved">return</span> new Template(<span class="literal">'n = h.attr(n, r, "#{1}", "#{3}", "#{2}", c); c = false;'</span>).evaluate(m);
    },
    pseudo: <span class="reserved">function</span>(m) {
      <span class="reserved">if</span> (m[6]) m[6] = m[6].replace(/<span class="literal">"/g, '\\"</span><span class="literal">');
      return new Template('</span>n = h.pseudo(n, <span class="literal">"#{1}"</span>, <span class="literal">"#{6}"</span>, r, c); c = false;<span class="literal">').evaluate(m);
    },
    descendant:   '</span>c = <span class="literal">"descendant"</span>;<span class="literal">',
    child:        '</span>c = <span class="literal">"child"</span>;<span class="literal">',
    adjacent:     '</span>c = <span class="literal">"adjacent"</span>;<span class="literal">',
    laterSibling: '</span>c = <span class="literal">"laterSibling"</span>;<span class="literal">'
  },

  patterns: {
    // combinators must be listed first
    // (and descendant needs to be last combinator)
    laterSibling: /^\s*~\s*/,
    child:        /^\s*&gt;\s*/,
    adjacent:     /^\s*\+\s*/,
    descendant:   /^\s/,

    // selectors follow
    tagName:      /^\s*(\*|[\w\-]+)(\b|$)?/,
    id:           /^#([\w\-\*]+)(\b|$)/,
    className:    /^\.([\w\-\*]+)(\b|$)/,
    pseudo:
/^:((first|last|nth|nth-last|only)(-child|-of-type)|empty|checked|(en|dis)abled|not)(\((.*?)\))?(\b|$|(?=\s|[:+~&gt;]))/,
    attrPresence: /^\[([\w]+)\]/,
    attr:         /\[((?:[\w-]*:)?[\w-]+)\s*(?:([!^$*~|]?=)\s*((['</span><span class="literal">"])([^\4]*?)\4|([^'"</span>][^\]]*?)))?\]/
  },

  <span class="comment">// for Selector.match and Element#match</span>
  assertions: {
    tagName: <span class="reserved">function</span>(element, matches) {
      <span class="reserved">return</span> matches[1].toUpperCase() == element.tagName.toUpperCase();
    },

    className: <span class="reserved">function</span>(element, matches) {
      <span class="reserved">return</span> Element.hasClassName(element, matches[1]);
    },

    id: <span class="reserved">function</span>(element, matches) {
      <span class="reserved">return</span> element.id === matches[1];
    },

    attrPresence: <span class="reserved">function</span>(element, matches) {
      <span class="reserved">return</span> Element.hasAttribute(element, matches[1]);
    },

    attr: <span class="reserved">function</span>(element, matches) {
      var nodeValue = Element.readAttribute(element, matches[1]);
      <span class="reserved">return</span> nodeValue &amp;&amp; Selector.operators[matches[2]](nodeValue, matches[5] || matches[6]);
    }
  },

  handlers: {
    <span class="comment">// UTILITY FUNCTIONS</span>
    <span class="comment">// joins two collections</span>
    concat: <span class="reserved">function</span>(a, b) {
      <span class="reserved">for</span> (var i = 0, node; node = b[i]; i++)
        a.push(node);
      <span class="reserved">return</span> a;
    },

    <span class="comment">// marks an array of nodes for counting</span>
    mark: <span class="reserved">function</span>(nodes) {
      var _true = Prototype.emptyFunction;
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
        node._countedByPrototype = _true;
      <span class="reserved">return</span> nodes;
    },

    unmark: <span class="reserved">function</span>(nodes) {
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
        node._countedByPrototype = undefined;
      <span class="reserved">return</span> nodes;
    },

    <span class="comment">// mark each child node with its position (for nth calls)</span>
    <span class="comment">// "ofType" flag indicates whether we're indexing for nth-of-type</span>
    <span class="comment">// rather than nth-child</span>
    index: <span class="reserved">function</span>(parentNode, reverse, ofType) {
      parentNode._countedByPrototype = Prototype.emptyFunction;
      <span class="reserved">if</span> (reverse) {
        <span class="reserved">for</span> (var nodes = parentNode.childNodes, i = nodes.length - 1, j = 1; i &gt;= 0; i--) {
          var node = nodes[i];
          <span class="reserved">if</span> (node.nodeType == 1 &amp;&amp; (!ofType || node._countedByPrototype)) node.nodeIndex = j++;
        }
      } <span class="reserved">else</span> {
        <span class="reserved">for</span> (var i = 0, j = 1, nodes = parentNode.childNodes; node = nodes[i]; i++)
          <span class="reserved">if</span> (node.nodeType == 1 &amp;&amp; (!ofType || node._countedByPrototype)) node.nodeIndex = j++;
      }
    },

    <span class="comment">// filters out duplicates and extends all nodes</span>
    unique: <span class="reserved">function</span>(nodes) {
      <span class="reserved">if</span> (nodes.length == 0) <span class="reserved">return</span> nodes;
      var results = [], n;
      <span class="reserved">for</span> (var i = 0, l = nodes.length; i &lt; l; i++)
        <span class="reserved">if</span> (!(n = nodes[i])._countedByPrototype) {
          n._countedByPrototype = Prototype.emptyFunction;
          results.push(Element.extend(n));
        }
      <span class="reserved">return</span> Selector.handlers.unmark(results);
    },

    <span class="comment">// COMBINATOR FUNCTIONS</span>
    descendant: <span class="reserved">function</span>(nodes) {
      var h = Selector.handlers;
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        h.concat(results, node.getElementsByTagName(<span class="literal">'*'</span>));
      <span class="reserved">return</span> results;
    },

    child: <span class="reserved">function</span>(nodes) {
      var h = Selector.handlers;
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++) {
        <span class="reserved">for</span> (var j = 0, child; child = node.childNodes[j]; j++)
          <span class="reserved">if</span> (child.nodeType == 1 &amp;&amp; child.tagName != <span class="literal">'!'</span>) results.push(child);
      }
      <span class="reserved">return</span> results;
    },

    adjacent: <span class="reserved">function</span>(nodes) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++) {
        var next = <span class="reserved">this</span>.nextElementSibling(node);
        <span class="reserved">if</span> (next) results.push(next);
      }
      <span class="reserved">return</span> results;
    },

    laterSibling: <span class="reserved">function</span>(nodes) {
      var h = Selector.handlers;
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        h.concat(results, Element.nextSiblings(node));
      <span class="reserved">return</span> results;
    },

    nextElementSibling: <span class="reserved">function</span>(node) {
      <span class="reserved">while</span> (node = node.nextSibling)
	      <span class="reserved">if</span> (node.nodeType == 1) <span class="reserved">return</span> node;
      <span class="reserved">return</span> null;
    },

    previousElementSibling: <span class="reserved">function</span>(node) {
      <span class="reserved">while</span> (node = node.previousSibling)
        <span class="reserved">if</span> (node.nodeType == 1) <span class="reserved">return</span> node;
      <span class="reserved">return</span> null;
    },

    <span class="comment">// TOKEN FUNCTIONS</span>
    tagName: <span class="reserved">function</span>(nodes, root, tagName, combinator) {
      var uTagName = tagName.toUpperCase();
      var results = [], h = Selector.handlers;
      <span class="reserved">if</span> (nodes) {
        <span class="reserved">if</span> (combinator) {
          <span class="comment">// fastlane for ordinary descendant combinators</span>
          <span class="reserved">if</span> (combinator == <span class="literal">"descendant"</span>) {
            <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
              h.concat(results, node.getElementsByTagName(tagName));
            <span class="reserved">return</span> results;
          } <span class="reserved">else</span> nodes = <span class="reserved">this</span>[combinator](nodes);
          <span class="reserved">if</span> (tagName == <span class="literal">"*"</span>) <span class="reserved">return</span> nodes;
        }
        <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
          <span class="reserved">if</span> (node.tagName.toUpperCase() === uTagName) results.push(node);
        <span class="reserved">return</span> results;
      } <span class="reserved">else</span> <span class="reserved">return</span> root.getElementsByTagName(tagName);
    },

    id: <span class="reserved">function</span>(nodes, root, id, combinator) {
      var targetNode = $(id), h = Selector.handlers;
      <span class="reserved">if</span> (!targetNode) <span class="reserved">return</span> [];
      <span class="reserved">if</span> (!nodes &amp;&amp; root == document) <span class="reserved">return</span> [targetNode];
      <span class="reserved">if</span> (nodes) {
        <span class="reserved">if</span> (combinator) {
          <span class="reserved">if</span> (combinator == <span class="literal">'child'</span>) {
            <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
              <span class="reserved">if</span> (targetNode.parentNode == node) <span class="reserved">return</span> [targetNode];
          } <span class="reserved">else</span> <span class="reserved">if</span> (combinator == <span class="literal">'descendant'</span>) {
            <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
              <span class="reserved">if</span> (Element.descendantOf(targetNode, node)) <span class="reserved">return</span> [targetNode];
          } <span class="reserved">else</span> <span class="reserved">if</span> (combinator == <span class="literal">'adjacent'</span>) {
            <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
              <span class="reserved">if</span> (Selector.handlers.previousElementSibling(targetNode) == node)
                <span class="reserved">return</span> [targetNode];
          } <span class="reserved">else</span> nodes = h[combinator](nodes);
        }
        <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
          <span class="reserved">if</span> (node == targetNode) <span class="reserved">return</span> [targetNode];
        <span class="reserved">return</span> [];
      }
      <span class="reserved">return</span> (targetNode &amp;&amp; Element.descendantOf(targetNode, root)) ? [targetNode] : [];
    },

    className: <span class="reserved">function</span>(nodes, root, className, combinator) {
      <span class="reserved">if</span> (nodes &amp;&amp; combinator) nodes = <span class="reserved">this</span>[combinator](nodes);
      <span class="reserved">return</span> Selector.handlers.byClassName(nodes, root, className);
    },

    byClassName: <span class="reserved">function</span>(nodes, root, className) {
      <span class="reserved">if</span> (!nodes) nodes = Selector.handlers.descendant([root]);
      var needle = <span class="literal">' '</span> + className + <span class="literal">' '</span>;
      <span class="reserved">for</span> (var i = 0, results = [], node, nodeClassName; node = nodes[i]; i++) {
        nodeClassName = node.className;
        <span class="reserved">if</span> (nodeClassName.length == 0) continue;
        <span class="reserved">if</span> (nodeClassName == className || (<span class="literal">' '</span> + nodeClassName + <span class="literal">' '</span>).include(needle))
          results.push(node);
      }
      <span class="reserved">return</span> results;
    },

    attrPresence: <span class="reserved">function</span>(nodes, root, attr, combinator) {
      <span class="reserved">if</span> (!nodes) nodes = root.getElementsByTagName(<span class="literal">"*"</span>);
      <span class="reserved">if</span> (nodes &amp;&amp; combinator) nodes = <span class="reserved">this</span>[combinator](nodes);
      var results = [];
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
        <span class="reserved">if</span> (Element.hasAttribute(node, attr)) results.push(node);
      <span class="reserved">return</span> results;
    },

    attr: <span class="reserved">function</span>(nodes, root, attr, value, operator, combinator) {
      <span class="reserved">if</span> (!nodes) nodes = root.getElementsByTagName(<span class="literal">"*"</span>);
      <span class="reserved">if</span> (nodes &amp;&amp; combinator) nodes = <span class="reserved">this</span>[combinator](nodes);
      var handler = Selector.operators[operator], results = [];
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++) {
        var nodeValue = Element.readAttribute(node, attr);
        <span class="reserved">if</span> (nodeValue === null) continue;
        <span class="reserved">if</span> (handler(nodeValue, value)) results.push(node);
      }
      <span class="reserved">return</span> results;
    },

    pseudo: <span class="reserved">function</span>(nodes, name, value, root, combinator) {
      <span class="reserved">if</span> (nodes &amp;&amp; combinator) nodes = <span class="reserved">this</span>[combinator](nodes);
      <span class="reserved">if</span> (!nodes) nodes = root.getElementsByTagName(<span class="literal">"*"</span>);
      <span class="reserved">return</span> Selector.pseudos[name](nodes, value, root);
    }
  },

  pseudos: {
    <span class="literal">'first-child'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++) {
        <span class="reserved">if</span> (Selector.handlers.previousElementSibling(node)) continue;
          results.push(node);
      }
      <span class="reserved">return</span> results;
    },
    <span class="literal">'last-child'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++) {
        <span class="reserved">if</span> (Selector.handlers.nextElementSibling(node)) continue;
          results.push(node);
      }
      <span class="reserved">return</span> results;
    },
    <span class="literal">'only-child'</span>: <span class="reserved">function</span>(nodes, value, root) {
      var h = Selector.handlers;
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        <span class="reserved">if</span> (!h.previousElementSibling(node) &amp;&amp; !h.nextElementSibling(node))
          results.push(node);
      <span class="reserved">return</span> results;
    },
    <span class="literal">'nth-child'</span>:        <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, formula, root);
    },
    <span class="literal">'nth-last-child'</span>:   <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, formula, root, true);
    },
    <span class="literal">'nth-of-type'</span>:      <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, formula, root, false, true);
    },
    <span class="literal">'nth-last-of-type'</span>: <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, formula, root, true, true);
    },
    <span class="literal">'first-of-type'</span>:    <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, <span class="literal">"1"</span>, root, false, true);
    },
    <span class="literal">'last-of-type'</span>:     <span class="reserved">function</span>(nodes, formula, root) {
      <span class="reserved">return</span> Selector.pseudos.nth(nodes, <span class="literal">"1"</span>, root, true, true);
    },
    <span class="literal">'only-of-type'</span>:     <span class="reserved">function</span>(nodes, formula, root) {
      var p = Selector.pseudos;
      <span class="reserved">return</span> p[<span class="literal">'last-of-type'</span>](p[<span class="literal">'first-of-type'</span>](nodes, formula, root), formula, root);
    },

    <span class="comment">// handles the an+b logic</span>
    getIndices: <span class="reserved">function</span>(a, b, total) {
      <span class="reserved">if</span> (a == 0) <span class="reserved">return</span> b &gt; 0 ? [b] : [];
      <span class="reserved">return</span> $R(1, total).inject([], <span class="reserved">function</span>(memo, i) {
        <span class="reserved">if</span> (0 == (i - b) % a &amp;&amp; (i - b) / a &gt;= 0) memo.push(i);
        <span class="reserved">return</span> memo;
      });
    },

    <span class="comment">// handles nth(-last)-child, nth(-last)-of-type, and (first|last)-of-type</span>
    nth: <span class="reserved">function</span>(nodes, formula, root, reverse, ofType) {
      <span class="reserved">if</span> (nodes.length == 0) <span class="reserved">return</span> [];
      <span class="reserved">if</span> (formula == <span class="literal">'even'</span>) formula = <span class="literal">'2n+0'</span>;
      <span class="reserved">if</span> (formula == <span class="literal">'odd'</span>)  formula = <span class="literal">'2n+1'</span>;
      var h = Selector.handlers, results = [], indexed = [], m;
      h.mark(nodes);
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++) {
        <span class="reserved">if</span> (!node.parentNode._countedByPrototype) {
          h.index(node.parentNode, reverse, ofType);
          indexed.push(node.parentNode);
        }
      }
      <span class="reserved">if</span> (formula.match(/^\d+$/)) { <span class="comment">// just a number</span>
        formula = Number(formula);
        <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
          <span class="reserved">if</span> (node.nodeIndex == formula) results.push(node);
      } <span class="reserved">else</span> <span class="reserved">if</span> (m = formula.match(/^(-?\d*)?n(([+-])(\d+))?/)) { <span class="comment">// an+b</span>
        <span class="reserved">if</span> (m[1] == <span class="literal">"-"</span>) m[1] = -1;
        var a = m[1] ? Number(m[1]) : 1;
        var b = m[2] ? Number(m[2]) : 0;
        var indices = Selector.pseudos.getIndices(a, b, nodes.length);
        <span class="reserved">for</span> (var i = 0, node, l = indices.length; node = nodes[i]; i++) {
          <span class="reserved">for</span> (var j = 0; j &lt; l; j++)
            <span class="reserved">if</span> (node.nodeIndex == indices[j]) results.push(node);
        }
      }
      h.unmark(nodes);
      h.unmark(indexed);
      <span class="reserved">return</span> results;
    },

    <span class="literal">'empty'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++) {
        <span class="comment">// IE treats comments as element nodes</span>
        <span class="reserved">if</span> (node.tagName == <span class="literal">'!'</span> || (node.firstChild &amp;&amp; !node.innerHTML.match(/^\s*$/))) continue;
        results.push(node);
      }
      <span class="reserved">return</span> results;
    },

    <span class="literal">'not'</span>: <span class="reserved">function</span>(nodes, selector, root) {
      var h = Selector.handlers, selectorType, m;
      var exclusions = new Selector(selector).findElements(root);
      h.mark(exclusions);
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        <span class="reserved">if</span> (!node._countedByPrototype) results.push(node);
      h.unmark(exclusions);
      <span class="reserved">return</span> results;
    },

    <span class="literal">'enabled'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        <span class="reserved">if</span> (!node.disabled) results.push(node);
      <span class="reserved">return</span> results;
    },

    <span class="literal">'disabled'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        <span class="reserved">if</span> (node.disabled) results.push(node);
      <span class="reserved">return</span> results;
    },

    <span class="literal">'checked'</span>: <span class="reserved">function</span>(nodes, value, root) {
      <span class="reserved">for</span> (var i = 0, results = [], node; node = nodes[i]; i++)
        <span class="reserved">if</span> (node.checked) results.push(node);
      <span class="reserved">return</span> results;
    }
  },

  operators: {
    <span class="literal">'='</span>:  <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> nv == v; },
    <span class="literal">'!='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> nv != v; },
    <span class="literal">'^='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> nv.startsWith(v); },
    <span class="literal">'$='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> nv.endsWith(v); },
    <span class="literal">'*='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> nv.include(v); },
    <span class="literal">'~='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> (<span class="literal">' '</span> + nv + <span class="literal">' '</span>).include(<span class="literal">' '</span> + v + <span class="literal">' '</span>); },
    <span class="literal">'|='</span>: <span class="reserved">function</span>(nv, v) { <span class="reserved">return</span> (<span class="literal">'-'</span> + nv.toUpperCase() + <span class="literal">'-'</span>).include(<span class="literal">'-'</span> + v.toUpperCase() + <span class="literal">'-'</span>); }
  },

  split: <span class="reserved">function</span>(expression) {
    var expressions = [];
    expression.scan(/(([\w#:.~&gt;+()\s-]+|\*|\[.*?\])+)\s*(,|$)/, <span class="reserved">function</span>(m) {
      expressions.push(m[1].strip());
    });
    <span class="reserved">return</span> expressions;
  },

  matchElements: <span class="reserved">function</span>(elements, expression) {
    var matches = $$(expression), h = Selector.handlers;
    h.mark(matches);
    <span class="reserved">for</span> (var i = 0, results = [], element; element = elements[i]; i++)
      <span class="reserved">if</span> (element._countedByPrototype) results.push(element);
    h.unmark(matches);
    <span class="reserved">return</span> results;
  },

  findElement: <span class="reserved">function</span>(elements, expression, index) {
    <span class="reserved">if</span> (Object.isNumber(expression)) {
      index = expression; expression = false;
    }
    <span class="reserved">return</span> Selector.matchElements(elements, expression || <span class="literal">'*'</span>)[index || 0];
  },

  findChildElements: <span class="reserved">function</span>(element, expressions) {
    expressions = Selector.split(expressions.join(<span class="literal">','</span>));
    var results = [], h = Selector.handlers;
    <span class="reserved">for</span> (var i = 0, l = expressions.length, selector; i &lt; l; i++) {
      selector = new Selector(expressions[i].strip());
      h.concat(results, selector.findElements(element));
    }
    <span class="reserved">return</span> (l &gt; 1) ? h.unique(results) : results;
  }
});

<span class="reserved">if</span> (Prototype.Browser.IE) {
  Object.extend(Selector.handlers, {
    <span class="comment">// IE returns comment nodes on getElementsByTagName("*").</span>
    <span class="comment">// Filter them out.</span>
    concat: <span class="reserved">function</span>(a, b) {
      <span class="reserved">for</span> (var i = 0, node; node = b[i]; i++)
        <span class="reserved">if</span> (node.tagName !== <span class="literal">"!"</span>) a.push(node);
      <span class="reserved">return</span> a;
    },

    <span class="comment">// IE improperly serializes _countedByPrototype in (inner|outer)HTML.</span>
    unmark: <span class="reserved">function</span>(nodes) {
      <span class="reserved">for</span> (var i = 0, node; node = nodes[i]; i++)
        node.removeAttribute(<span class="literal">'_countedByPrototype'</span>);
      <span class="reserved">return</span> nodes;
    }
  });
}

<span class="reserved">function</span> $$() {
  <span class="reserved">return</span> Selector.findChildElements(document, $A(arguments));
}
var Form = {
  reset: <span class="reserved">function</span>(form) {
    $(form).reset();
    <span class="reserved">return</span> form;
  },

  serializeElements: <span class="reserved">function</span>(elements, options) {
    <span class="reserved">if</span> (typeof options != <span class="literal">'object'</span>) options = { hash: !!options };
    <span class="reserved">else</span> <span class="reserved">if</span> (Object.isUndefined(options.hash)) options.hash = true;
    var key, value, submitted = false, submit = options.submit;

    var data = elements.inject({ }, <span class="reserved">function</span>(result, element) {
      <span class="reserved">if</span> (!element.disabled &amp;&amp; element.name) {
        key = element.name; value = $(element).getValue();
        <span class="reserved">if</span> (value != null &amp;&amp; (element.type != <span class="literal">'submit'</span> || (!submitted &amp;&amp;
            submit !== false &amp;&amp; (!submit || key == submit) &amp;&amp; (submitted = true)))) {
          <span class="reserved">if</span> (key in result) {
            <span class="comment">// a key is already present; construct an array of values</span>
            <span class="reserved">if</span> (!Object.isArray(result[key])) result[key] = [result[key]];
            result[key].push(value);
          }
          <span class="reserved">else</span> result[key] = value;
        }
      }
      <span class="reserved">return</span> result;
    });

    <span class="reserved">return</span> options.hash ? data : Object.toQueryString(data);
  }
};

Form.Methods = {
  serialize: <span class="reserved">function</span>(form, options) {
    <span class="reserved">return</span> Form.serializeElements(Form.getElements(form), options);
  },

  getElements: <span class="reserved">function</span>(form) {
    <span class="reserved">return</span> $A($(form).getElementsByTagName(<span class="literal">'*'</span>)).inject([],
      <span class="reserved">function</span>(elements, child) {
        <span class="reserved">if</span> (Form.Element.Serializers[child.tagName.toLowerCase()])
          elements.push(Element.extend(child));
        <span class="reserved">return</span> elements;
      }
    );
  },

  getInputs: <span class="reserved">function</span>(form, typeName, name) {
    form = $(form);
    var inputs = form.getElementsByTagName(<span class="literal">'input'</span>);

    <span class="reserved">if</span> (!typeName &amp;&amp; !name) <span class="reserved">return</span> $A(inputs).map(Element.extend);

    <span class="reserved">for</span> (var i = 0, matchingInputs = [], length = inputs.length; i &lt; length; i++) {
      var input = inputs[i];
      <span class="reserved">if</span> ((typeName &amp;&amp; input.type != typeName) || (name &amp;&amp; input.name != name))
        continue;
      matchingInputs.push(Element.extend(input));
    }

    <span class="reserved">return</span> matchingInputs;
  },

  disable: <span class="reserved">function</span>(form) {
    form = $(form);
    Form.getElements(form).invoke(<span class="literal">'disable'</span>);
    <span class="reserved">return</span> form;
  },

  enable: <span class="reserved">function</span>(form) {
    form = $(form);
    Form.getElements(form).invoke(<span class="literal">'enable'</span>);
    <span class="reserved">return</span> form;
  },

  findFirstElement: <span class="reserved">function</span>(form) {
    var elements = $(form).getElements().findAll(<span class="reserved">function</span>(element) {
      <span class="reserved">return</span> <span class="literal">'hidden'</span> != element.type &amp;&amp; !element.disabled;
    });
    var firstByIndex = elements.findAll(<span class="reserved">function</span>(element) {
      <span class="reserved">return</span> element.hasAttribute(<span class="literal">'tabIndex'</span>) &amp;&amp; element.tabIndex &gt;= 0;
    }).sortBy(<span class="reserved">function</span>(element) { <span class="reserved">return</span> element.tabIndex }).first();

    <span class="reserved">return</span> firstByIndex ? firstByIndex : elements.find(<span class="reserved">function</span>(element) {
      <span class="reserved">return</span> [<span class="literal">'input'</span>, <span class="literal">'select'</span>, <span class="literal">'textarea'</span>].include(element.tagName.toLowerCase());
    });
  },

  focusFirstElement: <span class="reserved">function</span>(form) {
    form = $(form);
    form.findFirstElement().activate();
    <span class="reserved">return</span> form;
  },

  request: <span class="reserved">function</span>(form, options) {
    form = $(form), options = Object.clone(options || { });

    var params = options.parameters, action = form.readAttribute(<span class="literal">'action'</span>) || <span class="literal">''</span>;
    <span class="reserved">if</span> (action.blank()) action = window.location.href;
    options.parameters = form.serialize(true);

    <span class="reserved">if</span> (params) {
      <span class="reserved">if</span> (Object.isString(params)) params = params.toQueryParams();
      Object.extend(options.parameters, params);
    }

    <span class="reserved">if</span> (form.hasAttribute(<span class="literal">'method'</span>) &amp;&amp; !options.method)
      options.method = form.method;

    <span class="reserved">return</span> new Ajax.Request(action, options);
  }
};

<span class="comment">/*--------------------------------------------------------------------------*/</span>

Form.Element = {
  focus: <span class="reserved">function</span>(element) {
    $(element).focus();
    <span class="reserved">return</span> element;
  },

  select: <span class="reserved">function</span>(element) {
    $(element).select();
    <span class="reserved">return</span> element;
  }
};

Form.Element.Methods = {
  serialize: <span class="reserved">function</span>(element) {
    element = $(element);
    <span class="reserved">if</span> (!element.disabled &amp;&amp; element.name) {
      var value = element.getValue();
      <span class="reserved">if</span> (value != undefined) {
        var pair = { };
        pair[element.name] = value;
        <span class="reserved">return</span> Object.toQueryString(pair);
      }
    }
    <span class="reserved">return</span> <span class="literal">''</span>;
  },

  getValue: <span class="reserved">function</span>(element) {
    element = $(element);
    var method = element.tagName.toLowerCase();
    <span class="reserved">return</span> Form.Element.Serializers[method](element);
  },

  setValue: <span class="reserved">function</span>(element, value) {
    element = $(element);
    var method = element.tagName.toLowerCase();
    Form.Element.Serializers[method](element, value);
    <span class="reserved">return</span> element;
  },

  clear: <span class="reserved">function</span>(element) {
    $(element).value = <span class="literal">''</span>;
    <span class="reserved">return</span> element;
  },

  present: <span class="reserved">function</span>(element) {
    <span class="reserved">return</span> $(element).value != <span class="literal">''</span>;
  },

  activate: <span class="reserved">function</span>(element) {
    element = $(element);
    try {
      element.focus();
      <span class="reserved">if</span> (element.select &amp;&amp; (element.tagName.toLowerCase() != <span class="literal">'input'</span> ||
          ![<span class="literal">'button'</span>, <span class="literal">'reset'</span>, <span class="literal">'submit'</span>].include(element.type)))
        element.select();
    } catch (e) { }
    <span class="reserved">return</span> element;
  },

  disable: <span class="reserved">function</span>(element) {
    element = $(element);
    element.blur();
    element.disabled = true;
    <span class="reserved">return</span> element;
  },

  enable: <span class="reserved">function</span>(element) {
    element = $(element);
    element.disabled = false;
    <span class="reserved">return</span> element;
  }
};

<span class="comment">/*--------------------------------------------------------------------------*/</span>

var Field = Form.Element;
var $F = Form.Element.Methods.getValue;

<span class="comment">/*--------------------------------------------------------------------------*/</span>

Form.Element.Serializers = {
  input: <span class="reserved">function</span>(element, value) {
    switch (element.type.toLowerCase()) {
      case <span class="literal">'checkbox'</span>:
      case <span class="literal">'radio'</span>:
        <span class="reserved">return</span> Form.Element.Serializers.inputSelector(element, value);
      default:
        <span class="reserved">return</span> Form.Element.Serializers.textarea(element, value);
    }
  },

  inputSelector: <span class="reserved">function</span>(element, value) {
    <span class="reserved">if</span> (Object.isUndefined(value)) <span class="reserved">return</span> element.checked ? element.value : null;
    <span class="reserved">else</span> element.checked = !!value;
  },

  textarea: <span class="reserved">function</span>(element, value) {
    <span class="reserved">if</span> (Object.isUndefined(value)) <span class="reserved">return</span> element.value;
    <span class="reserved">else</span> element.value = value;
  },

  select: <span class="reserved">function</span>(element, index) {
    <span class="reserved">if</span> (Object.isUndefined(index))
      <span class="reserved">return</span> <span class="reserved">this</span>[element.type == <span class="literal">'select-one'</span> ?
        <span class="literal">'selectOne'</span> : <span class="literal">'selectMany'</span>](element);
    <span class="reserved">else</span> {
      var opt, value, single = !Object.isArray(index);
      <span class="reserved">for</span> (var i = 0, length = element.length; i &lt; length; i++) {
        opt = element.options[i];
        value = <span class="reserved">this</span>.optionValue(opt);
        <span class="reserved">if</span> (single) {
          <span class="reserved">if</span> (value == index) {
            opt.selected = true;
            <span class="reserved">return</span>;
          }
        }
        <span class="reserved">else</span> opt.selected = index.include(value);
      }
    }
  },

  selectOne: <span class="reserved">function</span>(element) {
    var index = element.selectedIndex;
    <span class="reserved">return</span> index &gt;= 0 ? <span class="reserved">this</span>.optionValue(element.options[index]) : null;
  },

  selectMany: <span class="reserved">function</span>(element) {
    var values, length = element.length;
    <span class="reserved">if</span> (!length) <span class="reserved">return</span> null;

    <span class="reserved">for</span> (var i = 0, values = []; i &lt; length; i++) {
      var opt = element.options[i];
      <span class="reserved">if</span> (opt.selected) values.push(<span class="reserved">this</span>.optionValue(opt));
    }
    <span class="reserved">return</span> values;
  },

  optionValue: <span class="reserved">function</span>(opt) {
    <span class="comment">// extend element because hasAttribute may not be native</span>
    <span class="reserved">return</span> Element.extend(opt).hasAttribute(<span class="literal">'value'</span>) ? opt.value : opt.text;
  }
};

<span class="comment">/*--------------------------------------------------------------------------*/</span>

Abstract.TimedObserver = Class.create(PeriodicalExecuter, {
  initialize: <span class="reserved">function</span>($super, element, frequency, callback) {
    $super(callback, frequency);
    <span class="reserved">this</span>.element   = $(element);
    <span class="reserved">this</span>.lastValue = <span class="reserved">this</span>.getValue();
  },

  execute: <span class="reserved">function</span>() {
    var value = <span class="reserved">this</span>.getValue();
    <span class="reserved">if</span> (Object.isString(<span class="reserved">this</span>.lastValue) &amp;&amp; Object.isString(value) ?
        <span class="reserved">this</span>.lastValue != value : String(<span class="reserved">this</span>.lastValue) != String(value)) {
      <span class="reserved">this</span>.callback(<span class="reserved">this</span>.element, value);
      <span class="reserved">this</span>.lastValue = value;
    }
  }
});

Form.Element.Observer = Class.create(Abstract.TimedObserver, {
  getValue: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Form.Element.getValue(<span class="reserved">this</span>.element);
  }
});

Form.Observer = Class.create(Abstract.TimedObserver, {
  getValue: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Form.serialize(<span class="reserved">this</span>.element);
  }
});

<span class="comment">/*--------------------------------------------------------------------------*/</span>

Abstract.EventObserver = Class.create({
  initialize: <span class="reserved">function</span>(element, callback) {
    <span class="reserved">this</span>.element  = $(element);
    <span class="reserved">this</span>.callback = callback;

    <span class="reserved">this</span>.lastValue = <span class="reserved">this</span>.getValue();
    <span class="reserved">if</span> (<span class="reserved">this</span>.element.tagName.toLowerCase() == <span class="literal">'form'</span>)
      <span class="reserved">this</span>.registerFormCallbacks();
    <span class="reserved">else</span>
      <span class="reserved">this</span>.registerCallback(<span class="reserved">this</span>.element);
  },

  onElementEvent: <span class="reserved">function</span>() {
    var value = <span class="reserved">this</span>.getValue();
    <span class="reserved">if</span> (<span class="reserved">this</span>.lastValue != value) {
      <span class="reserved">this</span>.callback(<span class="reserved">this</span>.element, value);
      <span class="reserved">this</span>.lastValue = value;
    }
  },

  registerFormCallbacks: <span class="reserved">function</span>() {
    Form.getElements(<span class="reserved">this</span>.element).each(<span class="reserved">this</span>.registerCallback, <span class="reserved">this</span>);
  },

  registerCallback: <span class="reserved">function</span>(element) {
    <span class="reserved">if</span> (element.type) {
      switch (element.type.toLowerCase()) {
        case <span class="literal">'checkbox'</span>:
        case <span class="literal">'radio'</span>:
          Event.observe(element, <span class="literal">'click'</span>, <span class="reserved">this</span>.onElementEvent.bind(<span class="reserved">this</span>));
          break;
        default:
          Event.observe(element, <span class="literal">'change'</span>, <span class="reserved">this</span>.onElementEvent.bind(<span class="reserved">this</span>));
          break;
      }
    }
  }
});

Form.Element.EventObserver = Class.create(Abstract.EventObserver, {
  getValue: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Form.Element.getValue(<span class="reserved">this</span>.element);
  }
});

Form.EventObserver = Class.create(Abstract.EventObserver, {
  getValue: <span class="reserved">function</span>() {
    <span class="reserved">return</span> Form.serialize(<span class="reserved">this</span>.element);
  }
});
<span class="reserved">if</span> (!window.Event) var Event = { };

Object.extend(Event, {
  KEY_BACKSPACE: 8,
  KEY_TAB:       9,
  KEY_RETURN:   13,
  KEY_ESC:      27,
  KEY_LEFT:     37,
  KEY_UP:       38,
  KEY_RIGHT:    39,
  KEY_DOWN:     40,
  KEY_DELETE:   46,
  KEY_HOME:     36,
  KEY_END:      35,
  KEY_PAGEUP:   33,
  KEY_PAGEDOWN: 34,
  KEY_INSERT:   45,

  cache: { },

  relatedTarget: <span class="reserved">function</span>(event) {
    var element;
    switch(event.type) {
      case <span class="literal">'mouseover'</span>: element = event.fromElement; break;
      case <span class="literal">'mouseout'</span>:  element = event.toElement;   break;
      default: <span class="reserved">return</span> null;
    }
    <span class="reserved">return</span> Element.extend(element);
  }
});

Event.Methods = (<span class="reserved">function</span>() {
  var isButton;

  <span class="reserved">if</span> (Prototype.Browser.IE) {
    var buttonMap = { 0: 1, 1: 4, 2: 2 };
    isButton = <span class="reserved">function</span>(event, code) {
      <span class="reserved">return</span> event.button == buttonMap[code];
    };

  } <span class="reserved">else</span> <span class="reserved">if</span> (Prototype.Browser.WebKit) {
    isButton = <span class="reserved">function</span>(event, code) {
      switch (code) {
        case 0: <span class="reserved">return</span> event.which == 1 &amp;&amp; !event.metaKey;
        case 1: <span class="reserved">return</span> event.which == 1 &amp;&amp; event.metaKey;
        default: <span class="reserved">return</span> false;
      }
    };

  } <span class="reserved">else</span> {
    isButton = <span class="reserved">function</span>(event, code) {
      <span class="reserved">return</span> event.which ? (event.which === code + 1) : (event.button === code);
    };
  }

  <span class="reserved">return</span> {
    isLeftClick:   <span class="reserved">function</span>(event) { <span class="reserved">return</span> isButton(event, 0) },
    isMiddleClick: <span class="reserved">function</span>(event) { <span class="reserved">return</span> isButton(event, 1) },
    isRightClick:  <span class="reserved">function</span>(event) { <span class="reserved">return</span> isButton(event, 2) },

    element: <span class="reserved">function</span>(event) {
      var node = Event.extend(event).target;
      <span class="reserved">return</span> Element.extend(node.nodeType == Node.TEXT_NODE ? node.parentNode : node);
    },

    findElement: <span class="reserved">function</span>(event, expression) {
      var element = Event.element(event);
      <span class="reserved">if</span> (!expression) <span class="reserved">return</span> element;
      var elements = [element].concat(element.ancestors());
      <span class="reserved">return</span> Selector.findElement(elements, expression, 0);
    },

    pointer: <span class="reserved">function</span>(event) {
      <span class="reserved">return</span> {
        x: event.pageX || (event.clientX +
          (document.documentElement.scrollLeft || document.body.scrollLeft)),
        y: event.pageY || (event.clientY +
          (document.documentElement.scrollTop || document.body.scrollTop))
      };
    },

    pointerX: <span class="reserved">function</span>(event) { <span class="reserved">return</span> Event.pointer(event).x },
    pointerY: <span class="reserved">function</span>(event) { <span class="reserved">return</span> Event.pointer(event).y },

    stop: <span class="reserved">function</span>(event) {
      Event.extend(event);
      event.preventDefault();
      event.stopPropagation();
      event.stopped = true;
    }
  };
})();

Event.extend = (<span class="reserved">function</span>() {
  var methods = Object.keys(Event.Methods).inject({ }, <span class="reserved">function</span>(m, name) {
    m[name] = Event.Methods[name].methodize();
    <span class="reserved">return</span> m;
  });

  <span class="reserved">if</span> (Prototype.Browser.IE) {
    Object.extend(methods, {
      stopPropagation: <span class="reserved">function</span>() { <span class="reserved">this</span>.cancelBubble = true },
      preventDefault:  <span class="reserved">function</span>() { <span class="reserved">this</span>.returnValue = false },
      inspect: <span class="reserved">function</span>() { <span class="reserved">return</span> <span class="literal">"[object Event]"</span> }
    });

    <span class="reserved">return</span> <span class="reserved">function</span>(event) {
      <span class="reserved">if</span> (!event) <span class="reserved">return</span> false;
      <span class="reserved">if</span> (event._extendedByPrototype) <span class="reserved">return</span> event;

      event._extendedByPrototype = Prototype.emptyFunction;
      var pointer = Event.pointer(event);
      Object.extend(event, {
        target: event.srcElement,
        relatedTarget: Event.relatedTarget(event),
        pageX:  pointer.x,
        pageY:  pointer.y
      });
      <span class="reserved">return</span> Object.extend(event, methods);
    };

  } <span class="reserved">else</span> {
    Event.<span class="reserved">prototype</span> = Event.<span class="reserved">prototype</span> || document.createEvent(<span class="literal">"HTMLEvents"</span>).__proto__;
    Object.extend(Event.<span class="reserved">prototype</span>, methods);
    <span class="reserved">return</span> Prototype.K;
  }
})();

Object.extend(Event, (<span class="reserved">function</span>() {
  var cache = Event.cache;

  <span class="reserved">function</span> getEventID(element) {
    <span class="reserved">if</span> (element._prototypeEventID) <span class="reserved">return</span> element._prototypeEventID[0];
    arguments.callee.id = arguments.callee.id || 1;
    <span class="reserved">return</span> element._prototypeEventID = [++arguments.callee.id];
  }

  <span class="reserved">function</span> getDOMEventName(eventName) {
    <span class="reserved">if</span> (eventName &amp;&amp; eventName.include(<span class="literal">':'</span>)) <span class="reserved">return</span> <span class="literal">"dataavailable"</span>;
    <span class="reserved">return</span> eventName;
  }

  <span class="reserved">function</span> getCacheForID(id) {
    <span class="reserved">return</span> cache[id] = cache[id] || { };
  }

  <span class="reserved">function</span> getWrappersForEventName(id, eventName) {
    var c = getCacheForID(id);
    <span class="reserved">return</span> c[eventName] = c[eventName] || [];
  }

  <span class="reserved">function</span> createWrapper(element, eventName, handler) {
    var id = getEventID(element);
    var c = getWrappersForEventName(id, eventName);
    <span class="reserved">if</span> (c.pluck(<span class="literal">"handler"</span>).include(handler)) <span class="reserved">return</span> false;

    var wrapper = <span class="reserved">function</span>(event) {
      <span class="reserved">if</span> (!Event || !Event.extend ||
        (event.eventName &amp;&amp; event.eventName != eventName))
          <span class="reserved">return</span> false;

      Event.extend(event);
      handler.call(element, event);
    };

    wrapper.handler = handler;
    c.push(wrapper);
    <span class="reserved">return</span> wrapper;
  }

  <span class="reserved">function</span> findWrapper(id, eventName, handler) {
    var c = getWrappersForEventName(id, eventName);
    <span class="reserved">return</span> c.find(<span class="reserved">function</span>(wrapper) { <span class="reserved">return</span> wrapper.handler == handler });
  }

  <span class="reserved">function</span> destroyWrapper(id, eventName, handler) {
    var c = getCacheForID(id);
    <span class="reserved">if</span> (!c[eventName]) <span class="reserved">return</span> false;
    c[eventName] = c[eventName].without(findWrapper(id, eventName, handler));
  }

  <span class="reserved">function</span> destroyCache() {
    <span class="reserved">for</span> (var id in cache)
      <span class="reserved">for</span> (var eventName in cache[id])
        cache[id][eventName] = null;
  }

  <span class="reserved">if</span> (window.attachEvent) {
    window.attachEvent(<span class="literal">"onunload"</span>, destroyCache);
  }

  <span class="reserved">return</span> {
    observe: <span class="reserved">function</span>(element, eventName, handler) {
      element = $(element);
      var name = getDOMEventName(eventName);

      var wrapper = createWrapper(element, eventName, handler);
      <span class="reserved">if</span> (!wrapper) <span class="reserved">return</span> element;

      <span class="reserved">if</span> (element.addEventListener) {
        element.addEventListener(name, wrapper, false);
      } <span class="reserved">else</span> {
        element.attachEvent(<span class="literal">"on"</span> + name, wrapper);
      }

      <span class="reserved">return</span> element;
    },

    stopObserving: <span class="reserved">function</span>(element, eventName, handler) {
      element = $(element);
      var id = getEventID(element), name = getDOMEventName(eventName);

      <span class="reserved">if</span> (!handler &amp;&amp; eventName) {
        getWrappersForEventName(id, eventName).each(<span class="reserved">function</span>(wrapper) {
          element.stopObserving(eventName, wrapper.handler);
        });
        <span class="reserved">return</span> element;

      } <span class="reserved">else</span> <span class="reserved">if</span> (!eventName) {
        Object.keys(getCacheForID(id)).each(<span class="reserved">function</span>(eventName) {
          element.stopObserving(eventName);
        });
        <span class="reserved">return</span> element;
      }

      var wrapper = findWrapper(id, eventName, handler);
      <span class="reserved">if</span> (!wrapper) <span class="reserved">return</span> element;

      <span class="reserved">if</span> (element.removeEventListener) {
        element.removeEventListener(name, wrapper, false);
      } <span class="reserved">else</span> {
        element.detachEvent(<span class="literal">"on"</span> + name, wrapper);
      }

      destroyWrapper(id, eventName, handler);

      <span class="reserved">return</span> element;
    },

    fire: <span class="reserved">function</span>(element, eventName, memo) {
      element = $(element);
      <span class="reserved">if</span> (element == document &amp;&amp; document.createEvent &amp;&amp; !element.dispatchEvent)
        element = document.documentElement;

      var event;
      <span class="reserved">if</span> (document.createEvent) {
        event = document.createEvent(<span class="literal">"HTMLEvents"</span>);
        event.initEvent(<span class="literal">"dataavailable"</span>, true, true);
      } <span class="reserved">else</span> {
        event = document.createEventObject();
        event.eventType = <span class="literal">"ondataavailable"</span>;
      }

      event.eventName = eventName;
      event.memo = memo || { };

      <span class="reserved">if</span> (document.createEvent) {
        element.dispatchEvent(event);
      } <span class="reserved">else</span> {
        element.fireEvent(event.eventType, event);
      }

      <span class="reserved">return</span> Event.extend(event);
    }
  };
})());

Object.extend(Event, Event.Methods);

Element.addMethods({
  fire:          Event.fire,
  observe:       Event.observe,
  stopObserving: Event.stopObserving
});

Object.extend(document, {
  fire:          Element.Methods.fire.methodize(),
  observe:       Element.Methods.observe.methodize(),
  stopObserving: Element.Methods.stopObserving.methodize(),
  loaded:        false
});

(<span class="reserved">function</span>() {
  <span class="comment">/* Support for the DOMContentLoaded event is based on work by Dan Webb,
     Matthias Miller, Dean Edwards and John Resig. */</span>

  var timer;

  <span class="reserved">function</span> fireContentLoadedEvent() {
    <span class="reserved">if</span> (document.loaded) <span class="reserved">return</span>;
    <span class="reserved">if</span> (timer) window.clearInterval(timer);
    document.fire(<span class="literal">"dom:loaded"</span>);
    document.loaded = true;
  }

  <span class="reserved">if</span> (document.addEventListener) {
    <span class="reserved">if</span> (Prototype.Browser.WebKit) {
      timer = window.setInterval(<span class="reserved">function</span>() {
        <span class="reserved">if</span> (/loaded|complete/.test(document.readyState))
          fireContentLoadedEvent();
      }, 0);

      Event.observe(window, <span class="literal">"load"</span>, fireContentLoadedEvent);

    } <span class="reserved">else</span> {
      document.addEventListener(<span class="literal">"DOMContentLoaded"</span>,
        fireContentLoadedEvent, false);
    }

  } <span class="reserved">else</span> {
    document.write(<span class="literal">"&lt;script id=__onDOMContentLoaded defer src=//:&gt;&lt;\/script&gt;"</span>);
    $(<span class="literal">"__onDOMContentLoaded"</span>).onreadystatechange = <span class="reserved">function</span>() {
      <span class="reserved">if</span> (<span class="reserved">this</span>.readyState == <span class="literal">"complete"</span>) {
        <span class="reserved">this</span>.onreadystatechange = null;
        fireContentLoadedEvent();
      }
    };
  }
})();
<span class="comment">/*------------------------------- DEPRECATED -------------------------------*/</span>

Hash.toQueryString = Object.toQueryString;

var Toggle = { display: Element.toggle };

Element.Methods.childOf = Element.Methods.descendantOf;

var Insertion = {
  Before: <span class="reserved">function</span>(element, content) {
    <span class="reserved">return</span> Element.insert(element, {before:content});
  },

  Top: <span class="reserved">function</span>(element, content) {
    <span class="reserved">return</span> Element.insert(element, {top:content});
  },

  Bottom: <span class="reserved">function</span>(element, content) {
    <span class="reserved">return</span> Element.insert(element, {bottom:content});
  },

  After: <span class="reserved">function</span>(element, content) {
    <span class="reserved">return</span> Element.insert(element, {after:content});
  }
};

var $continue = new Error(<span class="literal">'"throw $continue" is deprecated, use "return" instead'</span>);

<span class="comment">// This should be moved to script.aculo.us; notice the deprecated methods</span>
<span class="comment">// further below, that map to the newer Element methods.</span>
var Position = {
  <span class="comment">// set to true if needed, warning: firefox performance problems</span>
  <span class="comment">// NOT neeeded for page scrolling, only if draggable contained in</span>
  <span class="comment">// scrollable elements</span>
  includeScrollOffsets: false,

  <span class="comment">// must be called before calling withinIncludingScrolloffset, every time the</span>
  <span class="comment">// page is scrolled</span>
  prepare: <span class="reserved">function</span>() {
    <span class="reserved">this</span>.deltaX =  window.pageXOffset
                || document.documentElement.scrollLeft
                || document.body.scrollLeft
                || 0;
    <span class="reserved">this</span>.deltaY =  window.pageYOffset
                || document.documentElement.scrollTop
                || document.body.scrollTop
                || 0;
  },

  <span class="comment">// caches x/y coordinate pair to use with overlap</span>
  within: <span class="reserved">function</span>(element, x, y) {
    <span class="reserved">if</span> (<span class="reserved">this</span>.includeScrollOffsets)
      <span class="reserved">return</span> <span class="reserved">this</span>.withinIncludingScrolloffsets(element, x, y);
    <span class="reserved">this</span>.xcomp = x;
    <span class="reserved">this</span>.ycomp = y;
    <span class="reserved">this</span>.offset = Element.cumulativeOffset(element);

    <span class="reserved">return</span> (y &gt;= <span class="reserved">this</span>.offset[1] &amp;&amp;
            y &lt;  <span class="reserved">this</span>.offset[1] + element.offsetHeight &amp;&amp;
            x &gt;= <span class="reserved">this</span>.offset[0] &amp;&amp;
            x &lt;  <span class="reserved">this</span>.offset[0] + element.offsetWidth);
  },

  withinIncludingScrolloffsets: <span class="reserved">function</span>(element, x, y) {
    var offsetcache = Element.cumulativeScrollOffset(element);

    <span class="reserved">this</span>.xcomp = x + offsetcache[0] - <span class="reserved">this</span>.deltaX;
    <span class="reserved">this</span>.ycomp = y + offsetcache[1] - <span class="reserved">this</span>.deltaY;
    <span class="reserved">this</span>.offset = Element.cumulativeOffset(element);

    <span class="reserved">return</span> (<span class="reserved">this</span>.ycomp &gt;= <span class="reserved">this</span>.offset[1] &amp;&amp;
            <span class="reserved">this</span>.ycomp &lt;  <span class="reserved">this</span>.offset[1] + element.offsetHeight &amp;&amp;
            <span class="reserved">this</span>.xcomp &gt;= <span class="reserved">this</span>.offset[0] &amp;&amp;
            <span class="reserved">this</span>.xcomp &lt;  <span class="reserved">this</span>.offset[0] + element.offsetWidth);
  },

  <span class="comment">// within must be called directly before</span>
  overlap: <span class="reserved">function</span>(mode, element) {
    <span class="reserved">if</span> (!mode) <span class="reserved">return</span> 0;
    <span class="reserved">if</span> (mode == <span class="literal">'vertical'</span>)
      <span class="reserved">return</span> ((<span class="reserved">this</span>.offset[1] + element.offsetHeight) - <span class="reserved">this</span>.ycomp) /
        element.offsetHeight;
    <span class="reserved">if</span> (mode == <span class="literal">'horizontal'</span>)
      <span class="reserved">return</span> ((<span class="reserved">this</span>.offset[0] + element.offsetWidth) - <span class="reserved">this</span>.xcomp) /
        element.offsetWidth;
  },

  <span class="comment">// Deprecation layer -- use newer Element methods now (1.5.2).</span>

  cumulativeOffset: Element.Methods.cumulativeOffset,

  positionedOffset: Element.Methods.positionedOffset,

  absolutize: <span class="reserved">function</span>(element) {
    Position.prepare();
    <span class="reserved">return</span> Element.absolutize(element);
  },

  relativize: <span class="reserved">function</span>(element) {
    Position.prepare();
    <span class="reserved">return</span> Element.relativize(element);
  },

  realOffset: Element.Methods.cumulativeScrollOffset,

  offsetParent: Element.Methods.getOffsetParent,

  page: Element.Methods.viewportOffset,

  clone: <span class="reserved">function</span>(source, target, options) {
    options = options || { };
    <span class="reserved">return</span> Element.clonePosition(target, source, options);
  }
};

<span class="comment">/*--------------------------------------------------------------------------*/</span>

<span class="reserved">if</span> (!document.getElementsByClassName) document.getElementsByClassName = <span class="reserved">function</span>(instanceMethods){
  <span class="reserved">function</span> iter(name) {
    <span class="reserved">return</span> name.blank() ? null : <span class="literal">"[contains(concat(' ', @class, ' '), ' "</span> + name + <span class="literal">" ')]"</span>;
  }

  instanceMethods.getElementsByClassName = Prototype.BrowserFeatures.XPath ?
  <span class="reserved">function</span>(element, className) {
    className = className.toString().strip();
    var cond = /\s/.test(className) ? $w(className).map(iter).join(<span class="literal">''</span>) : iter(className);
    <span class="reserved">return</span> cond ? document._getElementsByXPath(<span class="literal">'.//*'</span> + cond, element) : [];
  } : <span class="reserved">function</span>(element, className) {
    className = className.toString().strip();
    var elements = [], classNames = (/\s/.test(className) ? $w(className) : null);
    <span class="reserved">if</span> (!classNames &amp;&amp; !className) <span class="reserved">return</span> elements;

    var nodes = $(element).getElementsByTagName(<span class="literal">'*'</span>);
    className = <span class="literal">' '</span> + className + <span class="literal">' '</span>;

    <span class="reserved">for</span> (var i = 0, child, cn; child = nodes[i]; i++) {
      <span class="reserved">if</span> (child.className &amp;&amp; (cn = <span class="literal">' '</span> + child.className + <span class="literal">' '</span>) &amp;&amp; (cn.include(className) ||
          (classNames &amp;&amp; classNames.all(<span class="reserved">function</span>(name) {
            <span class="reserved">return</span> !name.toString().blank() &amp;&amp; cn.include(<span class="literal">' '</span> + name + <span class="literal">' '</span>);
          }))))
        elements.push(Element.extend(child));
    }
    <span class="reserved">return</span> elements;
  };

  <span class="reserved">return</span> <span class="reserved">function</span>(className, parentElement) {
    <span class="reserved">return</span> $(parentElement || document.body).getElementsByClassName(className);
  };
}(Element.Methods);

<span class="comment">/*--------------------------------------------------------------------------*/</span>

Element.ClassNames = Class.create();
Element.ClassNames.<span class="reserved">prototype</span> = {
  initialize: <span class="reserved">function</span>(element) {
    <span class="reserved">this</span>.element = $(element);
  },

  _each: <span class="reserved">function</span>(iterator) {
    <span class="reserved">this</span>.element.className.split(/\s+/).select(<span class="reserved">function</span>(name) {
      <span class="reserved">return</span> name.length &gt; 0;
    })._each(iterator);
  },

  set: <span class="reserved">function</span>(className) {
    <span class="reserved">this</span>.element.className = className;
  },

  add: <span class="reserved">function</span>(classNameToAdd) {
    <span class="reserved">if</span> (<span class="reserved">this</span>.include(classNameToAdd)) <span class="reserved">return</span>;
    <span class="reserved">this</span>.set($A(<span class="reserved">this</span>).concat(classNameToAdd).join(<span class="literal">' '</span>));
  },

  remove: <span class="reserved">function</span>(classNameToRemove) {
    <span class="reserved">if</span> (!<span class="reserved">this</span>.include(classNameToRemove)) <span class="reserved">return</span>;
    <span class="reserved">this</span>.set($A(<span class="reserved">this</span>).without(classNameToRemove).join(<span class="literal">' '</span>));
  },

  toString: <span class="reserved">function</span>() {
    <span class="reserved">return</span> $A(<span class="reserved">this</span>).join(<span class="literal">' '</span>);
  }
};

Object.extend(Element.ClassNames.<span class="reserved">prototype</span>, Enumerable);

<span class="comment">/*--------------------------------------------------------------------------*/</span>

Element.addMethods();<span class="comment">/**
 * SWFUpload v2.1.0 by Jacob Roberts, Feb 2008, http://www.swfupload.org, http://swfupload.googlecode.com, http://www.swfupload.org
 * -------- -------- -------- -------- -------- -------- -------- --------
 * SWFUpload is (c) 2006 Lars Huring, Olov Nilzn and Mammon Media and is released under the MIT License:
 * http://www.opensource.org/licenses/mit-license.php
 *
 * See Changelog.txt for version history
 *
 */</span>


<span class="comment">/* *********** */</span>
<span class="comment">/* Constructor */</span>
<span class="comment">/* *********** */</span>

var SWFUpload = <span class="reserved">function</span> (settings) {
	<span class="reserved">this</span>.initSWFUpload(settings);
};

SWFUpload.<span class="reserved">prototype</span>.initSWFUpload = <span class="reserved">function</span> (settings) {
	try {
		<span class="reserved">this</span>.customSettings = {};	<span class="comment">// A container where developers can place their own settings associated with this instance.</span>
		<span class="reserved">this</span>.settings = settings;
		<span class="reserved">this</span>.eventQueue = [];
		<span class="reserved">this</span>.movieName = <span class="literal">"SWFUpload_"</span> + SWFUpload.movieCount++;
		<span class="reserved">this</span>.movieElement = null;

		<span class="comment">// Setup global control tracking</span>
		SWFUpload.instances[<span class="reserved">this</span>.movieName] = <span class="reserved">this</span>;

		<span class="comment">// Load the settings.  Load the Flash movie.</span>
		<span class="reserved">this</span>.initSettings();
		<span class="reserved">this</span>.loadFlash();
		<span class="reserved">this</span>.displayDebugInfo();
	} catch (ex) {
		delete SWFUpload.instances[<span class="reserved">this</span>.movieName];
		throw ex;
	}
};

<span class="comment">/* *************** */</span>
<span class="comment">/* Static Members  */</span>
<span class="comment">/* *************** */</span>
SWFUpload.instances = {};
SWFUpload.movieCount = 0;
SWFUpload.version = <span class="literal">"2.1.0"</span>;
SWFUpload.QUEUE_ERROR = {
	QUEUE_LIMIT_EXCEEDED	  		: -100,
	FILE_EXCEEDS_SIZE_LIMIT  		: -110,
	ZERO_BYTE_FILE			  		: -120,
	INVALID_FILETYPE		  		: -130
};
SWFUpload.UPLOAD_ERROR = {
	HTTP_ERROR				  		: -200,
	MISSING_UPLOAD_URL	      		: -210,
	IO_ERROR				  		: -220,
	SECURITY_ERROR			  		: -230,
	UPLOAD_LIMIT_EXCEEDED	  		: -240,
	UPLOAD_FAILED			  		: -250,
	SPECIFIED_FILE_ID_NOT_FOUND		: -260,
	FILE_VALIDATION_FAILED	  		: -270,
	FILE_CANCELLED			  		: -280,
	UPLOAD_STOPPED					: -290
};
SWFUpload.FILE_STATUS = {
	QUEUED		 : -1,
	IN_PROGRESS	 : -2,
	ERROR		 : -3,
	COMPLETE	 : -4,
	CANCELLED	 : -5
};


<span class="comment">/* ******************** */</span>
<span class="comment">/* Instance Members  */</span>
<span class="comment">/* ******************** */</span>

<span class="comment">// Private: initSettings ensures that all the</span>
<span class="comment">// settings are set, getting a default value if one was not assigned.</span>
SWFUpload.<span class="reserved">prototype</span>.initSettings = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.ensureDefault = <span class="reserved">function</span> (settingName, defaultValue) {
		<span class="reserved">this</span>.settings[settingName] = (<span class="reserved">this</span>.settings[settingName] == undefined) ? defaultValue : <span class="reserved">this</span>.settings[settingName];
	};
	
	<span class="comment">// Upload backend settings</span>
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_url"</span>, <span class="literal">""</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_post_name"</span>, <span class="literal">"Filedata"</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"post_params"</span>, {});
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"use_query_string"</span>, false);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"requeue_on_error"</span>, false);
	
	<span class="comment">// File Settings</span>
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_types"</span>, <span class="literal">"*.*"</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_types_description"</span>, <span class="literal">"All Files"</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_size_limit"</span>, 0);	<span class="comment">// Default zero means "unlimited"</span>
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_upload_limit"</span>, 0);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_queue_limit"</span>, 0);

	<span class="comment">// Flash Settings</span>
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"flash_url"</span>, <span class="literal">"swfupload_f9.swf"</span>);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"flash_color"</span>, <span class="literal">"#FFFFFF"</span>);

	<span class="comment">// Debug Settings</span>
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"debug"</span>, false);
	<span class="reserved">this</span>.settings.debug_enabled = <span class="reserved">this</span>.settings.debug;	<span class="comment">// Here to maintain v2 API</span>
	
	<span class="comment">// Event Handlers</span>
	<span class="reserved">this</span>.settings.return_upload_start_handler = <span class="reserved">this</span>.returnUploadStart;
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"swfupload_loaded_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_dialog_start_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_queued_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_queue_error_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"file_dialog_complete_handler"</span>, null);
	
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_start_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_progress_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_error_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_success_handler"</span>, null);
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"upload_complete_handler"</span>, null);
	
	<span class="reserved">this</span>.ensureDefault(<span class="literal">"debug_handler"</span>, <span class="reserved">function</span>(msg) {
		N2i.log(msg)
	});

	<span class="reserved">this</span>.ensureDefault(<span class="literal">"custom_settings"</span>, {});

	<span class="comment">// Other settings</span>
	<span class="reserved">this</span>.customSettings = <span class="reserved">this</span>.settings.custom_settings;
	
	delete <span class="reserved">this</span>.ensureDefault;
};

<span class="comment">// Private: loadFlash generates the HTML tag for the Flash</span>
<span class="comment">// It then adds the flash to the body</span>
SWFUpload.<span class="reserved">prototype</span>.loadFlash = <span class="reserved">function</span> () {
	var targetElement, container;

	<span class="comment">// Make sure an element with the ID we are going to use doesn't already exist</span>
	<span class="reserved">if</span> (document.getElementById(<span class="reserved">this</span>.movieName) !== null) {
		throw <span class="literal">"ID "</span> + <span class="reserved">this</span>.movieName + <span class="literal">" is already in use. The Flash Object could not be added"</span>;
	}

	<span class="comment">// Get the body tag where we will be adding the flash movie</span>
	targetElement = document.getElementsByTagName(<span class="literal">"body"</span>)[0];

	<span class="reserved">if</span> (targetElement == undefined) {
		throw <span class="literal">"Could not find the 'body' element."</span>;
	}

	<span class="comment">// Append the container and load the flash</span>
	container = document.createElement(<span class="literal">"div"</span>);
	container.style.top = <span class="literal">"-100px"</span>;
	container.style.left = <span class="literal">"-100px"</span>;
	container.style.position = <span class="literal">"absolute"</span>;

	targetElement.appendChild(container);
	<span class="reserved">if</span> (N2i.isIE()) {
		container.innerHTML = <span class="reserved">this</span>.getFlashHTML();	<span class="comment">// Using innerHTML is non-standard but the only sensible way to dynamically add Flash in IE (and maybe other browsers)</span>
	} <span class="reserved">else</span> {
		var object = N2i.create(<span class="literal">'object'</span>,{id:<span class="reserved">this</span>.movieName,data:<span class="reserved">this</span>.settings.flash_url},{width:<span class="literal">'1px'</span>,height:<span class="literal">'1px'</span>});
		object.appendChild(N2i.create(<span class="literal">'param'</span>,{name:<span class="literal">'movie'</span>,value:<span class="reserved">this</span>.settings.flash_url}));
		object.appendChild(N2i.create(<span class="literal">'param'</span>,{name:<span class="literal">'flashvars'</span>,value: <span class="reserved">this</span>.getFlashVars()}));
		container.appendChild(object);
	}
};

<span class="comment">// Private: getFlashHTML generates the object tag needed to embed the flash in to the document</span>
SWFUpload.<span class="reserved">prototype</span>.getFlashHTML = <span class="reserved">function</span> () {
	<span class="comment">// Flash Satay object syntax: http://www.alistapart.com/articles/flashsatay</span>
	<span class="reserved">return</span> [<span class="literal">'&lt;object id="'</span>, <span class="reserved">this</span>.movieName, <span class="literal">'" type="application/x-shockwave-flash" data="'</span>, <span class="reserved">this</span>.settings.flash_url, <span class="literal">'" width="1" height="1" style="-moz-user-focus: ignore;"&gt;'</span>,
				<span class="literal">'&lt;param name="movie" value="'</span>, <span class="reserved">this</span>.settings.flash_url, <span class="literal">'" /&gt;'</span>,
				<span class="literal">'&lt;param name="bgcolor" value="'</span>, <span class="reserved">this</span>.settings.flash_color, <span class="literal">'" /&gt;'</span>,
				<span class="literal">'&lt;param name="quality" value="high" /&gt;'</span>,
				<span class="literal">'&lt;param name="menu" value="false" /&gt;'</span>,
				<span class="literal">'&lt;param name="allowScriptAccess" value="always" /&gt;'</span>,
				<span class="literal">'&lt;param name="flashvars" value="'</span> + <span class="reserved">this</span>.getFlashVars() + <span class="literal">'" /&gt;'</span>,
				<span class="literal">'&lt;/object&gt;'</span>].join(<span class="literal">""</span>);
};

<span class="comment">// Private: getFlashVars builds the parameter string that will be passed</span>
<span class="comment">// to flash in the flashvars param.</span>
SWFUpload.<span class="reserved">prototype</span>.getFlashVars = <span class="reserved">function</span> () {
	<span class="comment">// Build a string from the post param object</span>
	var paramString = <span class="reserved">this</span>.buildParamString();

	<span class="comment">// Build the parameter string</span>
	<span class="reserved">return</span> [<span class="literal">"movieName="</span>, encodeURIComponent(<span class="reserved">this</span>.movieName),
			<span class="literal">"&amp;uploadURL="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.upload_url),
			<span class="literal">"&amp;useQueryString="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.use_query_string),
			<span class="literal">"&amp;requeueOnError="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.requeue_on_error),
			<span class="literal">"&amp;params="</span>, encodeURIComponent(paramString),
			<span class="literal">"&amp;filePostName="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_post_name),
			<span class="literal">"&amp;fileTypes="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_types),
			<span class="literal">"&amp;fileTypesDescription="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_types_description),
			<span class="literal">"&amp;fileSizeLimit="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_size_limit),
			<span class="literal">"&amp;fileUploadLimit="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_upload_limit),
			<span class="literal">"&amp;fileQueueLimit="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.file_queue_limit),
			<span class="literal">"&amp;debugEnabled="</span>, encodeURIComponent(<span class="reserved">this</span>.settings.debug_enabled)].join(<span class="literal">""</span>);
};

<span class="comment">// Public: getMovieElement retrieves the DOM reference to the Flash element added by SWFUpload</span>
<span class="comment">// The element is cached after the first lookup</span>
SWFUpload.<span class="reserved">prototype</span>.getMovieElement = <span class="reserved">function</span> () {
	<span class="reserved">if</span> (<span class="reserved">this</span>.movieElement == undefined) {
		<span class="reserved">this</span>.movieElement = document.getElementById(<span class="reserved">this</span>.movieName);
	}

	<span class="reserved">if</span> (<span class="reserved">this</span>.movieElement === null) {
		throw <span class="literal">"Could not find Flash element"</span>;
	}
	<span class="reserved">return</span> <span class="reserved">this</span>.movieElement;
};

<span class="comment">// Private: buildParamString takes the name/value pairs in the post_params setting object</span>
<span class="comment">// and joins them up in to a string formatted "name=value&amp;amp;name=value"</span>
SWFUpload.<span class="reserved">prototype</span>.buildParamString = <span class="reserved">function</span> () {
	var postParams = <span class="reserved">this</span>.settings.post_params;
	var paramStringPairs = [];

	<span class="reserved">if</span> (typeof(postParams) === <span class="literal">"object"</span>) {
		<span class="reserved">for</span> (var name in postParams) {
			<span class="reserved">if</span> (postParams.hasOwnProperty(name)) {
				paramStringPairs.push(encodeURIComponent(name.toString()) + <span class="literal">"="</span> + encodeURIComponent(postParams[name].toString()));
			}
		}
	}

	<span class="reserved">return</span> paramStringPairs.join(<span class="literal">"&amp;"</span>);
};

<span class="comment">// Public: Used to remove a SWFUpload instance from the page. This method strives to remove</span>
<span class="comment">// all references to the SWF, and other objects so memory is properly freed.</span>
<span class="comment">// Returns true if everything was destroyed. Returns a false if a failure occurs leaving SWFUpload in an inconsistant state.</span>
SWFUpload.<span class="reserved">prototype</span>.destroy = <span class="reserved">function</span> () {
	try {
		<span class="comment">// Make sure Flash is done before we try to remove it</span>
		<span class="reserved">this</span>.stopUpload();
		
		<span class="comment">// Remove the SWFUpload DOM nodes</span>
		var movieElement = null;
		try {
			movieElement = <span class="reserved">this</span>.getMovieElement();
		} catch (ex) {
		}
		
		<span class="reserved">if</span> (movieElement != undefined &amp;&amp; movieElement.parentNode != undefined &amp;&amp; typeof(movieElement.parentNode.removeChild) === <span class="literal">"function"</span>) {
			var container = movieElement.parentNode;
			<span class="reserved">if</span> (container != undefined) {
				container.removeChild(movieElement);
				<span class="reserved">if</span> (container.parentNode != undefined &amp;&amp; typeof(container.parentNode.removeChild) === <span class="literal">"function"</span>) {
					container.parentNode.removeChild(container);
				}
			}
		}
		
		<span class="comment">// Destroy references</span>
		SWFUpload.instances[<span class="reserved">this</span>.movieName] = null;
		delete SWFUpload.instances[<span class="reserved">this</span>.movieName];

		delete <span class="reserved">this</span>.movieElement;
		delete <span class="reserved">this</span>.settings;
		delete <span class="reserved">this</span>.customSettings;
		delete <span class="reserved">this</span>.eventQueue;
		delete <span class="reserved">this</span>.movieName;
		
		<span class="reserved">return</span> true;
	} catch (ex1) {
		<span class="reserved">return</span> false;
	}
};

<span class="comment">// Public: displayDebugInfo prints out settings and configuration</span>
<span class="comment">// information about this SWFUpload instance.</span>
<span class="comment">// This function (and any references to it) can be deleted when placing</span>
<span class="comment">// SWFUpload in production.</span>
SWFUpload.<span class="reserved">prototype</span>.displayDebugInfo = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.debug(
		[
			<span class="literal">"---SWFUpload Instance Info---\n"</span>,
			<span class="literal">"Version: "</span>, SWFUpload.version, <span class="literal">"\n"</span>,
			<span class="literal">"Movie Name: "</span>, <span class="reserved">this</span>.movieName, <span class="literal">"\n"</span>,
			<span class="literal">"Settings:\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_url:             "</span>, <span class="reserved">this</span>.settings.upload_url, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"use_query_string:       "</span>, <span class="reserved">this</span>.settings.use_query_string.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_post_name:         "</span>, <span class="reserved">this</span>.settings.file_post_name, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"post_params:            "</span>, <span class="reserved">this</span>.settings.post_params.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_types:             "</span>, <span class="reserved">this</span>.settings.file_types, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_types_description: "</span>, <span class="reserved">this</span>.settings.file_types_description, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_size_limit:        "</span>, <span class="reserved">this</span>.settings.file_size_limit, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_upload_limit:      "</span>, <span class="reserved">this</span>.settings.file_upload_limit, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_queue_limit:       "</span>, <span class="reserved">this</span>.settings.file_queue_limit, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"flash_url:              "</span>, <span class="reserved">this</span>.settings.flash_url, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"flash_color:            "</span>, <span class="reserved">this</span>.settings.flash_color, <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"debug:                  "</span>, <span class="reserved">this</span>.settings.debug.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"custom_settings:        "</span>, <span class="reserved">this</span>.settings.custom_settings.toString(), <span class="literal">"\n"</span>,
			<span class="literal">"Event Handlers:\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"swfupload_loaded_handler assigned:  "</span>, (typeof(<span class="reserved">this</span>.settings.swfupload_loaded_handler) === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_dialog_start_handler assigned: "</span>, (typeof(<span class="reserved">this</span>.settings.file_dialog_start_handler) === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_queued_handler assigned:       "</span>, (typeof(<span class="reserved">this</span>.settings.file_queued_handler) === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"file_queue_error_handler assigned:  "</span>, (typeof(<span class="reserved">this</span>.settings.file_queue_error_handler) === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_start_handler assigned:      "</span>, (typeof(<span class="reserved">this</span>.settings.upload_start_handler) === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_progress_handler assigned:   "</span>, (typeof(<span class="reserved">this</span>.settings.upload_progress_handler) === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_error_handler assigned:      "</span>, (typeof(<span class="reserved">this</span>.settings.upload_error_handler) === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_success_handler assigned:    "</span>, (typeof(<span class="reserved">this</span>.settings.upload_success_handler) === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"upload_complete_handler assigned:   "</span>, (typeof(<span class="reserved">this</span>.settings.upload_complete_handler) === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>,
			<span class="literal">"\t"</span>, <span class="literal">"debug_handler assigned:             "</span>, (typeof(<span class="reserved">this</span>.settings.debug_handler) === <span class="literal">"function"</span>).toString(), <span class="literal">"\n"</span>
		].join(<span class="literal">""</span>)
	);
};

<span class="comment">/* Note: addSetting and getSetting are no longer used by SWFUpload but are included
	the maintain v2 API compatibility
*/</span>
<span class="comment">// Public: (Deprecated) addSetting adds a setting value. If the value given is undefined or null then the default_value is used.</span>
SWFUpload.<span class="reserved">prototype</span>.addSetting = <span class="reserved">function</span> (name, value, default_value) {
    <span class="reserved">if</span> (value == undefined) {
        <span class="reserved">return</span> (<span class="reserved">this</span>.settings[name] = default_value);
    } <span class="reserved">else</span> {
        <span class="reserved">return</span> (<span class="reserved">this</span>.settings[name] = value);
	}
};

<span class="comment">// Public: (Deprecated) getSetting gets a setting. Returns an empty string if the setting was not found.</span>
SWFUpload.<span class="reserved">prototype</span>.getSetting = <span class="reserved">function</span> (name) {
    <span class="reserved">if</span> (<span class="reserved">this</span>.settings[name] != undefined) {
        <span class="reserved">return</span> <span class="reserved">this</span>.settings[name];
	}

    <span class="reserved">return</span> <span class="literal">""</span>;
};



<span class="comment">// Private: callFlash handles function calls made to the Flash element.</span>
<span class="comment">// Calls are made with a setTimeout for some functions to work around</span>
<span class="comment">// bugs in the ExternalInterface library.</span>
SWFUpload.<span class="reserved">prototype</span>.callFlash = <span class="reserved">function</span> (functionName, argumentArray) {
	argumentArray = argumentArray || [];
	
	var self = <span class="reserved">this</span>;
	var callFunction = <span class="reserved">function</span> () {
		var movieElement = self.getMovieElement();
		var returnValue;
		<span class="reserved">if</span> (typeof(movieElement[functionName]) == <span class="literal">"function"</span>) {
			<span class="comment">// We have to go through all this if/else stuff because the Flash functions don't have apply() and only accept the exact number of arguments.</span>
			<span class="reserved">if</span> (argumentArray.length === 0) {
				returnValue = movieElement[functionName]();
			} <span class="reserved">else</span> <span class="reserved">if</span> (argumentArray.length === 1) {
				returnValue = movieElement[functionName](argumentArray[0]);
			} <span class="reserved">else</span> <span class="reserved">if</span> (argumentArray.length === 2) {
				returnValue = movieElement[functionName](argumentArray[0], argumentArray[1]);
			} <span class="reserved">else</span> <span class="reserved">if</span> (argumentArray.length === 3) {
				returnValue = movieElement[functionName](argumentArray[0], argumentArray[1], argumentArray[2]);
			} <span class="reserved">else</span> {
				throw <span class="literal">"Too many arguments"</span>;
			}
			
			<span class="comment">// Unescape file post param values</span>
			<span class="reserved">if</span> (returnValue != undefined &amp;&amp; typeof(returnValue.post) === <span class="literal">"object"</span>) {
				returnValue = self.unescapeFilePostParams(returnValue);
			}
			
			<span class="reserved">return</span> returnValue;
		} <span class="reserved">else</span> {
			throw <span class="literal">"Invalid function name"</span>;
		}
	};
	
	<span class="reserved">return</span> callFunction();
};


<span class="comment">/* *****************************
	-- Flash control methods --
	Your UI should use these
	to operate SWFUpload
   ***************************** */</span>

<span class="comment">// Public: selectFile causes a File Selection Dialog window to appear.  This</span>
<span class="comment">// dialog only allows 1 file to be selected.</span>
SWFUpload.<span class="reserved">prototype</span>.selectFile = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.callFlash(<span class="literal">"SelectFile"</span>);
};

<span class="comment">// Public: selectFiles causes a File Selection Dialog window to appear/ This</span>
<span class="comment">// dialog allows the user to select any number of files</span>
<span class="comment">// Flash Bug Warning: Flash limits the number of selectable files based on the combined length of the file names.</span>
<span class="comment">// If the selection name length is too long the dialog will fail in an unpredictable manner.  There is no work-around</span>
<span class="comment">// for this bug.</span>
SWFUpload.<span class="reserved">prototype</span>.selectFiles = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.callFlash(<span class="literal">"SelectFiles"</span>);
};


<span class="comment">// Public: startUpload starts uploading the first file in the queue unless</span>
<span class="comment">// the optional parameter 'fileID' specifies the ID </span>
SWFUpload.<span class="reserved">prototype</span>.startUpload = <span class="reserved">function</span> (fileID) {
	<span class="reserved">this</span>.callFlash(<span class="literal">"StartUpload"</span>, [fileID]);
};

<span class="comment">/* Cancels a the file upload.  You must specify a file_id */</span>
<span class="comment">// Public: cancelUpload cancels any queued file.  The fileID parameter</span>
<span class="comment">// must be specified.</span>
SWFUpload.<span class="reserved">prototype</span>.cancelUpload = <span class="reserved">function</span> (fileID) {
	<span class="reserved">this</span>.callFlash(<span class="literal">"CancelUpload"</span>, [fileID]);
};

<span class="comment">// Public: stopUpload stops the current upload and requeues the file at the beginning of the queue.</span>
<span class="comment">// If nothing is currently uploading then nothing happens.</span>
SWFUpload.<span class="reserved">prototype</span>.stopUpload = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.callFlash(<span class="literal">"StopUpload"</span>);
};

<span class="comment">/* ************************
 * Settings methods
 *   These methods change the SWFUpload settings.
 *   SWFUpload settings should not be changed directly on the settings object
 *   since many of the settings need to be passed to Flash in order to take
 *   effect.
 * *********************** */</span>

<span class="comment">// Public: getStats gets the file statistics object.</span>
SWFUpload.<span class="reserved">prototype</span>.getStats = <span class="reserved">function</span> () {
	<span class="reserved">return</span> <span class="reserved">this</span>.callFlash(<span class="literal">"GetStats"</span>);
};

<span class="comment">// Public: setStats changes the SWFUpload statistics.  You shouldn't need to </span>
<span class="comment">// change the statistics but you can.  Changing the statistics does not</span>
<span class="comment">// affect SWFUpload accept for the successful_uploads count which is used</span>
<span class="comment">// by the upload_limit setting to determine how many files the user may upload.</span>
SWFUpload.<span class="reserved">prototype</span>.setStats = <span class="reserved">function</span> (statsObject) {
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetStats"</span>, [statsObject]);
};

<span class="comment">// Public: getFile retrieves a File object by ID or Index.  If the file is</span>
<span class="comment">// not found then 'null' is returned.</span>
SWFUpload.<span class="reserved">prototype</span>.getFile = <span class="reserved">function</span> (fileID) {
	<span class="reserved">if</span> (typeof(fileID) === <span class="literal">"number"</span>) {
		<span class="reserved">return</span> <span class="reserved">this</span>.callFlash(<span class="literal">"GetFileByIndex"</span>, [fileID]);
	} <span class="reserved">else</span> {
		<span class="reserved">return</span> <span class="reserved">this</span>.callFlash(<span class="literal">"GetFile"</span>, [fileID]);
	}
};

<span class="comment">// Public: addFileParam sets a name/value pair that will be posted with the</span>
<span class="comment">// file specified by the Files ID.  If the name already exists then the</span>
<span class="comment">// exiting value will be overwritten.</span>
SWFUpload.<span class="reserved">prototype</span>.addFileParam = <span class="reserved">function</span> (fileID, name, value) {
	<span class="reserved">return</span> <span class="reserved">this</span>.callFlash(<span class="literal">"AddFileParam"</span>, [fileID, name, value]);
};

<span class="comment">// Public: removeFileParam removes a previously set (by addFileParam) name/value</span>
<span class="comment">// pair from the specified file.</span>
SWFUpload.<span class="reserved">prototype</span>.removeFileParam = <span class="reserved">function</span> (fileID, name) {
	<span class="reserved">this</span>.callFlash(<span class="literal">"RemoveFileParam"</span>, [fileID, name]);
};

<span class="comment">// Public: setUploadUrl changes the upload_url setting.</span>
SWFUpload.<span class="reserved">prototype</span>.setUploadURL = <span class="reserved">function</span> (url) {
	<span class="reserved">this</span>.settings.upload_url = url.toString();
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetUploadURL"</span>, [url]);
};

<span class="comment">// Public: setPostParams changes the post_params setting</span>
SWFUpload.<span class="reserved">prototype</span>.setPostParams = <span class="reserved">function</span> (paramsObject) {
	<span class="reserved">this</span>.settings.post_params = paramsObject;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetPostParams"</span>, [paramsObject]);
};

<span class="comment">// Public: addPostParam adds post name/value pair.  Each name can have only one value.</span>
SWFUpload.<span class="reserved">prototype</span>.addPostParam = <span class="reserved">function</span> (name, value) {
	<span class="reserved">this</span>.settings.post_params[name] = value;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetPostParams"</span>, [<span class="reserved">this</span>.settings.post_params]);
};

<span class="comment">// Public: removePostParam deletes post name/value pair.</span>
SWFUpload.<span class="reserved">prototype</span>.removePostParam = <span class="reserved">function</span> (name) {
	delete <span class="reserved">this</span>.settings.post_params[name];
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetPostParams"</span>, [<span class="reserved">this</span>.settings.post_params]);
};

<span class="comment">// Public: setFileTypes changes the file_types setting and the file_types_description setting</span>
SWFUpload.<span class="reserved">prototype</span>.setFileTypes = <span class="reserved">function</span> (types, description) {
	<span class="reserved">this</span>.settings.file_types = types;
	<span class="reserved">this</span>.settings.file_types_description = description;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetFileTypes"</span>, [types, description]);
};

<span class="comment">// Public: setFileSizeLimit changes the file_size_limit setting</span>
SWFUpload.<span class="reserved">prototype</span>.setFileSizeLimit = <span class="reserved">function</span> (fileSizeLimit) {
	<span class="reserved">this</span>.settings.file_size_limit = fileSizeLimit;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetFileSizeLimit"</span>, [fileSizeLimit]);
};

<span class="comment">// Public: setFileUploadLimit changes the file_upload_limit setting</span>
SWFUpload.<span class="reserved">prototype</span>.setFileUploadLimit = <span class="reserved">function</span> (fileUploadLimit) {
	<span class="reserved">this</span>.settings.file_upload_limit = fileUploadLimit;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetFileUploadLimit"</span>, [fileUploadLimit]);
};

<span class="comment">// Public: setFileQueueLimit changes the file_queue_limit setting</span>
SWFUpload.<span class="reserved">prototype</span>.setFileQueueLimit = <span class="reserved">function</span> (fileQueueLimit) {
	<span class="reserved">this</span>.settings.file_queue_limit = fileQueueLimit;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetFileQueueLimit"</span>, [fileQueueLimit]);
};

<span class="comment">// Public: setFilePostName changes the file_post_name setting</span>
SWFUpload.<span class="reserved">prototype</span>.setFilePostName = <span class="reserved">function</span> (filePostName) {
	<span class="reserved">this</span>.settings.file_post_name = filePostName;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetFilePostName"</span>, [filePostName]);
};

<span class="comment">// Public: setUseQueryString changes the use_query_string setting</span>
SWFUpload.<span class="reserved">prototype</span>.setUseQueryString = <span class="reserved">function</span> (useQueryString) {
	<span class="reserved">this</span>.settings.use_query_string = useQueryString;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetUseQueryString"</span>, [useQueryString]);
};

<span class="comment">// Public: setRequeueOnError changes the requeue_on_error setting</span>
SWFUpload.<span class="reserved">prototype</span>.setRequeueOnError = <span class="reserved">function</span> (requeueOnError) {
	<span class="reserved">this</span>.settings.requeue_on_error = requeueOnError;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetRequeueOnError"</span>, [requeueOnError]);
};

<span class="comment">// Public: setDebugEnabled changes the debug_enabled setting</span>
SWFUpload.<span class="reserved">prototype</span>.setDebugEnabled = <span class="reserved">function</span> (debugEnabled) {
	<span class="reserved">this</span>.settings.debug_enabled = debugEnabled;
	<span class="reserved">this</span>.callFlash(<span class="literal">"SetDebugEnabled"</span>, [debugEnabled]);
};


<span class="comment">/* *******************************
	Flash Event Interfaces
	These functions are used by Flash to trigger the various
	events.
	
	All these functions a Private.
	
	Because the ExternalInterface library is buggy the event calls
	are added to a queue and the queue then executed by a setTimeout.
	This ensures that events are executed in a determinate order and that
	the ExternalInterface bugs are avoided.
******************************* */</span>

SWFUpload.<span class="reserved">prototype</span>.queueEvent = <span class="reserved">function</span> (handlerName, argumentArray) {
	<span class="comment">// Warning: Don't call this.debug inside here or you'll create an infinite loop</span>
	
	<span class="reserved">if</span> (argumentArray == undefined) {
		argumentArray = [];
	} <span class="reserved">else</span> <span class="reserved">if</span> (!(argumentArray instanceof Array)) {
		argumentArray = [argumentArray];
	}
	
	var self = <span class="reserved">this</span>;
	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.settings[handlerName]) === <span class="literal">"function"</span>) {
		<span class="comment">// Queue the event</span>
		<span class="reserved">this</span>.eventQueue.push(<span class="reserved">function</span> () {
			<span class="reserved">this</span>.settings[handlerName].apply(<span class="reserved">this</span>, argumentArray);
		});
		
		<span class="comment">// Execute the next queued event</span>
		setTimeout(<span class="reserved">function</span> () {
			self.executeNextEvent();
		}, 0);
		
	} <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.settings[handlerName] !== null) {
		throw <span class="literal">"Event handler "</span> + handlerName + <span class="literal">" is unknown or is not a function"</span>;
	}
};

<span class="comment">// Private: Causes the next event in the queue to be executed.  Since events are queued using a setTimeout</span>
<span class="comment">// we must queue them in order to garentee that they are executed in order.</span>
SWFUpload.<span class="reserved">prototype</span>.executeNextEvent = <span class="reserved">function</span> () {
	<span class="comment">// Warning: Don't call this.debug inside here or you'll create an infinite loop</span>

	var  f = <span class="reserved">this</span>.eventQueue ? <span class="reserved">this</span>.eventQueue.shift() : null;
	<span class="reserved">if</span> (typeof(f) === <span class="literal">"function"</span>) {
		f.apply(<span class="reserved">this</span>);
	}
};

<span class="comment">// Private: unescapeFileParams is part of a workaround for a flash bug where objects passed through ExternalInterfance cannot have</span>
<span class="comment">// properties that contain characters that are not valid for JavaScript identifiers. To work around this</span>
<span class="comment">// the Flash Component escapes the parameter names and we must unescape again before passing them along.</span>
SWFUpload.<span class="reserved">prototype</span>.unescapeFilePostParams = <span class="reserved">function</span> (file) {
	var reg = /[$]([0-9a-f]{4})/i;
	var unescapedPost = {};
	var uk;

	<span class="reserved">if</span> (file != undefined) {
		<span class="reserved">for</span> (var k in file.post) {
			<span class="reserved">if</span> (file.post.hasOwnProperty(k)) {
				uk = k;
				var match;
				<span class="reserved">while</span> ((match = reg.exec(uk)) !== null) {
					uk = uk.replace(match[0], String.fromCharCode(parseInt(<span class="literal">"0x"</span>+match[1], 16)));
				}
				unescapedPost[uk] = file.post[k];
			}
		}

		file.post = unescapedPost;
	}

	<span class="reserved">return</span> file;
};

SWFUpload.<span class="reserved">prototype</span>.flashReady = <span class="reserved">function</span> () {
	<span class="comment">// Check that the movie element is loaded correctly with its ExternalInterface methods defined</span>
	var movieElement = <span class="reserved">this</span>.getMovieElement();
	<span class="reserved">if</span> (typeof(movieElement.StartUpload) !== <span class="literal">"function"</span>) {
		throw <span class="literal">"ExternalInterface methods failed to initialize."</span>;
	}
	
	<span class="reserved">this</span>.queueEvent(<span class="literal">"swfupload_loaded_handler"</span>);
};


<span class="comment">/* This is a chance to do something before the browse window opens */</span>
SWFUpload.<span class="reserved">prototype</span>.fileDialogStart = <span class="reserved">function</span> () {
	<span class="reserved">this</span>.queueEvent(<span class="literal">"file_dialog_start_handler"</span>);
};


<span class="comment">/* Called when a file is successfully added to the queue. */</span>
SWFUpload.<span class="reserved">prototype</span>.fileQueued = <span class="reserved">function</span> (file) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"file_queued_handler"</span>, file);
};


<span class="comment">/* Handle errors that occur when an attempt to queue a file fails. */</span>
SWFUpload.<span class="reserved">prototype</span>.fileQueueError = <span class="reserved">function</span> (file, errorCode, message) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"file_queue_error_handler"</span>, [file, errorCode, message]);
};

<span class="comment">/* Called after the file dialog has closed and the selected files have been queued.
	You could call startUpload here if you want the queued files to begin uploading immediately. */</span>
SWFUpload.<span class="reserved">prototype</span>.fileDialogComplete = <span class="reserved">function</span> (numFilesSelected, numFilesQueued) {
	<span class="reserved">this</span>.queueEvent(<span class="literal">"file_dialog_complete_handler"</span>, [numFilesSelected, numFilesQueued]);
};

SWFUpload.<span class="reserved">prototype</span>.uploadStart = <span class="reserved">function</span> (file) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"return_upload_start_handler"</span>, file);
};

SWFUpload.<span class="reserved">prototype</span>.returnUploadStart = <span class="reserved">function</span> (file) {
	var returnValue;
	<span class="reserved">if</span> (typeof(<span class="reserved">this</span>.settings.upload_start_handler) === <span class="literal">"function"</span>) {
		file = <span class="reserved">this</span>.unescapeFilePostParams(file);
		returnValue = <span class="reserved">this</span>.settings.upload_start_handler.call(<span class="reserved">this</span>, file);
	} <span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.settings.upload_start_handler != undefined) {
		throw <span class="literal">"upload_start_handler must be a function"</span>;
	}

	<span class="comment">// Convert undefined to true so if nothing is returned from the upload_start_handler it is</span>
	<span class="comment">// interpretted as 'true'.</span>
	<span class="reserved">if</span> (returnValue === undefined) {
		returnValue = true;
	}
	
	returnValue = !!returnValue;
	
	<span class="reserved">this</span>.callFlash(<span class="literal">"ReturnUploadStart"</span>, [returnValue]);
};



SWFUpload.<span class="reserved">prototype</span>.uploadProgress = <span class="reserved">function</span> (file, bytesComplete, bytesTotal) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"upload_progress_handler"</span>, [file, bytesComplete, bytesTotal]);
};

SWFUpload.<span class="reserved">prototype</span>.uploadError = <span class="reserved">function</span> (file, errorCode, message) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"upload_error_handler"</span>, [file, errorCode, message]);
};

SWFUpload.<span class="reserved">prototype</span>.uploadSuccess = <span class="reserved">function</span> (file, serverData) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"upload_success_handler"</span>, [file, serverData]);
};

SWFUpload.<span class="reserved">prototype</span>.uploadComplete = <span class="reserved">function</span> (file) {
	file = <span class="reserved">this</span>.unescapeFilePostParams(file);
	<span class="reserved">this</span>.queueEvent(<span class="literal">"upload_complete_handler"</span>, file);
};

<span class="comment">/* Called by SWFUpload JavaScript and Flash functions when debug is enabled. By default it writes messages to the
   internal debug console.  You can override this event and have messages written where you want. */</span>
SWFUpload.<span class="reserved">prototype</span>.debug = <span class="reserved">function</span> (message) {
	<span class="reserved">this</span>.queueEvent(<span class="literal">"debug_handler"</span>, message);
};
<span class="reserved">if</span> (!N2i) {var N2i = {};}

<span class="comment">/**
 * <span class="attrib">@class</span>
 */</span>
N2i.Animation = {
	objects : {},
	running : false,
	latestId : 0,
	IE : navigator.userAgent.indexOf(<span class="literal">'MSIE'</span>)!=-1
};

N2i.Animation.loco = <span class="reserved">function</span>(val) {
	<span class="reserved">return</span> Math.sin(3*val*Math.PI-Math.PI/2)*.5+.5;
}

N2i.Animation.ease = <span class="reserved">function</span>(val) {
	<span class="reserved">return</span> Math.sin(val*Math.PI-Math.PI/2)*.5+.5;
}

N2i.Animation.func2 = <span class="reserved">function</span>(val) {
	<span class="reserved">return</span> (-1*Math.pow((val-1),2))+1;
}

N2i.Animation.fastSlow = <span class="reserved">function</span>(val) {
	var a = .5;
	var b = .7
	<span class="reserved">return</span> -1*Math.pow(Math.cos((Math.PI/2)*Math.pow(val,a)),Math.pow(Math.PI,b))+1;
}

N2i.Animation.slowFastSlow = <span class="reserved">function</span>(val) {
	var a = 1.6;
	var b = 1.4;
	<span class="reserved">return</span> -1*Math.pow(Math.cos((Math.PI/2)*Math.pow(val,a)),Math.pow(Math.PI,b))+1;
}

N2i.Animation.elasticIn = <span class="reserved">function</span>(n) {
	<span class="reserved">if</span>(n==0){ <span class="reserved">return</span> 0; }
	<span class="reserved">if</span>(n==1){ <span class="reserved">return</span> 1; }
	var p = .3;
	var s = p/4;
	n = n - 1;
	<span class="reserved">return</span> -1 * Math.pow(2,10*n) * Math.sin((n-s)*(2*Math.PI)/p);
}

N2i.Animation.backOut = <span class="reserved">function</span>(n) {
	n = n - 1;
	var s = 1.70158;
	<span class="reserved">return</span> Math.pow(n, 2) * ((s + 1) * n + s) + 1;
}

N2i.Animation.bounce = <span class="reserved">function</span>(t) {
	<span class="reserved">if</span> (t &lt; (1/2.75)) {
		<span class="reserved">return</span> 7.5625*t*t;
	} <span class="reserved">else</span> <span class="reserved">if</span> (t &lt; (2/2.75)) {
		<span class="reserved">return</span> (7.5625*(t-=(1.5/2.75))*t + .75);
	} <span class="reserved">else</span> <span class="reserved">if</span> (t &lt; (2.5/2.75)) {
		<span class="reserved">return</span> (7.5625*(t-=(2.25/2.75))*t + .9375);
	} <span class="reserved">else</span> {
		<span class="reserved">return</span> (7.5625*(t-=(2.625/2.75))*t + .984375);
	}
}

N2i.Animation.elastic = <span class="reserved">function</span>(t) {
	<span class="reserved">return</span> 1 - N2i.Animation.elastic2(1-t);
}

N2i.Animation.elastic2 = <span class="reserved">function</span> (t, a, p) {
	<span class="reserved">if</span> (t&lt;=0 || t&gt;=1) <span class="reserved">return</span> t;
	<span class="reserved">if</span> (!p) p=0.45;
	var s;
	<span class="reserved">if</span> (!a || a &lt; 1) {
		a=1;
		s=p/4;
	} <span class="reserved">else</span> {
		s = p/(2*Math.PI) * Math.asin (1/a);
	}
	<span class="reserved">return</span> -(a*Math.pow(2,10*(t-=1)) * Math.sin( (t-s)*(2*Math.PI)/p ));
}

N2i.Animation.get = <span class="reserved">function</span>(element) {
	element = $id(element);
	<span class="reserved">if</span> (!element.n2iAnimationId) element.n2iAnimationId = <span class="reserved">this</span>.latestId++;
	<span class="reserved">if</span> (!<span class="reserved">this</span>.objects[element.n2iAnimationId]) {
		<span class="reserved">this</span>.objects[element.n2iAnimationId] = new N2i.Animation.Item(element);
	}
	<span class="reserved">return</span> <span class="reserved">this</span>.objects[element.n2iAnimationId];
}

N2i.Animation.start = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (!<span class="reserved">this</span>.running) {
		N2i.Animation.render();
	}
}

N2i.Animation.render = <span class="reserved">function</span>(element) {
	<span class="reserved">this</span>.running = true;
	var next = false;
	var stamp = new Date().getTime();
	<span class="reserved">for</span> (id in <span class="reserved">this</span>.objects) {
		var obj = <span class="reserved">this</span>.objects[id];
		<span class="reserved">if</span> (obj.work) {
			<span class="reserved">for</span> (var i=0; i &lt; obj.work.length; i++) {
				var work = obj.work[i];
				<span class="reserved">if</span> (work.finished) continue;
				var place = (stamp-work.start)/(work.end-work.start);
				<span class="reserved">if</span> (place&lt;0) {
					next=true;
					continue;
				}
				<span class="reserved">else</span> <span class="reserved">if</span> (isNaN(place)) place = 1;
				<span class="reserved">else</span> <span class="reserved">if</span> (place&gt;1) place=1;
				<span class="reserved">else</span> <span class="reserved">if</span> (place&lt;1) next=true;
				var v = place;
				<span class="reserved">if</span> (work.delegate &amp;&amp; work.delegate.ease) {
					v = work.delegate.ease(v);
				}
				var value = null;
				<span class="reserved">if</span> (!work.css) {
					obj.element[work.property] = Math.round(work.from+(work.to-work.from)*v);
				} <span class="reserved">else</span> <span class="reserved">if</span> (work.to.red!=null) {
					var red = Math.round(work.from.red+(work.to.red-work.from.red)*v);
					var green = Math.round(work.from.green+(work.to.green-work.from.green)*v);
					var blue = Math.round(work.from.blue+(work.to.blue-work.from.blue)*v);
					value = <span class="literal">'rgb('</span>+red+<span class="literal">','</span>+green+<span class="literal">','</span>+blue+<span class="literal">')'</span>;
					obj.element.style[work.property]=value;
				} <span class="reserved">else</span> <span class="reserved">if</span> (N2i.Animation.IE &amp;&amp; work.property==<span class="literal">'opacity'</span>) {
					var opacity = (work.from+(work.to-work.from)*v);
					obj.element.style[<span class="literal">'filter'</span>]=<span class="literal">'alpha(opacity='</span>+(opacity*100)+<span class="literal">')'</span>;
				} <span class="reserved">else</span> {
					value = new String(work.from+(work.to-work.from)*v)+(work.unit!=null ? work.unit : <span class="literal">''</span>);
					obj.element.style[work.property]=value;
				}
				<span class="reserved">if</span> (place==1) {
					work.finished = true;
					<span class="reserved">if</span> (work.delegate &amp;&amp; work.delegate.onComplete) {
						work.delegate.onComplete();
					} <span class="reserved">else</span> <span class="reserved">if</span> (work.delegate &amp;&amp; work.delegate.hideOnComplete) {
						obj.element.style.display=<span class="literal">'none'</span>;
					}
				}
			};
		}
	}
	<span class="reserved">if</span> (next) {
		window.setTimeout(<span class="reserved">function</span>() {
			N2i.Animation.render();
		},0);
	} <span class="reserved">else</span> {
		<span class="reserved">this</span>.running = false;
	}
	<span class="comment">//window.status = this.running;</span>
}

N2i.Animation.parseStyle = <span class="reserved">function</span>(value) {
	var parsed = {type:null,value:null,unit:null};
	var match;
	<span class="reserved">if</span> (!isNaN(value)) {
		parsed.value=parseFloat(value);
	} <span class="reserved">else</span> <span class="reserved">if</span> (match=value.match(/([\-]?[0-9\.]+)(px|pt|%)/)) {
		parsed.type = <span class="literal">'length'</span>;
		parsed.value = parseFloat(match[1]);
		parsed.unit = match[2];
	} <span class="reserved">else</span> <span class="reserved">if</span> (match=value.match(/rgb\(([0-9]+),[ ]?([0-9]+),[ ]?([0-9]+)\)/)) {
		parsed.type = <span class="literal">'color'</span>;
		parsed.value = {
			red:parseInt(match[1]),
			green:parseInt(match[2]),
			blue:parseInt(match[3])
		};
	} <span class="reserved">else</span> {
		var color = new N2i.Color(value);
		<span class="reserved">if</span> (color.ok) {
			parsed.value = {
				red:color.r,
				green:color.g,
				blue:color.b
			};
		}
	}
	<span class="reserved">return</span> parsed;
}

<span class="comment">/********************************* Item **********************************/</span>

N2i.Animation.Item = <span class="reserved">function</span>(element) {
	<span class="reserved">this</span>.element = element;
	<span class="reserved">this</span>.work = [];
}

N2i.Animation.Item.<span class="reserved">prototype</span>.animate = <span class="reserved">function</span>(from,to,property,duration,delegate) {
	var css = true;
	<span class="reserved">if</span> (property==<span class="literal">'scrollLeft'</span>) {
		css = false;
	}
	
	var work = <span class="reserved">this</span>.getWork(css ? N2i.camelize(property) : property);
	work.delegate = delegate;
	work.finished = false;
	work.css = css;
	<span class="reserved">if</span> (from!=null) {
		work.from = from;
	} <span class="reserved">else</span> <span class="reserved">if</span> (work.css &amp;&amp; N2i.Animation.IE &amp;&amp; property==<span class="literal">'opacity'</span>) {
		work.from = <span class="reserved">this</span>.getIEOpacity(<span class="reserved">this</span>.element);
	} <span class="reserved">else</span> <span class="reserved">if</span> (work.css) {
		var style = N2i.Element.getStyle(<span class="reserved">this</span>.element,property);
		var parsedStyle = N2i.Animation.parseStyle(style);
		work.from = parsedStyle.value;
	} <span class="reserved">else</span> {
		work.from = <span class="reserved">this</span>.element[property];
	}
	<span class="reserved">if</span> (work.css) {
		var parsed = N2i.Animation.parseStyle(to);
		work.to = parsed.value;
		work.unit = parsed.unit;
	} <span class="reserved">else</span> {
		work.to = to;
		work.unit = null;
	}
	work.start = new Date().getTime();
	<span class="reserved">if</span> (delegate &amp;&amp; delegate.delay) work.start+=delegate.delay;
	work.end = work.start+duration;
	N2i.Animation.start();
}

N2i.Animation.Item.<span class="reserved">prototype</span>.getIEOpacity = <span class="reserved">function</span>(element) {
	var filter = N2i.Element.getStyle(element,<span class="literal">'filter'</span>).toLowerCase();
	var match;
	<span class="reserved">if</span> (match = filter.match(/opacity=([0-9]+)/)) {
		<span class="reserved">return</span> parseFloat(match[1])/100;
	} <span class="reserved">else</span> {
		<span class="reserved">return</span> 1;
	}
}

N2i.Animation.Item.<span class="reserved">prototype</span>.getWork = <span class="reserved">function</span>(property) {
	<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.work.length; i++) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.work[i].property==property) {
			<span class="reserved">return</span> <span class="reserved">this</span>.work[i];
		}
	};
	var work = {property:property};
	<span class="reserved">this</span>.work[<span class="reserved">this</span>.work.length] = work;
	<span class="reserved">return</span> work;
}

<span class="comment">/************************************** Loop **********************************/</span>

N2i.Animation.Loop = <span class="reserved">function</span>(recipe) {
	<span class="reserved">this</span>.recipe = recipe;
	<span class="reserved">this</span>.position = -1;
	<span class="reserved">this</span>.running = false;
}

N2i.Animation.Loop.<span class="reserved">prototype</span>.next = <span class="reserved">function</span>() {
	<span class="reserved">this</span>.position++;
	<span class="reserved">if</span> (<span class="reserved">this</span>.position&gt;=<span class="reserved">this</span>.recipe.length) {
		<span class="reserved">this</span>.position = 0;
	}
	var item = <span class="reserved">this</span>.recipe[<span class="reserved">this</span>.position];
	<span class="reserved">if</span> (typeof(item)==<span class="literal">'function'</span>) {
		item();
	} <span class="reserved">else</span> <span class="reserved">if</span> (item.element) {
		$ani(item.element,item.property,item.value,item.duration,{ease:item.ease});
	}
	var self = <span class="reserved">this</span>;
	var time = item.duration || 0;
	window.setTimeout(<span class="reserved">function</span>() {self.next()},time);
}

N2i.Animation.Loop.<span class="reserved">prototype</span>.start = <span class="reserved">function</span>() {
	<span class="reserved">this</span>.running=true;
	<span class="reserved">this</span>.next();
}

<span class="comment">/************************************** Color *********************************/</span>


N2i.Color = <span class="reserved">function</span>(color_string) {
    <span class="reserved">this</span>.ok = false;

    <span class="comment">// strip any leading #</span>
    <span class="reserved">if</span> (color_string.charAt(0) == <span class="literal">'#'</span>) { <span class="comment">// remove # if any</span>
        color_string = color_string.substr(1,6);
    }

    color_string = color_string.replace(/ /g,<span class="literal">''</span>);
    color_string = color_string.toLowerCase();

    <span class="comment">// before getting into regexps, try simple matches</span>
    <span class="comment">// and overwrite the input</span>
    var simple_colors = {
        aliceblue: <span class="literal">'f0f8ff'</span>,
        antiquewhite: <span class="literal">'faebd7'</span>,
        aqua: <span class="literal">'00ffff'</span>,
        aquamarine: <span class="literal">'7fffd4'</span>,
        azure: <span class="literal">'f0ffff'</span>,
        beige: <span class="literal">'f5f5dc'</span>,
        bisque: <span class="literal">'ffe4c4'</span>,
        black: <span class="literal">'000000'</span>,
        blanchedalmond: <span class="literal">'ffebcd'</span>,
        blue: <span class="literal">'0000ff'</span>,
        blueviolet: <span class="literal">'8a2be2'</span>,
        brown: <span class="literal">'a52a2a'</span>,
        burlywood: <span class="literal">'deb887'</span>,
        cadetblue: <span class="literal">'5f9ea0'</span>,
        chartreuse: <span class="literal">'7fff00'</span>,
        chocolate: <span class="literal">'d2691e'</span>,
        coral: <span class="literal">'ff7f50'</span>,
        cornflowerblue: <span class="literal">'6495ed'</span>,
        cornsilk: <span class="literal">'fff8dc'</span>,
        crimson: <span class="literal">'dc143c'</span>,
        cyan: <span class="literal">'00ffff'</span>,
        darkblue: <span class="literal">'00008b'</span>,
        darkcyan: <span class="literal">'008b8b'</span>,
        darkgoldenrod: <span class="literal">'b8860b'</span>,
        darkgray: <span class="literal">'a9a9a9'</span>,
        darkgreen: <span class="literal">'006400'</span>,
        darkkhaki: <span class="literal">'bdb76b'</span>,
        darkmagenta: <span class="literal">'8b008b'</span>,
        darkolivegreen: <span class="literal">'556b2f'</span>,
        darkorange: <span class="literal">'ff8c00'</span>,
        darkorchid: <span class="literal">'9932cc'</span>,
        darkred: <span class="literal">'8b0000'</span>,
        darksalmon: <span class="literal">'e9967a'</span>,
        darkseagreen: <span class="literal">'8fbc8f'</span>,
        darkslateblue: <span class="literal">'483d8b'</span>,
        darkslategray: <span class="literal">'2f4f4f'</span>,
        darkturquoise: <span class="literal">'00ced1'</span>,
        darkviolet: <span class="literal">'9400d3'</span>,
        deeppink: <span class="literal">'ff1493'</span>,
        deepskyblue: <span class="literal">'00bfff'</span>,
        dimgray: <span class="literal">'696969'</span>,
        dodgerblue: <span class="literal">'1e90ff'</span>,
        feldspar: <span class="literal">'d19275'</span>,
        firebrick: <span class="literal">'b22222'</span>,
        floralwhite: <span class="literal">'fffaf0'</span>,
        forestgreen: <span class="literal">'228b22'</span>,
        fuchsia: <span class="literal">'ff00ff'</span>,
        gainsboro: <span class="literal">'dcdcdc'</span>,
        ghostwhite: <span class="literal">'f8f8ff'</span>,
        gold: <span class="literal">'ffd700'</span>,
        goldenrod: <span class="literal">'daa520'</span>,
        gray: <span class="literal">'808080'</span>,
        green: <span class="literal">'008000'</span>,
        greenyellow: <span class="literal">'adff2f'</span>,
        honeydew: <span class="literal">'f0fff0'</span>,
        hotpink: <span class="literal">'ff69b4'</span>,
        indianred : <span class="literal">'cd5c5c'</span>,
        indigo : <span class="literal">'4b0082'</span>,
        ivory: <span class="literal">'fffff0'</span>,
        khaki: <span class="literal">'f0e68c'</span>,
        lavender: <span class="literal">'e6e6fa'</span>,
        lavenderblush: <span class="literal">'fff0f5'</span>,
        lawngreen: <span class="literal">'7cfc00'</span>,
        lemonchiffon: <span class="literal">'fffacd'</span>,
        lightblue: <span class="literal">'add8e6'</span>,
        lightcoral: <span class="literal">'f08080'</span>,
        lightcyan: <span class="literal">'e0ffff'</span>,
        lightgoldenrodyellow: <span class="literal">'fafad2'</span>,
        lightgrey: <span class="literal">'d3d3d3'</span>,
        lightgreen: <span class="literal">'90ee90'</span>,
        lightpink: <span class="literal">'ffb6c1'</span>,
        lightsalmon: <span class="literal">'ffa07a'</span>,
        lightseagreen: <span class="literal">'20b2aa'</span>,
        lightskyblue: <span class="literal">'87cefa'</span>,
        lightslateblue: <span class="literal">'8470ff'</span>,
        lightslategray: <span class="literal">'778899'</span>,
        lightsteelblue: <span class="literal">'b0c4de'</span>,
        lightyellow: <span class="literal">'ffffe0'</span>,
        lime: <span class="literal">'00ff00'</span>,
        limegreen: <span class="literal">'32cd32'</span>,
        linen: <span class="literal">'faf0e6'</span>,
        magenta: <span class="literal">'ff00ff'</span>,
        maroon: <span class="literal">'800000'</span>,
        mediumaquamarine: <span class="literal">'66cdaa'</span>,
        mediumblue: <span class="literal">'0000cd'</span>,
        mediumorchid: <span class="literal">'ba55d3'</span>,
        mediumpurple: <span class="literal">'9370d8'</span>,
        mediumseagreen: <span class="literal">'3cb371'</span>,
        mediumslateblue: <span class="literal">'7b68ee'</span>,
        mediumspringgreen: <span class="literal">'00fa9a'</span>,
        mediumturquoise: <span class="literal">'48d1cc'</span>,
        mediumvioletred: <span class="literal">'c71585'</span>,
        midnightblue: <span class="literal">'191970'</span>,
        mintcream: <span class="literal">'f5fffa'</span>,
        mistyrose: <span class="literal">'ffe4e1'</span>,
        moccasin: <span class="literal">'ffe4b5'</span>,
        navajowhite: <span class="literal">'ffdead'</span>,
        navy: <span class="literal">'000080'</span>,
        oldlace: <span class="literal">'fdf5e6'</span>,
        olive: <span class="literal">'808000'</span>,
        olivedrab: <span class="literal">'6b8e23'</span>,
        orange: <span class="literal">'ffa500'</span>,
        orangered: <span class="literal">'ff4500'</span>,
        orchid: <span class="literal">'da70d6'</span>,
        palegoldenrod: <span class="literal">'eee8aa'</span>,
        palegreen: <span class="literal">'98fb98'</span>,
        paleturquoise: <span class="literal">'afeeee'</span>,
        palevioletred: <span class="literal">'d87093'</span>,
        papayawhip: <span class="literal">'ffefd5'</span>,
        peachpuff: <span class="literal">'ffdab9'</span>,
        peru: <span class="literal">'cd853f'</span>,
        pink: <span class="literal">'ffc0cb'</span>,
        plum: <span class="literal">'dda0dd'</span>,
        powderblue: <span class="literal">'b0e0e6'</span>,
        purple: <span class="literal">'800080'</span>,
        red: <span class="literal">'ff0000'</span>,
        rosybrown: <span class="literal">'bc8f8f'</span>,
        royalblue: <span class="literal">'4169e1'</span>,
        saddlebrown: <span class="literal">'8b4513'</span>,
        salmon: <span class="literal">'fa8072'</span>,
        sandybrown: <span class="literal">'f4a460'</span>,
        seagreen: <span class="literal">'2e8b57'</span>,
        seashell: <span class="literal">'fff5ee'</span>,
        sienna: <span class="literal">'a0522d'</span>,
        silver: <span class="literal">'c0c0c0'</span>,
        skyblue: <span class="literal">'87ceeb'</span>,
        slateblue: <span class="literal">'6a5acd'</span>,
        slategray: <span class="literal">'708090'</span>,
        snow: <span class="literal">'fffafa'</span>,
        springgreen: <span class="literal">'00ff7f'</span>,
        steelblue: <span class="literal">'4682b4'</span>,
        tan: <span class="literal">'d2b48c'</span>,
        teal: <span class="literal">'008080'</span>,
        thistle: <span class="literal">'d8bfd8'</span>,
        tomato: <span class="literal">'ff6347'</span>,
        turquoise: <span class="literal">'40e0d0'</span>,
        violet: <span class="literal">'ee82ee'</span>,
        violetred: <span class="literal">'d02090'</span>,
        wheat: <span class="literal">'f5deb3'</span>,
        white: <span class="literal">'ffffff'</span>,
        whitesmoke: <span class="literal">'f5f5f5'</span>,
        yellow: <span class="literal">'ffff00'</span>,
        yellowgreen: <span class="literal">'9acd32'</span>
    };
    <span class="reserved">for</span> (var key in simple_colors) {
        <span class="reserved">if</span> (color_string == key) {
            color_string = simple_colors[key];
        }
    }
    <span class="comment">// emd of simple type-in colors</span>

    <span class="comment">// array of color definition objects</span>
    var color_defs = [
        {
            re: /^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,
            example: [<span class="literal">'rgb(123, 234, 45)'</span>, <span class="literal">'rgb(255,234,245)'</span>],
            process: <span class="reserved">function</span> (bits){
                <span class="reserved">return</span> [
                    parseInt(bits[1]),
                    parseInt(bits[2]),
                    parseInt(bits[3])
                ];
            }
        },
        {
            re: /^(\w{2})(\w{2})(\w{2})$/,
            example: [<span class="literal">'#00ff00'</span>, <span class="literal">'336699'</span>],
            process: <span class="reserved">function</span> (bits){
                <span class="reserved">return</span> [
                    parseInt(bits[1], 16),
                    parseInt(bits[2], 16),
                    parseInt(bits[3], 16)
                ];
            }
        },
        {
            re: /^(\w{1})(\w{1})(\w{1})$/,
            example: [<span class="literal">'#fb0'</span>, <span class="literal">'f0f'</span>],
            process: <span class="reserved">function</span> (bits){
                <span class="reserved">return</span> [
                    parseInt(bits[1] + bits[1], 16),
                    parseInt(bits[2] + bits[2], 16),
                    parseInt(bits[3] + bits[3], 16)
                ];
            }
        }
    ];

    <span class="comment">// search through the definitions to find a match</span>
    <span class="reserved">for</span> (var i = 0; i &lt; color_defs.length; i++) {
        var re = color_defs[i].re;
        var processor = color_defs[i].process;
        var bits = re.exec(color_string);
        <span class="reserved">if</span> (bits) {
            channels = processor(bits);
            <span class="reserved">this</span>.r = channels[0];
            <span class="reserved">this</span>.g = channels[1];
            <span class="reserved">this</span>.b = channels[2];
            <span class="reserved">this</span>.ok = true;
        }

    }

    <span class="comment">// validate/cleanup values</span>
    <span class="reserved">this</span>.r = (<span class="reserved">this</span>.r &lt; 0 || isNaN(<span class="reserved">this</span>.r)) ? 0 : ((<span class="reserved">this</span>.r &gt; 255) ? 255 : <span class="reserved">this</span>.r);
    <span class="reserved">this</span>.g = (<span class="reserved">this</span>.g &lt; 0 || isNaN(<span class="reserved">this</span>.g)) ? 0 : ((<span class="reserved">this</span>.g &gt; 255) ? 255 : <span class="reserved">this</span>.g);
    <span class="reserved">this</span>.b = (<span class="reserved">this</span>.b &lt; 0 || isNaN(<span class="reserved">this</span>.b)) ? 0 : ((<span class="reserved">this</span>.b &gt; 255) ? 255 : <span class="reserved">this</span>.b);

    <span class="comment">// some getters</span>
    <span class="reserved">this</span>.toRGB = <span class="reserved">function</span> () {
        <span class="reserved">return</span> <span class="literal">'rgb('</span> + <span class="reserved">this</span>.r + <span class="literal">', '</span> + <span class="reserved">this</span>.g + <span class="literal">', '</span> + <span class="reserved">this</span>.b + <span class="literal">')'</span>;
    }
    <span class="reserved">this</span>.toHex = <span class="reserved">function</span> () {
        var r = <span class="reserved">this</span>.r.toString(16);
        var g = <span class="reserved">this</span>.g.toString(16);
        var b = <span class="reserved">this</span>.b.toString(16);
        <span class="reserved">if</span> (r.length == 1) r = <span class="literal">'0'</span> + r;
        <span class="reserved">if</span> (g.length == 1) g = <span class="literal">'0'</span> + g;
        <span class="reserved">if</span> (b.length == 1) b = <span class="literal">'0'</span> + b;
        <span class="reserved">return</span> <span class="literal">'#'</span> + r + g + b;
    }

}


N2i.ease = {
	
	linear: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: A linear easing function</span>
		<span class="reserved">return</span> n;
	},

	quadIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n, 2);
	},

	quadOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> n * (n-2) * -1;
	},

	quadInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n=n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> Math.pow(n, 2) / 2; }
		<span class="reserved">return</span> -1 * ((--n)*(n-2) - 1) / 2;
	},

	cubicIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n, 3);
	},

	cubicOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n-1, 3) + 1;
	},

	cubicInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n=n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> Math.pow(n, 3) / 2; }
		n-=2;
		<span class="reserved">return</span> (Math.pow(n, 3) + 2) / 2;
	},

	quartIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n, 4);
	},

	quartOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> -1 * (Math.pow(n-1, 4) - 1);
	},

	quartInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n=n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> Math.pow(n, 4) / 2; }
		n-=2;
		<span class="reserved">return</span> -1/2 * (Math.pow(n, 4) - 2);
	},

	quintIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n, 5);
	},

	quintOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.pow(n-1, 5) + 1;
	},

	quintInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n=n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> Math.pow(n, 5) / 2; };
		n-=2;
		<span class="reserved">return</span> (Math.pow(n, 5) + 2) / 2;
	},

	sineIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> -1 * Math.cos(n * (Math.PI/2)) + 1;
	},

	sineOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> Math.sin(n * (Math.PI/2));
	},

	sineInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> -1 * (Math.cos(Math.PI*n) - 1) / 2;
	},

	expoIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> (n==0) ? 0 : Math.pow(2, 10 * (n - 1));
	},

	expoOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> (n==1) ? 1 : (-1 * Math.pow(2, -10 * n) + 1);
	},

	expoInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">if</span>(n==0){ <span class="reserved">return</span> 0; }
		<span class="reserved">if</span>(n==1){ <span class="reserved">return</span> 1; }
		n = n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> Math.pow(2, 10 * (n-1)) / 2; }
		--n;
		<span class="reserved">return</span> (-1 * Math.pow(2, -10 * n) + 2) / 2;
	},

	circIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">return</span> -1 * (Math.sqrt(1 - Math.pow(n, 2)) - 1);
	},

	circOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n = n-1;
		<span class="reserved">return</span> Math.sqrt(1 - Math.pow(n, 2));
	},

	circInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		n = n*2;
		<span class="reserved">if</span>(n&lt;1){ <span class="reserved">return</span> -1/2 * (Math.sqrt(1 - Math.pow(n, 2)) - 1); }
		n-=2;
		<span class="reserved">return</span> 1/2 * (Math.sqrt(1 - Math.pow(n, 2)) + 1);
	},

	backIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		var s = 1.70158;
		<span class="reserved">return</span> Math.pow(n, 2) * ((s+1)*n - s);
	},

	backOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: an easing function that pops past the range briefly, and </span>
		<span class="comment">// 	slowly comes back. </span>
		n = n - 1;
		var s = 1.70158;
		<span class="reserved">return</span> Math.pow(n, 2) * ((s + 1) * n + s) + 1;
	},

	backInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		var s = 1.70158 * 1.525;
		n = n*2;
		<span class="reserved">if</span>(n &lt; 1){ <span class="reserved">return</span> (Math.pow(n, 2)*((s+1)*n - s))/2; }
		n-=2;
		<span class="reserved">return</span> (Math.pow(n, 2)*((s+1)*n + s) + 2)/2;
	},

	elasticIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="reserved">if</span>(n==0){ <span class="reserved">return</span> 0; }
		<span class="reserved">if</span>(n==1){ <span class="reserved">return</span> 1; }
		var p = .3;
		var s = p/4;
		n = n - 1;
		<span class="reserved">return</span> -1 * Math.pow(2,10*n) * Math.sin((n-s)*(2*Math.PI)/p);
	},

	elasticOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: An easing function that elasticly snaps around the target value, near the end of the Animation</span>
		<span class="reserved">if</span>(n==0) <span class="reserved">return</span> 0;
		<span class="reserved">if</span>(n==1) <span class="reserved">return</span> 1;
		var p = .3;
		var s = p/4;
		<span class="reserved">return</span> Math.pow(2,-10*n) * Math.sin((n-s)*(2*Math.PI)/p) + 1;
	},

	elasticInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: An easing function that elasticly snaps around the value, near the beginning and end of the Animation		</span>
		<span class="reserved">if</span>(n==0) <span class="reserved">return</span> 0;
		n = n*2;
		<span class="reserved">if</span>(n==2) <span class="reserved">return</span> 1;
		var p = .3*1.5;
		var s = p/4;
		<span class="reserved">if</span>(n&lt;1){
			n-=1;
			<span class="reserved">return</span> -.5*(Math.pow(2,10*n) * Math.sin((n-s)*(2*Math.PI)/p));
		}
		n-=1;
		<span class="reserved">return</span> .5*(Math.pow(2,-10*n) * Math.sin((n-s)*(2*Math.PI)/p)) + 1;
	},

	bounceIn: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: An easing function that "bounces" near the beginning of an Animation</span>
		<span class="reserved">return</span> (1 - N2i.ease.bounceOut(1-n)); <span class="comment">// Decimal</span>
	},

	bounceOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: An easing function that "bounces" near the end of an Animation</span>
		var s=7.5625;
		var p=2.75;
		var l; 
		<span class="reserved">if</span>(n &lt; (1 / p)){
			l = s*Math.pow(n, 2);
		}<span class="reserved">else</span> <span class="reserved">if</span>(n &lt; (2 / p)){
			n -= (1.5 / p);
			l = s * Math.pow(n, 2) + .75;
		}<span class="reserved">else</span> <span class="reserved">if</span>(n &lt; (2.5 / p)){
			n -= (2.25 / p);
			l = s * Math.pow(n, 2) + .9375;
		}<span class="reserved">else</span>{
			n -= (2.625 / p);
			l = s * Math.pow(n, 2) + .984375;
		}
		<span class="reserved">return</span> l;
	},

	bounceInOut: <span class="reserved">function</span>(<span class="comment">/* Decimal? */</span>n){
		<span class="comment">// summary: An easing function that "bounces" at the beginning and end of the Animation</span>
		<span class="reserved">if</span>(n&lt;0.5){ <span class="reserved">return</span> N2i.ease.bounceIn(n*2) / 2; }
		<span class="reserved">return</span> (N2i.ease.bounceOut(n*2-1) / 2) + 0.5; <span class="comment">// Decimal</span>
	}
};<span class="reserved">if</span> (!N2i) {var N2i = {};}

N2i.TextField = <span class="reserved">function</span>(field,options,delegate) {
	<span class="reserved">this</span>.field = $id(field);
	<span class="reserved">this</span>.value = <span class="reserved">this</span>.field.value;
	<span class="reserved">this</span>.options = options || {};
	<span class="reserved">this</span>.delegate = delegate || {};
	<span class="reserved">if</span> (<span class="reserved">this</span>.options.placeholder &amp;&amp; <span class="reserved">this</span>.field.value==<span class="literal">''</span>) {
		<span class="reserved">this</span>.field.value=<span class="reserved">this</span>.options.placeholder;
	}
	<span class="reserved">this</span>.addBehaviour();
}

N2i.TextField.<span class="reserved">prototype</span>.addBehaviour = <span class="reserved">function</span>() {
	var self = <span class="reserved">this</span>;
	<span class="reserved">this</span>.field.onfocus = <span class="reserved">function</span>() {
		self.onfocus();
	}
	<span class="reserved">this</span>.field.onblur = <span class="reserved">function</span>() {
		self.blur();
	}
	<span class="reserved">this</span>.field.onkeydown = <span class="reserved">this</span>.field.onkeyup = <span class="reserved">this</span>.field.onkeypress = <span class="reserved">function</span>() {
		self.key();
	}
}

N2i.TextField.<span class="reserved">prototype</span>.setDelegate = <span class="reserved">function</span>(delegate) {
	<span class="reserved">this</span>.delegate = delegate || {};
}

N2i.TextField.<span class="reserved">prototype</span>.setEnabled = <span class="reserved">function</span>(enabled) {
	<span class="reserved">this</span>.field.disabled = !enabled;
}

N2i.TextField.<span class="reserved">prototype</span>.getValue = <span class="reserved">function</span>() {
	<span class="reserved">return</span> <span class="reserved">this</span>.value;
}

N2i.TextField.<span class="reserved">prototype</span>.setValue = <span class="reserved">function</span>(value) {
	value = value || <span class="literal">''</span>;
	<span class="reserved">this</span>.value = <span class="reserved">this</span>.field.value = value;
}

N2i.TextField.<span class="reserved">prototype</span>.focus = <span class="reserved">function</span>() {
	<span class="reserved">this</span>.field.focus();
}

N2i.TextField.<span class="reserved">prototype</span>.onfocus = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (<span class="reserved">this</span>.field.value==<span class="reserved">this</span>.options.placeholder) {
		<span class="reserved">this</span>.field.value=<span class="literal">''</span>;
	}
}

N2i.TextField.<span class="reserved">prototype</span>.blur = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (<span class="reserved">this</span>.field.value==<span class="literal">''</span> &amp;&amp; <span class="reserved">this</span>.options.placeholder) {
		<span class="reserved">this</span>.field.value=<span class="reserved">this</span>.options.placeholder;
	}
}

N2i.TextField.<span class="reserved">prototype</span>.key = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (<span class="reserved">this</span>.value != <span class="reserved">this</span>.field.value) {
		<span class="reserved">this</span>.value = <span class="reserved">this</span>.field.value;
		<span class="reserved">if</span> (<span class="reserved">this</span>.delegate.valueDidChange) {
			<span class="reserved">this</span>.delegate.valueDidChange(<span class="reserved">this</span>);
		}
	}
}

<span class="comment">/********************** Date *******************/</span>

N2i.DateField = <span class="reserved">function</span>(field,options,delegate) {
	<span class="reserved">this</span>.field = $id(field);
	<span class="reserved">this</span>.value = <span class="reserved">this</span>.field.value;
	<span class="reserved">this</span>.date = null;
	<span class="reserved">this</span>.inputFormats = [<span class="literal">'d-m-Y'</span>,<span class="literal">'d-m-Y'</span>,<span class="literal">'d-m-Y'</span>,<span class="literal">'d-m-Y'</span>,<span class="literal">'d-m'</span>,<span class="literal">'d/m'</span>,<span class="literal">'d'</span>,<span class="literal">'m-d-Y'</span>,<span class="literal">'m-d-Y'</span>,<span class="literal">'m-d-Y'</span>,<span class="literal">'m-d-Y'</span>,<span class="literal">'m-d'</span>,<span class="literal">'m/d'</span>];
	<span class="reserved">this</span>.outputFormat = <span class="literal">'d-m-Y'</span>;
	<span class="reserved">this</span>.delegate = delegate || {};
	<span class="reserved">this</span>.options = options || {};
	<span class="reserved">if</span> (<span class="reserved">this</span>.options.placeholder &amp;&amp; <span class="reserved">this</span>.field.value==<span class="literal">''</span>) {
		<span class="reserved">this</span>.field.value=<span class="reserved">this</span>.options.placeholder;
	}
	<span class="reserved">this</span>.addBehaviour();
	<span class="reserved">this</span>.check();
}

N2i.DateField.<span class="reserved">prototype</span>.setDelegate = <span class="reserved">function</span>(delegate) {
	<span class="reserved">this</span>.delegate = delegate || {};
}

N2i.DateField.<span class="reserved">prototype</span>.setEnabled = <span class="reserved">function</span>(enabled) {
	<span class="reserved">this</span>.field.disabled = !enabled;
}

N2i.DateField.<span class="reserved">prototype</span>.setDate = <span class="reserved">function</span>(date) {
	<span class="reserved">this</span>.date = date;
	<span class="reserved">this</span>.field.value = <span class="reserved">this</span>.date.dateFormat(<span class="reserved">this</span>.outputFormat);
	<span class="reserved">this</span>.value = <span class="reserved">this</span>.field.value;
}

N2i.DateField.<span class="reserved">prototype</span>.getDate = <span class="reserved">function</span>() {
	<span class="reserved">return</span> <span class="reserved">this</span>.date;
}

N2i.DateField.<span class="reserved">prototype</span>.addBehaviour = <span class="reserved">function</span>() {
	var self = <span class="reserved">this</span>;
	<span class="reserved">this</span>.field.onfocus = <span class="reserved">function</span>() {
		self.focus();
	}
	<span class="reserved">this</span>.field.onblur = <span class="reserved">function</span>() {
		self.blur();
	}
	<span class="reserved">this</span>.field.onkeydown = <span class="reserved">this</span>.field.onkeyup = <span class="reserved">this</span>.field.onkeypress = <span class="reserved">function</span>() {
		self.key();
	}
}

N2i.DateField.<span class="reserved">prototype</span>.check = <span class="reserved">function</span>() {
	var parsed = null;
	<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.inputFormats.length &amp;&amp; parsed==null; i++) {
		parsed = Date.parseDate(<span class="reserved">this</span>.value,	<span class="reserved">this</span>.inputFormats[i]);
	};
	<span class="reserved">if</span> (parsed) {
		<span class="reserved">this</span>.date = parsed;
	}
	<span class="reserved">if</span> (<span class="reserved">this</span>.date==null) {
		<span class="reserved">this</span>.field.value = <span class="literal">''</span>;
	} <span class="reserved">else</span> {
		<span class="reserved">this</span>.field.value = <span class="reserved">this</span>.date.dateFormat(<span class="reserved">this</span>.outputFormat);
	}
	<span class="reserved">this</span>.value = <span class="reserved">this</span>.field.value;
}

N2i.DateField.<span class="reserved">prototype</span>.getValue = <span class="reserved">function</span>() {
	<span class="reserved">return</span> <span class="reserved">this</span>.value;
}

N2i.DateField.<span class="reserved">prototype</span>.focus = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (<span class="reserved">this</span>.field.value==<span class="reserved">this</span>.options.placeholder) {
		<span class="reserved">this</span>.field.value=<span class="literal">''</span>;
	}
}

N2i.DateField.<span class="reserved">prototype</span>.blur = <span class="reserved">function</span>() {
	<span class="reserved">this</span>.check();
	<span class="reserved">if</span> (<span class="reserved">this</span>.field.value==<span class="literal">''</span> &amp;&amp; <span class="reserved">this</span>.options.placeholder) {
		<span class="reserved">this</span>.field.value=<span class="reserved">this</span>.options.placeholder;
	}
}

N2i.DateField.<span class="reserved">prototype</span>.key = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (<span class="reserved">this</span>.value != <span class="reserved">this</span>.field.value) {
		<span class="reserved">this</span>.value = <span class="reserved">this</span>.field.value;
		<span class="reserved">if</span> (<span class="reserved">this</span>.options.valueDidChange) {
			<span class="reserved">this</span>.options.valueDidChange(<span class="reserved">this</span>);
		}
	}
}

<span class="comment">/********************** Date time *******************/</span>

N2i.DateTimeField = <span class="reserved">function</span>(field,delegate) {
	<span class="reserved">this</span>.field = $id(field);
	<span class="reserved">this</span>.value = <span class="reserved">this</span>.field.value;
	<span class="reserved">this</span>.date = null;
	<span class="reserved">this</span>.inputFormats = [<span class="literal">'d-m-Y H:i:s'</span>,<span class="literal">'d-m-Y H:i'</span>,<span class="literal">'d-m-Y H'</span>,<span class="literal">'d-m-Y'</span>,<span class="literal">'d-m'</span>,<span class="literal">'d/m'</span>];
	<span class="reserved">this</span>.outputFormat = <span class="literal">'d-m-Y H:i:s'</span>;
	<span class="reserved">this</span>.delegate = delegate || {};
	<span class="reserved">if</span> (<span class="reserved">this</span>.delegate.placeholder &amp;&amp; <span class="reserved">this</span>.field.value==<span class="literal">''</span>) {
		<span class="reserved">this</span>.field.value=<span class="reserved">this</span>.delegate.placeholder;
	}
	<span class="reserved">this</span>.addBehaviour();
	<span class="reserved">this</span>.check();
}

N2i.DateTimeField.<span class="reserved">prototype</span>.addBehaviour = <span class="reserved">function</span>() {
	var self = <span class="reserved">this</span>;
	<span class="reserved">this</span>.field.onfocus = <span class="reserved">function</span>() {
		self.focus();
	}
	<span class="reserved">this</span>.field.onblur = <span class="reserved">function</span>() {
		self.blur();
	}
	<span class="reserved">this</span>.field.onkeydown = <span class="reserved">this</span>.field.onkeyup = <span class="reserved">this</span>.field.onkeypress = <span class="reserved">function</span>() {
		self.key();
	}
}

N2i.DateTimeField.<span class="reserved">prototype</span>.check = <span class="reserved">function</span>() {
	var parsed = null;
	<span class="reserved">for</span> (var i=0; i &lt; <span class="reserved">this</span>.inputFormats.length &amp;&amp; parsed==null; i++) {
		parsed = Date.parseDate(<span class="reserved">this</span>.value,	<span class="reserved">this</span>.inputFormats[i]);
	};
	<span class="reserved">if</span> (parsed) {
		<span class="reserved">this</span>.date = parsed;
	}
	<span class="reserved">this</span>.field.value = <span class="reserved">this</span>.date.dateFormat(<span class="reserved">this</span>.outputFormat);
	<span class="reserved">this</span>.value = <span class="reserved">this</span>.field.value;
}

N2i.DateTimeField.<span class="reserved">prototype</span>.getValue = <span class="reserved">function</span>() {
	<span class="reserved">return</span> <span class="reserved">this</span>.value;
}

N2i.DateTimeField.<span class="reserved">prototype</span>.focus = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (<span class="reserved">this</span>.field.value==<span class="reserved">this</span>.delegate.placeholder) {
		<span class="reserved">this</span>.field.value=<span class="literal">''</span>;
	}
}

N2i.DateTimeField.<span class="reserved">prototype</span>.blur = <span class="reserved">function</span>() {
	<span class="reserved">this</span>.check();
	<span class="reserved">if</span> (<span class="reserved">this</span>.field.value==<span class="literal">''</span> &amp;&amp; <span class="reserved">this</span>.delegate.placeholder) {
		<span class="reserved">this</span>.field.value=<span class="reserved">this</span>.delegate.placeholder;
	}
}

N2i.DateTimeField.<span class="reserved">prototype</span>.key = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (<span class="reserved">this</span>.value != <span class="reserved">this</span>.field.value) {
		<span class="reserved">this</span>.value = <span class="reserved">this</span>.field.value;
		<span class="reserved">if</span> (<span class="reserved">this</span>.delegate.valueDidChange) {
			<span class="reserved">this</span>.delegate.valueDidChange(<span class="reserved">this</span>);
		}
	}
}


<span class="comment">/*
 * Copyright (C) 2004 Baron Schwartz &lt;baron at sequent dot org&gt;
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as published by the
 * Free Software Foundation, version 2.1.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more
 * details.
 */</span>

Date.parseFunctions = {count:0};
Date.parseRegexes = [];
Date.formatFunctions = {count:0};

Date.<span class="reserved">prototype</span>.dateFormat = <span class="reserved">function</span>(format) {
    <span class="reserved">if</span> (Date.formatFunctions[format] == null) {
        Date.createNewFormat(format);
    }
    var func = Date.formatFunctions[format];
    <span class="reserved">return</span> <span class="reserved">this</span>[func]();
}

Date.createNewFormat = <span class="reserved">function</span>(format) {
    var funcName = <span class="literal">"format"</span> + Date.formatFunctions.count++;
    Date.formatFunctions[format] = funcName;
    var code = <span class="literal">"Date.prototype."</span> + funcName + <span class="literal">" = function(){return "</span>;
    var special = false;
    var ch = <span class="literal">''</span>;
    <span class="reserved">for</span> (var i = 0; i &lt; format.length; ++i) {
        ch = format.charAt(i);
        <span class="reserved">if</span> (!special &amp;&amp; ch == <span class="literal">"\\"</span>) {
            special = true;
        }
        <span class="reserved">else</span> <span class="reserved">if</span> (special) {
            special = false;
            code += <span class="literal">"'"</span> + String.escape(ch) + <span class="literal">"' + "</span>;
        }
        <span class="reserved">else</span> {
            code += Date.getFormatCode(ch);
        }
    }
    eval(code.substring(0, code.length - 3) + <span class="literal">";}"</span>);
}

Date.getFormatCode = <span class="reserved">function</span>(character) {
    switch (character) {
    case <span class="literal">"d"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad(this.getDate(), 2, '0') + "</span>;
    case <span class="literal">"D"</span>:
        <span class="reserved">return</span> <span class="literal">"Date.dayNames[this.getDay()].substring(0, 3) + "</span>;
    case <span class="literal">"j"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getDate() + "</span>;
    case <span class="literal">"l"</span>:
        <span class="reserved">return</span> <span class="literal">"Date.dayNames[this.getDay()] + "</span>;
    case <span class="literal">"S"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getSuffix() + "</span>;
    case <span class="literal">"w"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getDay() + "</span>;
    case <span class="literal">"z"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getDayOfYear() + "</span>;
    case <span class="literal">"W"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getWeekOfYear() + "</span>;
    case <span class="literal">"F"</span>:
        <span class="reserved">return</span> <span class="literal">"Date.monthNames[this.getMonth()] + "</span>;
    case <span class="literal">"m"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad(this.getMonth() + 1, 2, '0') + "</span>;
    case <span class="literal">"M"</span>:
        <span class="reserved">return</span> <span class="literal">"Date.monthNames[this.getMonth()].substring(0, 3) + "</span>;
    case <span class="literal">"n"</span>:
        <span class="reserved">return</span> <span class="literal">"(this.getMonth() + 1) + "</span>;
    case <span class="literal">"t"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getDaysInMonth() + "</span>;
    case <span class="literal">"L"</span>:
        <span class="reserved">return</span> <span class="literal">"(this.isLeapYear() ? 1 : 0) + "</span>;
    case <span class="literal">"Y"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getFullYear() + "</span>;
    case <span class="literal">"y"</span>:
        <span class="reserved">return</span> <span class="literal">"('' + this.getFullYear()).substring(2, 4) + "</span>;
    case <span class="literal">"a"</span>:
        <span class="reserved">return</span> <span class="literal">"(this.getHours() &lt; 12 ? 'am' : 'pm') + "</span>;
    case <span class="literal">"A"</span>:
        <span class="reserved">return</span> <span class="literal">"(this.getHours() &lt; 12 ? 'AM' : 'PM') + "</span>;
    case <span class="literal">"g"</span>:
        <span class="reserved">return</span> <span class="literal">"((this.getHours() %12) ? this.getHours() % 12 : 12) + "</span>;
    case <span class="literal">"G"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getHours() + "</span>;
    case <span class="literal">"h"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad((this.getHours() %12) ? this.getHours() % 12 : 12, 2, '0') + "</span>;
    case <span class="literal">"H"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad(this.getHours(), 2, '0') + "</span>;
    case <span class="literal">"i"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad(this.getMinutes(), 2, '0') + "</span>;
    case <span class="literal">"s"</span>:
        <span class="reserved">return</span> <span class="literal">"String.leftPad(this.getSeconds(), 2, '0') + "</span>;
    case <span class="literal">"O"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getGMTOffset() + "</span>;
    case <span class="literal">"T"</span>:
        <span class="reserved">return</span> <span class="literal">"this.getTimezone() + "</span>;
    case <span class="literal">"Z"</span>:
        <span class="reserved">return</span> <span class="literal">"(this.getTimezoneOffset() * -60) + "</span>;
    default:
        <span class="reserved">return</span> <span class="literal">"'"</span> + String.escape(character) + <span class="literal">"' + "</span>;
    }
}

Date.parseDate = <span class="reserved">function</span>(input, format) {
    <span class="reserved">if</span> (Date.parseFunctions[format] == null) {
        Date.createParser(format);
    }
    var func = Date.parseFunctions[format];
    <span class="reserved">return</span> Date[func](input);
}

Date.createParser = <span class="reserved">function</span>(format) {
    var funcName = <span class="literal">"parse"</span> + Date.parseFunctions.count++;
    var regexNum = Date.parseRegexes.length;
    var currentGroup = 1;
    Date.parseFunctions[format] = funcName;

    var code = <span class="literal">"Date."</span> + funcName + <span class="literal">" = function(input){\n"</span>
        + <span class="literal">"var y = -1, m = -1, d = -1, h = -1, i = -1, s = -1;\n"</span>
        + <span class="literal">"var d = new Date();\n"</span>
        + <span class="literal">"y = d.getFullYear();\n"</span>
        + <span class="literal">"m = d.getMonth();\n"</span>
        + <span class="literal">"d = d.getDate();\n"</span>
        + <span class="literal">"var results = input.match(Date.parseRegexes["</span> + regexNum + <span class="literal">"]);\n"</span>
        + <span class="literal">"if (results &amp;&amp; results.length &gt; 0) {"</span>
    var regex = <span class="literal">""</span>;

    var special = false;
    var ch = <span class="literal">''</span>;
    <span class="reserved">for</span> (var i = 0; i &lt; format.length; ++i) {
        ch = format.charAt(i);
        <span class="reserved">if</span> (!special &amp;&amp; ch == <span class="literal">"\\"</span>) {
            special = true;
        }
        <span class="reserved">else</span> <span class="reserved">if</span> (special) {
            special = false;
            regex += String.escape(ch);
        }
        <span class="reserved">else</span> {
            obj = Date.formatCodeToRegex(ch, currentGroup);
            currentGroup += obj.g;
            regex += obj.s;
            <span class="reserved">if</span> (obj.g &amp;&amp; obj.c) {
                code += obj.c;
            }
        }
    }

    code += <span class="literal">"if (y &gt; 0 &amp;&amp; m &gt;= 0 &amp;&amp; d &gt; 0 &amp;&amp; h &gt;= 0 &amp;&amp; i &gt;= 0 &amp;&amp; s &gt;= 0)\n"</span>
        + <span class="literal">"{return new Date(y, m, d, h, i, s);}\n"</span>
        + <span class="literal">"else if (y &gt; 0 &amp;&amp; m &gt;= 0 &amp;&amp; d &gt; 0 &amp;&amp; h &gt;= 0 &amp;&amp; i &gt;= 0)\n"</span>
        + <span class="literal">"{return new Date(y, m, d, h, i);}\n"</span>
        + <span class="literal">"else if (y &gt; 0 &amp;&amp; m &gt;= 0 &amp;&amp; d &gt; 0 &amp;&amp; h &gt;= 0)\n"</span>
        + <span class="literal">"{return new Date(y, m, d, h);}\n"</span>
        + <span class="literal">"else if (y &gt; 0 &amp;&amp; m &gt;= 0 &amp;&amp; d &gt; 0)\n"</span>
        + <span class="literal">"{return new Date(y, m, d);}\n"</span>
        + <span class="literal">"else if (y &gt; 0 &amp;&amp; m &gt;= 0)\n"</span>
        + <span class="literal">"{return new Date(y, m);}\n"</span>
        + <span class="literal">"else if (y &gt; 0)\n"</span>
        + <span class="literal">"{return new Date(y);}\n"</span>
        + <span class="literal">"}return null;}"</span>;

    Date.parseRegexes[regexNum] = new RegExp(<span class="literal">"^"</span> + regex + <span class="literal">"$"</span>);
    eval(code);
}

Date.formatCodeToRegex = <span class="reserved">function</span>(character, currentGroup) {
    switch (character) {
    case <span class="literal">"D"</span>:
        <span class="reserved">return</span> {g:0,
        c:null,
        s:<span class="literal">"(?:Sun|Mon|Tue|Wed|Thu|Fri|Sat)"</span>};
    case <span class="literal">"j"</span>:
    case <span class="literal">"d"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"d = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>,
            s:<span class="literal">"(\\d{1,2})"</span>};
    case <span class="literal">"l"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"(?:"</span> + Date.dayNames.join(<span class="literal">"|"</span>) + <span class="literal">")"</span>};
    case <span class="literal">"S"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"(?:st|nd|rd|th)"</span>};
    case <span class="literal">"w"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"\\d"</span>};
    case <span class="literal">"z"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"(?:\\d{1,3})"</span>};
    case <span class="literal">"W"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"(?:\\d{2})"</span>};
    case <span class="literal">"F"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"m = parseInt(Date.monthNumbers[results["</span> + currentGroup + <span class="literal">"].substring(0, 3)], 10);\n"</span>,
            s:<span class="literal">"("</span> + Date.monthNames.join(<span class="literal">"|"</span>) + <span class="literal">")"</span>};
    case <span class="literal">"M"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"m = parseInt(Date.monthNumbers[results["</span> + currentGroup + <span class="literal">"]], 10);\n"</span>,
            s:<span class="literal">"(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)"</span>};
    case <span class="literal">"n"</span>:
    case <span class="literal">"m"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"m = parseInt(results["</span> + currentGroup + <span class="literal">"], 10) - 1;\n"</span>,
            s:<span class="literal">"(\\d{1,2})"</span>};
    case <span class="literal">"t"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"\\d{1,2}"</span>};
    case <span class="literal">"L"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"(?:1|0)"</span>};
    case <span class="literal">"Y"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"y = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>,
            s:<span class="literal">"(\\d{4})"</span>};
    case <span class="literal">"y"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"var ty = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>
                + <span class="literal">"y = ty &gt; Date.y2kYear ? 1900 + ty : 2000 + ty;\n"</span>,
            s:<span class="literal">"(\\d{1,2})"</span>};
    case <span class="literal">"a"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"if (results["</span> + currentGroup + <span class="literal">"] == 'am') {\n"</span>
                + <span class="literal">"if (h == 12) { h = 0; }\n"</span>
                + <span class="literal">"} else { if (h &lt; 12) { h += 12; }}"</span>,
            s:<span class="literal">"(am|pm)"</span>};
    case <span class="literal">"A"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"if (results["</span> + currentGroup + <span class="literal">"] == 'AM') {\n"</span>
                + <span class="literal">"if (h == 12) { h = 0; }\n"</span>
                + <span class="literal">"} else { if (h &lt; 12) { h += 12; }}"</span>,
            s:<span class="literal">"(AM|PM)"</span>};
    case <span class="literal">"g"</span>:
    case <span class="literal">"G"</span>:
    case <span class="literal">"h"</span>:
    case <span class="literal">"H"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"h = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>,
            s:<span class="literal">"(\\d{1,2})"</span>};
    case <span class="literal">"i"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"i = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>,
            s:<span class="literal">"(\\d{2})"</span>};
    case <span class="literal">"s"</span>:
        <span class="reserved">return</span> {g:1,
            c:<span class="literal">"s = parseInt(results["</span> + currentGroup + <span class="literal">"], 10);\n"</span>,
            s:<span class="literal">"(\\d{2})"</span>};
    case <span class="literal">"O"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"[+-]\\d{4}"</span>};
    case <span class="literal">"T"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"[A-Z]{3}"</span>};
    case <span class="literal">"Z"</span>:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:<span class="literal">"[+-]\\d{1,5}"</span>};
    default:
        <span class="reserved">return</span> {g:0,
            c:null,
            s:String.escape(character)};
    }
}

Date.<span class="reserved">prototype</span>.getTimezone = <span class="reserved">function</span>() {
    <span class="reserved">return</span> <span class="reserved">this</span>.toString().replace(
        /^.*? ([A-Z]{3}) [0-9]{4}.*$/, <span class="literal">"$1"</span>).replace(
        /^.*?\(([A-Z])[a-z]+ ([A-Z])[a-z]+ ([A-Z])[a-z]+\)$/, <span class="literal">"$1$2$3"</span>);
}

Date.<span class="reserved">prototype</span>.getGMTOffset = <span class="reserved">function</span>() {
    <span class="reserved">return</span> (<span class="reserved">this</span>.getTimezoneOffset() &gt; 0 ? <span class="literal">"-"</span> : <span class="literal">"+"</span>)
        + String.leftPad(Math.floor(<span class="reserved">this</span>.getTimezoneOffset() / 60), 2, <span class="literal">"0"</span>)
        + String.leftPad(<span class="reserved">this</span>.getTimezoneOffset() % 60, 2, <span class="literal">"0"</span>);
}

Date.<span class="reserved">prototype</span>.getDayOfYear = <span class="reserved">function</span>() {
    var num = 0;
    Date.daysInMonth[1] = <span class="reserved">this</span>.isLeapYear() ? 29 : 28;
    <span class="reserved">for</span> (var i = 0; i &lt; <span class="reserved">this</span>.getMonth(); ++i) {
        num += Date.daysInMonth[i];
    }
    <span class="reserved">return</span> num + <span class="reserved">this</span>.getDate() - 1;
}

Date.<span class="reserved">prototype</span>.getWeekOfYear = <span class="reserved">function</span>() {
    <span class="comment">// Skip to Thursday of this week</span>
    var now = <span class="reserved">this</span>.getDayOfYear() + (5 - <span class="reserved">this</span>.getDay());
    <span class="comment">// Find the first Thursday of the year</span>
    var jan1 = new Date(<span class="reserved">this</span>.getFullYear(), 0, 1);
    var then = (5 - jan1.getDay());
    <span class="reserved">return</span> String.leftPad(((now - then) / 7) + 1, 2, <span class="literal">"0"</span>);
}

Date.<span class="reserved">prototype</span>.isLeapYear = <span class="reserved">function</span>() {
    var year = <span class="reserved">this</span>.getFullYear();
    <span class="reserved">return</span> ((year &amp; 3) == 0 &amp;&amp; (year % 100 || (year % 400 == 0 &amp;&amp; year)));
}

Date.<span class="reserved">prototype</span>.getFirstDayOfMonth = <span class="reserved">function</span>() {
    var day = (<span class="reserved">this</span>.getDay() - (<span class="reserved">this</span>.getDate() - 1)) % 7;
    <span class="reserved">return</span> (day &lt; 0) ? (day + 7) : day;
}

Date.<span class="reserved">prototype</span>.getLastDayOfMonth = <span class="reserved">function</span>() {
    var day = (<span class="reserved">this</span>.getDay() + (Date.daysInMonth[<span class="reserved">this</span>.getMonth()] - <span class="reserved">this</span>.getDate())) % 7;
    <span class="reserved">return</span> (day &lt; 0) ? (day + 7) : day;
}

Date.<span class="reserved">prototype</span>.getDaysInMonth = <span class="reserved">function</span>() {
    Date.daysInMonth[1] = <span class="reserved">this</span>.isLeapYear() ? 29 : 28;
    <span class="reserved">return</span> Date.daysInMonth[<span class="reserved">this</span>.getMonth()];
}

Date.<span class="reserved">prototype</span>.getSuffix = <span class="reserved">function</span>() {
    switch (<span class="reserved">this</span>.getDate()) {
        case 1:
        case 21:
        case 31:
            <span class="reserved">return</span> <span class="literal">"st"</span>;
        case 2:
        case 22:
            <span class="reserved">return</span> <span class="literal">"nd"</span>;
        case 3:
        case 23:
            <span class="reserved">return</span> <span class="literal">"rd"</span>;
        default:
            <span class="reserved">return</span> <span class="literal">"th"</span>;
    }
}

String.escape = <span class="reserved">function</span>(string) {
    <span class="reserved">return</span> string.replace(/(<span class="literal">'|\\)/g, "\\$1");
}

String.leftPad = function (val, size, ch) {
    var result = new String(val);
    if (ch == null) {
        ch = " ";
    }
    while (result.length &lt; size) {
        result = ch + result;
    }
    return result;
}

Date.daysInMonth = [31,28,31,30,31,30,31,31,30,31,30,31];
Date.monthNames =
   ["January",
    "February",
    "March",
    "April",
    "May",
    "June",
    "July",
    "August",
    "September",
    "October",
    "November",
    "December"];
Date.dayNames =
   ["Sunday",
    "Monday",
    "Tuesday",
    "Wednesday",
    "Thursday",
    "Friday",
    "Saturday"];
Date.y2kYear = 50;
Date.monthNumbers = {
    Jan:0,
    Feb:1,
    Mar:2,
    Apr:3,
    May:4,
    Jun:5,
    Jul:6,
    Aug:7,
    Sep:8,
    Oct:9,
    Nov:10,
    Dec:11};
Date.patterns = {
    ISO8601LongPattern:"Y-m-d H:i:s",
    ISO8601ShortPattern:"Y-m-d",
    ShortDatePattern: "n/j/Y",
    LongDatePattern: "l, F d, Y",
    FullDateTimePattern: "l, F d, Y g:i:s A",
    MonthDayPattern: "F d",
    ShortTimePattern: "g:i A",
    LongTimePattern: "g:i:s A",
    SortableDateTimePattern: "Y-m-d\\TH:i:s",
    UniversalSortableDateTimePattern: "Y-m-d H:i:sO",
    YearMonthPattern: "F, Y"};
/*
    json2.js
    2008-01-17

    Public Domain

    No warranty expressed or implied. Use at your own risk.

    See http://www.JSON.org/js.html

    This file creates a global JSON object containing two methods:

        JSON.stringify(value, whitelist)
            value       any JavaScript value, usually an object or array.

            whitelist   an optional array prameter that determines how object
                        values are stringified.

            This method produces a JSON text from a JavaScript value.
            There are three possible ways to stringify an object, depending
            on the optional whitelist parameter.

            If an object has a toJSON method, then the toJSON() method will be
            called. The value returned from the toJSON method will be
            stringified.

            Otherwise, if the optional whitelist parameter is an array, then
            the elements of the array will be used to select members of the
            object for stringification.

            Otherwise, if there is no whitelist parameter, then all of the
            members of the object will be stringified.

            Values that do not have JSON representaions, such as undefined or
            functions, will not be serialized. Such values in objects will be
            dropped; in arrays will be replaced with null.
            JSON.stringify(undefined) returns undefined. Dates will be
            stringified as quoted ISO dates.

            Example:

            var text = JSON.stringify(['</span>e<span class="literal">', {pluribus: '</span>unum<span class="literal">'}]);
            // text is '</span>[<span class="literal">"e"</span>,{<span class="literal">"pluribus"</span>:<span class="literal">"unum"</span>}]<span class="literal">'

        JSON.parse(text, filter)
            This method parses a JSON text to produce an object or
            array. It can throw a SyntaxError exception.

            The optional filter parameter is a function that can filter and
            transform the results. It receives each of the keys and values, and
            its return value is used instead of the original value. If it
            returns what it received, then structure is not modified. If it
            returns undefined then the member is deleted.

            Example:

            // Parse the text. If a key contains the string '</span>date<span class="literal">' then
            // convert the value to a date.

            myData = JSON.parse(text, function (key, value) {
                return key.indexOf('</span>date<span class="literal">') &gt;= 0 ? new Date(value) : value;
            });

    This is a reference implementation. You are free to copy, modify, or
    redistribute.

    Use your own copy. It is extremely unwise to load third party
    code into your pages.
*/

/*jslint evil: true */

/*global JSON */

/*members "\b", "\t", "\n", "\f", "\r", "\"", JSON, "\\", apply,
    charCodeAt, floor, getUTCDate, getUTCFullYear, getUTCHours,
    getUTCMinutes, getUTCMonth, getUTCSeconds, hasOwnProperty, join, length,
    parse, propertyIsEnumerable, prototype, push, replace, stringify, test,
    toJSON, toString
*/

if (!this.JSON) {

    JSON = function () {

        function f(n) {    // Format integers to have at least two digits.
            return n &lt; 10 ? '</span>0<span class="literal">' + n : n;
        }

        Date.prototype.toJSON = function () {

// Eventually, this method will be based on the date.toISOString method.

            return this.getUTCFullYear()   + '</span>-<span class="literal">' +
                 f(this.getUTCMonth() + 1) + '</span>-<span class="literal">' +
                 f(this.getUTCDate())      + '</span>T<span class="literal">' +
                 f(this.getUTCHours())     + '</span>:<span class="literal">' +
                 f(this.getUTCMinutes())   + '</span>:<span class="literal">' +
                 f(this.getUTCSeconds())   + '</span>Z<span class="literal">';
        };


        var m = {    // table of character substitutions
            '</span>\b<span class="literal">': '</span>\\b<span class="literal">',
            '</span>\t<span class="literal">': '</span>\\t<span class="literal">',
            '</span>\n<span class="literal">': '</span>\\n<span class="literal">',
            '</span>\f<span class="literal">': '</span>\\f<span class="literal">',
            '</span>\r<span class="literal">': '</span>\\r<span class="literal">',
            '</span><span class="literal">"' : '\\"</span><span class="literal">',
            '</span>\\<span class="literal">': '</span>\\\\<span class="literal">'
        };

        function stringify(value, whitelist) {
            var a,          // The array holding the partial texts.
                i,          // The loop counter.
                k,          // The member key.
                l,          // Length.
                r = /["\\\x00-\x1f\x7f-\x9f]/g,
                v;          // The member value.

            switch (typeof value) {
            case '</span>string<span class="literal">':

// If the string contains no control characters, no quote characters, and no
// backslash characters, then we can safely slap some quotes around it.
// Otherwise we must also replace the offending characters with safe sequences.

                return r.test(value) ?
                    '</span><span class="literal">"' + value.replace(r, function (a) {
                        var c = m[a];
                        if (c) {
                            return c;
                        }
                        c = a.charCodeAt();
                        return '\\u00' + Math.floor(c / 16).toString(16) +
                                                   (c % 16).toString(16);
                    }) + '"</span><span class="literal">' :
                    '</span><span class="literal">"' + value + '"</span><span class="literal">';

            case '</span>number<span class="literal">':

// JSON numbers must be finite. Encode non-finite numbers as null.

                return isFinite(value) ? String(value) : '</span>null<span class="literal">';

            case '</span>boolean<span class="literal">':
            case '</span>null<span class="literal">':
                return String(value);

            case '</span>object<span class="literal">':

// Due to a specification blunder in ECMAScript,
// typeof null is '</span>object<span class="literal">', so watch out for that case.

                if (!value) {
                    return '</span>null<span class="literal">';
                }

// If the object has a toJSON method, call it, and stringify the result.

                if (typeof value.toJSON === '</span><span class="reserved">function</span><span class="literal">') {
                    return stringify(value.toJSON());
                }
                a = [];
                if (typeof value.length === '</span>number<span class="literal">' &amp;&amp;
                        !(value.propertyIsEnumerable('</span>length<span class="literal">'))) {

// The object is an array. Stringify every element. Use null as a placeholder
// for non-JSON values.

                    l = value.length;
                    for (i = 0; i &lt; l; i += 1) {
                        a.push(stringify(value[i], whitelist) || '</span>null<span class="literal">');
                    }

// Join all of the elements together and wrap them in brackets.

                    return '</span>[<span class="literal">' + a.join('</span>,<span class="literal">') + '</span>]<span class="literal">';
                }
                if (whitelist) {

// If a whitelist (array of keys) is provided, use it to select the components
// of the object.

                    l = whitelist.length;
                    for (i = 0; i &lt; l; i += 1) {
                        k = whitelist[i];
                        if (typeof k === '</span>string<span class="literal">') {
                            v = stringify(value[k], whitelist);
                            if (v) {
                                a.push(stringify(k) + '</span>:<span class="literal">' + v);
                            }
                        }
                    }
                } else {

// Otherwise, iterate through all of the keys in the object.

                    for (k in value) {
                        if (typeof k === '</span>string<span class="literal">') {
                            v = stringify(value[k], whitelist);
                            if (v) {
                                a.push(stringify(k) + '</span>:<span class="literal">' + v);
                            }
                        }
                    }
                }

// Join all of the member texts together and wrap them in braces.

                return '</span>{<span class="literal">' + a.join('</span>,<span class="literal">') + '</span>}<span class="literal">';
            }
        }

        return {
            stringify: stringify,
            parse: function (text, filter) {
                var j;

                function walk(k, v) {
                    var i, n;
                    if (v &amp;&amp; typeof v === '</span>object<span class="literal">') {
                        for (i in v) {
                            if (Object.prototype.hasOwnProperty.apply(v, [i])) {
                                n = walk(i, v[i]);
                                if (n !== undefined) {
                                    v[i] = n;
                                }
                            }
                        }
                    }
                    return filter(k, v);
                }


// Parsing happens in three stages. In the first stage, we run the text against
// regular expressions that look for non-JSON patterns. We are especially
// concerned with '</span>()<span class="literal">' and '</span>new<span class="literal">' because they can cause invocation, and '</span>=<span class="literal">'
// because it can cause mutation. But just to be safe, we want to reject all
// unexpected forms.

// We split the first stage into 4 regexp operations in order to work around
// crippling inefficiencies in IE'</span>s and Safari<span class="literal">'s regexp engines. First we
// replace all backslash pairs with '</span>@<span class="literal">' (a non-JSON character). Second, we
// replace all simple value tokens with '</span>]<span class="literal">' characters. Third, we delete all
// open brackets that follow a colon or comma or that begin the text. Finally,
// we look to see that the remaining characters are only whitespace or '</span>]<span class="literal">' or
// '</span>,<span class="literal">' or '</span>:<span class="literal">' or '</span>{<span class="literal">' or '</span>}<span class="literal">'. If that is so, then the text is safe for eval.

                if (/^[\],:{}\s]*$/.test(text.replace(/\\./g, '</span>@<span class="literal">').
replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, '</span>]<span class="literal">').
replace(/(?:^|:|,)(?:\s*\[)+/g, '</span><span class="literal">'))) {

// In the second stage we use the eval function to compile the text into a
// JavaScript structure. The '</span>{<span class="literal">' operator is subject to a syntactic ambiguity
// in JavaScript: it can begin a block or an object literal. We wrap the text
// in parens to eliminate the ambiguity.

                    j = eval('</span>(<span class="literal">' + text + '</span>)<span class="literal">');

// In the optional third stage, we recursively walk the new structure, passing
// each name/value pair to a filter function for possible transformation.

                    return typeof filter === '</span><span class="reserved">function</span><span class="literal">' ? walk('</span><span class="literal">', j) : j;
                }

// If the text is not JSON parseable, then a SyntaxError is thrown.

                throw new SyntaxError('</span>parseJSON<span class="literal">');
            }
        };
    }();
}


function In2iGui() {
	this.overflows = [];
	this.delegates = [];
	this.objects = new Hash();
	this.addBehavior();
}

In2iGui.latestObjectIndex=0;

In2iGui.latestIndex=500;
In2iGui.latestPanelIndex=1000;
In2iGui.latestAlertIndex=1500;

In2iGui.browser = {};
In2iGui.browser.msie7 = navigator.userAgent.indexOf('</span>MSIE 7<span class="literal">')!=-1;
In2iGui.browser.webkit = navigator.userAgent.indexOf('</span>WebKit<span class="literal">')!=-1;
In2iGui.browser.gecko = !In2iGui.browser.webkit &amp;&amp; navigator.userAgent.indexOf('</span>Gecko<span class="literal">')!=-1;

In2iGui.get = function(name) {
	if (!In2iGui.instance) {
		In2iGui.instance = new In2iGui();
	}
	if (name) {
		return In2iGui.instance.objects.get(name);
	} else {
		return In2iGui.instance;
	}
}

document.observe('</span>dom:loaded<span class="literal">', function() {In2iGui.get().ignite();});

In2iGui.dwrErrorhandler = function(msg,e) {
	N2i.log(msg);
	N2i.log(e);
	In2iGui.get().showAlert({title:'</span>An unexpected error occurred!<span class="literal">',text:msg,emotion:'</span>gasp<span class="literal">'});
}

In2iGui.prototype = {
	ignite : function(id) {
		if (window.dwr) {
			if (dwr &amp;&amp; dwr.engine &amp;&amp; dwr.engine.setErrorHandler) {
				dwr.engine.setErrorHandler(In2iGui.dwrErrorhandler);
			}
		}
		this.resize();
		In2iGui.callSuperDelegates(this,'</span>interfaceIsReady<span class="literal">');
	},
	addBehavior : function(id) {
		var self = this;
		N2i.Event.addListener(window,'</span>resize<span class="literal">',function() {
			self.resize();
		});
	},
	addDelegate : function(delegate) {
		this.delegates[this.delegates.length] = delegate;
	},
	getTopPad : function(element) {
		var pad = 0;
		var all = parseInt(N2i.getStyle(element,'</span>padding<span class="literal">'));
		var top = parseInt(N2i.getStyle(element,'</span>padding-top<span class="literal">'));
		if (all) pad+=all;
		if (top) pad+=top;
		return pad;
	},
	getBottomPad : function(element) {
		var pad = 0;
		var all = parseInt(N2i.getStyle(element,'</span>padding<span class="literal">'));
		var bottom = parseInt(N2i.getStyle(element,'</span>padding-bottom<span class="literal">'));
		if (all) pad+=all;
		if (bottom) pad+=bottom;
		return pad;
	},
	resize : function(id) {
		var height = N2i.Window.getInnerHeight();
		for (var i=0; i &lt; this.overflows.length; i++) {
			this.overflows[i].element.style.height = height+this.overflows[i].diff+'</span>px<span class="literal">';
		};
	},
	registerOverflow : function(id,diff) {
		var overflow = $id(id);
		this.overflows.push({element:overflow,diff:diff});
	},
	alert : function(options) {
		if (!this.alertBox) {
			this.alertBox = In2iGui.Alert.create(null,options);
			var button = In2iGui.Button.create(null,{text : '</span>OK<span class="literal">'});
			button.addDelegate({click:function(){
				In2iGui.get().alertBox.hide();
			}});
			this.alertBox.addButton(button);
		} else {
			this.alertBox.update(options);
		}
		this.alertBox.show();
	},
	/** @deprecated */
	showAlert : function(options) {
		this.alert(options);
	},
	confirm : function(name,options) {
		var alert = In2iGui.get(name);
		if (!alert) {
			alert = In2iGui.Alert.create(name,options);
			var cancel = In2iGui.Button.create(name+'</span>_cancel<span class="literal">',{text : options.cancel || '</span>Cancel<span class="literal">',highlighted:options.highlighted=='</span>cancel<span class="literal">'});
			cancel.addDelegate({buttonWasClicked:function(){
				In2iGui.get(name).hide();
				In2iGui.callDelegates(In2iGui.get(name),'</span>cancel<span class="literal">');
			}});
			alert.addButton(cancel);
		
			var ok = In2iGui.Button.create(name+'</span>_ok<span class="literal">',{text : options.ok || '</span>OK<span class="literal">',highlighted:options.highlighted=='</span>ok<span class="literal">'});
			ok.addDelegate({buttonWasClicked:function(){
				In2iGui.get(name).hide();
				In2iGui.callDelegates(In2iGui.get(name),'</span>ok<span class="literal">');
			}});
			alert.addButton(ok);
		} else {
			alert.update(options);
			In2iGui.get(name+'</span>_ok<span class="literal">').setText(options.ok || '</span>ok<span class="literal">');
			In2iGui.get(name+'</span>_ok<span class="literal">').setHighlighted(options.highlighted=='</span>ok<span class="literal">');
			In2iGui.get(name+'</span>_cancel<span class="literal">').setText(options.ok || '</span>cancel<span class="literal">');
			In2iGui.get(name+'</span>_cancel<span class="literal">').setHighlighted(options.highlighted=='</span>cancel<span class="literal">');
			if (options.cancel) In2iGui.get(name+'</span>_cancel<span class="literal">').setText(options.cancel);
		}
		alert.show();
	},
	changeState : function(state) {
		if (this.state==state) return;
		var objects = this.objects.values();
		objects.each(function(obj) {
			if (obj.state) {
				if (obj.state==state) obj.show();
				else obj.hide();
			}
		});
	}
}

In2iGui.nextIndex = function() {
	In2iGui.latestIndex++;
	return 	In2iGui.latestIndex;
}

In2iGui.nextPanelIndex = function() {
	In2iGui.latestPanelIndex++;
	return 	In2iGui.latestPanelIndex;
}
In2iGui.nextAlertIndex = function() {
	In2iGui.latestAlertIndex++;
	return 	In2iGui.latestAlertIndex;
}

In2iGui.isWithin = function(e,element) {
	var offset = element.cumulativeOffset();
	var dims = element.getDimensions();
	return e.pointerX()&gt;=offset.left &amp;&amp; e.pointerX()&lt;offset.left+dims.width &amp;&amp; e.pointerY()&gt;offset.top &amp;&amp; e.pointerY()&lt;offset.top+dims.height;
}

In2iGui.getIconUrl = function(icon,size) {
	return In2iGui.context+'</span>/In2iGui/icons/<span class="literal">'+icon+size+'</span>.png<span class="literal">';
}

In2iGui.showCurtain = function(widget,zIndex) {
	if (!widget.curtain) {
		widget.curtain = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_curtain<span class="literal">'},{'</span>z-index<span class="literal">':'</span>none<span class="literal">'});
		widget.curtain.onclick = function() {
			if (widget.curtainWasClicked) {
				widget.curtainWasClicked();
			}
		}
		document.body.appendChild(widget.curtain);
	}
	widget.curtain.style.height=N2i.getDocumentHeight()+'</span>px<span class="literal">';
	widget.curtain.style.zIndex=zIndex;
	N2i.setOpacity(widget.curtain,0);
	widget.curtain.style.display='</span>block<span class="literal">';
	$ani(widget.curtain,'</span>opacity<span class="literal">',.5,1000,{ease:N2i.Animation.slowFastSlow});
}

In2iGui.hideCurtain = function(widget) {
	if (widget.curtain) {
		$ani(widget.curtain,'</span>opacity<span class="literal">',0,200,{hideOnComplete:true});
	}
}

//////////////////////////// Positioning /////////////////////////////

In2iGui.positionAtElement = function(element,target,options) {
	options = options || {};
	element = $(element);
	target = $(target);
	var origDisplay = element.getStyle('</span>display<span class="literal">');
	if (origDisplay=='</span>none<span class="literal">') {
		element.setStyle({'</span>visibility<span class="literal">':'</span>hidden<span class="literal">','</span>display<span class="literal">':'</span>block<span class="literal">'});
	}
	var pos = target.cumulativeOffset();
	var left = pos.left;
	var top = pos.top;
	if (options.horizontal &amp;&amp; options.horizontal=='</span>right<span class="literal">') {
		left = left+target.getWidth()-element.getWidth();
	}
	if (options.vertical &amp;&amp; options.vertical=='</span>topOutside<span class="literal">') {
		top = top-element.getHeight();
	}
	element.setStyle({'</span>left<span class="literal">':left+'</span>px<span class="literal">','</span>top<span class="literal">':top+'</span>px<span class="literal">'});
	if (origDisplay=='</span>none<span class="literal">') {
		element.setStyle({'</span>visibility<span class="literal">':'</span>visible<span class="literal">','</span>display<span class="literal">':'</span>none<span class="literal">'});
	}
}


/* ********************** Frag drop ******************* */

In2iGui.getDragProxy = function() {
	if (!In2iGui.dragProxy) {
		In2iGui.dragProxy = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_dragproxy<span class="literal">'},{'</span>display<span class="literal">':'</span>none<span class="literal">'});
		document.body.appendChild(In2iGui.dragProxy);
	}
	return In2iGui.dragProxy;
}

In2iGui.startDrag = function(e,element,options) {
	var info = element.dragDropInfo;
	In2iGui.dropTypes = In2iGui.findDropTypes(info);
	if (!In2iGui.dropTypes) return;
	var event = new N2i.Event(e);
	var proxy = In2iGui.getDragProxy();
	N2i.addListener(document.body,'</span>mousemove<span class="literal">',In2iGui.dragListener);
	N2i.addListener(document.body,'</span>mouseup<span class="literal">',In2iGui.dragEndListener);
	In2iGui.dragInfo = info;
	if (info.icon) {
		proxy.style.backgroundImage = '</span>url(<span class="literal">'+In2iGui.getIconUrl(info.icon,1)+'</span>)<span class="literal">';
	}
	In2iGui.startDragPos = {top:event.mouseTop(),left:event.mouseLeft()};
	proxy.innerHTML = info.title;
	In2iGui.dragging = true;
}

In2iGui.findDropTypes = function(drag) {
	var gui = In2iGui.get();
	var drops = null;
	for (var i=0; i &lt; gui.delegates.length; i++) {
		if (gui.delegates[i].dragDrop) {
			for (var j=0; j &lt; gui.delegates[i].dragDrop.length; j++) {
				var rule = gui.delegates[i].dragDrop[j];
				if (rule.drag==drag.kind) {
					if (drops==null) drops={};
					drops[rule.drop] = {};
				}
			};
		}
	}
	return drops;
}

In2iGui.dragListener = function(e) {
	var event = new N2i.Event(e);
	In2iGui.dragProxy.style.left = (event.mouseLeft()+10)+'</span>px<span class="literal">';
	In2iGui.dragProxy.style.top = event.mouseTop()+'</span>px<span class="literal">';
	In2iGui.dragProxy.style.display='</span>block<span class="literal">';
	var target = In2iGui.findDropTarget(event.getTarget());
	if (target &amp;&amp; In2iGui.dropTypes[target.dragDropInfo['</span>kind<span class="literal">']]) {
		if (In2iGui.latestDropTarget) {
			N2i.removeClass(In2iGui.latestDropTarget,'</span>in2igui_drop<span class="literal">');
		}
		N2i.addClass(target,'</span>in2igui_drop<span class="literal">');
		In2iGui.latestDropTarget = target;
	} else if (In2iGui.latestDropTarget) {
		N2i.removeClass(In2iGui.latestDropTarget,'</span>in2igui_drop<span class="literal">');
		In2iGui.latestDropTarget = null;
	}
	return false;
}

In2iGui.findDropTarget = function(node) {
	while (node) {
		if (node.dragDropInfo) {
			return node;
		}
		node = node.parentNode;
	}
	return null;
}

In2iGui.dragEndListener = function(event) {
	N2i.removeListener(document.body,'</span>mousemove<span class="literal">',In2iGui.dragListener);
	N2i.removeListener(document.body,'</span>mouseup<span class="literal">',In2iGui.dragEndListener);
	In2iGui.dragging = false;
	if (In2iGui.latestDropTarget) {
		N2i.removeClass(In2iGui.latestDropTarget,'</span>in2igui_drop<span class="literal">');
		In2iGui.callDelegatesDrop(In2iGui.dragInfo,In2iGui.latestDropTarget.dragDropInfo);
		In2iGui.dragProxy.style.display='</span>none<span class="literal">';
	} else {
		$ani(In2iGui.dragProxy,'</span>left<span class="literal">',In2iGui.startDragPos.left+'</span>px<span class="literal">',300,{ease:N2i.Animation.fastSlow});
		$ani(In2iGui.dragProxy,'</span>top<span class="literal">',In2iGui.startDragPos.top+'</span>px<span class="literal">',300,{ease:N2i.Animation.fastSlow,hideOnComplete:true});
	}
}

In2iGui.dropOverListener = function(event) {
	if (In2iGui.dragging) {
		//this.style.backgroundColor='</span>#3875D7<span class="literal">';
	}
}

In2iGui.dropOutListener = function(event) {
	if (In2iGui.dragging) {
		//this.style.backgroundColor='</span><span class="literal">';
	}
}

/* ****************** Delegating *************** */

In2iGui.extend = In2iGui.enableDelegating = function(obj) {
	if (!obj.name) {
		In2iGui.latestObjectIndex++;
		obj.name = '</span>unnamed<span class="literal">'+In2iGui.latestObjectIndex;
	}
	In2iGui.get().objects.set(obj.name,obj);
	obj.delegates = [];
	obj.addDelegate = function(delegate) {
		this.delegates[this.delegates.length] = delegate;
	}
	if (!obj.getElement) {
		obj.getElement = function() {
			return this.element;
		}
	}
}

In2iGui.callDelegatesDrop = function(dragged,dropped) {
	var gui = In2iGui.get();
	var result = null;
	for (var i=0; i &lt; gui.delegates.length; i++) {
		if (gui.delegates[i]['</span>drop$<span class="literal">'+dragged.kind+'</span>$<span class="literal">'+dropped.kind]) {
			gui.delegates[i]['</span>drop$<span class="literal">'+dragged.kind+'</span>$<span class="literal">'+dropped.kind](dragged,dropped);
		}
	}
}

In2iGui.callDelegates = function(obj,method,value,event) {
	if (typeof(value)=='</span>undefined<span class="literal">') value=obj;
	var result = null;
	if (obj.delegates) {
		for (var i=0; i &lt; obj.delegates.length; i++) {
			var delegate = obj.delegates[i];
			var thisResult = null;
			if (obj.name &amp;&amp; delegate[method+'</span>$<span class="literal">'+obj.name]) {
				thisResult = delegate[method+'</span>$<span class="literal">'+obj.name](value,event);
			} else if (obj.kind &amp;&amp; delegate[method+'</span>$<span class="literal">'+obj.kind]) {
				thisResult = delegate[method+'</span>$<span class="literal">'+obj.kind](value,event);
			} else if (delegate[method]) {
				thisResult = delegate[method](value,event);
			}
			if (result==null &amp;&amp; thisResult!=null &amp;&amp; typeof(thisResult)!='</span>undefined<span class="literal">') {
				result = thisResult;
			}
		};
	}
	var superResult = In2iGui.callSuperDelegates(obj,method,value,event);
	if (result==null &amp;&amp; superResult!=null) result = superResult;
	return result;
}

In2iGui.callSuperDelegates = function(obj,method,value,event) {
	if (typeof(value)=='</span>undefined<span class="literal">') value=obj;
	var gui = In2iGui.get();
	var result = null;
	for (var i=0; i &lt; gui.delegates.length; i++) {
		var delegate = gui.delegates[i];
		var thisResult = null;
		if (obj.name &amp;&amp; delegate[method+'</span>$<span class="literal">'+obj.name]) {
			thisResult = delegate[method+'</span>$<span class="literal">'+obj.name](value,event);
		} else if (obj.kind &amp;&amp; delegate[method+'</span>$<span class="literal">'+obj.kind]) {
			thisResult = delegate[method+'</span>$<span class="literal">'+obj.kind](value,event);
		} else if (delegate[method]) {
			thisResult = delegate[method](value,event);
		}
		if (result==null &amp;&amp; thisResult!=null &amp;&amp; typeof(thisResult)!='</span>undefined<span class="literal">') {
			result = thisResult;
		}
	};
	return result;
}

/******************** Data *****************/

In2iGui.dwrUpdate = function() {
	var func = arguments[0];
	var delegate = {
  		callback:function(data) { In2iGui.handleDwrUpdate(data) }
	}
	var num = arguments.length;
	if (num==1) {
		func(delegate);
	} else if (num==2) {
		func(arguments[1],delegate);
	} else {
		alert('</span>Too many parameters<span class="literal">');
	}
}

In2iGui.handleDwrUpdate = function(data) {
	var gui = In2iGui.get();
	for (var i=0; i &lt; data.length; i++) {
		if (gui.objects.get(data[i].name)) {
			gui.objects.get(data[i].name).updateFromObject(data[i]);
		}
	};
}

In2iGui.update = function(url,delegate) {
	var dlgt = {
		onSuccess:function(t) {In2iGui.handleUpdate(t,delegate)}
	}
	$get(url,dlgt);
}

In2iGui.handleUpdate = function(t,delegate) {
	var gui = In2iGui.get();
	var doc = t.responseXML.firstChild;
	var children = doc.childNodes;
	for (var i=0; i &lt; children.length; i++) {
		if (children[i].nodeType==1) {
			var name = children[i].getAttribute('</span>name<span class="literal">');
			if (name &amp;&amp; name!='</span><span class="literal">' &amp;&amp; gui.objects.get(name)) {
				gui.objects.get(name).updateFromNode(children[i]);
			}
		}
	};
	delegate.onSuccess();
}

In2iGui.jsonResponse = function(t,key) {
	if (!t.responseXML || !t.responseXML.documentElement) {
		var str = t.responseText.replace(/^\s+|\s+$/g, '</span><span class="literal">');
		if (str.length&gt;0) {
			var json = JSON.parse(t.responseText)
		} else {
			json = '</span><span class="literal">';
		}
		In2iGui.callDelegates(json,'</span>success$<span class="literal">'+key)
	} else {
		In2iGui.callDelegates(t,'</span>success$<span class="literal">'+key)
	}
}

In2iGui.json = function(data,url,delegateOrKey) {
	if (typeof(delegateOrKey)=='</span>string<span class="literal">') {
		delegate = {onSuccess:function(t) {In2iGui.jsonResponse(t,delegateOrKey)}}
	} else {
		delegate = delegateOrKey;
	}
	var options = {method:'</span>POST<span class="literal">',parameters:{}};
	for (key in data) {
		options.parameters[key]=JSON.stringify(data[key])
	}
	$get(url,delegate,options)
}


///////////////////////////////////// Common text field ////////////////////////

In2iGui.TextField = function(id,name,options) {
	this.options = {};
	N2i.override(this.options,options);
	this.element = $(id);
	this.element.setAttribute('</span>autocomplete<span class="literal">','</span>off<span class="literal">');
	this.value = this.element.value;
	this.name = name;
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.TextField.prototype = {
	addBehavior : function() {
		var self = this;
		this.element.observe('</span>keyup<span class="literal">',function() {
			self.keyDidStrike();
		});
	},
	keyDidStrike : function() {
		if (this.value!=this.element.value) {
			this.value = this.element.value;
			In2iGui.callDelegates(this,'</span>valueChanged<span class="literal">');
		}
	},
	getValue : function() {
		return this.value;
	},
	setValue : function(value) {
		this.value = value;
		this.element.value = value;
	}
}

In2iGui.InfoView = function(id,name,options) {
	this.options = {clickObjects:false};
	N2i.override(this.options,options);
	this.element = $(id);
	this.body = this.element.select('</span>tbody<span class="literal">')[0];
	this.name = name;
	In2iGui.extend(this);
}

In2iGui.InfoView.create = function(name,options) {
	options = options || {};
	var element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_infoview<span class="literal">'});
	if (options.height) {
		element.setStyle({height:options.height+'</span>px<span class="literal">','</span>overflow<span class="literal">':'</span>auto<span class="literal">','</span>overflowX<span class="literal">':'</span>hidden<span class="literal">'});
	}
	if (options.margin) {
		element.setStyle({margin:options.margin+'</span>px<span class="literal">'});
	}
	element.update('</span>&lt;table&gt;&lt;tbody&gt;&lt;/tbody&gt;&lt;/table&gt;<span class="literal">');
	return new In2iGui.InfoView(element,name,options);
}

In2iGui.InfoView.prototype = {
	addHeader : function(text) {
		var row = new Element('</span>tr<span class="literal">');
		row.insert(new Element('</span>th<span class="literal">',{'</span>class<span class="literal">' : '</span>in2igui_infoview_header<span class="literal">','</span>colspan<span class="literal">':'</span>2<span class="literal">'}).insert(text));
		this.body.insert(row);
	},
	addProperty : function(label,text) {
		var row = new Element('</span>tr<span class="literal">');
		row.insert(new Element('</span>th<span class="literal">').insert(label));
		row.insert(new Element('</span>td<span class="literal">').insert(text));
		this.body.insert(row);
	},
	addObjects : function(label,objects) {
		if (!objects || objects.length==0) return;
		var row = new Element('</span>tr<span class="literal">');
		row.insert(new Element('</span>th<span class="literal">').insert(label));
		var cell = new Element('</span>td<span class="literal">');
		var click = this.options.clickObjects;
		objects.each(function(obj) {
			var node = new Element('</span>div<span class="literal">').insert(obj.title);
			if (click) {
				node.addClassName('</span>in2igui_infoview_click<span class="literal">')
				node.observe('</span>click<span class="literal">',function() {
					In2iGui.callDelegates(this,'</span>objectWasClicked<span class="literal">',obj);
				});
			}
			cell.insert(node);
		});
		row.insert(cell);
		this.body.insert(row);
	},
	setBusy : function(busy) {
		if (busy) {
			this.element.addClassName('</span>in2igui_infoview_busy<span class="literal">');
		} else {
			this.element.removeClassName('</span>in2igui_infoview_busy<span class="literal">');
		}
	},
	clear : function() {
		this.body.update();
	},
	update : function(data) {
		this.clear();
		for (var i=0; i &lt; data.length; i++) {
			switch (data[i].type) {
				case '</span>header<span class="literal">': this.addHeader(data[i].value); break;
				case '</span>property<span class="literal">': this.addProperty(data[i].label,data[i].value); break;
				case '</span>objects<span class="literal">': this.addObjects(data[i].label,data[i].value); break;
			}
		};
	}
}

/* EOF */
In2iGui.Window = function(element,name) {
	this.element = $(element);
	this.name = name;
	this.close = this.element.select('</span>.close<span class="literal">')[0];
	this.titlebar = this.element.select('</span>.titlebar<span class="literal">')[0];
	this.title = this.titlebar.select('</span>.title<span class="literal">')[0];
	this.content = this.element.select('</span>.in2igui_window_body<span class="literal">')[0];
	this.visible = false;
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.Window.create = function(name,options) {
	N2i.log(options);
	options = N2i.override({title:'</span>Window<span class="literal">'},options);
	N2i.log(options);
	var element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_window<span class="literal">'+(options.variant ? '</span> in2igui_window_<span class="literal">'+options.variant : '</span><span class="literal">')});
	element.update('</span>&lt;div class=<span class="literal">"close"</span>&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"titlebar"</span>&gt;&lt;div class=<span class="literal">"titlebar"</span>&gt;&lt;div class=<span class="literal">"titlebar"</span>&gt;&lt;span&gt;<span class="literal">'+options.title+'</span>&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"in2igui_window_content"</span>&gt;&lt;div class=<span class="literal">"in2igui_window_content"</span>&gt;&lt;div class=<span class="literal">"in2igui_window_body"</span> style=<span class="literal">"'+
		(options.width ? 'width:'+options.width+'px;':'')+
		(options.padding ? 'padding:'+options.padding+'px;':'')+
		'"</span>&gt;<span class="literal">'+
		'</span>&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"in2igui_window_bottom"</span>&gt;&lt;div class=<span class="literal">"in2igui_window_bottom"</span>&gt;&lt;div class=<span class="literal">"in2igui_window_bottom"</span>&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;/div&gt;<span class="literal">');
	document.body.appendChild(element);
	return new In2iGui.Window(element,name);
}

In2iGui.Window.prototype = {
	addBehavior : function() {
		var self = this;
		this.close.observe('</span>click<span class="literal">',function() {self.hide();});
		this.titlebar.onmousedown = function(e) {self.startDrag(e);return false;};
		this.titlebar.observe('</span>touchstart<span class="literal">',function(e) {self.startDrag(e);return false;});
	},
	setTitle : function(title) {
		this.title.update(title);
	},
	show : function() {
		if (this.visible) return;
		this.element.setStyle({
			zIndex : In2iGui.nextPanelIndex(), visibility : '</span>hidden<span class="literal">', display : '</span>block<span class="literal">'
		})
		var width = this.element.clientWidth;
		this.element.setStyle({
			width : width+'</span>px<span class="literal">' , visibility : '</span>visible<span class="literal">'
		});
		if (!N2i.isIE()) {
			$ani(this.element,'</span>opacity<span class="literal">',1,0);
		}
		this.visible = true;
	},
	toggle : function() {
		(this.visible ? this.hide() : this.show() );
	},
	hide : function() {
		if (!this.visible) return;
		if (!N2i.isIE()) {
			$ani(this.element,'</span>opacity<span class="literal">',0,200,{hideOnComplete:true});
		} else {
			this.element.setStyle({display:'</span>none<span class="literal">'});
		}
		this.visible = false;
	},
	add : function(widgetOrNode) {
		if (widgetOrNode.getElement) {
			this.content.insert(widgetOrNode.getElement());
		} else {
			this.content.insert(widgetOrNode);
		}
	},

////////////////////////////// Dragging ////////////////////////////////

	startDrag : function(e) {
		this.element.style.zIndex=In2iGui.nextPanelIndex();
		var event = new N2i.Event(e);
		this.dragState = {left:event.mouseLeft()-N2i.Element.getLeft(this.element),top:event.mouseTop()-N2i.Element.getTop(this.element)};
		this.latestPosition = {left: this.dragState.left, top:this.dragState.top};
		this.latestTime = new Date().getMilliseconds();
		var self = this;
		this.moveListener = function(e) {self.drag(e)};
		this.upListener = function(e) {self.endDrag(e)};
		N2i.Event.addListener(document,'</span>mousemove<span class="literal">',this.moveListener);
		N2i.Event.addListener(document,'</span>mouseup<span class="literal">',this.upListener);
		N2i.Event.stop(e);
		document.body.onselectstart = function () { return false; };
		return false;
	},
	calc : function(top,left) {
		// TODO: No need to do this all the time
		this.a = this.latestPosition.left-left;
		this.b = this.latestPosition.top-top;
		this.dist = Math.sqrt(Math.pow((this.a),2),Math.pow((this.b),2));
		this.latestTime = new Date().getMilliseconds();
		this.latestPosition = {'</span>top<span class="literal">':top,'</span>left<span class="literal">':left};
	},
	drag : function(e) {
		var event = new N2i.Event(e);
		this.element.style.right = '</span>auto<span class="literal">';
		var top = (event.mouseTop()-this.dragState.top);
		var left = (event.mouseLeft()-this.dragState.left);
		this.element.style.top = Math.max(top,0)+'</span>px<span class="literal">';
		this.element.style.left = Math.max(left,0)+'</span>px<span class="literal">';
		//this.calc(top,left);
		return false;
	},
	endDrag : function(e) {
		N2i.Event.removeListener(document,'</span>mousemove<span class="literal">',this.moveListener);
		N2i.Event.removeListener(document,'</span>mouseup<span class="literal">',this.upListener);
		document.body.onselectstart = null;
		/*
		var func = N2i.Animation.fastSlow;
		var newTop = parseInt(this.element.style.top)-this.b*10;
		var newLeft = parseInt(this.element.style.left)-this.a*10;
		if (newTop&lt;0) {newTop=0; func=N2i.Animation.bounce};
		if (newLeft&lt;0) {newLeft=0; func=N2i.Animation.bounce};
		$ani(this.element,'</span>top<span class="literal">',newTop+'</span>px<span class="literal">',1000,{ease:func});
		$ani(this.element,'</span>left<span class="literal">',newLeft+'</span>px<span class="literal">',1000,{ease:func});
		*/
	}
}

/* EOF */In2iGui.Formula = function(id,name) {
	this.id = id;
	this.name = name;
	this.element = $(id);
	this.inputs = [];
	this.children = [];
	this.addBehavior();
	In2iGui.enableDelegating(this);
}

In2iGui.Formula.create = function(name) {
	var e = new Element('</span>form<span class="literal">',
		{'</span>class<span class="literal">':'</span>in2igui_formula<span class="literal">'}
	);
	return new In2iGui.Formula(e,name);
}

In2iGui.Formula.prototype = {
	addBehavior : function() {
		var self = this;
		this.element.onsubmit=function() {
			In2iGui.callDelegates(self,'</span>submit<span class="literal">');
			return false
		};
	},
	getElement : function() {
		return this.element;
	},
	registerInput : function(obj) {
		this.inputs[this.inputs.length] = obj;
	},
	registerChild : function(obj) {
		this.children.push(obj);
	},
	getValues : function() {
		var data = {};
		for (var i=0; i &lt; this.inputs.length; i++) {
			if (this.inputs[i].options.key) {
				data[this.inputs[i].options.key] = this.inputs[i].getValue();
			} else if (this.inputs[i].name) {
				data[this.inputs[i].name] = this.inputs[i].getValue();
			}
		};
		return data;
	},
	setValues : function(values) {
		for (var i=0; i &lt; this.inputs.length; i++) {
			var key = this.inputs[i].options.key;
			if (key &amp;&amp; values[key]) {
				this.inputs[i].setValue(values[key]);
			}
		}
	},
	reset : function() {
		for (var i=0; i &lt; this.inputs.length; i++) {
			this.inputs[i].reset();
		}
	},
	addContent : function(node) {
		this.element.insert(node);
	},
	add : function(widget) {
		widget.parent = this;
		this.element.insert(widget.getElement());
	},
	createGroup : function(options) {
		var g = In2iGui.Formula.Group.create(null,options);
		this.add(g);
		return g;
	}
}

/********************** Group **********************/


In2iGui.Formula.Group = function(elementOrId,name,options) {
	this.name = name;
	this.element = $(elementOrId);
	this.body = this.element.select('</span>tbody<span class="literal">')[0];
	this.options = N2i.override({above:true},options);
	this.parent = null;
	In2iGui.extend(this);
}

In2iGui.Formula.Group.create = function(name,options) {
	options = N2i.override({above:true},options);
	var element = new Element('</span>table<span class="literal">',
		{'</span>class<span class="literal">':'</span>in2igui_formula_group<span class="literal">'}
	);
	if (options.above) {
		element.addClassName('</span>in2igui_formula_group_above<span class="literal">');
	}
	element.insert(new Element('</span>tbody<span class="literal">'));
	return new In2iGui.Formula.Group(element,name,options);
}

In2iGui.Formula.Group.prototype = {
	add : function(widget) {
		var tr = new Element('</span>tr<span class="literal">');
		this.body.insert(tr);
		var label = widget.getLabel();
		if (label) {
			var th = new Element('</span>th<span class="literal">');
			th.insert(new Element('</span>label<span class="literal">').insert(label));
			tr.insert(th);
		}
		var td = new Element('</span>td<span class="literal">');
		td.insert(widget.getElement());
		if (this.options.above) {
			tr = new Element('</span>tr<span class="literal">');
			this.body.insert(tr);
		}
		tr.insert(td);
		if (this.parent) {
			this.parent.registerInput(widget);
		}
	},
	createButtons : function(options) {
		var tr = new Element('</span>tr<span class="literal">');
		this.body.insert(tr);
		var td = new Element('</span>td<span class="literal">',{colspan:this.options.above?1:2});
		tr.insert(td);
		var b = In2iGui.Buttons.create(null,options);
		td.insert(b.getElement());
		return b;
	}
}

/********************** Text ***********************/

In2iGui.Formula.Text = function(element,name,options) {
	this.name = name;
	this.options = {label:null,key:null};
	N2i.override(this.options,options);
	this.element = $(element);
	this.input = this.element.select('</span>.in2igui_formula_text<span class="literal">')[0];
	In2iGui.extend(this);
}

In2iGui.Formula.Text.create = function(name,options) {
	options = N2i.override({lines:1},options);
	if (options.lines&gt;1) {
		var input = N2i.create('</span>textarea<span class="literal">',
			{'</span>class<span class="literal">':'</span>in2igui_formula_text<span class="literal">','</span>rows<span class="literal">':options.lines}
		);
	} else {
		var input = N2i.create('</span>input<span class="literal">',
			{'</span>class<span class="literal">':'</span>in2igui_formula_text<span class="literal">'}
		);		
	}
	var element = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_field<span class="literal">'});
	element.appendChild(input);
	return new In2iGui.Formula.Text(element,name,options);
}

In2iGui.Formula.Text.prototype = {
	updateFromNode : function(node) {
		if (node.firstChild) {
			this.setValue(node.firstChild.nodeValue);
		} else {
			this.setValue(null);
		}
	},
	updateFromObject : function(data) {
		this.setValue(data.value);
	},
	focus : function() {
		try {
			this.element.focus();
		} catch (ignore) {}
	},
	reset : function() {
		this.setValue('</span><span class="literal">');
	},
	setValue : function(value) {
		this.input.value = value;
	},
	getValue : function() {
		return this.input.value;
	},
	getLabel : function() {
		return this.options.label;
	},
	isEmpty : function() {
		return N2i.isEmpty(this.input.value);
	}
}

/********************** Dat time ***********************/

In2iGui.Formula.DateTime = function(elementOrId,name,options) {
	this.inputFormats = ['</span>d-m-Y<span class="literal">','</span>d/m-Y<span class="literal">','</span>d/m/Y<span class="literal">','</span>d-m-Y H:i:s<span class="literal">','</span>d/m-Y H:i:s<span class="literal">','</span>d/m/Y H:i:s<span class="literal">','</span>d-m-Y H:i<span class="literal">','</span>d/m-Y H:i<span class="literal">','</span>d/m/Y H:i<span class="literal">','</span>d-m-Y H<span class="literal">','</span>d/m-Y H<span class="literal">','</span>d/m/Y H<span class="literal">','</span>d-m<span class="literal">','</span>d/m<span class="literal">','</span>d<span class="literal">','</span>Y<span class="literal">','</span>m-d-Y<span class="literal">','</span>m-d<span class="literal">','</span>m/d<span class="literal">'];
	this.outputFormat = '</span>d-m-Y H:i:s<span class="literal">';
	//this.id = id;
	this.name = name;
	this.options = options;
	this.value = null;
	this.element = $id(elementOrId);
	In2iGui.enableDelegating(this);
	this.addBehavior();
}

In2iGui.Formula.DateTime.create = function(name,opts) {
	var options = {};
	N2i.override(options,opts);
	var element = N2i.create('</span>input<span class="literal">',
		{'</span>class<span class="literal">':'</span>in2igui_formula_text<span class="literal">'}
	);
	return new In2iGui.Formula.DateTime(element,name,options);
}

In2iGui.Formula.DateTime.prototype = {
	addBehavior : function() {
		var self = this;
		this.element.onblur = function() {
			self.check();
		}
	},
	updateFromNode : function(node) {
		if (node.firstChild) {
			this.setValue(node.firstChild.nodeValue);
		} else {
			this.setValue(null);
		}
	},
	updateFromObject : function(data) {
		this.setValue(data.value);
	},
	focus : function() {
		try {this.element.focus();} catch (ignore) {}
	},
	reset : function() {
		this.setValue('</span><span class="literal">');
	},
	setValue : function(value) {
		if (!value) {
			this.value = null;
		} else {
			this.value = new Date();
			this.value.setTime(parseInt(value)*1000);
		}
		this.updateUI();
	},
	check : function() {
		var str = this.element.value;
		var parsed = null;
		for (var i=0; i &lt; this.inputFormats.length &amp;&amp; parsed==null; i++) {
			parsed = Date.parseDate(str,this.inputFormats[i]);
		};
		this.value = parsed;
		this.updateUI();
	},
	getValue : function() {
		return (this.value!=null ? Math.round(this.value.getTime()/1000) : null);
	},
	getElement : function() {
		return this.element;
	},
	getLabel : function() {
		if (!this.label) {
			this.label = N2i.create('</span>label<span class="literal">');
			this.label.innerHTML = this.options.label;
		}
		return this.label;
	},
	updateUI : function() {
		if (this.value) {
			this.element.value = this.value.dateFormat(this.outputFormat);
		} else {
			this.element.value = '</span><span class="literal">'
		}
	}
}

/************************************* Select *******************************/

In2iGui.Formula.Select = function(elementOrId,name,options) {
	this.name = name;
	this.options = options;
	this.element = $id(elementOrId);
	this.value = null;
	In2iGui.enableDelegating(this);
	this.refresh();
}

In2iGui.Formula.Select.prototype = {
	refresh : function() {
		if (this.options.source) {
			var self = this;
			$get(this.options.source,{onSuccess:function(t) {self.update(t.responseXML)}});
		}
	},
	update : function(doc) {
		for (var i = this.element.options.length - 1; i &gt;= 0; i--){
			this.element.remove(i);
		};
		var items = doc.getElementsByTagName('</span>item<span class="literal">');
		for (var i=0; i &lt; items.length; i++) {
			var title = items[i].getAttribute('</span>title<span class="literal">');
			var value = items[i].getAttribute('</span>value<span class="literal">');
			this.element.options[this.element.options.length] = new Option(title,value);
		};
		this.setValue(this.value);
	},
	reset : function() {
		this.element.selectedIndex = 0;
		this.value = null;
	},
	setValue : function(value) {
		value=value+'</span><span class="literal">';
		for (var i=0; i &lt; this.element.options.length; i++) {
			if (this.element.options[i].value==value) {
				this.element.selectedIndex = i;
				this.value = value;
				return;
			}
		};
		if (this.element.options.length==0) {
			this.value = null;
		} else {
			this.element.selectedIndex = 0;
			this.value = this.element.options[0].value;
		}
	},
	getValue : function(value) {
		return this.element.value;
	}
}


/********************************* Radio buttons ****************************/

In2iGui.Formula.Radiobuttons = function(id,name,options) {
	this.element = $id(id);
	this.name = name;
	this.radios = [];
	this.value = options.value;
	this.defaultValue = this.value;
	In2iGui.enableDelegating(this);
}

In2iGui.Formula.Radiobuttons.prototype = {
	click : function() {
		this.value = !this.value;
		this.updateUI();
	},
	updateUI : function() {
		for (var i=0; i &lt; this.radios.length; i++) {
			var radio = this.radios[i];
			N2i.setClass(radio.id,'</span>selected<span class="literal">',radio.value==this.value);
		};
	},
	setValue : function(value) {
		this.value = value;
		this.updateUI();
	},
	getValue : function() {
		return this.value;
	},
	reset : function() {
		this.setValue(this.defaultValue);
	},
	registerRadiobutton : function(radio) {
		this.radios.push(radio);
		var element = $id(radio.id);
		var self = this;
		element.onclick = function() {
			self.setValue(radio.value);
		}
	}
}


/********************************* Checkboxes ****************************/

In2iGui.Formula.Checkbox = function(id,name,options) {
	this.element = $id(id);
	this.name = name;
	this.value = options.value=='</span>true<span class="literal">';
	In2iGui.enableDelegating(this);
	this.addBehavior();
}

In2iGui.Formula.Checkbox.prototype = {
	addBehavior : function() {
		var control = $firstClass('</span>check<span class="literal">',this.element);
		var self = this;
		control.onclick = function() {self.click()};
	},
	click : function() {
		this.value = !this.value;
		this.updateUI();
	},
	updateUI : function() {
		N2i.setClass(this.element,'</span>checked<span class="literal">',this.value);
	},
	setValue : function(value) {
		this.value = value;
		this.updateUI();
	},
	getValue : function() {
		return this.value;
	},
	reset : function() {
		this.setValue(false);
	}
}

/********************************* Checkboxes ****************************/

In2iGui.Formula.Checkboxes = function(id,name) {
	this.element = $id(id);
	this.name = name;
	this.checkboxes = [];
	this.sources = [];
	this.values = [];
	In2iGui.enableDelegating(this);
}

In2iGui.Formula.Checkboxes.prototype = {
	getValues : function() {
		return this.values;
	},
	checkValues : function() {
		var newValues = [];
		for (var i=0; i &lt; this.values.length; i++) {
			var value = this.values[i];
			var found = false;
			for (var j=0; j &lt; this.sources.length; j++) {
				found = found || this.sources[j].hasValue(value);
			};
			if (found) {
				newValues.push(value);
			}
		};
		this.values=newValues;
	},
	setValues : function(values) {
		this.values=values;
		this.checkValues();
		this.updateUI();
	},
	flipValue : function(value) {
		N2i.flipInArray(this.values,value);
		this.checkValues();
		this.updateUI();
	},
	updateUI : function() {
		for (var i=0; i &lt; this.sources.length; i++) {
			this.sources[i].updateUI();
		};
	},
	refresh : function() {
		for (var i=0; i &lt; this.sources.length; i++) {
			this.sources[i].refresh();
		};
	},
	reset : function() {
		this.setValues([]);
	},
	registerSource : function(source) {
		source.parent = this;
		this.sources.push(source);
	},
	itemWasClicked : function(item) {
		this.changeValue(item.in2iGuiValue);
	}
}

/******************************** Source ****************************/

In2iGui.Formula.Checkboxes.Source = function(id,name,options) {
	this.element = $id(id);
	this.name = name;
	this.parent = null;
	this.options = options;
	this.checkboxes = [];
	In2iGui.enableDelegating(this);
	var self = this;
	N2i.Event.addLoadListener(function() {self.refresh()});
}

In2iGui.Formula.Checkboxes.Source.prototype = {
	refresh : function() {
		var self = this;
		$get(this.options.url,{onSuccess:function(t) {self.update(t.responseXML)}});
	},
	update : function(doc) {
		this.checkboxes = [];
		N2i.removeChildren(this.element);
		var self = this;
		var items = doc.getElementsByTagName('</span>checkbox<span class="literal">');
		for (var i=0; i &lt; items.length; i++) {
			var item = items[i];
			var node = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>checkbox<span class="literal">'});
			var label = item.getAttribute('</span>label<span class="literal">');
			var value = item.getAttribute('</span>value<span class="literal">');
			var check = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>check<span class="literal">'});
			node.appendChild(check);
			node.appendChild(document.createTextNode(label));
			this.element.appendChild(node);
			node.in2iGuiValue = value;
			node.onclick = function() {
				self.itemWasClicked(this);
			}
			this.checkboxes.push({label:label,element:node,value:value});
		};
		if (items.length==0) {
			//this.element.innerHTML='</span>&amp;nbsp;<span class="literal">';
		}
		this.parent.checkValues();
		this.updateUI();
	},
	itemWasClicked : function(node) {
		this.parent.flipValue(node.in2iGuiValue);
	},
	updateUI : function() {
		for (var i=0; i &lt; this.checkboxes.length; i++) {
			var item = this.checkboxes[i];
			N2i.setClass(item.element,'</span>checked<span class="literal">',N2i.inArray(this.parent.values,item.value));
		};
	},
	hasValue : function(value) {
		for (var i=0; i &lt; this.checkboxes.length; i++) {
			if (this.checkboxes[i].value==value) {
				return true;
			}
		};
		return false;
	}
}

/**************************** Token ************************/

In2iGui.Formula.Tokens = function(element,name,options) {
	this.options = {label:null,key:null};
	N2i.override(this.options,options);
	this.element = $(element);
	this.name = name;
	this.value = ['</span><span class="literal">'];
	In2iGui.extend(this);
	this.updateUI();
}

In2iGui.Formula.Tokens.create = function(name,opts) {
	var element = new Element('</span>div<span class="literal">').addClassName('</span>in2igui_tokens<span class="literal">');
	return new In2iGui.Formula.Tokens(element,name,opts);
}

In2iGui.Formula.Tokens.prototype = {
	setValue : function(objects) {
		this.value = objects;
		this.value.push('</span><span class="literal">');
		this.updateUI();
	},
	reset : function() {
		this.value = ['</span><span class="literal">'];
		this.updateUI();
	},
	getValue : function() {
		var out = [];
		this.value.each(function(value) {
			value = value.strip();
			if (value.length&gt;0) out.push(value);
		})
		return out;
	},
	getLabel : function() {
		return this.options.label;
	},
	updateUI : function() {
		this.element.update();
		var self = this;
		this.value.each(function(value,i) {
			var input = new Element('</span>input<span class="literal">').addClassName('</span>in2igui_tokens_token<span class="literal">');
			input.value = value;
			input.in2iguiIndex = i;
			self.element.insert(input);
			input.observe('</span>keyup<span class="literal">',function() {self.inputChanged(input,i)});
		});
	},
	/** @private */
	inputChanged : function(input,index) {
		if (index==this.value.length-1 &amp;&amp; input.value!=this.value[index]) {
			this.addField();
		}
		this.value[index] = input.value;
	},
	/** @private */
	addField : function() {
		var input = new Element('</span>input<span class="literal">').addClassName('</span>in2igui_tokens_token<span class="literal">');
		var i = this.value.length;
		this.value.push('</span><span class="literal">');
		this.element.insert(input);
		var self = this;
		input.observe('</span>keyup<span class="literal">',function() {self.inputChanged(input,i)});
	}
}

/* EOF */In2iGui.List = function(element,name,options) {
	this.element = $(element);
	this.name = name;
	this.state = options.state;
	
	this.source = options.source;
	this.head = this.element.getElementsByTagName('</span>thead<span class="literal">')[0];
	this.body = this.element.getElementsByTagName('</span>tbody<span class="literal">')[0];
	this.columns = [];
	this.rows = [];
	this.selected = [];
	this.navigation = $class('</span>navigation<span class="literal">',this.element)[0];
	this.count = $class('</span>count<span class="literal">',this.navigation)[0];
	this.windowSize = $class('</span>window_size<span class="literal">',this.navigation)[0];
	this.windowNumber = $firstClass('</span>window_number<span class="literal">',this.navigation);
	this.windowNumberBody = $firstClass('</span>window_number_body<span class="literal">',this.navigation);
	this.parameters = {};
	this.sortKey = null;
	this.sortDirection = null;
	
	this.window = {size:null,number:1,total:0};
	if (options.windowSize!='</span><span class="literal">') {
		this.window.size = parseInt(options.windowSize);
	}
	In2iGui.enableDelegating(this);
	this.refresh();
}

In2iGui.List.prototype = {
	hide : function() {
		this.element.hide();
	},
	show : function() {
		this.element.show();
	},
	registerColumn : function(column) {
		this.columns.push(column);
	},
	getSelection : function() {
		var items = [];
		for (var i=0; i &lt; this.selected.length; i++) {
			items.push(this.rows[this.selected[i]]);
		};
		return items;
	},
	getFirstSelection : function() {
		var items = this.getSelection();
		if (items.length&gt;0) return items[0];
		else return null;
	},
	setParameter : function(key,value) {
		this.parameters[key]=value;
	},
	loadData : function(url) {
		this.source = url;
		this.selected = [];
		this.sortKey = null;
		this.sortDirection = null;
		this.window.number = 0;
		this.refresh();
	},

/**
 * @private
 */
	refresh : function() {
		if (!this.source) return;
		var self = this;
		var delegate = {
			onSuccess:function(t) {
				self.parse(t.responseXML);
			}
		};
		var url = this.source;
		if (this.window.number) {
			url+=url.indexOf('</span>?<span class="literal">')==-1 ? '</span>?<span class="literal">' : '</span>&amp;<span class="literal">';
			url+='</span>windowNumber=<span class="literal">'+this.window.number;
		}
		if (this.window.size) {
			url+=url.indexOf('</span>?<span class="literal">')==-1 ? '</span>?<span class="literal">' : '</span>&amp;<span class="literal">';
			url+='</span>windowSize=<span class="literal">'+this.window.size;
		}
		if (this.sortKey) {
			url+=url.indexOf('</span>?<span class="literal">')==-1 ? '</span>?<span class="literal">' : '</span>&amp;<span class="literal">';
			url+='</span>sort=<span class="literal">'+this.sortKey;
		}
		if (this.sortDirection) {
			url+=url.indexOf('</span>?<span class="literal">')==-1 ? '</span>?<span class="literal">' : '</span>&amp;<span class="literal">';
			url+='</span>direction=<span class="literal">'+this.sortDirection;
		}
		for (key in this.parameters) {
			url+=url.indexOf('</span>?<span class="literal">')==-1 ? '</span>?<span class="literal">' : '</span>&amp;<span class="literal">';
			url+=key+'</span>=<span class="literal">'+this.parameters[key];
		}
		$get(url,delegate);
	},
	sort : function(index) {
		var key = this.columns[index].key;
		if (key==this.sortKey) {
			this.sortDirection = this.sortDirection=='</span>ascending<span class="literal">' ? '</span>descending<span class="literal">' : '</span>ascending<span class="literal">';
		}
		this.sortKey = key;
		this.refresh();
	},

	/**
	 * @private
	 */
	parse : function(doc) {
		this.parseWindow(doc);
		this.buildNavigation();
		N2i.removeChildren(this.body);
		N2i.removeChildren(this.head);
		this.rows = [];
		this.columns = [];
		var headTr = N2i.create('</span>tr<span class="literal">');
		var sort = doc.getElementsByTagName('</span>sort<span class="literal">');
		this.sortKey=null;
		this.sortDirection=null;
		if (sort.length&gt;0) {
			this.sortKey=sort[0].getAttribute('</span>key<span class="literal">');
			this.sortDirection=sort[0].getAttribute('</span>direction<span class="literal">');
		}
		var headers = doc.getElementsByTagName('</span>header<span class="literal">');
		for (var i=0; i &lt; headers.length; i++) {
			var className = '</span><span class="literal">';
			var th = N2i.create('</span>th<span class="literal">');
			var width = headers[i].getAttribute('</span>width<span class="literal">');
			var key = headers[i].getAttribute('</span>key<span class="literal">');
			var sortable = headers[i].getAttribute('</span>sortable<span class="literal">')=='</span>true<span class="literal">';
			if (width &amp;&amp; width!='</span><span class="literal">') {
				th.style.width=width+'</span>%<span class="literal">';
			}
			if (sortable) {
				var self = this;
				th.in2iguiIndex = i;
				th.onclick=function() {self.sort(this.in2iguiIndex)};
				className+='</span>sortable<span class="literal">';
			}
			if (key==this.sortKey) {
				className+='</span> sort_<span class="literal">'+this.sortDirection;
			}
			th.className=className;
			var span = N2i.create('</span>span<span class="literal">');
			th.appendChild(span);
			span.appendChild(document.createTextNode(headers[i].getAttribute('</span>title<span class="literal">')));
			headTr.appendChild(th);
			this.columns.push({'</span>key<span class="literal">':key,'</span>sortable<span class="literal">':sortable,'</span>width<span class="literal">':width});
		};
		this.head.appendChild(headTr);
		var rows = doc.getElementsByTagName('</span>row<span class="literal">');
		for (var i=0; i &lt; rows.length; i++) {
			var cells = rows[i].getElementsByTagName('</span>cell<span class="literal">');
			var row = document.createElement('</span>tr<span class="literal">');
			var info = {uid:rows[i].getAttribute('</span>uid<span class="literal">'),kind:rows[i].getAttribute('</span>kind<span class="literal">'),icon:rows[i].getAttribute('</span>icon<span class="literal">'),title:rows[i].getAttribute('</span>title<span class="literal">'),index:i};
			row.dragDropInfo = info;
			for (var j=0; j &lt; cells.length; j++) {
				//var text = null;
				var cell = document.createElement('</span>td<span class="literal">');
				this.parseCell(cells[j],cell);
				//cell.appendChild(document.createTextNode('</span> <span class="literal">'));
				row.appendChild(cell);
			};
			this.addRowBehavior(row,i);
			this.body.appendChild(row);
			this.rows.push(info);
		};
	}
};

In2iGui.List.prototype.filter = function(str) {
	var len = 20;
	var regex = new RegExp("[\\w]{"+len+",}","g");
	var match = regex.exec(str);
	if (match) {
		for (var i=0; i &lt; match.length; i++) {
			var rep = '</span><span class="literal">';
			for (var j=0; j &lt; match[i].length; j++) {
				rep+=match[i][j];
				if ((j+1)%len==0) rep+='</span>\u200B<span class="literal">';
			};
			str = str.replace(match[i],rep);
		};
	}
	return str;
}

In2iGui.List.prototype.parseCell = function(node,cell) {
	if (node.getAttribute('</span>icon<span class="literal">')!=null) {
		var icon = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>icon<span class="literal">'},{'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">"'+In2iGui.getIconUrl(node.getAttribute('icon'),1)+'"</span>)<span class="literal">'});
		cell.appendChild(icon);
	}
	for (var i=0; i &lt; node.childNodes.length; i++) {
		var child = node.childNodes[i];
		if (child.nodeType==N2i.TEXT_NODE &amp;&amp; child.nodeValue.length&gt;0) {
			cell.appendChild(document.createTextNode(this.filter(child.nodeValue)));
		} else if (child.nodeType==N2i.ELEMENT_NODE &amp;&amp; child.nodeName=='</span>break<span class="literal">') {
			cell.appendChild(N2i.create('</span>br<span class="literal">'));
		} else if (child.nodeType==N2i.ELEMENT_NODE &amp;&amp; child.nodeName=='</span>object<span class="literal">') {
			var obj = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>object<span class="literal">'});
			if (child.getAttribute('</span>icon<span class="literal">')!=null) {
				var icon = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>icon<span class="literal">'},{'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">"'+In2iGui.getIconUrl(child.getAttribute('icon'),1)+'"</span>)<span class="literal">'});
				obj.appendChild(icon);
			}
			if (child.firstChild &amp;&amp; child.firstChild.nodeType==N2i.TEXT_NODE &amp;&amp; child.firstChild.nodeValue.length&gt;0) {
				obj.appendChild(document.createTextNode(child.firstChild.nodeValue));
			}
			cell.appendChild(obj);
		}
	};
}

/**
 * @private
 */
In2iGui.List.prototype.parseWindow = function(doc) {
	var wins = doc.getElementsByTagName('</span>window<span class="literal">');
	if (wins.length&gt;0) {
		var win = wins[0];
		this.window.total = parseInt(win.getAttribute('</span>total<span class="literal">'));
		this.window.size = parseInt(win.getAttribute('</span>size<span class="literal">'));
		this.window.number = parseInt(win.getAttribute('</span>number<span class="literal">'));
	} else {
		this.window.total = 0;
		this.window.size = 0;
		this.window.number = 0;
	}
}

In2iGui.List.prototype.buildNavigation = function(doc) {
	var self = this;
	var pages = this.window.size&gt;0 ? Math.ceil(this.window.total/this.window.size) : 0;
	if (pages&lt;2) {
		this.navigation.style.display='</span>none<span class="literal">';
		return;
	}
	this.navigation.style.display='</span>block<span class="literal">';
	var from = ((this.window.number-1)*this.window.size+1);
	this.count.innerHTML = '</span>&lt;span&gt;&lt;span&gt;<span class="literal">'+from+'</span>-<span class="literal">'+Math.min((this.window.number)*this.window.size,this.window.total)+'</span>/<span class="literal">'+this.window.total+'</span>&lt;/span&gt;&lt;/span&gt;<span class="literal">';
	this.windowNumberBody.innerHTML = '</span><span class="literal">';
	if (pages&lt;2) {
		this.windowNumber.style.display='</span>none<span class="literal">';	
	} else {
		for (var i=1;i&lt;=pages;i++) {
			var a = document.createElement('</span>a<span class="literal">');
			a.appendChild(document.createTextNode(i));
			a.in2GuiNumber = i;
			a.onclick = function() {
				self.windowNumberWasClicked(this);
				return false;
			}
			if (i==this.window.number) {
				a.className='</span>selected<span class="literal">';
			}
			this.windowNumberBody.appendChild(a);
		}
		this.windowNumber.style.display='</span>block<span class="literal">';
	}
}

/********************************** Update from objects *******************************/

In2iGui.List.prototype.setObjects = function(objects) {
	this.selected = [];
	this.body.innerHTML='</span><span class="literal">';
	this.rows = [];
	for (var i=0; i &lt; objects.length; i++) {
		var row = new Element('</span>tr<span class="literal">');
		var obj = objects[i];
		for (var j=0; j &lt; this.columns.length; j++) {
			var cell = new Element('</span>td<span class="literal">');
			if (this.builder) {
				cell.update(this.builder.buildColumn(this.columns[j],obj));
			} else {
				var value = obj[this.columns[j].key] || '</span><span class="literal">';
				if (value.constructor == Array) {
					for (var k=0; k &lt; value.length; k++) {
						if (value[k].constructor == Object) {
							cell.insert(this.createObject(value[k]));
						} else {
							cell.insert(new Element('</span>div<span class="literal">').update(value));
						}
					};
				} else if (value.constructor == Object) {
					cell.insert(this.createObject(value[j]));
				} else {
					cell.insert(value);
				}
			}
			row.insert(cell);
		};
		this.body.appendChild(row);
		this.addRowBehavior(row,i);
		this.rows.push(obj);
	};
}

In2iGui.List.prototype.createObject = function(object) {
	var node = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>object<span class="literal">'});
	if (object.icon) {
		node.insert(new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>icon<span class="literal">'}).setStyle({'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">"'+In2iGui.getIconUrl(object.icon,1)+'"</span>)<span class="literal">'}));
	}
	return node.insert(object.text || object.name || '</span><span class="literal">');
}

/************************************* Behavior ***************************************/


/**
 * @private
 */
In2iGui.List.prototype.addRowBehavior = function(row,index) {
	var self = this;
	row.onmousedown = function(e) {
		self.rowDown(index);
		In2iGui.startDrag(e,row);
		return false;
	}
	row.ondblclick = function() {
		self.rowDoubleClick(index);
		return false;
	}
}

In2iGui.List.prototype.changeSelection = function(indexes) {
	var rows = this.body.getElementsByTagName('</span>tr<span class="literal">');
	for (var i=0;i&lt;this.selected.length;i++) {
		N2i.Element.removeClassName(rows[this.selected[i]],'</span>selected<span class="literal">');
	}
	for (var i=0;i&lt;indexes.length;i++) {
		N2i.Element.addClassName(rows[indexes[i]],'</span>selected<span class="literal">');
	}
	this.selected = indexes
}

/**
 * @private
 */
In2iGui.List.prototype.rowDown = function(index) {
	this.changeSelection([index]);
}

/**
 * @private
 */
In2iGui.List.prototype.rowDoubleClick = function(index) {
	In2iGui.callDelegates(this,'</span>listRowsWasOpened<span class="literal">');
}

/**
 * @private
 */
In2iGui.List.prototype.windowNumberWasClicked = function(tag) {
	this.window.number = tag.in2GuiNumber;
	this.refresh();
}

/* EOF */In2iGui.Icons = function(id,name,options) {
	this.id = id;
	this.name = name;
	this.element = $id(id);
	this.source = options.source;
	In2iGui.enableDelegating(this);
}

/* EOF */In2iGui.Tabs = function(id,name) {
	this.id = id;
	this.name = name;
	this.element = $(id);
	this.bar = this.element.select('</span>.in2igui_tabs_bar<span class="literal">')[0];
	this.activeTab = 0;
	this.tabs = [];
	this.addBehavior();
	In2iGui.enableDelegating(this);
}

In2iGui.Tabs.prototype.registerTab = function(obj) {
	obj.parent = this;
	this.tabs[this.tabs.length] = obj;
}

In2iGui.Tabs.prototype.addBehavior = function() {
	var self = this;
	var tabs = this.bar.select('</span>li<span class="literal">');
	for (var i=0; i &lt; tabs.length; i++) {
		tabs[i].in2iGuiIndex = i;
		tabs[i].onclick = function() {
			self.tabWasClicked(this);
		}
	};
}

In2iGui.Tabs.prototype.tabWasClicked = function(tag) {
	this.activeTab = tag.in2iGuiIndex;
	this.updateGUI();
}

In2iGui.Tabs.prototype.updateGUI = function() {
	for (var i=0; i &lt; this.tabs.length; i++) {
		this.tabs[i].setActive(i==this.activeTab);
	};
}

//////////////////////////////////// Tab ////////////////////////////////

In2iGui.Tabs.Tab = function(id,name) {
	this.id = id;
	this.name = name;
	this.parent = null;
	this.element = $(id+'</span>_content<span class="literal">');
	this.tab = $(id+'</span>_tab<span class="literal">');
	In2iGui.enableDelegating(this);
}

In2iGui.Tabs.Tab.prototype = {
	setActive : function(active) {
		this.element.style.display = (active ? '</span>block<span class="literal">' : '</span>none<span class="literal">');
		N2i.setClass(this.tab,'</span>in2igui_tabs_selected<span class="literal">',active);
	}
}

/* EOF */In2iGui.ViewStack = function(id,name,options) {
	this.id = id;
	this.name = name;
	this.element = $id(id);
	this.contents = [];
	In2iGui.enableDelegating(this);
}

In2iGui.ViewStack.prototype.registerContent = function(id,name) {
	this.contents[this.contents.length] = {element:$id(id),name:name};
}

In2iGui.ViewStack.prototype.change = function(name) {
	for (var i=0; i &lt; this.contents.length; i++) {
		if (this.contents[i].name==name) {
			this.contents[i].element.style.display='</span>block<span class="literal">';
		} else {
			this.contents[i].element.style.display='</span>none<span class="literal">';
		}
	};
}

/* EOF */In2iGui.Tabbox = function(id,name) {
	this.id = id;
	this.name = name;
	this.element = $id(id);
	this.panes = $class('</span>tab<span class="literal">',$class('</span>tabbox_top<span class="literal">',this.element)[0]);
	this.activeTab = 0;
	this.tabs = [];
	this.addBehavior();
	this.updateGUI();
	In2iGui.enableDelegating(this);
}

In2iGui.Tabbox.prototype.registerTab = function(obj) {
	this.tabs[this.tabs.length] = obj;
}

In2iGui.Tabbox.prototype.addBehavior = function() {
	var self = this;
	var tabs = $class('</span>tabbox_top<span class="literal">',this.element)[0].getElementsByTagName('</span>a<span class="literal">');
	for (var i=0; i &lt; tabs.length; i++) {
		tabs[i].in2iGuiIndex = i;
		tabs[i].onclick = function() {
			self.tabWasClicked(this);
		}
	};
}

In2iGui.Tabbox.prototype.tabWasClicked = function(tag) {
	this.activeTab = tag.in2iGuiIndex;
	this.updateGUI();
}

In2iGui.Tabbox.prototype.updateGUI = function() {
	var body = $class('</span>tabbox_body<span class="literal">',this.element)[0];
	$ani(body,'</span>scrollLeft<span class="literal">',this.activeTab*592,700,{ease:N2i.Animation.slowFastSlow});
	for (var i=0; i &lt; this.panes.length; i++) {
		if (i==this.activeTab) {
			N2i.Element.addClassName(this.panes[i],'</span>tab_selected<span class="literal">');
		} else {
			N2i.Element.removeClassName(this.panes[i],'</span>tab_selected<span class="literal">');
		}
	};
}

//////////////////////////////////// Tab ////////////////////////////////

In2iGui.Tabbox.Tab = function(id,name) {
	this.id = id;
	this.name = name;
	this.element = $id(id);
	In2iGui.enableDelegating(this);
}

/* EOF */
In2iGui.ObjectList = function(id,name,options) {
	this.options = {key:null};
	N2i.override(this.options,options);
	this.name = name;
	this.element = $id(id);
	this.body = this.element.getElementsByTagName('</span>tbody<span class="literal">')[0];
	this.template = [];
	this.objects = [];
	In2iGui.extend(this);
}

In2iGui.ObjectList.prototype = {
	ignite : function() {
		this.addObject({id:0});
	},
	addObject : function(data,addToEnd) {
		if (this.objects.length==0 || addToEnd) {
			var obj = new In2iGui.ObjectList.Object(this.objects.length,data,this);
			this.objects.push(obj);
			this.body.appendChild(obj.getElement());
		} else {
			var last = this.objects.pop();
			var obj = new In2iGui.ObjectList.Object(last.index,data,this);
			last.index++;
			this.objects.push(obj);
			this.objects.push(last);
			this.body.insertBefore(obj.getElement(),last.getElement())
		}
	},
	reset : function() {
		for (var i=0; i &lt; this.objects.length; i++) {
			var element = this.objects[i].getElement();
			element.parentNode.removeChild(element);
		};
		this.objects = [];
		this.addObject({id:0});
	},
	addObjects : function(data) {
		for (var i=0; i &lt; data.length; i++) {
			this.addObject(data[i]);
		};
	},
	setObjects : function(data) {
		this.reset();
		this.addObjects(data);
	},
	getObjects : function(data) {
		var list = [];
		for (var i=0; i &lt; this.objects.length-1; i++) {
			list.push(this.objects[i].getData());
		};
		return list;
	},
	getValue : function() {
		return this.getObjects();
	},
	setValue : function(data) {
		this.setObjects(data);
	},
	registerTemplateItem : function(item) {
		this.template.push(item);
	},
	objectDidChange : function(obj) {
		if (obj.index&gt;=this.objects.length-1) {
			this.addObject({},true);
		}
	}
}

/********************** Object ********************/

In2iGui.ObjectList.Object = function(index,data,list) {
	this.data = data;
	this.index = index;
	this.list = list;
	this.fields = [];
}

In2iGui.ObjectList.Object.prototype = {
	getElement : function() {
		if (!this.element) {
			var self = this;
			this.element = document.createElement('</span>tr<span class="literal">');
			for (var i=0; i &lt; this.list.template.length; i++) {
				var template = this.list.template[i];
				var field = template.clone();
				field.object = this;
				this.fields.push(field);
				var cell = document.createElement('</span>td<span class="literal">');
				if (i==0) cell.className='</span>first<span class="literal">';
				cell.appendChild(field.getElement());
				field.setValue(this.data[template.key]);
				this.element.appendChild(cell);
			};
		}
		return this.element;
	},
	valueDidChange : function() {
		this.list.objectDidChange(this);
	},
	getData : function() {
		var data = this.data;
		for (var i=0; i &lt; this.fields.length; i++) {
			data[this.fields[i].key] = this.fields[i].getValue();
		};
		return data;
	}
}

/*************************** Text **************************/

In2iGui.ObjectList.Text = function(key) {
	this.key = key;
	this.value = null;
}

In2iGui.ObjectList.Text.prototype = {
	clone : function() {
		return new In2iGui.ObjectList.Text(this.key);
	},
	getElement : function() {
		var input = N2i.create('</span>input<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_formula_text<span class="literal">'});
		var field = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_field<span class="literal">'});
		field.appendChild(input);
		this.wrapper = new N2i.TextField(input);
		this.wrapper.setDelegate(this);
		return field;
	},
	valueDidChange : function(field) {
		this.value = field.getValue();
		this.object.valueDidChange();
	},
	getValue : function() {
		return this.value;
	},
	setValue : function(value) {
		this.value = value;
		this.wrapper.setValue(value);
	}
}

/*************************** Select **************************/

In2iGui.ObjectList.Select = function(key) {
	this.key = key;
	this.value = null;
	this.options = [];
}

In2iGui.ObjectList.Select.prototype = {
	clone : function() {
		var copy = new In2iGui.ObjectList.Select(this.key);
		copy.options = this.options;
		return copy;
	},
	getElement : function() {
		this.select = N2i.create('</span>select<span class="literal">');
		for (var i=0; i &lt; this.options.length; i++) {
			this.select.options[this.select.options.length] = new Option(this.options[i].label,this.options[i].value);
		};
		var self = this;
		this.select.onchange = function() {
			self.object.valueDidChange();
		}
		return this.select;
	},
	getValue : function() {
		return this.select.value;
	},
	setValue : function(value) {
		this.select.value = value;
	},
	addOption : function(value,label) {
		this.options.push({value:value,label:label});
	}
}

/* EOF *//**
 * An alert that can be
 * @constructor
 */
In2iGui.Alert = function(element,name) {
	this.element = $id(element);
	this.name = name;
	this.body = $firstClass('</span>in2igui_alert_body<span class="literal">',this.element);
	this.content = $firstClass('</span>in2igui_alert_content<span class="literal">',this.element);
	this.emotion = null;
	var h1s = $tag('</span>h1<span class="literal">',this.element);
	this.title = h1s.length&gt;0 ? h1s[0] : null;
	In2iGui.extend(this);
}

/**
 * Creates a new instance of an alert
 * @static
 */
In2iGui.Alert.create = function(name,options) {
	var opts = {title:'</span><span class="literal">',text:'</span><span class="literal">',emotion:null,variant:null,title:null};
	N2i.override(opts,options);
	
	var element = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_alert<span class="literal">'});
	var body = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_alert_body<span class="literal">'});
	element.appendChild(body);
	var content = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_alert_content<span class="literal">'});
	body.appendChild(content);
	document.body.appendChild(element);
	var obj = new In2iGui.Alert(element,name);
	if (opts.variant) {
		obj.setVariant(opts.variant);
	}
	if (opts.emotion) {
		obj.setEmotion(opts.emotion);
	}
	if (opts.title) {
		obj.setTitle(opts.title);
	}
	if (opts.text) {
		obj.setText(opts.text);
	}
	
	return obj;
}

In2iGui.Alert.prototype = {
	show : function() {
		this.element.style.zIndex=In2iGui.nextAlertIndex();
		this.element.style.display='</span>block<span class="literal">';
		this.element.style.top=(N2i.Window.getScrollTop()+100)+'</span>px<span class="literal">';
		$ani(this.element,'</span>opacity<span class="literal">',1,200);
		$ani(this.element,'</span>margin-top<span class="literal">','</span>40px<span class="literal">',600,{ease:N2i.Animation.elastic});
	},
	hide : function() {
		$ani(this.element,'</span>opacity<span class="literal">',0,200,{hideOnComplete:true});
		$ani(this.element,'</span>margin-top<span class="literal">','</span>0px<span class="literal">',200);
	},
	setTitle : function(text) {
		if (!this.title) {
			this.title = N2i.create('</span>h1<span class="literal">');
			this.content.appendChild(this.title);
		}
		this.title.innerHTML = text;
	},
	setText : function(text) {
		if (!this.text) {
			this.text = N2i.create('</span>p<span class="literal">');
			this.content.appendChild(this.text);
		}
		this.text.innerHTML = text;
	},
	/** @deprecated */
	setVariant : function(variant) {
		this.setEmotion(variant);
	},
	setEmotion : function(emotion) {
		if (this.emotion) {
			N2i.removeClass(this.body,this.emotion);
		}
		this.emotion = emotion;
		N2i.addClass(this.body,emotion);
	},
	update : function(options) {
		options = options || {};
		this.setTitle(options.title || null);
		this.setText(options.text || null);
		this.setVariant(options.variant || null);
		this.setEmotion(options.emotion || null);
	},
	addButton : function(button) {
		if (!this.buttons) {
			this.buttons = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_buttons<span class="literal">'});
			this.body.appendChild(this.buttons);
		}
		this.buttons.appendChild(button.getElement());
	}
}

/* EOF */In2iGui.Button = function(id,name) {
	this.name = name;
	this.element = $(id);
	this.inner = this.element.getElementsByTagName('</span>span<span class="literal">')[1];
	this.enabled = true;
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.Button.create = function(name,opts) {
	var options = {text:'</span><span class="literal">',highlighted:false};
	N2i.override(options,opts);
	var className = '</span>in2igui_button<span class="literal">'+(options.highlighted ? '</span> in2igui_button_highlighted<span class="literal">' : '</span><span class="literal">');
	var element = new Element('</span>a<span class="literal">',{'</span>class<span class="literal">':className});
	var element2 = new Element('</span>span<span class="literal">');
	element.appendChild(element2);
	var element3 = new Element('</span>span<span class="literal">');
	element2.appendChild(element3);
	if (options.icon) {
		var icon = new Element('</span>em<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_button_icon<span class="literal">'}).setStyle({'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+In2iGui.getIconUrl(options.icon,1)+'</span>)<span class="literal">'});
		if (!options.text || options.text.length==0) {
			icon.addClassName('</span>in2igui_button_icon_notext<span class="literal">');
		}
		element3.insert(icon);
	}
	if (options.text &amp;&amp; options.text.length&gt;0) {
		element3.insert(options.text);
	}
	return new In2iGui.Button(element,name);
}

In2iGui.Button.prototype = {
	addBehavior : function() {
		var self = this;
		this.element.onclick = function() {
			self.clicked();
		}
	},
	clicked : function() {
		if (this.enabled) {
			In2iGui.callDelegates(this,'</span>buttonWasClicked<span class="literal">'); // deprecated
			In2iGui.callDelegates(this,'</span>click<span class="literal">');
		}
	},
	setEnabled : function(enabled) {
		this.enabled = enabled;
		this.updateUI();
	},
	setHighlighted : function(highlighted) {
		N2i.setClass(this.element,'</span>in2igui_button_highlighted<span class="literal">',highlighted);
	},
	updateUI : function() {
		N2i.setClass(this.element,'</span>in2igui_button_disabled<span class="literal">',!this.enabled);
	},
	setText : function(text) {
		this.inner.innerHTML = text;
	}
}

In2iGui.Buttons = function(id,name) {
	this.name = name;
	this.element = $(id);
	In2iGui.extend(this);
}

In2iGui.Buttons.create = function(name,options) {
	options = N2i.override({top:0},options);
	var e = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_buttons<span class="literal">'});
	if (options.top&gt;0) e.setStyle({paddingTop:options.top+'</span>px<span class="literal">'});
	return new In2iGui.Buttons(e,name);
}

In2iGui.Buttons.prototype = {
	add : function(widget) {
		this.element.insert(widget.getElement());
	}
}

/* EOF */In2iGui.Selection = function(id,name,source) {
	this.element = $(id);
	this.name = name;
	this.items = [];
	this.sources = [];
	this.value = null;
	this.selected = [];
	In2iGui.extend(this);
	var self = this;
}

In2iGui.Selection.create = function(name,options) {
	options = N2i.override({width:0},options);
	var e = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_selection<span class="literal">'});
	if (options.width&gt;0) e.setStyle({width:options.width+'</span>px<span class="literal">'});
	return new In2iGui.Selection(e,name,options);
}

In2iGui.Selection.prototype = {
	getValue : function() {
		return this.value;
	},
	getSelection : function() {
		for (var i=0; i &lt; this.items.length; i++) {
			if (this.items[i].value == this.value) {
				return this.items[i];
			}
		};
		for (var i=0; i &lt; this.sources.length; i++) {
			var item = this.sources[i].getSelection();
			if (item) return item;
		};
	},
	changeValue : function(value) {
		this.value = value;
		for (var i=0; i &lt; this.items.length; i++) {
			var item = this.items[i];
			N2i.setClass(item.element,'</span>selected<span class="literal">',(item.value==value));
		};
		for (var i=0; i &lt; this.sources.length; i++) {
			var source = this.sources[i];
			source.updateUI();
		};
		In2iGui.callDelegates(this,'</span>selectorSelectionChanged<span class="literal">');
		In2iGui.callDelegates(this,'</span>selectionChanged<span class="literal">',this.value);
	},
	registerSource : function(source) {
		source.selection = this;
		this.sources.push(source);
	},
	registerItem : function(id,title,icon,badge,value,kind) {
		var element = $id(id);
		element.in2iGuiValue = value;
		this.items.push({id:id,title:title,icon:icon,badge:badge,element:element,value:value,kind:kind});
		var self = this;
		element.onclick = function() {
			self.itemWasClicked(this);
		}
		element.ondblclick = function() {
			self.itemWasDoubleClicked();
			return false;
		}
		element.dropInfo = {kind:kind,controller:this};
		N2i.addClass(element,'</span>droppable<span class="literal">');
		N2i.addListener(element,'</span>mouseover<span class="literal">',In2iGui.dropOverListener);
		N2i.addListener(element,'</span>mouseout<span class="literal">',In2iGui.dropOutListener);
	},
	
	setItems : function(items) {
		var self = this;
		items.each(function(item) {
			self.items.push(item);
			var node = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>item<span class="literal">'});
			node.in2iGuiValue = item.value;
			item.element = node;
			self.element.insert(node);
			if (item.icon) {
				var img = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>icon<span class="literal">'}).setStyle({'</span>backgroundImage<span class="literal">' : '</span>url(<span class="literal">'+In2iGui.getIconUrl(item.icon,1)+'</span>)<span class="literal">'});
				node.insert(img);
			}
			node.insert(item.title);
			node.observe('</span>click<span class="literal">',function() {
				self.itemWasClicked(node);
			});
			node.observe('</span>dblclick<span class="literal">',function() {
				self.itemWasDoubleClicked(node);
				return false;
			});
		});
	},
	
	// Events
	itemWasClicked : function(item) {
		this.changeValue(item.in2iGuiValue);
	},
	itemWasDoubleClicked : function() {
		In2iGui.callDelegates(this,'</span>selectorObjectWasOpened<span class="literal">');
	}
}

/******************************** Source ****************************/

In2iGui.Selection.Source = function(id,name,options) {
	this.element = $id(id);
	this.name = name;
	this.selection = null;
	this.options = options;
	this.items = [];
	In2iGui.enableDelegating(this);
	var self = this;
	N2i.Event.addLoadListener(function() {self.refresh()});
}

In2iGui.Selection.Source.prototype.refresh = function() {
	var self = this;
	$get(this.options.url,{onSuccess:function(t) {self.updateSource(t.responseXML)}});
}

In2iGui.Selection.Source.prototype.updateSource = function(doc) {
	this.items = [];
	N2i.removeChildren(this.element);
	var self = this;
	var items = doc.getElementsByTagName('</span>item<span class="literal">');
	for (var i=0; i &lt; items.length; i++) {
		var item = items[i];
		var node = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>item<span class="literal">'});
		var title = item.getAttribute('</span>title<span class="literal">');
		var badge = item.getAttribute('</span>badge<span class="literal">');
		var icon = item.getAttribute('</span>icon<span class="literal">');
		var value = item.getAttribute('</span>value<span class="literal">');
		var kind = item.getAttribute('</span>kind<span class="literal">');
		if (icon) {
			var img = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>icon<span class="literal">'},{'</span>backgroundImage<span class="literal">' : '</span>url(<span class="literal">'+In2iGui.getIconUrl(icon,1)+'</span>)<span class="literal">'});
			node.appendChild(img);
		}
		node.appendChild(document.createTextNode(title));
		this.element.appendChild(node);
		node.in2iGuiValue = value;
		node.onclick = function() {
			self.itemWasClicked(this);
		}
		node.ondblclick = function() {
			self.itemWasDoubleClicked(this);
			return false;
		}
		var info = {title:title,icon:icon,badge:badge,kind:kind,element:node,value:value};
		node.dragDropInfo = info;
		this.items.push(info);
	};
	this.updateUI();
}

In2iGui.Selection.Source.prototype.itemWasClicked = function(node) {
	this.selection.changeValue(node.in2iGuiValue);
}

In2iGui.Selection.Source.prototype.itemWasDoubleClicked = function(node) {
	this.selection.itemWasDoubleClicked();
}

In2iGui.Selection.Source.prototype.getSelection = function() {
	for (var i=0; i &lt; this.items.length; i++) {
		if (this.items[i].value == this.selection.value) {
			return this.items[i];
		}
	};
	return null;
}

In2iGui.Selection.Source.prototype.updateUI = function() {
	for (var i=0; i &lt; this.items.length; i++) {
		var item = this.items[i];
		N2i.setClass(item.element,'</span>selected<span class="literal">',(item.value==this.selection.value));
	};
}

/* EOF */
/** @constructor */
In2iGui.Toolbar = function(element,name,options) {
	this.element = $id(element);
	this.name = name;
	In2iGui.extend(this);
}

In2iGui.Toolbar.create = function(name,options) {
	var element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_toolbar<span class="literal">'});
	if (options &amp;&amp; options.labels==false) {
		element.addClassName('</span>in2igui_toolbar_nolabels<span class="literal">');
	}
	return new In2iGui.Toolbar(element,name,options);
}

In2iGui.Toolbar.prototype = {
	add : function(widget) {
		this.element.appendChild(widget.getElement());
	},
	addDivider : function() {
		this.element.appendChild(N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_divider<span class="literal">'}));
	}
}



/*************** Revealing **************/

/** @constructor */
In2iGui.RevealingToolbar = function(element,name,options) {
	this.element = $id(element);
	this.name = name;
	In2iGui.extend(this);
}

In2iGui.RevealingToolbar.create = function(name,options) {
	var element = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_revealing_toolbar<span class="literal">'},{'</span>display<span class="literal">':'</span>none<span class="literal">'});
	document.body.appendChild(element);
	var rev = new In2iGui.RevealingToolbar(element,name,options);
	var toolbar = In2iGui.Toolbar.create();
	rev.setToolbar(toolbar);
	return rev;
}

In2iGui.RevealingToolbar.prototype = {
	setToolbar : function(widget) {
		this.toolbar = widget;
		this.element.appendChild(widget.getElement());
	},
	getToolbar : function() {
		return this.toolbar;
	},
	show : function(instantly) {
		this.element.style.display='</span><span class="literal">';
		$ani(this.element,'</span>height<span class="literal">','</span>58px<span class="literal">',instantly ? 0 : 600,{ease:N2i.Animation.slowFastSlow});
	},
	hide : function() {
		$ani(this.element,'</span>height<span class="literal">','</span>0px<span class="literal">',500,{ease:N2i.Animation.slowFastSlow,hideOnComplete:true});
	}
}



/***************** Icon ***************/

/** @constructor */
In2iGui.Toolbar.Icon = function(id,name) {
	this.element = $(id);
	this.name = name;
	this.enabled = !this.element.hasClassName('</span>in2igui_toolbar_icon_disabled<span class="literal">');
	this.icon = this.element.select('</span>.in2igui_icon<span class="literal">')[0];
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.Toolbar.Icon.create = function(name,options) {
	var element = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_toolbar_icon<span class="literal">'});
	var icon = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_icon<span class="literal">'},{'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+In2iGui.getIconUrl(options.icon,2)+'</span>)<span class="literal">'});
	var title = N2i.create('</span>span<span class="literal">');
	title.innerHTML=options.title;
	if (options.overlay) {
		var overlay = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_icon_overlay<span class="literal">'},{'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+In2iGui.getIconUrl('</span>overlay/<span class="literal">'+options.overlay,2)+'</span>)<span class="literal">'});
		icon.appendChild(overlay);
	}
	element.appendChild(icon);
	element.appendChild(title);
	return new In2iGui.Toolbar.Icon(element,name,options);
}

In2iGui.Toolbar.Icon.prototype = {
	/** @private */
	addBehavior : function() {
		var self = this;
		this.element.onclick = function() {
			self.wasClicked();
		}
	},
	/** Sets wether the icon should be enabled */
	setEnabled : function(enabled) {
		this.enabled = enabled;
		N2i.setClass(this.element,'</span>in2igui_toolbar_icon_disabled<span class="literal">',!this.enabled);
	},
	/** @private */
	wasClicked : function() {
		if (this.enabled) {
			In2iGui.callDelegates(this,'</span>toolbarIconWasClicked<span class="literal">');
			In2iGui.callDelegates(this,'</span>click<span class="literal">');
		}
	}
}


/***************** Search field ***************/

In2iGui.Toolbar.SearchField = function(element,name) {
	this.element = $id(element);
	this.name = name;
	this.field = this.element.getElementsByTagName('</span>input<span class="literal">')[0];
	this.value = this.field.value;
	In2iGui.enableDelegating(this);
	this.addBehavior();
}

In2iGui.Toolbar.SearchField.prototype = {
	getValue : function() {
		return this.field.value;
	},
	addBehavior : function() {
		var self = this;
		this.field.onkeyup = function() {
			self.fieldChanged();
		}
		this.field.onfocus = function() {
			$ani(this,'</span>width<span class="literal">','</span>120px<span class="literal">',500,{ease:N2i.Animation.slowFastSlow});
		}
		this.field.onblur = function() {
			$ani(this,'</span>width<span class="literal">','</span>80px<span class="literal">',500,{ease:N2i.Animation.slowFastSlow});
		}
	},
	fieldChanged : function() {
		if (this.field.value!=this.value) {
			this.value=this.field.value;
			In2iGui.callDelegates(this,'</span>valueChanged<span class="literal">');
		}
	}
}


/***************** Badge ***************/

In2iGui.Toolbar.Badge = function(element,name) {
	this.element = $(element);
	this.name = name;
	this.label = this.element.select('</span>strong<span class="literal">')[0];
	this.text = this.element.select('</span>span<span class="literal">')[0];
	In2iGui.enableDelegating(this);
}

In2iGui.Toolbar.Badge.prototype = {
	setLabel : function(str) {
		this.label.update(str);
	},
	setText : function(str) {
		this.text.update(str);
	}
}

/* EOF */In2iGui.ImagePicker = function(id,name,options) {
	this.id = id;
	this.name = name;
	this.options = options || {};
	this.element = $id(id);
	this.images = [];
	this.object = null;
	this.thumbnailsLoaded = false;
	In2iGui.enableDelegating(this);
	this.addBehavior();
}

In2iGui.ImagePicker.prototype = {
	addBehavior : function() {
		var self = this;
		this.element.onclick = function() {
			self.showPicker();
		}
	},
	setObject : function(obj) {
		this.object = obj;
		this.updateUI();
	},
	getObject : function() {
		return this.object;
	},
	reset : function() {
		this.object = null;
		this.updateUI();
	},
	updateUI : function() {
		if (this.object==null) {
			this.element.style.backgroundImage='</span><span class="literal">';
		} else {
			var url = In2iGui.callDelegates(this,'</span>getImageUrl<span class="literal">');
			this.element.style.backgroundImage='</span>url(<span class="literal">'+url+'</span>)<span class="literal">';
		}
	},
	showPicker : function() {
		if (!this.picker) {
			var self = this;
			this.picker = In2iGui.BoundPanel.create();
			this.content = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_imagepicker_thumbs<span class="literal">'});
			var buttons = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_imagepicker_buttons<span class="literal">'});
			var close = In2iGui.Button.create(null,{text:'</span>Luk<span class="literal">',highlighted:true});
			close.addDelegate({
				click:function() {self.hidePicker()}
			});
			var remove = In2iGui.Button.create(null,{text:'</span>Fjern<span class="literal">'});
			remove.addDelegate({
				click:function() {self.setObject(null);self.hidePicker()}
			});
			buttons.appendChild(close.getElement());
			buttons.appendChild(remove.getElement());
			this.picker.add(this.content);
			this.picker.add(buttons);
		}
		this.picker.position(this.element);
		this.picker.show();
		if (!this.thumbnailsLoaded) {
			this.updateImages();
			this.thumbnailsLoaded = true;
		}
	},
	hidePicker : function() {
		this.picker.hide();
	},
	updateImages : function() {
		var self = this;
		var delegate = {
			onXML:function(doc) {
				self.parse(doc);
			}
		};
		$get(this.options.source,delegate);
	},
	parse : function(doc) {
		N2i.removeChildren(this.content);
		var images = doc.getElementsByTagName('</span>image<span class="literal">');
		var self = this;
		for (var i=0; i &lt; images.length &amp;&amp; i&lt;50; i++) {
			var id = images[i].getAttribute('</span>id<span class="literal">');
			var url = '</span>../../../util/images/?id=<span class="literal">'+id+'</span>&amp;maxwidth=48&amp;maxheight=48&amp;format=jpg<span class="literal">';
			var thumb = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_imagepicker_thumbnail<span class="literal">'},{'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+url+'</span>)<span class="literal">'});
			thumb.in2iguiObject = {'</span>id<span class="literal">':id};
			thumb.onclick = function() {
				self.setObject(this.in2iguiObject);
				self.hidePicker();
			}
			this.content.appendChild(thumb);
		};
	}
}

/* EOF */In2iGui.BoundPanel = function(element,name) {
	this.element = $(element);
	this.visible = false;
	this.content=this.element.select('</span>.content<span class="literal">')[0];
	this.arrow=this.element.select('</span>.arrow<span class="literal">')[0];
	In2iGui.extend(this);
}

In2iGui.BoundPanel.create = function(opts) {
	var options = {name:null,top:'</span>0px<span class="literal">',left:'</span>0px<span class="literal">'};
	N2i.override(options,opts);
	var element = N2i.create('</span>div<span class="literal">',
		{'</span>class<span class="literal">':'</span>in2igui_boundpanel<span class="literal">'},
		{'</span>display<span class="literal">':'</span>none<span class="literal">','</span>zIndex<span class="literal">':In2iGui.nextPanelIndex(),'</span>top<span class="literal">':options.top,'</span>left<span class="literal">':options.left}
	);
	
	var html = 
		'</span>&lt;div class=<span class="literal">"arrow"</span>&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"top"</span>&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"body"</span>&gt;&lt;div class=<span class="literal">"body"</span>&gt;&lt;div class=<span class="literal">"body"</span>&gt;&lt;div class=<span class="literal">"content"</span> style=<span class="literal">"';
	if (options.width) {
		html+='width:'+options.width+'px;';
	}
	if (options.padding) {
		html+='padding:'+options.padding+'px;';
	}
	html+='"</span>&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"bottom"</span>&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">';
	element.innerHTML=html;
	document.body.appendChild(element);
	return new In2iGui.BoundPanel(element);
}

/********************************* Public methods ***********************************/

In2iGui.BoundPanel.prototype = {
	show : function() {
		if (!this.visible) {
			if (!N2i.isIE()) {
				N2i.setOpacity(this.element,0);
			}
			if (this.relativePosition=='</span>left<span class="literal">') {
				this.element.style.marginLeft='</span>30px<span class="literal">';
			} else {
				this.element.style.marginLeft='</span>-30px<span class="literal">';
			}
			this.element.setStyle({
				visibility : '</span>hidden<span class="literal">', display : '</span>block<span class="literal">'
			})
			var width = this.element.clientWidth;
			this.element.setStyle({
				width : width+'</span>px<span class="literal">' , visibility : '</span>visible<span class="literal">'
			});
			this.element.style.marginTop='</span>0px<span class="literal">';
			this.element.style.display='</span>block<span class="literal">';
			if (!N2i.isIE()) {
				$ani(this.element,'</span>opacity<span class="literal">',1,400,{ease:N2i.Animation.fastSlow});
			}
			$ani(this.element,'</span>margin-left<span class="literal">','</span>0px<span class="literal">',800,{ease:N2i.Animation.bounce});
		}
		this.element.style.zIndex = In2iGui.nextPanelIndex();
		this.visible=true;
	},
	hide : function() {
		if (N2i.isIE()) {
			this.element.style.display='</span>none<span class="literal">';
		} else {
			$ani(this.element,'</span>opacity<span class="literal">',0,300,{ease:N2i.Animation.slowFast,hideOnComplete:true});
		}
		this.visible=false;
	},
	add : function(obj) {
		if (obj.getElement) {
			this.content.appendChild(obj.getElement());
		} else {
			this.content.appendChild(obj);
		}
	},
	addSpace : function(height) {
		this.add(new Element('</span>div<span class="literal">').setStyle({fontSize:'</span>0px<span class="literal">',height:height+'</span>px<span class="literal">'}));
	},
	getDimensions : function() {
		if (this.element.style.display=='</span>none<span class="literal">') {
			this.element.style.visibility='</span>hidden<span class="literal">';
			this.element.style.display='</span>block<span class="literal">';
			var width = N2i.getWidth(this.element);
			var height = N2i.getHeight(this.element);
			this.element.style.display='</span>none<span class="literal">';
			this.element.style.visibility='</span><span class="literal">';
		} else {
			var width = N2i.getWidth(this.element);
			var height = N2i.getHeight(this.element);
		}
		return {width:width,height:height};
	},
	position : function(node) {
		node = $(node);
		var offset = node.cumulativeOffset();
		var scrollOffset = node.cumulativeScrollOffset();
		var dims = this.getDimensions();
		var winWidth = N2i.Window.getInnerWidth();
		var nodeLeft = offset.left-scrollOffset.left+N2i.Window.getScrollLeft();
		var nodeWidth = N2i.getWidth(node);
		var nodeHeight = N2i.getHeight(node);
		var nodeTop = offset.top-scrollOffset.top+N2i.Window.getScrollTop();
		if ((nodeLeft+nodeWidth/2)/winWidth&lt;.5) {
			this.relativePosition='</span>left<span class="literal">';
			var left = nodeLeft+nodeWidth+10;
			this.arrow.className='</span>arrow arrow_left<span class="literal">';
			var arrowLeft=-14;
		} else {
			this.relativePosition='</span>right<span class="literal">';
			var left = nodeLeft-dims.width-10;
			this.arrow.className='</span>arrow arrow_right<span class="literal">';
			var arrowLeft=dims.width-4;
		}
		var top = Math.max(0,nodeTop+(nodeHeight-dims.height)/2);
		this.arrow.style.marginTop = (dims.height-32)/2+Math.min(0,nodeTop+(nodeHeight-dims.height)/2)+'</span>px<span class="literal">';
		this.arrow.style.marginLeft = arrowLeft+'</span>px<span class="literal">';
		if (this.visible) {
			$ani(this.element,'</span>top<span class="literal">',top+'</span>px<span class="literal">',500,{ease:N2i.Animation.fastSlow});
			$ani(this.element,'</span>left<span class="literal">',left+'</span>px<span class="literal">',500,{ease:N2i.Animation.fastSlow});
		} else {
			this.element.style.top=top+'</span>px<span class="literal">';
			this.element.style.left=left+'</span>px<span class="literal">';
		}
	}
}

/* EOF */In2iGui.Panel = function(element,name) {
	this.element = $(element);
	this.titlebar = $class('</span>titlebar<span class="literal">',this.element)[0];
	this.content=$class('</span>content<span class="literal">',this.element)[0];
	this.close = $class('</span>close<span class="literal">',this.element)[0];
	In2iGui.enableDelegating(this);
	this.addBehavior();
}

In2iGui.Panel.create = function(opts) {
	var options = {name:null,title:'</span>Panel<span class="literal">'};
	N2i.override(options,opts);
	var element = N2i.create('</span>div<span class="literal">',
		{'</span>class<span class="literal">':'</span>in2igui_panel<span class="literal">'},
		{'</span>display<span class="literal">':'</span>none<span class="literal">','</span>top<span class="literal">':'</span>100px<span class="literal">','</span>left<span class="literal">':'</span>100px<span class="literal">'}
	);
	
	var html = '</span>&lt;div class=<span class="literal">"titlebar"</span>&gt;&lt;div&gt;&lt;div&gt;<span class="literal">'+
			'</span>&lt;div class=<span class="literal">"close"</span>&gt;&lt;/div&gt;&lt;strong&gt;<span class="literal">'+options.title+'</span>&lt;/strong&gt;<span class="literal">'+
		'</span>&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"body"</span>&gt;&lt;div class=<span class="literal">"body"</span>&gt;&lt;div class=<span class="literal">"body"</span>&gt;&lt;div class=<span class="literal">"content"</span><span class="literal">'+
		(options.padding ? '</span> style=<span class="literal">"padding: '+options.padding+'px; padding-bottom: 0px;"</span><span class="literal">' : '</span><span class="literal">')+
		'</span>&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
		'</span>&lt;div class=<span class="literal">"bottom"</span>&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">';
	element.innerHTML=html;
	document.body.appendChild(element);
	return new In2iGui.Panel(element);
}

In2iGui.Panel.prototype = {
	addBehavior : function() {
		var self = this;
		this.titlebar.onmousedown = function(e) {self.startDrag(e);return false;};
		var close = $class('</span>close<span class="literal">',this.titlebar)[0];
		close.onclick = function() {self.hide()};
	},
	show : function() {
		this.element.setStyle({
			zIndex : In2iGui.nextPanelIndex(), visibility : '</span>hidden<span class="literal">', display : '</span>block<span class="literal">'
		})
		var width = this.element.clientWidth;
		this.element.setStyle({
			width : width+'</span>px<span class="literal">' , visibility : '</span>visible<span class="literal">'
		});
	},
	hide : function() {
		this.element.style.display='</span>none<span class="literal">';
	},
	add : function(widget) {
		this.content.appendChild(widget.getElement());
	},
	addContent : function(node) {
		this.content.appendChild(node);
	},
	startDrag : function(e) {
		this.element.style.zIndex=In2iGui.nextPanelIndex();
		var event = new N2i.Event(e);
		this.dragState = {left:event.mouseLeft()-N2i.Element.getLeft(this.element),top:event.mouseTop()-N2i.Element.getTop(this.element)};
		var self = this;
		this.moveListener = function(e) {self.drag(e)};
		this.upListener = function(e) {self.endDrag(e)};
		N2i.Event.addListener(document,'</span>mousemove<span class="literal">',this.moveListener);
		N2i.Event.addListener(document,'</span>mouseup<span class="literal">',this.upListener);
		N2i.Event.stop(e);
		document.body.onselectstart = function () { return false; };
		return false;
	},

	drag : function(e) {
		var event = new N2i.Event(e);
		this.element.style.right = '</span>auto<span class="literal">';
		this.element.style.top = (event.mouseTop()-this.dragState.top)+'</span>px<span class="literal">';
		this.element.style.left = (event.mouseLeft()-this.dragState.left)+'</span>px<span class="literal">';
		return false;
	},

	endDrag : function() {
		N2i.Event.removeListener(document,'</span>mousemove<span class="literal">',this.moveListener);
		N2i.Event.removeListener(document,'</span>mouseup<span class="literal">',this.upListener);
		document.body.onselectstart = null;
	}
}

/* EOF */
In2iGui.RichText = function(id,name,opts) {
	this.element = $id(id);
	this.options = {debug:false,value:'</span><span class="literal">',autoHideToolbar:true};
	N2i.override(this.options,opts);
	this.iframe = this.element.getElementsByTagName('</span>iframe<span class="literal">')[0];
	this.toolbar = $firstClass('</span>in2igui_richtext_toolbar<span class="literal">',this.element);
	this.toolbarContent = $firstClass('</span>in2igui_richtext_toolbar_content<span class="literal">',this.element);
	this.value = this.options.value;
	this.document;
	this.buildToolbar();
	this.ignite();
	In2iGui.extend(this);
}

In2iGui.RichText.actions = [
	{key:'</span>bold<span class="literal">',				cmd:'</span>bold<span class="literal">',				value:null,		icon:'</span>edit/text_bold<span class="literal">'},
	{key:'</span>italic<span class="literal">',				cmd:'</span>italic<span class="literal">',			value:null,		icon:'</span>edit/text_italic<span class="literal">'},
	{key:'</span>underline<span class="literal">',			cmd:'</span>underline<span class="literal">',		value:null,		icon:'</span>edit/text_underline<span class="literal">'},
	null,
	{key:'</span>justifyleft<span class="literal">',			cmd:'</span>justifyleft<span class="literal">',		value:null,		icon:'</span>edit/text_align_left<span class="literal">'},
	{key:'</span>justifycenter<span class="literal">',		cmd:'</span>justifycenter<span class="literal">',	value:null,		icon:'</span>edit/text_align_center<span class="literal">'},
	{key:'</span>justifyright<span class="literal">',		cmd:'</span>justifyright<span class="literal">',		value:null,		icon:'</span>edit/text_align_right<span class="literal">'},
	null,
	{key:'</span>increasefontsize<span class="literal">',	cmd:'</span>increasefontsize<span class="literal">',	value:null,		icon:'</span>edit/increase_font_size<span class="literal">'},
	{key:'</span>decreasefontsize<span class="literal">',	cmd:'</span>decreasefontsize<span class="literal">',	value:null,		icon:'</span>edit/decrease_font_size<span class="literal">'},
	{key:'</span>color<span class="literal">',				cmd:null,				value:null,		icon:'</span>common/color<span class="literal">'}
	/*,
	null,
	{key:'</span>p<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>p<span class="literal">'},
	{key:'</span>h1<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h1<span class="literal">'},
	{key:'</span>h2<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h2<span class="literal">'},
	{key:'</span>h3<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h3<span class="literal">'},
	{key:'</span>h4<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h4<span class="literal">'},
	{key:'</span>h5<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h5<span class="literal">'},
	{key:'</span>h6<span class="literal">',				cmd:'</span>formatblock<span class="literal">',		value:'</span>h6<span class="literal">'},
	{key:'</span>removeformat<span class="literal">', 	cmd:'</span>removeformat<span class="literal">', 	'</span>value<span class="literal">':null}*/
];

In2iGui.RichText.replaceInput = function(options) {
	var input = $id(options.input);
	input.style.display='</span>none<span class="literal">';
	options.value = input.value;
	var obj = In2iGui.RichText.create(options);
	input.parentNode.insertBefore(obj.element,input);
	obj.ignite();
}

In2iGui.RichText.create = function(name,options) {
	var base = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_richtext<span class="literal">'});
	var toolbar = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_richtext_toolbar<span class="literal">'});
	base.appendChild(toolbar);
	var iframe = N2i.create('</span>iframe<span class="literal">',{frameborder:0});
	base.appendChild(iframe);
	toolbar.innerHTML='</span>&lt;div class=<span class="literal">"in2igui_richtext_inner_toolbar"</span>&gt;&lt;div class=<span class="literal">"in2igui_richtext_toolbar_content"</span>&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">';
	return new In2iGui.RichText(base,name,options);
}

In2iGui.RichText.prototype = {
	ignite : function() {
		this.setupIframe();
	},
	isCompatible : function() {
	    var agt=navigator.userAgent.toLowerCase();
		return true;
		return (agt.indexOf('</span>msie 6<span class="literal">')&gt;-1 || agt.indexOf('</span>msie 7<span class="literal">')&gt;-1 || (agt.indexOf('</span>gecko<span class="literal">')&gt;-1 &amp;&amp; agt.indexOf('</span>safari<span class="literal">')&lt;0));
	},
	setupIframe : function() {
		var self = this;
		if (!this.iframe.contentWindow) return;
		this.window = this.iframe.contentWindow;
		this.document = this.iframe.contentDocument || this.window.document;
		this.document.designMode='</span>on<span class="literal">';
		
		this.document.open();
		this.document.write('</span>&lt;html&gt;&lt;head&gt;&lt;style&gt;body{margin:0px}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;<span class="literal">'+this.value+'</span>&lt;/body&gt;&lt;/html&gt;<span class="literal">');
		this.document.close();
		
		this.document.body.style.minHeight='</span>100%<span class="literal">';
		this.document.documentElement.style.cursor='</span>text<span class="literal">';
		this.document.documentElement.style.minHeight='</span>100%<span class="literal">';
		
		this.window.onkeypress=function() {self.documentChanged()};
		
		N2i.Event.addListener(this.window,'</span>focus<span class="literal">',function() {self.documentFocused()});
		N2i.Event.addListener(this.window,'</span>blur<span class="literal">',function() {self.documentBlurred()});
		N2i.Event.addListener(this.window,'</span>keyup<span class="literal">',function() {self.documentChanged()});
	},
	setHeight : function(height) {
		this.iframe.style.height=height+'</span>px<span class="literal">';
	},
	focus : function() {
		try { // TODO : May only work in gecko
			var r = this.document.createRange();
			r.selectNodeContents(this.document.body);
			this.window.getSelection().addRange(r);
		} catch (ignore) {}
		this.window.focus();
	},
	setValue : function(value) {
		this.value = value;
		this.document.body.innerHTML = value;
	},
	getValue : function() {
		return this.value;
	},
	deactivate : function() {
		if (this.colorPicker) this.colorPicker.hide();
	},
	
	buildToolbar : function() {
		var self = this;
		var actions = In2iGui.RichText.actions;
		for (var i=0; i &lt; actions.length; i++) {
			if (actions[i]==null) {
				this.toolbarContent.appendChild(N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_richtext_divider<span class="literal">'}));
			} else {
				var div = new Element('</span>div<span class="literal">').addClassName('</span>action action_<span class="literal">'+actions[i].key);
				div.title=actions[i].key;
				div.in2iguiRichTextAction = actions[i];
				div.onclick = div.ondblclick = function(e) {return self.actionWasClicked(this.in2iguiRichTextAction,e);}
				var img = new Element('</span>img<span class="literal">');
				img.src=In2iGui.context+'</span>/In2iGui/gfx/trans.png<span class="literal">';
				if (actions[i].icon) {
					div.setStyle({'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+In2iGui.getIconUrl(actions[i].icon,1)+'</span>)<span class="literal">'});
				}
				div.insert(img);
				this.toolbarContent.appendChild(div);
				div.onmousedown = In2iGui.RichText.stopEvent;
			}
		};
	},
	
	documentFocused : function() {
		if (N2i.isIE()) {
			this.toolbar.style.display='</span>block<span class="literal">';
			return;
		}
		if (this.toolbar.style.display!='</span>block<span class="literal">') {
			this.toolbar.style.marginTop='</span>-40px<span class="literal">';
			N2i.setOpacity(this.toolbar,0);
			this.toolbar.style.display='</span>block<span class="literal">';
			$ani(this.toolbar,'</span>opacity<span class="literal">',1,300);
			$ani(this.toolbar,'</span>margin-top<span class="literal">','</span>-32px<span class="literal">',300);
		}
	},
	
	documentBlurred : function() {
		if (this.options.autoHideToolbar) {
			if (N2i.isIE()) {
				var self = this;
				window.setTimeout(function() {
					self.toolbar.style.display='</span>none<span class="literal">';
				},100);
				return;
			}
			$ani(this.toolbar,'</span>opacity<span class="literal">',0,300,{hideOnComplete:true});
			$ani(this.toolbar,'</span>margin-top<span class="literal">','</span>-40px<span class="literal">',300);
		}
		this.documentChanged();
		In2iGui.callDelegates(this,'</span>richTextDidChange<span class="literal">');
	},
	
	documentChanged : function() {
		this.value = this.document.body.innerHTML;
		if (this.options.input) {
			$id(this.options.input).value=this.value;
		}
	},
	
	disabler : function(e) {
		var evt = e ? e : window.event; 
		//if (evt.stopPropagation) {
		//	evt.stopPropagation();
		//}
		if (evt.returnValue) {
			evt.returnValue = false;
		} else if (evt.preventDefault) {
			evt.preventDefault( );
		}
		return false;
	},
	actionWasClicked : function(action,e) {
		In2iGui.RichText.stopEvent(e);
		if (action.key=='</span>color<span class="literal">') {
			this.showColorPicker();
		} else {
			this.execCommand(action);
		}
		this.document.body.focus();
		this.documentChanged();
		return false;
	},
	execCommand : function(action) {
		this.document.execCommand(action.cmd,false,action.value);
		this.documentChanged();
	},
	showColorPicker : function() {
		if (!this.colorPicker) {
			var panel = In2iGui.Window.create(null,{variant:'</span>dark<span class="literal">'});
			var picker = In2iGui.ColorPicker.create();
			picker.addDelegate(this);
			panel.add(picker);
			panel.show();
			this.colorPicker = panel;
		}
		this.colorPicker.show();
	},
	colorWasHovered : function(color) {
		//this.document.execCommand('</span>forecolor<span class="literal">',false,color);
	},
	colorWasSelected : function(color) {
		this.document.execCommand('</span>forecolor<span class="literal">',false,color);
		this.documentChanged();
	}
}



In2iGui.RichText.stopEvent = function(e) {
  var evt = e ? e : window.event; 
  if (evt.returnValue) {
    evt.returnValue = false;
  } else if (evt.preventDefault) {
    evt.preventDefault( );
  } else {
    return false;
  }
}

/* EOF */In2iGui.ImageViewer = function(element,name,options) {
	this.options = {maxWidth:800,maxHeight:600};
	N2i.override(this.options,options);
	this.element = $id(element);
	this.viewer = $firstClass('</span>in2igui_imageviewer_viewer<span class="literal">',this.element);
	this.innerViewer = $firstClass('</span>in2igui_imageviewer_inner_viewer<span class="literal">',this.element);
	this.status = $firstClass('</span>in2igui_imageviewer_status<span class="literal">',this.element);
	this.previousControl = $firstClass('</span>in2igui_imageviewer_previous<span class="literal">',this.element);
	this.controller = $firstClass('</span>in2igui_imageviewer_controller<span class="literal">',this.element);
	this.nextControl = $firstClass('</span>in2igui_imageviewer_next<span class="literal">',this.element);
	this.playControl = $firstClass('</span>in2igui_imageviewer_play<span class="literal">',this.element);
	this.dirty = false;
	this.width = 600;
	this.height = 460;
	this.index = 0;
	this.playing=false;
	this.name = name;
	this.images = [];
	this.addBehavior();
	In2iGui.enableDelegating(this);
}

In2iGui.ImageViewer.create = function(name,opts) {
	var options = {name:null,top:'</span>0px<span class="literal">',left:'</span>0px<span class="literal">'};
	N2i.override(options,opts);
	var element = N2i.create('</span>div<span class="literal">',
		{'</span>class<span class="literal">':'</span>in2igui_imageviewer<span class="literal">'},
		{'</span>display<span class="literal">':'</span>none<span class="literal">'}
	);
	element.innerHTML = '</span>&lt;div class=<span class="literal">"in2igui_imageviewer_viewer"</span>&gt;&lt;div class=<span class="literal">"in2igui_imageviewer_inner_viewer"</span>&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
	'</span>&lt;div class=<span class="literal">"in2igui_imageviewer_status"</span>&gt;&lt;/div&gt;<span class="literal">'+
	'</span>&lt;div class=<span class="literal">"in2igui_imageviewer_controller"</span>&gt;<span class="literal">'+
	'</span>&lt;a class=<span class="literal">"in2igui_imageviewer_previous"</span>&gt;&lt;/a&gt;<span class="literal">'+
	'</span>&lt;a class=<span class="literal">"in2igui_imageviewer_play"</span>&gt;&lt;/a&gt;<span class="literal">'+
	'</span>&lt;a class=<span class="literal">"in2igui_imageviewer_next"</span>&gt;&lt;/a&gt;<span class="literal">'+
	'</span>&lt;/div&gt;<span class="literal">';
	document.body.appendChild(element);
	return new In2iGui.ImageViewer(element,name,options);
}

In2iGui.ImageViewer.prototype = {
	addBehavior : function() {
		var self = this;
		this.nextControl.onclick = function() {
			self.next(true);
		}
		this.previousControl.onclick = function() {
			self.previous(true);
		}
		this.playControl.onclick = function() {
			self.playOrPause();
		}
		this.viewer.onclick = function() {
			self.hide();
		}
		this.timer = function() {
			self.next(false);
		}
		this.keyListener = function(e) {
			var event = new N2i.Event(e);
			if (event.isRightKey()) {
				self.next(true);
			} else if (event.isLeftKey()) {
				self.previous(true);
			} else if (event.isEscapeKey()) {
				self.hide();
			} else if (event.isReturnKey()) {
				self.playOrPause();
			}
		}
	},
	getLargestSize : function(canvas,image) {
		if (image.width&lt;=canvas.width &amp;&amp; image.height&lt;=canvas.height) {
			return {width:image.width,height:image.height};
		} else if (canvas.width/canvas.height&gt;image.width/image.height) {
			return {width:canvas.height/image.height*image.width,height:canvas.height};
		} else if (canvas.width/canvas.height&lt;image.width/image.height) {
			return {width:canvas.width,height:canvas.width/image.width*image.height};
		} else {
			return {width:canvas.width,height:canvas.height};
		}
	},	
	calculateSize : function() {
		var newWidth = N2i.Window.getInnerWidth()-100;
		newWidth = Math.floor(newWidth/100)*100;
		newWidth = Math.min(newWidth,this.options.maxWidth);
		var newHeight = N2i.Window.getInnerHeight()-100;
		newHeight = Math.floor(newHeight/100)*100;
		newHeight = Math.min(newHeight,this.options.maxHeight);
		var maxWidth = 0;
		var maxHeight = 0;
		for (var i=0; i &lt; this.images.length; i++) {
			N2i.log('</span>********************<span class="literal">');
			N2i.log({width:newWidth,height:newHeight});
			N2i.log(this.images[i]);
			var dims = this.getLargestSize({width:newWidth,height:newHeight},this.images[i]);
			maxWidth = Math.max(maxWidth,dims.width);
			maxHeight = Math.max(maxHeight,dims.height);
			N2i.log(dims);
		};
		newHeight = Math.round(Math.min(newHeight,maxHeight));
		newWidth = Math.round(Math.min(newWidth,maxWidth));
		/*
		
			alert(min);
			alert(newWidth/newHeight);
		if (newHeight&gt;max) {
			newWidth = newHeight*max;
		}
		if (newWidth/newHeight&gt;min) {
			newHeight = newWidth/min;
		}
		*/
		if (newWidth!=this.width || newHeight!=this.height) {
			this.width = newWidth;
			this.height = newHeight;
			this.dirty = true;
		}
	},
	showById: function(id) {
		for (var i=0; i &lt; this.images.length; i++) {
			if (this.images[i].id==id) {
				this.show(i);
				break;
			}
		};
	},
	show: function(index) {
		this.index = index || 0;
		this.calculateSize();
		this.updateUI();
		var curtainIndex = In2iGui.nextPanelIndex();
		this.element.style.zIndex=In2iGui.nextPanelIndex();
		this.element.style.width=(this.width+10)+'</span>px<span class="literal">';
		this.element.style.height=(this.height+50)+'</span>px<span class="literal">';
		this.element.style.marginLeft='</span>-<span class="literal">'+Math.round((this.width+10)/2)+'</span>px<span class="literal">';
		this.element.style.top=Math.round((N2i.Window.getInnerHeight()-(this.height+50))/2)+N2i.Window.getScrollTop()+'</span>px<span class="literal">';
		this.viewer.style.width=(this.width+10)+'</span>px<span class="literal">';
		this.viewer.style.height=this.height+'</span>px<span class="literal">';
		this.innerViewer.style.width=((this.width+10)*this.images.length)+'</span>px<span class="literal">';
		this.innerViewer.style.height=this.height+'</span>px<span class="literal">';
		this.controller.style.marginLeft=((this.width-115)/2+5)+'</span>px<span class="literal">';
		this.element.style.display='</span>block<span class="literal">';
		this.goToImage(false,0,false);
		In2iGui.showCurtain(this,curtainIndex);
		N2i.addListener(document,'</span>keydown<span class="literal">',this.keyListener);
	},
	hide: function(index) {
		this.pause();
		In2iGui.hideCurtain(this);
		this.element.style.display='</span>none<span class="literal">';
		N2i.removeListener(document,'</span>keydown<span class="literal">',this.keyListener);
	},
	curtainWasClicked : function() {
		this.hide();
	},
	updateUI : function() {
		if (this.dirty) {
			this.innerViewer.innerHTML='</span><span class="literal">';
			for (var i=0; i &lt; this.images.length; i++) {
				var url = this.resolveImageUrl(this.images[i]);
				url = url.replace(/&amp;amp;/,'</span>&amp;<span class="literal">');
				var element = N2i.create('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_imageviewer_image<span class="literal">'},{'</span>width<span class="literal">':(this.width+10)+'</span>px<span class="literal">','</span>height<span class="literal">':this.height+'</span>px<span class="literal">'});
				
				var url = this.resolveImageUrl(this.images[i]);
				url = url.replace(/&amp;amp;/g,'</span>&amp;<span class="literal">');
				//element.style.backgroundImage="url('</span><span class="literal">"+url+"</span><span class="literal">')";
				this.innerViewer.appendChild(element);
			};
			this.dirty = false;
			this.preload();
		}
	},
	goToImage : function(animate,num,user) {	
		if (animate) {
			if (num&gt;1) {
				$ani(this.viewer,'</span>scrollLeft<span class="literal">',this.index*(this.width+10),Math.min(num*300,2000),{ease:N2i.Animation.slowFastSlow});				
			} else {
				var end = this.index==0 || this.index==this.images.length-1;
				var ease = (user ? (end ? N2i.Animation.bounce : N2i.Animation.elastic) : N2i.ease.backInOut);
				$ani(this.viewer,'</span>scrollLeft<span class="literal">',this.index*(this.width+10),(end ? 800 : 1200),{ease:ease});
			}
		} else {
			this.viewer.scrollLeft=this.index*(this.width+10);
		}
	},
	clearImages : function() {
		this.images = [];
		this.dirty = true;
	},
	addImages : function(images) {
		for (var i=0; i &lt; images.length; i++) {
			this.addImage(images[i]);
		};
	},
	addImage : function(img) {
		this.images.push(img);
		this.dirty = true;
	},
	resolveImageUrl : function(img) {
		for (var i=0; i &lt; this.delegates.length; i++) {
			if (this.delegates[i].resolveImageUrl) {
				return this.delegates[i].resolveImageUrl(img,this.width,this.height);
			}
		};
		return null;
	},
	play : function() {
		if (!this.interval) {
			this.interval = window.setInterval(this.timer,6000);
		}
		this.next(false);
		this.playing=true;
		this.playControl.className='</span>in2igui_imageviewer_pause<span class="literal">';
	},
	pause : function() {
		window.clearInterval(this.interval);
		this.interval = null;
		this.playControl.className='</span>in2igui_imageviewer_play<span class="literal">';
		this.playing = false;
	},
	playOrPause : function() {
		if (this.playing) {
			this.pause();
		} else {
			this.play();
		}
	},
	resetPlay : function() {
		if (this.playing) {
			window.clearInterval(this.interval);
			this.interval = window.setInterval(this.timer,6000);
		}
	},
	previous : function(user) {
		var num = 1;
		this.index--;
		if (this.index&lt;0) {
			this.index=this.images.length-1;
			num = this.images.length-1;
		}
		this.goToImage(true,num,user);
		this.resetPlay();
	},
	next : function(user) {
		var num = 1;
		this.index++;
		if (this.index==this.images.length) {
			this.index=0;
			num = this.images.length-1;
		}
		this.goToImage(true,num,user);
		this.resetPlay();
	},
	preload : function() {
		var guiLoader = new N2i.Preloader();
		guiLoader.addImages(In2iGui.context+'</span>In2iGui/gfx/imageviewer_controls.png<span class="literal">');
		var self = this;
		guiLoader.setDelegate({allImagesDidLoad:function() {self.preloadImages()}});
		guiLoader.load();
	},
	preloadImages : function() {
		this.loader = new N2i.Preloader();
		this.loader.setDelegate(this);
		for (var i=0; i &lt; this.images.length; i++) {
			this.loader.addImages(this.resolveImageUrl(this.images[i]));
		};
		this.status.innerHTML = '</span>0%<span class="literal">';
		this.status.style.display='</span><span class="literal">';
		this.loader.load();
	},
	allImagesDidLoad : function() {
		this.status.style.display='</span>none<span class="literal">';
	},
	imageDidLoad : function(loaded,total,index) {
		this.status.innerHTML = Math.round(loaded/total*100)+'</span>%<span class="literal">';
		var url = this.resolveImageUrl(this.images[index]);
		url = url.replace(/&amp;amp;/g,'</span>&amp;<span class="literal">');
		this.innerViewer.childNodes[index].style.backgroundImage="url('</span><span class="literal">"+url+"</span><span class="literal">')";
		N2i.setClass(this.innerViewer.childNodes[index],'</span>in2igui_imageviewer_image_abort<span class="literal">',false);
		N2i.setClass(this.innerViewer.childNodes[index],'</span>in2igui_imageviewer_image_error<span class="literal">',false);
	},
	imageDidGiveError : function(loaded,total,index) {
		N2i.setClass(this.innerViewer.childNodes[index],'</span>in2igui_imageviewer_image_error<span class="literal">',true);
	},
	imageDidAbort : function(loaded,total,index) {
		N2i.setClass(this.innerViewer.childNodes[index],'</span>in2igui_imageviewer_image_abort<span class="literal">',true);
	}
}

/* EOF */
In2iGui.Picker = function(element,name,options) {
	this.options = N2i.override({itemWidth:100,itemHeight:150},options);
	this.element = $id(element);
	this.name = name;
	this.container = $firstClass('</span>in2igui_picker_container<span class="literal">',this.element);
	this.title = $firstClass('</span>in2igui_picker_title<span class="literal">',this.element);
	this.objects = [];
	this.selected = null;
	In2iGui.extend(this);
}

In2iGui.Picker.create = function(name,options) {
	options = N2i.override({shadow:true},options);
	var element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_picker<span class="literal">'});
	element.update('</span>&lt;div class=<span class="literal">"in2igui_picker_top"</span>&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
	'</span>&lt;div class=<span class="literal">"in2igui_picker_middle"</span>&gt;&lt;div class=<span class="literal">"in2igui_picker_middle"</span>&gt;<span class="literal">'+
	(options.title ? '</span>&lt;div class=<span class="literal">"in2igui_picker_title"</span>&gt;<span class="literal">'+options.title+'</span>&lt;/div&gt;<span class="literal">' : '</span><span class="literal">')+
	'</span>&lt;div class=<span class="literal">"in2igui_picker_container"</span>&gt;&lt;/div&gt;<span class="literal">'+
	'</span>&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
	'</span>&lt;div class=<span class="literal">"in2igui_picker_bottom"</span>&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">');
	if (options.shadow==true) {
		element.addClassName('</span>in2igui_picker_shadow<span class="literal">')
	}
	return new In2iGui.Picker(element,name,options);
}

In2iGui.Picker.prototype = {
	setObjects : function(objects) {
		this.objects = objects;
		this.updateUI();
	},
	getSelection : function() {
		return this.selected==null ? null : this.objects[this.selected];
	},
	reset : function() {
		this.selected = null;
		this.updateSelection();
	},
	updateUI : function() {
		this.container.style.width=(this.objects.length*(this.options.itemWidth+14))+'</span>px<span class="literal">';
		this.container.style.height=(this.options.itemHeight+10)+'</span>px<span class="literal">';
		for (var i=0; i &lt; this.objects.length; i++) {
			var item = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_picker_item<span class="literal">'});
			item.update(
				'</span>&lt;div class=<span class="literal">"in2igui_picker_item_middle"</span>&gt;&lt;div class=<span class="literal">"in2igui_picker_item_middle"</span>&gt;<span class="literal">'+
				'</span>&lt;div style=<span class="literal">"width:'+this.options.itemWidth+'px;height:'+this.options.itemHeight+'px;background-image:url(\''+this.objects[i].image+'\')"</span>&gt;&lt;/div&gt;<span class="literal">'+
				'</span>&lt;/div&gt;&lt;/div&gt;<span class="literal">'+
				'</span>&lt;div class=<span class="literal">"in2igui_picker_item_bottom"</span>&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">'
			);
			item.in2iguiIndex = i;
			var self = this;
			item.onclick = function() {self.selectionChanged(this.in2iguiIndex)};
			this.container.appendChild(item);
		};
	},
	updateSelection : function() {
		var children = this.container.childNodes;
		for (var i=0; i &lt; children.length; i++) {
			N2i.setClass(children[i],'</span>in2igui_picker_item_selected<span class="literal">',i==this.selected);
		};
	},
	selectionChanged : function(index) {
		this.selected = index;
		this.updateSelection();
		In2iGui.callDelegates(this,'</span>selectionChanged<span class="literal">');
	}
}

/* EOF */
In2iGui.Editor = function(element,name,options) {
	this.name = '</span>In2iGuiEditor<span class="literal">';
	this.parts = [];
	this.rows = [];
	this.partControllers = [];
	this.activePart = null;
	this.active = false;
	this.dragProxy = null;
}

In2iGui.Editor.get = function() {
	if (!In2iGui.Editor.instance) {
		In2iGui.Editor.instance = new In2iGui.Editor();
	}
	return In2iGui.Editor.instance;
}

In2iGui.Editor.prototype = {
	ignite : function(options) {
		this.reload();
	},
	addPartController : function(key,title,controller) {
		this.partControllers.push({key:key,'</span>title<span class="literal">':title,'</span>controller<span class="literal">':controller});
	},
	getPartController : function(key) {
		var ctrl = null;
		this.partControllers.each(function(item) {
			if (item.key==key) ctrl=item;
		});
		return ctrl;
	},
	reload : function() {
		if (this.partControls) {
			this.partControls.hide();
		}
		var self = this;
		this.parts = [];
		var rows = $$('</span>.row<span class="literal">');
		rows.each(function(row,i) {
			var columns = row.select('</span>.column<span class="literal">');
			self.reloadColumns(columns,i);
			columns.each(function(column,j) {
				var parts = column.select('</span>.part<span class="literal">');
				self.reloadParts(parts,i,j);
			});
		});
		var parts = $$('</span>.part<span class="literal">');
		this.parts.each(function(part) {
			var i = parts.indexOf(part.element);
			if (i!=-1) delete(parts[i]);
		});
		this.reloadParts(parts,-1,-1);
	},
	partExists : function(element) {
		
	},
	reloadColumns : function(columns,rowIndex) {
		var self = this;
		columns.each(function(column,columnIndex) {
			column.observe('</span>mouseover<span class="literal">',function() {
				self.hoverColumn(column);
			});
			column.observe('</span>mouseout<span class="literal">',function() {
				self.blurColumn();
			});
			column.observe('</span>contextmenu<span class="literal">',function(e) {
				self.contextColumn(column,rowIndex,columnIndex,e);
			});
		});
	},
	reloadParts : function(parts,row,column) {
		var self = this;
		parts.each(function(element,partIndex) {
			if (!element) return;
			var match = element.className.match(/part_([\w]+)/i);
			if (match &amp;&amp; match[1]) {
				var handler = self.getPartController(match[1]);
				if (handler) {
					var part = new handler.controller(element,row,column,partIndex);
					part.type=match[1];
					element.observe('</span>click<span class="literal">',function() {
						//self.editPart(part);
					});
					element.observe('</span>mouseover<span class="literal">',function(e) {
						self.hoverPart(part);
					});
					element.observe('</span>mouseout<span class="literal">',function(e) {
						self.blurPart(e);
					});
					element.observe('</span>mousedown<span class="literal">',function(e) {
						self.startPartDrag(e);
					});
					self.parts.push(part);
				}
			}
		});
	},
	activate : function() {
		this.active = true;
	},
	deactivate : function() {
		this.active = false;
		if (this.activePart) {
			this.activePart.deactivate();
		}
		if (this.partControls) this.partControls.hide();
	},
	
	
	///////////////////////// Columns ////////////////////////
	
	hoverColumn : function(column) {
		this.hoveredColumn = column;
		if (!this.active || this.activePart) return;
		column.addClassName('</span>in2igui_editor_column_hover<span class="literal">');
	},
	
	blurColumn : function() {
		if (!this.active || !this.hoveredColumn) return;
		this.hoveredColumn.removeClassName('</span>in2igui_editor_column_hover<span class="literal">');
	},
	
	contextColumn : function(column,rowIndex,columnIndex,e) {
		if (!this.columnMenu) {
			var menu = In2iGui.Menu.create('</span>In2iGuiEditorColumnMenu<span class="literal">');
			menu.addItem('</span>Slet kolonne<span class="literal">','</span>removeColumn<span class="literal">');
			menu.addItem('</span>Tilfj kolonne<span class="literal">','</span>addColumn<span class="literal">');
			this.partControllers.each(function(item) {
				menu.addItem(item.title,item.key);
			});
			this.columnMenu = menu;
			menu.addDelegate(this);
		}
		this.hoveredRow=rowIndex;
		this.hoveredColumnIndex=columnIndex;
		this.columnMenu.showAtPointer(e);
	},
	itemWasClicked$In2iGuiEditorColumnMenu : function(value) {
		if (value=='</span>removeColumn<span class="literal">') {
			In2iGui.callDelegates(this,'</span>removeColumn<span class="literal">',{'</span>row<span class="literal">':this.hoveredRow,'</span>column<span class="literal">':this.hoveredColumnIndex});
		} else if (value=='</span>addColumn<span class="literal">') {
			In2iGui.callDelegates(this,'</span>addColumn<span class="literal">',{'</span>row<span class="literal">':this.hoveredRow,'</span>position<span class="literal">':this.hoveredColumnIndex+1});
		} else {
			In2iGui.callDelegates(this,'</span>addPart<span class="literal">',{'</span>row<span class="literal">':this.hoveredRow,'</span>column<span class="literal">':this.hoveredColumnIndex,'</span>position<span class="literal">':0,type:value});
		}
	},
	
	
	///////////////////////// Parts //////////////////////////
	
	hoverPart : function(part,event) {
		if (!this.active || this.activePart) return;
		this.hoveredPart = part;
		part.element.addClassName('</span>in2igui_editor_part_hover<span class="literal">');
		var self = this;
		this.partControlTimer = window.setTimeout(function() {self.showPartControls()},200);
	},
	blurPart : function(e) {
		window.clearTimeout(this.partControlTimer);
		if (!this.active) return;
		if (this.partControls &amp;&amp; !In2iGui.isWithin(e,this.partControls.element)) {
			this.hidePartControls();
			this.hoveredPart.element.removeClassName('</span>in2igui_editor_part_hover<span class="literal">');
		}
		if (!this.partControls) {
			this.hoveredPart.element.removeClassName('</span>in2igui_editor_part_hover<span class="literal">');			
		}
	},
	showPartEditControls : function() {
		if (!this.partEditControls) {
			this.partEditControls = In2iGui.Overlay.create('</span>In2iGuiEditorPartEditActions<span class="literal">');
			this.partEditControls.addIcon('</span>save<span class="literal">','</span>common/save<span class="literal">');
			this.partEditControls.addIcon('</span>cancel<span class="literal">','</span>common/close<span class="literal">');
			this.partEditControls.addDelegate(this);
		}
		this.partEditControls.showAtElement(this.activePart.element,{'</span>horizontal<span class="literal">':'</span>right<span class="literal">','</span>vertical<span class="literal">':'</span>topOutside<span class="literal">'});
	},
	showPartControls : function() {
		if (!this.partControls) {
			this.partControls = In2iGui.Overlay.create('</span>In2iGuiEditorPartActions<span class="literal">');
			this.partControls.addIcon('</span>edit<span class="literal">','</span>common/edit<span class="literal">');
			this.partControls.addIcon('</span>new<span class="literal">','</span>common/new<span class="literal">');
			this.partControls.addIcon('</span>delete<span class="literal">','</span>common/delete<span class="literal">');
			var self = this;
			this.partControls.getElement().observe('</span>mouseout<span class="literal">',function(e) {
				self.blurControls(e);
			});
			this.partControls.getElement().observe('</span>mouseover<span class="literal">',function(e) {
				self.hoverControls(e);
			});
			this.partControls.addDelegate(this);
		}
		if (this.hoveredPart.column==-1) {
			this.partControls.hideIcons(['</span>new<span class="literal">','</span>delete<span class="literal">']);
		} else {
			this.partControls.showIcons(['</span>new<span class="literal">','</span>delete<span class="literal">']);
		}
		this.partControls.showAtElement(this.hoveredPart.element,{'</span>horizontal<span class="literal">':'</span>right<span class="literal">'});
	},
	hoverControls : function(e) {
		this.hoveredPart.element.addClassName('</span>in2igui_editor_part_hover<span class="literal">');
	},
	blurControls : function(e) {
		this.hoveredPart.element.removeClassName('</span>in2igui_editor_part_hover<span class="literal">');
		if (!In2iGui.isWithin(e,this.hoveredPart.element)) {
			this.hidePartControls();
		}
	},
	iconWasClicked$In2iGuiEditorPartActions : function(key,event) {
		if (key=='</span>delete<span class="literal">') {
			this.deletePart(this.hoveredPart);
		} else if (key=='</span>new<span class="literal">') {
			this.newPart(event);
		} else if (key=='</span>edit<span class="literal">') {
			this.editPart(this.hoveredPart);
		}
	},
	iconWasClicked$In2iGuiEditorPartEditActions : function(key,event) {
		if (key=='</span>cancel<span class="literal">') {
			this.cancelPart(this.activePart);
		} else if (key=='</span>save<span class="literal">') {
			this.savePart(this.activePart);
		}
	},
	hidePartControls : function() {
		if (this.partControls) {
			this.partControls.hide();
		}
	},
	hidePartEditControls : function() {
		if (this.partEditControls) {
			this.partEditControls.hide();
		}
	},
	editPart : function(part) {
		if (!this.active || this.activePart) return;
		if (this.activePart) this.activePart.deactivate();
		this.activePart = part;
		this.showPartEditControls();
		part.element.addClassName('</span>in2igui_editor_part_active<span class="literal">');
		part.activate();
		window.clearTimeout(this.partControlTimer);
		this.hidePartControls();
		this.blurColumn();
	},
	cancelPart : function(part) {
		part.cancel();
	},
	savePart : function(part) {
		part.save();
	},
	getEditorForElement : function(element) {
		for (var i=0; i &lt; this.parts.length; i++) {
			if (this.parts[i].element==element) {
				return this.parts[i];
			}
		};
		return null;
	},
	partDidDeacivate : function(part) {
		part.element.removeClassName('</span>in2igui_editor_part_active<span class="literal">');
		this.activePart = null;
		this.hidePartEditControls();
	},
	partChanged : function(part) {
		In2iGui.callDelegates(part,'</span>partChanged<span class="literal">');
	},
	deletePart : function(part) {
		In2iGui.callDelegates(part,'</span>deletePart<span class="literal">');
		this.partControls.hide();
	},
	newPart : function(e) {
		if (!this.newPartMenu) {
			var menu = In2iGui.Menu.create('</span>In2iGuiEditorNewPartMenu<span class="literal">');
			this.partControllers.each(function(item) {
				menu.addItem(item.title,item.key);
			});
			menu.addDelegate(this);
			this.newPartMenu=menu;
		}
		this.newPartMenu.showAtPointer(e);
	},
	itemWasClicked$In2iGuiEditorNewPartMenu : function(value) {
		var info = {row:this.hoveredPart.row,column:this.hoveredPart.column,position:this.hoveredPart.position+1,type:value};
		In2iGui.callDelegates(this,'</span>addPart<span class="literal">',info);
	},
	/**** Dragging ****/
	startPartDrag : function(e) {
		return true;
		if (!this.active || this.activePart) return true;
		if (!this.dragProxy) {
			this.dragProxy = new Element('</span>div<span class="literal">').addClassName('</span>in2igui_editor_dragproxy part part_header<span class="literal">');
			document.body.appendChild(this.dragProxy);
		}
		var element = this.hoveredPart.element;
		this.dragProxy.setStyle({'</span>width<span class="literal">':element.getWidth()+'</span>px<span class="literal">'});
		this.dragProxy.innerHTML = element.innerHTML;
		In2iGui.Editor.startDrag(e,this.dragProxy);
		return;
		Element.observe(document.body,'</span>mouseup<span class="literal">',function() {
			self.endPartDrag();
		})
	},
	dragPart : function() {
		
	},
	endPartDrag : function() {
		In2iGui.get();
	}
}



In2iGui.Editor.startDrag = function(e,element) {
	In2iGui.Editor.dragElement = element;
	Element.observe(document.body,'</span>mousemove<span class="literal">',In2iGui.Editor.dragListener);
	Element.observe(document.body,'</span>mouseup<span class="literal">',In2iGui.Editor.dragEndListener);
	In2iGui.Editor.startDragPos = {top:e.pointerY(),left:e.pointerX()};
	e.stop();
	return false;
}

In2iGui.Editor.dragListener = function(e) {
	var element = In2iGui.Editor.dragElement;
	element.style.left = e.pointerX()+'</span>px<span class="literal">';
	element.style.top = e.pointerY()+'</span>px<span class="literal">';
	element.style.display='</span>block<span class="literal">';
	return false;
}

In2iGui.Editor.dragEndListener = function(event) {
	Event.stopObserving(document.body,'</span>mousemove<span class="literal">',In2iGui.Editor.dragListener);
	Event.stopObserving(document.body,'</span>mouseup<span class="literal">',In2iGui.Editor.dragEndListener);
	In2iGui.Editor.dragElement.style.display='</span>none<span class="literal">';
	In2iGui.Editor.dragElement=null;
}

////////////////////////////////// Header editor ////////////////////////////////

In2iGui.Editor.Header = function(element,row,column,position) {
	this.element = $(element);
	this.row = row;
	this.column = column;
	this.position = position;
	this.id = this.element.id.match(/part\-([\d]+)/i)[1];
	this.header = $tag('</span>*<span class="literal">',this.element)[0];
	this.field = null;
}

In2iGui.Editor.Header.prototype = {
	activate : function() {
		this.value = this.header.innerHTML;
		this.field = new Element('</span>textarea<span class="literal">').addClassName('</span>in2igui_editor_header<span class="literal">');
		this.field.value = this.value;
		this.header.style.visibility='</span>hidden<span class="literal">';
		this.updateFieldStyle();
		this.element.insertBefore(this.field,this.header);
		this.field.focus();
		this.field.select();
		var self = this;
		this.field.onblur = function() {
			//self.deactivate();
		}
		this.field.onkeydown = function(e) {
			if (new N2i.Event(e).isReturnKey()) {
				self.save();
			}
		}
	},
	save : function() {
		var value = this.field.value;
		this.header.innerHTML = value;
		this.deactivate();
		if (value!=this.value) {
			this.value = value;
			In2iGui.Editor.get().partChanged(this);
		}
	},
	cancel : function() {
		this.deactivate();
	},
	deactivate : function() {
		this.header.style.visibility='</span><span class="literal">';
		this.element.removeChild(this.field);
		In2iGui.Editor.get().partDidDeacivate(this);
	},
	updateFieldStyle : function() {
		this.field.style.width=N2i.getWidth(this.header)+'</span>px<span class="literal">';
		this.field.style.height=N2i.getHeight(this.header)+'</span>px<span class="literal">';
		this.field.style.fontSize=N2i.getStyle(this.header,'</span>font-size<span class="literal">');
		this.field.style.fontWeight=N2i.getStyle(this.header,'</span>font-weight<span class="literal">');
		this.field.style.fontFamily=N2i.getStyle(this.header,'</span>font-family<span class="literal">');
		this.field.style.textAlign=N2i.getStyle(this.header,'</span>text-align<span class="literal">');
		this.field.style.color=N2i.getStyle(this.header,'</span>color<span class="literal">');
	},
	getValue : function() {
		return this.value;
	}
}

////////////////////////////////// Html editor ////////////////////////////////

In2iGui.Editor.Html = function(element,row,column,position) {
	this.element = $id(element);
	this.row = row;
	this.column = column;
	this.position = position;
	this.id = this.element.id.match(/part\-([\d]+)/i)[1];
	this.field = null;
}

In2iGui.Editor.Html.prototype = {
	activate : function() {
		this.value = this.element.innerHTML;
		if (Prototype.Browser.IE) return;
		var height = this.element.getHeight();
		this.element.update('</span><span class="literal">');
		this.editor = In2iGui.RichText.create(null,{autoHideToolbar:false});
		this.editor.setHeight(height);
		this.element.appendChild(this.editor.getElement());
		this.editor.addDelegate(this);
		this.editor.ignite();
		this.editor.setValue(this.value);
		this.editor.focus();
	},
	cancel : function() {
		this.deactivate();
		this.element.innerHTML = this.value;
	},
	save : function() {
		this.deactivate();
		if (Prototype.Browser.IE) return;
		var value = this.editor.value;
		if (value!=this.value) {
			this.value = value;
			In2iGui.Editor.get().partChanged(this);
		}
		this.element.innerHTML = this.value;
	},
	deactivate : function() {
		if (!Prototype.Browser.IE) {
			this.editor.deactivate();
		}
		In2iGui.Editor.get().partDidDeacivate(this);
	},
	richTextDidChange : function() {
		//this.deactivate();
	},
	getValue : function() {
		return this.value;
	}
}

/* EOF */
In2iGui.Menu = function(element,name,options) {
	this.options = {};
	N2i.override(this.options,options);
	this.element = $id(element);
	this.name = name;
	this.value = null;
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.Menu.create = function(name,options) {
	options = options || {};
	var element = new Element('</span>div<span class="literal">').addClassName('</span>in2igui_menu<span class="literal">');
	var obj = new In2iGui.Menu(element,name,options);
	document.body.appendChild(element);
	return obj;
}

In2iGui.Menu.prototype = {
	addBehavior : function() {
		var self = this;
		this.hider = function() {self.hide();}
	},
	addItem : function(title,value) {
		var self = this;
		var item = new Element('</span>div<span class="literal">').addClassName('</span>in2igui_menu_item<span class="literal">').update(title);
		item.observe('</span>click<span class="literal">',function(e) {
			self.itemWasClicked(value);
			e.stop();
		})
		this.element.insert(item);
	},
	getValue : function() {
		return this.value;
	},
	itemWasClicked : function(value) {
		this.value = value;
		In2iGui.callDelegates(this,'</span>itemWasClicked<span class="literal">',value);
		this.hide();
	},
	showAtPointer : function(event) {
		this.showAtPoint({'</span>top<span class="literal">':event.pointerY(),'</span>left<span class="literal">':event.pointerX()});
		event.stop();
	},
	showAtElement : function(element) {
		this.showAtPoint(element.cumulativeOffset());
	},
	showAtPoint : function(pos) {
		var innerWidth = N2i.Window.getInnerWidth();
		this.element.setStyle({'</span>display<span class="literal">':'</span>block<span class="literal">','</span>visibility<span class="literal">':'</span>hidden<span class="literal">'});
		var width = this.element.getWidth();
		this.element.setStyle({'</span>top<span class="literal">':pos.top+'</span>px<span class="literal">','</span>left<span class="literal">':Math.min(pos.left,innerWidth-width-20)+'</span>px<span class="literal">','</span>visibility<span class="literal">':'</span>visible<span class="literal">'});
		this.addHider();
	},
	hide : function() {
		this.element.setStyle({'</span>display<span class="literal">':'</span>none<span class="literal">'});
		this.removeHider();
	},
	addHider : function() {
		Element.observe(document.body,'</span>click<span class="literal">',this.hider);
	},
	removeHider : function() {
		Event.stopObserving(document.body,'</span>click<span class="literal">',this.hider);
	}
}



/* EOF */In2iGui.Overlay = function(element,name,options) {
	this.element = $(element);
	this.content = this.element.select('</span>div.in2igui_inner_overlay<span class="literal">')[1];
	this.name = name;
	this.icons = new Hash();
	this.visible = false;
	In2iGui.extend(this);
}

In2iGui.Overlay.create = function(name,options) {
	var element = new Element('</span>div<span class="literal">').addClassName('</span>in2igui_overlay<span class="literal">').setStyle({'</span>display<span class="literal">':'</span>none<span class="literal">'});
	element.update('</span>&lt;div class=<span class="literal">"in2igui_inner_overlay"</span>&gt;&lt;div class=<span class="literal">"in2igui_inner_overlay"</span>&gt;&lt;/div&gt;&lt;/div&gt;<span class="literal">');
	document.body.appendChild(element);
	return new In2iGui.Overlay(element,name);
}

In2iGui.Overlay.prototype = {
	addIcon : function(key,icon) {
		var self = this;
		var element = new Element('</span>div<span class="literal">').addClassName('</span>in2igui_overlay_icon<span class="literal">');
		element.setStyle({'</span>backgroundImage<span class="literal">':'</span>url(<span class="literal">'+In2iGui.getIconUrl(icon,2)+'</span>)<span class="literal">'});
		element.observe('</span>click<span class="literal">',function(e) {
			self.iconWasClicked(key,e);
		});
		this.icons.set(key,element);
		this.content.insert(element);
	},
	hideIcons : function(keys) {
		var self = this;
		keys.each(function(key) {
			self.icons.get(key).hide();
		});
	},
	showIcons : function(keys) {
		var self = this;
		keys.each(function(key) {
			self.icons.get(key).show();
		});
	},
	iconWasClicked : function(key,e) {
		In2iGui.callDelegates(this,'</span>iconWasClicked<span class="literal">',key,e);
	},
	showAtElement : function(element,options) {
		In2iGui.positionAtElement(this.element,element,options);
		if (this.visible) return;
		this.element.setStyle({'</span>display<span class="literal">':'</span>block<span class="literal">','</span>opacity<span class="literal">':0});
		$ani(this.element,'</span>opacity<span class="literal">',1,300);
		this.visible = true;
		return;
	},
	hide : function() {
		this.element.setStyle({'</span>display<span class="literal">':'</span>none<span class="literal">'});
		this.visible = false;
	}
}

/* EOF */
In2iGui.Upload = function(element,name,options) {
	this.element = $(element);
	this.name = name;
	this.file = $class('</span>file<span class="literal">',this.element)[0];
	this.form = $tag('</span>form<span class="literal">',this.element)[0];
	In2iGui.extend(this);
	this.loader = null;
	this.addBehavior();
	this.createProgressBar();
}

In2iGui.Upload.create = function(name,options) {
	var element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_upload<span class="literal">'});
	var form = new Element('</span>form<span class="literal">',{'</span>action<span class="literal">':options.action, '</span>method<span class="literal">':'</span>post<span class="literal">', '</span>enctype<span class="literal">':'</span>multipart/form-data<span class="literal">','</span>encoding<span class="literal">':'</span>multipart/form-data<span class="literal">','</span>target<span class="literal">':'</span>upload<span class="literal">'});
	for (var i=0; i &lt; options.parameters.length; i++) {
		var hidden = new Element('</span>input<span class="literal">',{'</span>type<span class="literal">':'</span>hidden<span class="literal">','</span>name<span class="literal">':options.parameters[i].name,'</span>value<span class="literal">':options.parameters[i].value});
		form.insert(hidden);
	};
	var file = N2i.create('</span>input<span class="literal">',{'</span>type<span class="literal">':'</span>file<span class="literal">','</span>class<span class="literal">':'</span>file<span class="literal">','</span>name<span class="literal">':options.name});
	form.insert(file);
	element.insert(form);
	element.insert(new Element('</span>iframe<span class="literal">',{name:'</span>upload<span class="literal">',id:'</span>upload<span class="literal">'}).setStyle({display:'</span>none<span class="literal">'}));
	return new In2iGui.Upload(element,name,options);
}

In2iGui.Upload.prototype = {
	addBehavior : function() {
		var self = this;
		this.file.onchange = function() {
			self.submit();
		}
	},
	createProgressBar : function() {
		this.progressBar = In2iGui.ProgressBar.create();
		this.progressBar.hide();
		this.element.appendChild(this.progressBar.getElement());
	},
	submit : function() {
		this.form.submit();
		In2iGui.callDelegates(this,'</span>uploadDidSubmit<span class="literal">');
	},
	startProgress : function() {
		this.form.style.display='</span>none<span class="literal">';
		this.progressBar.show();
	},
	setProgress : function(value) {
		this.progressBar.setValue(value);
	},
	endProgress : function() {
		this.form.style.display='</span>block<span class="literal">';
		this.form.reset();
		this.progressBar.reset();
		this.progressBar.hide();
	}
}





//////////////////////////////////////// Mulit-upload ////////////////////////////////////////



In2iGui.MultiUpload = function(element,name,options) {
	this.options = {url:'</span><span class="literal">'};
	N2i.override(this.options,options);
	this.element = $(element);
	this.itemContainer = this.element.select('</span>.in2igui_multiupload_items<span class="literal">')[0];

	this.name = name;
	this.items = [];
	this.busy = false;

	this.button = this.element.select('</span>.in2igui_button<span class="literal">')[0];
	In2iGui.extend(this);
	this.addBehavior();
}

In2iGui.MultiUpload.prototype = {
	addBehavior : function() {
		var self = this;
		this.button.observe('</span>click<span class="literal">',function() {
			self.loader.selectFiles();
		});
		document.observe('</span>dom:loaded<span class="literal">', function() {self.createLoader()});
	},
	createLoader : function() {
		var loc = new String(document.location);
		var url = loc.slice(0,loc.lastIndexOf('</span>/<span class="literal">')+1);
		url += this.options.url;
		var session = N2i.Cookie.get('</span>JSESSIONID<span class="literal">');
		if (session) {
			url+='</span>;jsessionid=<span class="literal">'+session;
		}
		var self = this;
		this.loader = new SWFUpload({
			upload_url : url,
			flash_url : In2iGui.context+"/In2iGui/lib/swfupload/swfupload_f8.swf",
			file_size_limit : "20480",
			file_upload_limit : 100,
			debug : true,
			
			swfupload_loaded_handler : function() {self.loaded()},
			file_queued_handler : function(file) {self.fileQueued(file)},
			file_queue_error_handler : function(file, error, message) {self.fileQueueError(file, error, message)},
			file_dialog_complete_handler : function() {self.fileDialogComplete()},
			upload_start_handler : function() {self.uploadStart()},
			upload_progress_handler : function(file,complete,total) {self.uploadProgress(file,complete,total)},
			upload_error_handler : function(file, error, message) {self.uploadError(file, error, message)},
			upload_success_handler : function(file,data) {self.uploadSuccess(file,data)},
			upload_complete_handler : function(file) {self.uploadComplete(file)},
			queue_complete_handler : function() {self.queueComplete()},
		
			// SWFObject settings
			swfupload_pre_load_handler : function() {},
			swfupload_load_failed_handler : function() {}

		});
	},
	startNextUpload : function() {
		this.loader.startUpload();
	},
	addError : function(error,file) {
		var element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_multiupload_item_error<span class="literal">'});
		element.insert(new Element('</span>a<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_link<span class="literal">'}).update('</span>&lt;span&gt;Fjern&lt;/span&gt;<span class="literal">').observe('</span>click<span class="literal">',function() {this.parentNode.remove(); return false;}));
		element.insert('</span>&lt;strong&gt;<span class="literal">'+In2iGui.MultiUpload.errors[error]+'</span>&lt;/strong&gt;&lt;br/&gt;&lt;em&gt;<span class="literal">'+file.name+'</span>&lt;/em&gt;<span class="literal">');
		this.itemContainer.insert(element);
	},
	
	//////////////////// Events //////////////
	
	loaded : function() {
		
	},
	fileQueued : function(file) {
		var item = new In2iGui.MultiUpload.Item(file);
		this.items[file.index] = item;
		this.itemContainer.insert(item.element);
	},
	fileQueueError : function(file, error, message) {
		this.addError(error,file);
	},
	fileDialogComplete : function() {
		this.startNextUpload();
	},
	uploadStart : function() {
		
	},
	uploadProgress : function(file,complete,total) {
		this.items[file.index].updateProgress(complete,total);
	},
	uploadError : function(file, error, message) {
		if (file) {
			this.items[file.index].update(file);
		}
		this.addError(error,file);
	},
	uploadSuccess : function(file,data) {
		this.items[file.index].updateProgress(file.size,file.size);
	},
	uploadComplete : function(file) {
		this.startNextUpload();
		var self = this;
		window.setTimeout(function() {
			self.items[file.index].hide();
		},100);
		In2iGui.callDelegates(this,'</span>uploadDidComplete<span class="literal">',file);
	},
	queueComplete : function() {
		
	}
}

In2iGui.MultiUpload.Item = function(file) {
	this.element = new Element('</span>div<span class="literal">').addClassName('</span>in2igui_multiupload_item<span class="literal">');
	this.info = new Element('</span>strong<span class="literal">');
	this.progress = In2iGui.ProgressBar.create();
	this.element.insert(this.progress.getElement());
	this.element.insert(this.info);
	this.update(file);
}

In2iGui.MultiUpload.Item.prototype = {
	update : function(file) {
		this.info.update(file.name);
	},
	updateProgress : function(complete,total) {
		this.progress.setValue(complete/total);
	},
	hide : function() {
		this.element.hide();
	}
}

if (window.SWFUpload) {
In2iGui.MultiUpload.errors = {};
In2iGui.MultiUpload.errors[SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED]			= '</span>Der er <span class="reserved">for</span> mange filer i ken<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT]		= '</span>Filen er <span class="reserved">for</span> stor<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE]				= '</span>Filen er tom<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.QUEUE_ERROR.INVALID_FILETYPE]				= '</span>Filens type er ikke understttet<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.UPLOAD_ERROR.HTTP_ERROR]					= '</span>Der skete en netvrksfejl<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.UPLOAD_ERROR.MISSING_UPLOAD_URL]			= '</span>Upload-adressen findes ikke<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.UPLOAD_ERROR.IO_ERROR]						= '</span>Der skete en IO-fejl<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.UPLOAD_ERROR.SECURITY_ERROR]				= '</span>Der skete en sikkerhedsfejl<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED]			= '</span>Upload-strrelsen er overskredet<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.UPLOAD_ERROR.UPLOAD_FAILED]				= '</span>Upload af filen fejlede<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.UPLOAD_ERROR.SPECIFIED_FILE_ID_NOT_FOUND]	= '</span>Filens id kunne ikke findes<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED]		= '</span>Validering af filen fejlede<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.UPLOAD_ERROR.FILE_CANCELLED]				= '</span>Filen blev afbrudt<span class="literal">';
In2iGui.MultiUpload.errors[SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED]				= '</span>Upload af filen blev stoppet<span class="literal">';
}
/* EOF */In2iGui.ProgressBar = function(element,name) {
	this.element = $(element);
	this.indicator = this.element.firstDescendant();
	this.name = name;
	In2iGui.extend(this);
}

In2iGui.ProgressBar.create = function(name) {
	var element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_progressbar<span class="literal">'}).insert(N2i.create('</span>div<span class="literal">'));
	return new In2iGui.ProgressBar(element,name);
}
	
In2iGui.ProgressBar.prototype = {
	setValue : function(value) {
		$ani(this.indicator,'</span>width<span class="literal">',(value*100)+'</span>%<span class="literal">',value==1 ? 10 : 200);
	},
	reset : function() {
		this.indicator.style.width='</span>0%<span class="literal">';
	},
	hide : function() {
		this.element.style.display = '</span>none<span class="literal">';
	},
	show : function() {
		this.element.style.display = '</span>block<span class="literal">';
	}
}

/* EOF */In2iGui.Gallery = function(id,name,options) {
	this.id = id;
	this.name = name;
	this.options = options || {};
	this.element = $(id);
	this.objects = [];
	this.nodes = [];
	this.selected = new Hash();
	this.width = 100;
	this.height = 100;
	In2iGui.extend(this);
}

In2iGui.Gallery.prototype = {
	setObjects : function(objects) {
		this.objects = objects;
		this.render();
	},
	getObjects : function() {
		return this.objects;
	},
	render : function() {
		this.nodes = [];
		this.element.update();
		var self = this;
		this.objects.each(function(object,i) {
			var url = self.resolveImageUrl(object);
			url = url.replace(/&amp;amp;/,'</span>&amp;<span class="literal">');
			if (object.height&lt;object.width) {
				var top = (self.height-(self.height*object.height/object.width))/2;
			} else {
				var top = 0;
			}
			var img = new Element('</span>img<span class="literal">',{src:url}).setStyle({margin:top+'</span>px auto 0px<span class="literal">'});
			var item = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_gallery_item<span class="literal">'}).setStyle({'</span>width<span class="literal">':self.width+'</span>px<span class="literal">','</span>height<span class="literal">':self.height+'</span>px<span class="literal">'}).insert(img);
			item.observe('</span>click<span class="literal">',function() {
				self.itemClicked(i);
			});
			item.observe('</span>dblclick<span class="literal">',function() {
				self.itemDoubleClicked(i);
			});
			self.element.insert(item);
			self.nodes.push(item);
		});
	},
	updateUI : function() {
		var self = this;
		this.objects.each(function(object,i) {
			if (self.selected.get(i)) {
				self.nodes[i].addClassName('</span>in2igui_gallery_item_selected<span class="literal">');
			} else {
				self.nodes[i].removeClassName('</span>in2igui_gallery_item_selected<span class="literal">');
			}
		});
	},
	resolveImageUrl : function(img) {
		for (var i=0; i &lt; this.delegates.length; i++) {
			if (this.delegates[i].resolveImageUrl) {
				return this.delegates[i].resolveImageUrl(img,this.width,this.height);
			}
		};
		return '</span><span class="literal">';
	},
	itemClicked : function(index) {
		this.selected = new Hash();
		this.selected.set(index,true);
		this.updateUI();
	},
	itemDoubleClicked : function(index) {
		In2iGui.callDelegates(this,'</span>itemOpened<span class="literal">',this.objects[index]);
	}
}

/* EOF */In2iGui.Calendar = function(id,name,options) {
	this.name = name;
	this.options = {startHour:7,endHour:24};
	N2i.override(this.options,options);
	this.element = $(id);
	this.head = $(this.element.getElementsByTagName('</span>thead<span class="literal">')[0]);
	this.body = $(this.element.getElementsByTagName('</span>tbody<span class="literal">')[0]);
	this.date = new Date();
	In2iGui.extend(this);
	this.buildUI();
	this.updateUI();
}

In2iGui.Calendar.prototype = {
	getFirstDay : function() {
		var date = new Date(this.date.getTime());
		date.setDate(date.getDate()-date.getDay()+1);
		date.setHours(0);
		date.setMinutes(0);
		date.setSeconds(0);
		return date;
	},
	getLastDay : function() {
		var date = new Date(this.date.getTime());
		date.setDate(date.getDate()-date.getDay()+7);
		date.setHours(23);
		date.setMinutes(59);
		date.setSeconds(59);
		return date;
	},
	clearEvents : function() {
		this.events = [];
		var nodes = this.element.select('</span>.in2igui_calendar_event<span class="literal">');
		nodes.each(function(node) {
			node.remove();
		});
		this.hideEventViewer();
	},
	setEvents : function(events) {
		this.setBusy(false);
		this.clearEvents();
		this.events = events;
		var self = this;
		var pixels = (this.options.endHour-this.options.startHour)*40;
		this.events.each(function(event) {
			var day = self.body.select('</span>.day<span class="literal">')[event.startTime.getDay()-1];
			var node = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_calendar_event<span class="literal">'});
			var top = ((event.startTime.getHours()*60+event.startTime.getMinutes())/60-self.options.startHour)*40-1;
			var height = (event.endTime.getTime()-event.startTime.getTime())/1000/60/60*40+1;
			var height = Math.min(pixels-top,height);
			node.setStyle({'</span>marginTop<span class="literal">':top+'</span>px<span class="literal">','</span>height<span class="literal">':height+'</span>px<span class="literal">'});
			var content = new Element('</span>div<span class="literal">');
			content.insert(new Element('</span>p<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_calendar_event_time<span class="literal">'}).update(event.startTime.dateFormat('</span>H:i<span class="literal">')));
			content.insert(new Element('</span>p<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_calendar_event_text<span class="literal">'}).update(event.text));
			if (event.location) {
				content.insert(new Element('</span>p<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_calendar_event_location<span class="literal">'}).update(event.location));
			}
			day.insert(node.insert(content));
			node.observe('</span>click<span class="literal">',function() {
				self.eventWasClicked(event,this);
			});
		});
	},
	eventWasClicked : function(event,node) {
		this.showEvent(event,node);
	},
	setBusy : function(busy) {
		if (busy) {
			this.element.addClassName('</span>in2igui_calendar_busy<span class="literal">');
		} else {
			this.element.removeClassName('</span>in2igui_calendar_busy<span class="literal">');
		}
	},
	updateUI : function() {
		var first = this.getFirstDay();
		var x = this.head.select('</span>.time<span class="literal">')[0];
		x.update('</span>&lt;div&gt;Uge <span class="literal">'+this.date.getWeekOfYear()+'</span> <span class="literal">'+this.date.getFullYear()+'</span>&lt;/div&gt;<span class="literal">');
		
		var days = this.head.select('</span>.day<span class="literal">');
		for (var i=0; i &lt; days.length; i++) {
			var date = new Date(first.getTime());
			date.setDate(date.getDate()+i);
			days[i].update(date.dateFormat('</span>l \\d. d M<span class="literal">'))
		};
	},
	buildUI : function() {
		var bar = this.element.select('</span>.in2igui_calendar_bar<span class="literal">')[0];
		this.toolbar = In2iGui.Toolbar.create(null,{labels:false});
		bar.insert(this.toolbar.getElement());
		var previous = In2iGui.Button.create('</span>in2iguiCalendarPrevious<span class="literal">',{text:'</span><span class="literal">',icon:'</span>monochrome/previous<span class="literal">'});
		previous.addDelegate(this);
		this.toolbar.add(previous);
		var today = In2iGui.Button.create('</span>in2iguiCalendarToday<span class="literal">',{text:'</span>Idag<span class="literal">'});
		today.addDelegate(this);
		this.toolbar.add(today);
		var next = In2iGui.Button.create('</span>in2iguiCalendarNext<span class="literal">',{text:'</span><span class="literal">',icon:'</span>monochrome/next<span class="literal">'});
		next.addDelegate(this);
		this.toolbar.add(next);
		this.datePickerButton = In2iGui.Button.create('</span>in2iguiCalendarDatePicker<span class="literal">',{text:'</span>Vlg dato...<span class="literal">'});
		this.datePickerButton.addDelegate(this);
		this.toolbar.add(this.datePickerButton);
		
		var time = this.body.select('</span>.time<span class="literal">')[0];
		for (var i=this.options.startHour; i &lt;= this.options.endHour; i++) {
			var node = new Element('</span>div<span class="literal">').update('</span>&lt;span&gt;&lt;em&gt;<span class="literal">'+i+'</span>:00&lt;/em&gt;&lt;/span&gt;<span class="literal">');
			if (i==this.options.startHour) {
				node.addClassName('</span>first<span class="literal">');
			}
			if (i==this.options.endHour) {
				node.addClassName('</span>last<span class="literal">');
			}
			time.insert(node);
		};
	},
	click$in2iguiCalendarPrevious : function() {
		var date = new Date(this.date.getTime());
		date.setDate(this.date.getDate()-7);
		this.setDate(date);
	},
	click$in2iguiCalendarNext : function() {
		var date = new Date(this.date.getTime());
		date.setDate(this.date.getDate()+7);
		this.setDate(date);
	},
	click$in2iguiCalendarToday : function() {
		this.setDate(new Date());
	},
	setDate: function(date) {
		this.date = new Date(date.getTime());
		this.updateUI();
		this.refresh();
		if (this.datePicker) {
			this.datePicker.setValue(this.date);
		}
	},
	click$in2iguiCalendarDatePicker : function() {
		this.showDatePicker();
	},
	refresh : function() {
		this.clearEvents();
		this.setBusy(true);
		var info = {'</span>startTime<span class="literal">':this.getFirstDay(),'</span>endTime<span class="literal">':this.getLastDay()};
		In2iGui.callDelegates(this,'</span>calendarSpanChanged<span class="literal">',info);
	},
	
	////////////////////////////////// Date picker ///////////////////////////
	showDatePicker : function() {
		if (!this.datePickerPanel) {
			this.datePickerPanel = In2iGui.BoundPanel.create();
			this.datePicker = In2iGui.DatePicker.create('</span>in2iguiCalendarDatePicker<span class="literal">',{value:this.date});
			this.datePicker.addDelegate(this);
			this.datePickerPanel.add(this.datePicker);
			this.datePickerPanel.addSpace(5);
			var button = In2iGui.Button.create('</span>in2iguiCalendarDatePickerClose<span class="literal">',{text:'</span>Luk<span class="literal">'});
			button.addDelegate(this);
			this.datePickerPanel.add(button);
		}
		this.datePickerPanel.position(this.datePickerButton.getElement());
		this.datePickerPanel.show();
	},
	click$in2iguiCalendarDatePickerClose : function() {
		this.datePickerPanel.hide();
	},
	dateChanged$in2iguiCalendarDatePicker : function(date) {
		this.setDate(date);
	},
	
	//////////////////////////////// Event viewer //////////////////////////////
	
	showEvent : function(event,node) {
		if (!this.eventViewerPanel) {
			this.eventViewerPanel = In2iGui.BoundPanel.create({width:270,padding: 3});
			this.eventInfo = In2iGui.InfoView.create(null,{height:240,clickObjects:true});
			this.eventViewerPanel.add(this.eventInfo);
			this.eventViewerPanel.addSpace(5);
			var button = In2iGui.Button.create('</span>in2iguiCalendarEventClose<span class="literal">',{text:'</span>Luk<span class="literal">'});
			button.addDelegate(this);
			this.eventViewerPanel.add(button);
		}
		this.eventInfo.clear();
		this.eventInfo.setBusy(true);
		this.eventViewerPanel.position(node);
		this.eventViewerPanel.show();
		In2iGui.callDelegates(this,'</span>requestEventInfo<span class="literal">',event);
		return;
	},
	updateEventInfo : function(event,data) {
		this.eventInfo.setBusy(false);
		this.eventInfo.update(data);
	},
	click$in2iguiCalendarEventClose : function() {
		this.hideEventViewer();
	},
	hideEventViewer : function() {
		if (this.eventViewerPanel) {
			this.eventViewerPanel.hide();
		}
	}
}


/********************** Date picker ***************/

In2iGui.DatePicker = function(id,name,options) {
	this.name = name;
	this.element = $(id);
	this.options = {};
	N2i.override(this.options,options);
	this.cells = [];
	this.title = this.element.select('</span>strong<span class="literal">')[0];
	this.today = new Date();
	this.value = this.options.value ? new Date(this.options.value.getTime()) : new Date();
	this.viewDate = new Date(this.value.getTime());
	this.viewDate.setDate(1);
	In2iGui.extend(this);
	this.addBehavior();
	this.updateUI();
}

In2iGui.DatePicker.create = function(name,options) {
	var element = new Element('</span>div<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_datepicker<span class="literal">'});
	element.insert('</span>&lt;div class=<span class="literal">"in2igui_datepicker_header"</span>&gt;&lt;a class=<span class="literal">"in2igui_datepicker_next"</span>&gt;&lt;/a&gt;&lt;a class=<span class="literal">"in2igui_datepicker_previous"</span>&gt;&lt;/a&gt;&lt;strong&gt;&lt;/strong&gt;&lt;/div&gt;<span class="literal">');
	var table = new Element('</span>table<span class="literal">');
	var head = new Element('</span>tr<span class="literal">');
	table.insert(new Element('</span>thead<span class="literal">').insert(head));
	for (var i=0;i&lt;7;i++) {
		head.insert(new Element('</span>th<span class="literal">').update(Date.dayNames[i].substring(0,3)));
	}
	var body = new Element('</span>tbody<span class="literal">');
	table.insert(body);
	for (var i=0;i&lt;6;i++) {
		var row = new Element('</span>tr<span class="literal">');
		for (var j=0;j&lt;7;j++) {
			var cell = new Element('</span>td<span class="literal">');
			row.insert(cell);
		}
		body.insert(row);
	}
	element.insert(table);
	return new In2iGui.DatePicker(element,name,options);
}

In2iGui.DatePicker.prototype = {
	addBehavior : function() {
		var self = this;
		this.cells = this.element.select('</span>td<span class="literal">');
		this.cells.each(function(cell,index) {
			cell.observe('</span>mousedown<span class="literal">',function() {self.selectCell(index)});
		})
		this.element.select('</span>.in2igui_datepicker_next<span class="literal">')[0].observe('</span>mousedown<span class="literal">',function() {self.next()});
		this.element.select('</span>.in2igui_datepicker_previous<span class="literal">')[0].observe('</span>mousedown<span class="literal">',function() {self.previous()});
	},
	setValue : function(date) {
		this.value = new Date(date.getTime());
		this.viewDate = new Date(date.getTime());
		this.viewDate.setDate(1);
		this.updateUI();
	},
	updateUI : function() {
		this.title.update(this.viewDate.dateFormat('</span>F Y<span class="literal">'));
		var isSelectedYear =  this.value.getFullYear()==this.viewDate.getFullYear();
		var month = this.viewDate.getMonth();
		for (var i=0; i &lt; this.cells.length; i++) {
			var date = this.indexToDate(i);
			var cell = this.cells[i];
			if (date.getMonth()&lt;month) {
				cell.className = '</span>in2igui_datepicker_dimmed<span class="literal">';
			} else if (date.getMonth()&gt;month) {
				cell.className = '</span>in2igui_datepicker_dimmed<span class="literal">';
			} else {
				cell.className = '</span><span class="literal">';
			}
			if (date.getDate()==this.value.getDate() &amp;&amp; date.getMonth()==this.value.getMonth() &amp;&amp; isSelectedYear) {
				cell.addClassName('</span>in2igui_datepicker_selected<span class="literal">');
			}
			if (date.getDate()==this.today.getDate() &amp;&amp; date.getMonth()==this.today.getMonth() &amp;&amp; date.getFullYear()==this.today.getFullYear()) {
				cell.addClassName('</span>in2igui_datepicker_today<span class="literal">');
			}
			cell.update(date.getDate());
		};
	},
	getPreviousMonth : function() {
		var previous = new Date(this.viewDate.getTime());
		previous.setMonth(previous.getMonth()-1);
		return previous;
	},
	getNextMonth : function() {
		var previous = new Date(this.viewDate.getTime());
		previous.setMonth(previous.getMonth()+1);
		return previous;
	},
	////////////////// Events ///////////////
	previous : function() {
		this.viewDate = this.getPreviousMonth();
		this.updateUI();
	},
	next : function() {
		this.viewDate = this.getNextMonth();
		this.updateUI();
	},
	selectCell : function(index) {
		this.value = this.indexToDate(index);
		this.viewDate = new Date(this.value.getTime());
		this.viewDate.setDate(1);
		this.updateUI();
		In2iGui.callDelegates(this,'</span>dateChanged<span class="literal">',this.value);
	},
	indexToDate : function(index) {
		var first = this.viewDate.getDay();
		var days = this.viewDate.getDaysInMonth();
		var previousDays = this.getPreviousMonth().getDaysInMonth();
		if (index&lt;first) {
			var date = this.getPreviousMonth();
			date.setDate(previousDays-first+index+1);
			return date;
		} else if (index&gt;first+days-1) {
			var date = this.getPreviousMonth();
			date.setDate(index-first-days+1);
			return date;
			cell.update(i-first-days+1);
		} else {
			var date = new Date(this.viewDate.getTime());
			date.setDate(index+1-first);
			return date;
		}
	}
}

Date.monthNames =
   ["Januar",
    "Februar",
    "Marts",
    "April",
    "Maj",
    "Juni",
    "Juli",
    "August",
    "September",
    "Oktober",
    "November",
    "December"];
Date.dayNames =
   ["Sndag",
    "Mandag",
    "Tirsdag",
    "Onsdag",
    "Torsdag",
    "Fredag",
    "Lrdag"];

/* EOF */In2iGui.Columns = function(id,name,options) {
	this.name = name;
	this.options = options || {};
	this.element = $(id);
	this.body = this.element.select('</span>tr<span class="literal">')[0];
	In2iGui.extend(this);
}

In2iGui.Columns.create = function(name,options) {
	var e = new Element('</span>table<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_columns<span class="literal">'}).insert(new Element('</span>tbody<span class="literal">').insert(new Element('</span>tr<span class="literal">')));
	return new In2iGui.Columns(e,name,options);
}

In2iGui.Columns.prototype = {
	addToColumn : function(index,widget) {
		var c = this.ensureColumn(index);
		N2i.log(c);
		c.insert(widget.getElement());
	},
	ensureColumn : function(index) {
		var children = this.body.childElements();
		N2i.log(children.length-1);
		for (var i=children.length-1;i&lt;index;i++) {
			this.body.insert(new Element('</span>td<span class="literal">',{'</span>class<span class="literal">':'</span>in2igui_columns_column<span class="literal">'}));
			N2i.log('</span>insert');
		}
		N2i.log(<span class="reserved">this</span>.body);
		<span class="reserved">return</span> <span class="reserved">this</span>.body.childElements()[index];
	}
}

<span class="comment">/* EOF */</span></pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b></b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Sun Sep  7 23:30:30 2008</div>
</body>
</html>
