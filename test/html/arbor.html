<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>HUI</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<!--
	<script charset="utf-8" type="text/javascript" src="../../bin/all.js"></script>
	-->
	<script charset="utf-8" type="text/javascript" src="../../js/hui.js"></script>
	<script charset="utf-8" type="text/javascript" src="../../js/hui_animation.js"></script>
	<script charset="utf-8" type="text/javascript" src="../../js/hui_color.js"></script>
	<script charset="utf-8" type="text/javascript" src="../../js/ui.js"></script>
	<script charset="utf-8" type="text/javascript" src="../../js/Drawing.js"></script>
	<script charset="utf-8" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

	<!--
	<script charset="utf-8" type="text/javascript" src="../../lib/arbor/lib/arbor.js"></script>
	-->

	<script src="../../lib/arbor/src/etc.js"></script>
	<script src="../../lib/arbor/src/kernel.js"></script>
	<script src="../../lib/arbor/src/graphics/colors.js"></script>
	<script src="../../lib/arbor/src/graphics/primitives.js"></script>
	<script src="../../lib/arbor/src/graphics/graphics.js"></script>
	<script src="../../lib/arbor/src/tween/easing.js"></script>
	<script src="../../lib/arbor/src/tween/tween.js"></script>
	<script src="../../lib/arbor/src/physics/barnes-hut.js"></script>
	<script src="../../lib/arbor/src/physics/atoms.js"></script>
	<script src="../../lib/arbor/src/physics/physics.js"></script>
	<script src="../../lib/arbor/src/physics/system.js"></script>
	<script src="../../lib/arbor/src/dev.js"></script>
	
	<script type="text/javascript" charset="utf-8">
		hui.ui.context='../../..';
	</script>
	<style>
		.node {
			position: absolute;
		}
		.node_point
		{
			background: #ddd;
			color: #fff;
			width: 40px;
			height: 40px;
			line-height: 40px;
			text-align: center;
			font-family: Helvetica;
			font-size: 20px;
			border-radius: 50%;
			margin: -20px 0 0 -20px;
		}
		table
		{
			font-family: Helvetica;
			border: 1px solid #ddd;
			font-size: 12px;
			border-radius: 0 0 5px 5px;
			background: #fff;
		}
		caption
		{
			border-radius: 5px 5px 0 0;
			border: 1px solid #ddd;
			background: #fafafa;
			margin: 0 0 -1px 0;
			height: 20px;
			line-height: 20px;
		}
		th
		{
			font-weight: normal;
			text-align: right;
			width: 50%;
			color: #666;
			padding-left: 15px;
		}
		.icon
		{
			 white-space: nowrap;
		}
		.icon span
		{
			 display: inline-block; width: 16px; height: 16px; vertical-align: middle;
		}
		.icon strong
		{
			margin-top: 4px;
			margin-left: 2px; font: 12px 'Lucida Grande'; vertical-align: middle; padding: 0 3px; background: rgba(255,255,255,.5);
			position: absolute;
		}
		
		.icon64 span
		{
			 width: 64px; height: 64px;
		}
	</style>
</head>

<body>
	<div id="drawing">
		
	</div>
	<div id="C" class="node node_point">C</div>
	
	<script type="text/javascript" charset="utf-8">
		var drawing = hui.ui.Drawing.create({width:800,height:600,parent:hui.get('drawing')}),
			draggedNode,
			draggedPoint;
			
		var repulsion = 1000, // the force repelling nodes from each other
			stiffness = 600, // the rigidity of the edges
			friction = 0.5, // the amount of damping in the system
			gravity = false, // an additional force attracting nodes to the origin
			fps = 55, // frames per second
			dt = 0.02, // timestep to use for stepping the simulation
			precision = 0.6; // accuracy vs. speed in force calculations
		
		var myRenderer = {
  			init:  function(system){ console.log("starting",system) },
  			redraw : function() {
				hui.log('redraw')
				system.eachNode(function(node,point) {
					if (draggedNode==node) {
						return;
					}
					if (node.data.shape) {
						node.data.shape.setCenter(point);
					} else {						
						var e = node.data.element;
						e.style.left=point.x+'px';
						e.style.top=point.y+'px';
					}
				});
				system.eachEdge(function(edge,point1,point2) {
					var line = edge.data.line;
					if (edge.source!==draggedNode) {
						line.setFrom(point1);
					} else {
						line.setFrom(draggedPoint);
					}
					if (edge.target!==draggedNode) {
						line.setTo(point2);
					} else {
						line.setTo(draggedPoint);
					}
				});
			}
		}
		var system = arbor.ParticleSystem(repulsion, stiffness, friction, gravity, fps, dt, precision);
		system.screenSize(800, 600);
		system.screenPadding(50,100);
		system.renderer = myRenderer
		
		var a = drawing.addElement({
			html:'<table><caption>Person</caption><tbody><tr><th>First name</th><td>String</td></tr><tr><th>Middle name</th><td>String</td></tr><tr><th>Last name</th><td>String</td></tr></tbody></table>',
			movable : true
		});
		var map = {}
		var aNode = system.addNode("A", {id:1,shape:a});
		a.x = aNode;
		system.addNode("B", {id:2,shape:drawing.addElement({
			html:'<table><caption>Address</caption><tbody><tr><th>Street</th><td>String</td></tr><tr><th>City</th><td>String</td></tr><tr><th>Country</th><td>String</td></tr></tbody></table>',
			movable : true
		})});
		system.addNode("C", {id:3,element:document.getElementById('C')})
		system.addNode("D", {id:2,shape:drawing.addElement({
			html:'<span class="icon"><span style="background: url(../../icons/common/user16.png);"></span><strong>Jonas Munk</strong></span>',
			movable : true
		})});
		system.addNode("E", {id:2,shape:drawing.addElement({
			html:'<span class="icon"><span style="background: url(../../icons/common/folder16.png);"></span><strong>Jonas Munk</strong></span>',
			movable : true
		})});
		system.addNode("F", {id:2,shape:drawing.addElement({
			html:'<span class="icon icon64"><span style="background: url(../../icons/common/lifebuoy64.png);"></span><strong>Help</strong></span>',
			movable : true
		})});
		
		system.addEdge("A", "B", {type:'connection',line:drawing.addLine({x1:0,y1:0,x2:0,y2:0,color:'#aaa'})})
		system.addEdge("A", "C", {type:'connection',line:drawing.addLine({x1:0,y1:0,x2:0,y2:0,color:'#aaa'})})
		system.addEdge("A", "D", {type:'connection',line:drawing.addLine({x1:0,y1:0,x2:0,y2:0,color:'#aaa'})})
		system.addEdge("E", "C", {type:'connection',line:drawing.addLine({x1:0,y1:0,x2:0,y2:0,color:'#aaa'})})
		system.addEdge("F", "C", {type:'connection',line:drawing.addLine({x1:0,y1:0,x2:0,y2:0,color:'#aaa'})})
		system.addEdge("F", "D", {type:'connection',line:drawing.addLine({x1:0,y1:0,x2:0,y2:0,color:'#aaa'})})
		//system.stop();
		system.start();
		hui.ui.listen({
			$shapeWillMove : function(info) {
				var node = info.shape.x;
				draggedNode = node;
				//hui.log('shapeWillMove')
			},
			$shapeMoved : function(info) {
				var node = info.shape.x;
				draggedPoint = arbor.Point(info.event.getLeft(), info.event.getTop());
				node.p = system.fromScreen(arbor.Point(info.event.getLeft(), info.event.getTop()));
				
			},
			$shapeWasMoved : function(info) {
				//hui.log('shapeWasMoved')
				draggedNode = undefined;
			}
		})
	</script>
	<button onclick="system.start()">Start</button>
	<button onclick="system.stop()">Stop</button>
</body>
</html>
